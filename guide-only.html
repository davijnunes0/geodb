<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>GeoDB Cities - Guia AcadÃªmico Completo</title>
  <style>
/**
 * Estilos CSS para PDF gerado do guide.md
 * Aplicado durante a conversÃ£o markdown -> PDF
 */

/* Reset e base */
* {
  box-sizing: border-box;
}

body {
  font-family: 'Georgia', 'Times New Roman', serif;
  font-size: 11pt;
  line-height: 1.6;
  color: #333;
  max-width: 100%;
  margin: 0;
  padding: 0;
}

/* TÃ­tulos */
h1 {
  font-size: 24pt;
  font-weight: bold;
  color: #1a1a1a;
  margin-top: 30pt;
  margin-bottom: 15pt;
  page-break-after: avoid;
  border-bottom: 3pt solid #0066cc;
  padding-bottom: 10pt;
}

h2 {
  font-size: 20pt;
  font-weight: bold;
  color: #2c3e50;
  margin-top: 25pt;
  margin-bottom: 12pt;
  page-break-after: avoid;
  border-bottom: 2pt solid #3498db;
  padding-bottom: 8pt;
}

h3 {
  font-size: 16pt;
  font-weight: bold;
  color: #34495e;
  margin-top: 20pt;
  margin-bottom: 10pt;
  page-break-after: avoid;
}

h4 {
  font-size: 14pt;
  font-weight: bold;
  color: #555;
  margin-top: 15pt;
  margin-bottom: 8pt;
  page-break-after: avoid;
}

h5 {
  font-size: 12pt;
  font-weight: bold;
  color: #666;
  margin-top: 12pt;
  margin-bottom: 6pt;
}

h6 {
  font-size: 11pt;
  font-weight: bold;
  color: #777;
  margin-top: 10pt;
  margin-bottom: 5pt;
}

/* ParÃ¡grafos */
p {
  margin-top: 8pt;
  margin-bottom: 8pt;
  text-align: justify;
  orphans: 3;
  widows: 3;
}

/* Listas */
ul, ol {
  margin-top: 10pt;
  margin-bottom: 10pt;
  padding-left: 30pt;
}

li {
  margin-top: 5pt;
  margin-bottom: 5pt;
  line-height: 1.5;
}

/* CÃ³digo inline */
code {
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 10pt;
  background-color: #f4f4f4;
  border: 1pt solid #ddd;
  border-radius: 3pt;
  padding: 2pt 4pt;
  color: #c7254e;
}

/* Blocos de cÃ³digo - Estilo Livro AcadÃªmico */
pre {
  font-family: 'Consolas', 'Monaco', 'Courier New', 'Liberation Mono', monospace !important;
  font-size: 8.5pt !important;
  line-height: 1.5 !important;
  background-color: #f8f9fa !important;
  color: #212529 !important;
  border: 1pt solid #dee2e6 !important;
  border-left: 4pt solid #0066cc !important;
  border-radius: 3pt;
  padding: 12pt 12pt 12pt 40pt !important; /* EspaÃ§o Ã  esquerda para numeraÃ§Ã£o */
  margin: 18pt 0 !important;
  overflow-x: auto;
  overflow-y: visible;
  page-break-inside: avoid !important;
  box-shadow: 0 1pt 3pt rgba(0,0,0,0.08);
  position: relative;
  counter-reset: line-number;
  white-space: pre-wrap !important; /* Permite quebra de linha */
  word-wrap: break-word !important;
  tab-size: 2;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
}

pre.code-block {
  background-color: #f8f9fa !important;
  color: #212529 !important;
}

/* NumeraÃ§Ã£o de linhas estilo livro */
pre code {
  background-color: transparent !important;
  border: none !important;
  padding: 0 !important;
  color: inherit !important;
  font-size: inherit !important;
  font-family: inherit !important;
  display: block !important;
  position: relative;
  line-height: inherit !important;
  visibility: visible !important;
  opacity: 1 !important;
  white-space: pre-wrap !important;
  word-wrap: break-word !important;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
}

/* NumeraÃ§Ã£o de linhas usando CSS counters */
pre {
  counter-reset: line-number;
}

pre code .code-line {
  display: block !important;
  position: relative !important;
  padding-left: 40pt !important;
  padding-right: 0 !important;
  margin: 0 !important;
  counter-increment: line-number;
  visibility: visible !important;
  opacity: 1 !important;
  color: inherit !important;
  white-space: pre !important;
  word-wrap: normal !important;
  font-family: inherit !important;
  font-size: inherit !important;
  line-height: inherit !important;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
}

pre code .code-line::before {
  content: counter(line-number) !important;
  position: absolute !important;
  left: 0 !important;
  width: 30pt !important;
  text-align: right !important;
  color: #6c757d !important;
  font-size: 7.5pt !important;
  font-weight: normal !important;
  font-family: 'Consolas', 'Monaco', monospace !important;
  padding-right: 8pt !important;
  border-right: 1pt solid #dee2e6 !important;
  user-select: none;
  visibility: visible !important;
  opacity: 1 !important;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
  background-color: transparent !important;
}

/* Estilo alternativo para cÃ³digo escuro (quando necessÃ¡rio) */
pre.dark-code {
  background-color: #2d2d2d;
  color: #f8f8f2;
  border-left-color: #61afef;
}

pre.dark-code code::before {
  color: #5c6370;
  border-right-color: #444;
}

/* Syntax highlighting (highlight.js) - Estilo Livro */
.hljs {
  display: block;
  overflow-x: auto;
  padding: 0;
  background: transparent;
  color: inherit;
  font-size: inherit;
  line-height: inherit;
}

/* Ajusta cores para tema claro (padrÃ£o) */
pre:not(.dark-code) .hljs-keyword { color: #0066cc; font-weight: bold; }
pre:not(.dark-code) .hljs-string { color: #28a745; }
pre:not(.dark-code) .hljs-comment { color: #6c757d; font-style: italic; }
pre:not(.dark-code) .hljs-number { color: #dc3545; }
pre:not(.dark-code) .hljs-function { color: #0056b3; }
pre:not(.dark-code) .hljs-variable { color: #e83e8c; }
pre:not(.dark-code) .hljs-title { color: #fd7e14; }
pre:not(.dark-code) .hljs-params { color: #495057; }
pre:not(.dark-code) .hljs-built_in { color: #17a2b8; }
pre:not(.dark-code) .hljs-literal { color: #17a2b8; }
pre:not(.dark-code) .hljs-type { color: #fd7e14; }
pre:not(.dark-code) .hljs-property { color: #0056b3; }
pre:not(.dark-code) .hljs-attr { color: #dc3545; }
pre:not(.dark-code) .hljs-tag { color: #e83e8c; }
pre:not(.dark-code) .hljs-name { color: #e83e8c; }
pre:not(.dark-code) .hljs-selector-id { color: #e83e8c; }
pre:not(.dark-code) .hljs-selector-class { color: #e83e8c; }
pre:not(.dark-code) .hljs-regexp { color: #28a745; }
pre:not(.dark-code) .hljs-symbol { color: #17a2b8; }
pre:not(.dark-code) .hljs-meta { color: #0066cc; }

.hljs-keyword { color: #c678dd; font-weight: bold; }
.hljs-string { color: #98c379; }
.hljs-comment { color: #5c6370; font-style: italic; }
.hljs-number { color: #d19a66; }
.hljs-function { color: #61afef; }
.hljs-variable { color: #e06c75; }
.hljs-title { color: #e5c07b; }
.hljs-params { color: #abb2bf; }
.hljs-built_in { color: #56b6c2; }
.hljs-literal { color: #56b6c2; }
.hljs-type { color: #e5c07b; }
.hljs-property { color: #61afef; }
.hljs-attr { color: #d19a66; }
.hljs-tag { color: #e06c75; }
.hljs-name { color: #e06c75; }
.hljs-selector-id { color: #e06c75; }
.hljs-selector-class { color: #e06c75; }
.hljs-regexp { color: #98c379; }
.hljs-symbol { color: #56b6c2; }
.hljs-meta { color: #c678dd; }

/* Blockquotes */
blockquote {
  border-left: 4pt solid #3498db;
  margin: 15pt 0;
  padding: 10pt 15pt;
  background-color: #f8f9fa;
  font-style: italic;
  color: #555;
  page-break-inside: avoid;
}

/* Tabelas */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 15pt 0;
  page-break-inside: avoid;
}

th {
  background-color: #3498db;
  color: white;
  font-weight: bold;
  padding: 8pt;
  text-align: left;
  border: 1pt solid #2980b9;
}

td {
  padding: 8pt;
  border: 1pt solid #ddd;
}

tr:nth-child(even) {
  background-color: #f8f9fa;
}

/* Links */
a {
  color: #0066cc;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* Imagens */
img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 15pt auto;
  page-break-inside: avoid;
}

/* Alertas e boxes especiais */
.alert {
  padding: 12pt;
  margin: 15pt 0;
  border-radius: 5pt;
  border-left: 4pt solid;
  page-break-inside: avoid;
}

.alert-info {
  background-color: #d1ecf1;
  border-color: #0c5460;
  color: #0c5460;
}

.alert-warning {
  background-color: #fff3cd;
  border-color: #856404;
  color: #856404;
}

.alert-danger {
  background-color: #f8d7da;
  border-color: #721c24;
  color: #721c24;
}

.alert-success {
  background-color: #d4edda;
  border-color: #155724;
  color: #155724;
}

/* Emojis e Ã­cones */
.emoji {
  font-size: 1.2em;
}

/* Divisores */
hr {
  border: none;
  border-top: 2pt solid #ddd;
  margin: 20pt 0;
  page-break-after: avoid;
}

/* Ãndice */
.toc {
  page-break-after: always;
  margin-bottom: 30pt;
}

.toc ul {
  list-style-type: none;
  padding-left: 0;
}

.toc li {
  margin: 5pt 0;
}

.toc a {
  color: #0066cc;
  text-decoration: none;
}

/* Quebras de pÃ¡gina */
.page-break {
  page-break-before: always;
}

.no-break {
  page-break-inside: avoid;
}

/* Notas de rodapÃ© */
.footnote {
  font-size: 9pt;
  color: #666;
  margin-top: 10pt;
}

/* Destaques */
strong {
  font-weight: bold;
  color: #2c3e50;
}

em {
  font-style: italic;
  color: #555;
}

/* MatemÃ¡tica (se usar MathJax) */
.math {
  font-family: 'Times New Roman', serif;
  font-style: italic;
}

/* Print styles - Garantir que cÃ³digo apareÃ§a */
@media print {
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  body {
    print-color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  pre {
    background-color: #f8f9fa !important;
    color: #212529 !important;
    border: 1pt solid #dee2e6 !important;
    border-left: 4pt solid #0066cc !important;
    print-color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
    page-break-inside: avoid !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
  
  pre code {
    background-color: transparent !important;
    color: #212529 !important;
    print-color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
  
  pre code .code-line {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    color: #212529 !important;
    print-color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
  }
  
  pre code .code-line::before {
    content: counter(line-number) !important;
    visibility: visible !important;
    opacity: 1 !important;
    color: #6c757d !important;
    print-color-adjust: exact !important;
  }
  
  code {
    background-color: #f4f4f4 !important;
    color: #c7254e !important;
    print-color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
  }
  
  /* Syntax highlighting em print */
  .hljs-keyword { color: #0066cc !important; }
  .hljs-string { color: #28a745 !important; }
  .hljs-comment { color: #6c757d !important; }
  .hljs-number { color: #dc3545 !important; }
  .hljs-function { color: #0056b3 !important; }
}

  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
</head>
<body>
<h1>GeoDB Cities - Guia AcadÃªmico Completo de Aprendizado</h1>
<blockquote>
<p><strong>"NÃ£o copie o cÃ³digo. Herde o raciocÃ­nio."</strong><br />
<em>Guia desenvolvido com rigor acadÃªmico seguindo padrÃµes de cursos de CiÃªncia da ComputaÃ§Ã£o da USP</em></p>
</blockquote>
<hr />
<h2>ğŸ“‘ Ãndice AcadÃªmico</h2>
<h3>Parte I: FundamentaÃ§Ã£o TeÃ³rica</h3>
<ol>
<li><a href="#capÃ­tulo-1-programaÃ§Ã£o-assÃ­ncrona---fundamentos-teÃ³ricos">CapÃ­tulo 1: ProgramaÃ§Ã£o AssÃ­ncrona - Fundamentos TeÃ³ricos</a></li>
<li><a href="#capÃ­tulo-2-concorrÃªncia-vs-paralelismo---uma-distinÃ§Ã£o-fundamental">CapÃ­tulo 2: ConcorrÃªncia vs Paralelismo - Uma DistinÃ§Ã£o Fundamental</a></li>
<li><a href="#capÃ­tulo-3-programaÃ§Ã£o-funcional---fundamentaÃ§Ã£o-matemÃ¡tica">CapÃ­tulo 3: ProgramaÃ§Ã£o Funcional - FundamentaÃ§Ã£o MatemÃ¡tica</a></li>
<li><a href="#capÃ­tulo-4-memÃ³ria-compartilhada-e-sincronizaÃ§Ã£o---teoria-de-sistemas-distribuÃ­dos">CapÃ­tulo 4: MemÃ³ria Compartilhada e SincronizaÃ§Ã£o - Teoria de Sistemas DistribuÃ­dos</a></li>
<li><a href="#capÃ­tulo-5-algoritmo-de-divisÃ£o-e-conquista---anÃ¡lise-de-algoritmos">CapÃ­tulo 5: Algoritmo de DivisÃ£o e Conquista - AnÃ¡lise de Algoritmos</a></li>
<li><a href="#capÃ­tulo-6-algoritmo-k-means---fundamentaÃ§Ã£o-em-machine-learning">CapÃ­tulo 6: Algoritmo K-Means - FundamentaÃ§Ã£o em Machine Learning</a></li>
<li><a href="#capÃ­tulo-7-web-workers---arquitetura-de-processamento-paralelo">CapÃ­tulo 7: Web Workers - Arquitetura de Processamento Paralelo</a></li>
<li><a href="#capÃ­tulo-8-serializaÃ§Ã£o-de-dados---teoria-de-codificaÃ§Ã£o">CapÃ­tulo 8: SerializaÃ§Ã£o de Dados - Teoria de CodificaÃ§Ã£o</a></li>
<li><a href="#capÃ­tulo-9-rate-limiting-e-backoff---teoria-de-controle">CapÃ­tulo 9: Rate Limiting e Backoff - Teoria de Controle</a></li>
<li><a href="#capÃ­tulo-10-arquitetura-mvc---padrÃµes-de-design">CapÃ­tulo 10: Arquitetura MVC - PadrÃµes de Design</a></li>
</ol>
<h3>Parte II: AnÃ¡lise e OtimizaÃ§Ã£o</h3>
<ol>
<li><a href="#capÃ­tulo-11-anÃ¡lise-de-complexidade-detalhada---todo-o-sistema">CapÃ­tulo 11: AnÃ¡lise de Complexidade Detalhada</a></li>
<li><a href="#capÃ­tulo-12-seguranÃ§a-e-vulnerabilidades">CapÃ­tulo 12: SeguranÃ§a e Vulnerabilidades</a></li>
<li><a href="#capÃ­tulo-13-otimizaÃ§Ãµes-e-tÃ©cnicas-avanÃ§adas">CapÃ­tulo 13: OtimizaÃ§Ãµes e TÃ©cnicas AvanÃ§adas</a></li>
<li><a href="#capÃ­tulo-14-testes-e-validaÃ§Ã£o">CapÃ­tulo 14: Testes e ValidaÃ§Ã£o</a></li>
<li><a href="#capÃ­tulo-15-referÃªncias-acadÃªmicas-e-leitura-recomendada">CapÃ­tulo 15: ReferÃªncias AcadÃªmicas</a></li>
</ol>
<h3>Parte III: TÃ³picos AvanÃ§ados</h3>
<ol>
<li><a href="#capÃ­tulo-16-anÃ¡lise-comparativa-de-abordagens">CapÃ­tulo 16: AnÃ¡lise Comparativa de Abordagens</a></li>
<li><a href="#capÃ­tulo-17-padrÃµes-de-design-aplicados">CapÃ­tulo 17: PadrÃµes de Design Aplicados</a></li>
<li><a href="#capÃ­tulo-18-anÃ¡lise-de-erros-e-robustez">CapÃ­tulo 18: AnÃ¡lise de Erros e Robustez</a></li>
<li><a href="#capÃ­tulo-19-performance-e-otimizaÃ§Ã£o">CapÃ­tulo 19: Performance e OtimizaÃ§Ã£o</a></li>
<li><a href="#capÃ­tulo-20-escalabilidade-e-arquitetura">CapÃ­tulo 20: Escalabilidade e Arquitetura</a></li>
<li><a href="#capÃ­tulo-21-Ã©tica-e-responsabilidade-em-sistemas-computacionais">CapÃ­tulo 21: Ã‰tica e Responsabilidade</a></li>
</ol>
<h3>Parte IV: ImplementaÃ§Ã£o PrÃ¡tica</h3>
<ul>
<li><a href="#estrutura-completa-do-projeto">Estrutura Completa do Projeto</a></li>
<li><a href="#configuraÃ§Ã£o-inicial">ConfiguraÃ§Ã£o Inicial</a></li>
<li><a href="#implementaÃ§Ã£o-passo-a-passo">ImplementaÃ§Ã£o Passo a Passo</a></li>
<li><a href="#fluxo-completo-da-aplicaÃ§Ã£o">Fluxo Completo da AplicaÃ§Ã£o</a></li>
<li><a href="#docker-e-containerizaÃ§Ã£o">Docker e ContainerizaÃ§Ã£o</a></li>
</ul>
<hr />
<h2>ğŸ“– PrefÃ¡cio: A VisÃ£o Geral</h2>
<h3>A MissÃ£o</h3>
<p>Este projeto Ã© uma <strong>jornada de aprendizado</strong> que integra conceitos avanÃ§ados de programaÃ§Ã£o:
- <strong>ProgramaÃ§Ã£o AssÃ­ncrona</strong> (async/await, Promises)
- <strong>ConcorrÃªncia</strong> (mÃºltiplas operaÃ§Ãµes simultÃ¢neas)
- <strong>Paralelismo</strong> (Web Workers, processamento distribuÃ­do)
- <strong>ProgramaÃ§Ã£o Funcional</strong> (estado imutÃ¡vel, funÃ§Ãµes puras)
- <strong>MemÃ³ria Compartilhada</strong> (SharedArrayBuffer, Atomics)
- <strong>Algoritmos Paralelos</strong> (divisÃ£o e conquista, K-Means)</p>
<p><strong>O que vocÃª vai construir:</strong>
Uma aplicaÃ§Ã£o full-stack que consulta informaÃ§Ãµes sobre cidades do mundo, permite explorar e selecionar cidades, coleta dados em paralelo usando memÃ³ria compartilhada, e executa clustering K-Means paralelizado para agrupar cidades por similaridade geogrÃ¡fica e demogrÃ¡fica.</p>
<h3>Requisitos do Projeto</h3>
<p>Este projeto deve demonstrar:</p>
<ol>
<li>âœ… <strong>Consumo assÃ­ncrono da API</strong> - RequisiÃ§Ãµes nÃ£o-bloqueantes</li>
<li>âœ… <strong>Interface grÃ¡fica</strong> - Dois espaÃ§os distintos (exploraÃ§Ã£o e seleÃ§Ã£o)</li>
<li>âœ… <strong>Coleta paralela</strong> - Web Workers coletando dados simultaneamente</li>
<li>âœ… <strong>MemÃ³ria compartilhada</strong> - SharedArrayBuffer com sincronizaÃ§Ã£o Atomics</li>
<li>âœ… <strong>DivisÃ£o e conquista</strong> - Cada worker processa sua parcela independentemente</li>
<li>âœ… <strong>K-Means explÃ­cito</strong> - ImplementaÃ§Ã£o prÃ³pria paralelizada</li>
<li>âœ… <strong>ProgramaÃ§Ã£o funcional</strong> - Estado imutÃ¡vel, funÃ§Ãµes puras</li>
<li>âœ… <strong>InÃ­cio automÃ¡tico</strong> - K-Means inicia automaticamente apÃ³s coleta</li>
</ol>
<hr />
<h2>ğŸ“ FundamentaÃ§Ã£o TeÃ³rica e Conceitos AcadÃªmicos</h2>
<blockquote>
<p><strong>Nota do Professor:</strong> Esta seÃ§Ã£o apresenta uma fundamentaÃ§Ã£o teÃ³rica rigorosa dos conceitos implementados neste projeto, seguindo o padrÃ£o acadÃªmico de cursos de CiÃªncia da ComputaÃ§Ã£o da USP. Cada conceito serÃ¡ apresentado com seu contexto histÃ³rico, fundamentaÃ§Ã£o matemÃ¡tica (quando aplicÃ¡vel), anÃ¡lise de complexidade e comparaÃ§Ã£o com abordagens alternativas.</p>
</blockquote>
<hr />
<p><a id="capÃ­tulo-1-programaÃ§Ã£o-assÃ­ncrona---fundamentos-teÃ³ricos"></a></p>
<h2>ğŸ“š CapÃ­tulo 1: ProgramaÃ§Ã£o AssÃ­ncrona - Fundamentos TeÃ³ricos</h2>
<h3>ğŸ“– DefiniÃ§Ãµes de Conceitos</h3>
<p><strong>JavaScript:</strong> Uma linguagem de programaÃ§Ã£o de alto nÃ­vel, interpretada e orientada a objetos, originalmente desenvolvida para adicionar interatividade a pÃ¡ginas web. JavaScript Ã© single-threaded por padrÃ£o, executando cÃ³digo em um Ãºnico thread principal atravÃ©s de um event loop.</p>
<p><strong>ProgramaÃ§Ã£o AssÃ­ncrona:</strong> Um paradigma de programaÃ§Ã£o onde operaÃ§Ãµes podem ser iniciadas sem esperar que operaÃ§Ãµes anteriores sejam concluÃ­das. Permite que o programa continue executando outras tarefas enquanto aguarda operaÃ§Ãµes de I/O (entrada/saÃ­da) como requisiÃ§Ãµes de rede, leitura de arquivos ou acesso a banco de dados.</p>
<p><strong>Promise:</strong> Um objeto JavaScript que representa o resultado eventual (sucesso ou falha) de uma operaÃ§Ã£o assÃ­ncrona. Uma Promise pode estar em um de trÃªs estados: pendente (pending), resolvida (fulfilled) ou rejeitada (rejected). Permite encadear operaÃ§Ãµes assÃ­ncronas de forma mais legÃ­vel que callbacks.</p>
<p><strong>async/await:</strong> Sintaxe introduzida no ES2017 que permite escrever cÃ³digo assÃ­ncrono de forma similar ao cÃ³digo sÃ­ncrono. A palavra-chave <code>async</code> declara uma funÃ§Ã£o assÃ­ncrona, e <code>await</code> pausa a execuÃ§Ã£o atÃ© que uma Promise seja resolvida, sem bloquear o thread principal.</p>
<p><strong>Event Loop:</strong> O mecanismo fundamental do JavaScript que gerencia a execuÃ§Ã£o de cÃ³digo assÃ­ncrono. O event loop monitora a pilha de chamadas (call stack) e a fila de callbacks (callback queue), movendo callbacks da fila para a pilha quando a pilha estÃ¡ vazia.</p>
<p><strong>Callback:</strong> Uma funÃ§Ã£o passada como argumento para outra funÃ§Ã£o, que serÃ¡ executada apÃ³s a conclusÃ£o de uma operaÃ§Ã£o assÃ­ncrona. Callbacks sÃ£o a forma mais bÃ¡sica de programaÃ§Ã£o assÃ­ncrona em JavaScript.</p>
<p><strong>Callback Hell:</strong> Um problema comum em programaÃ§Ã£o assÃ­ncrona onde mÃºltiplos callbacks aninhados tornam o cÃ³digo difÃ­cil de ler e manter. Ocorre quando operaÃ§Ãµes assÃ­ncronas dependem umas das outras, criando mÃºltiplos nÃ­veis de indentaÃ§Ã£o.</p>
<h3>1.1 Contexto HistÃ³rico e EvoluÃ§Ã£o</h3>
<p>A programaÃ§Ã£o assÃ­ncrona nÃ£o Ã© um conceito novo. Suas raÃ­zes remontam aos primÃ³rdios da computaÃ§Ã£o, especificamente ao modelo de <strong>I/O nÃ£o-bloqueante</strong> desenvolvido nos sistemas operacionais Unix na dÃ©cada de 1970.</p>
<p><strong>EvoluÃ§Ã£o HistÃ³rica:</strong></p>
<ol>
<li><strong>Modelo SÃ­ncrono (Bloqueante)</strong> - Anos 1960-1970</li>
<li>Uma operaÃ§Ã£o bloqueia toda a execuÃ§Ã£o atÃ© completar</li>
<li>Simples de entender, mas ineficiente para I/O</li>
<li>
<p>Exemplo: <code>read()</code> bloqueia atÃ© dados estarem disponÃ­veis</p>
</li>
<li>
<p><strong>Modelo AssÃ­ncrono com Callbacks</strong> - Anos 1980-1990</p>
</li>
<li>OperaÃ§Ãµes nÃ£o-bloqueantes com callbacks</li>
<li>Problema: "Callback Hell" (aninhamento excessivo)</li>
<li>
<p>Exemplo: Node.js inicial (2009)</p>
</li>
<li>
<p><strong>Promises</strong> - PadrÃ£o ES6 (2015)</p>
</li>
<li>AbstraÃ§Ã£o matemÃ¡tica baseada em teoria de monads</li>
<li>Resolve problema de composiÃ§Ã£o de operaÃ§Ãµes assÃ­ncronas</li>
<li>
<p>FundamentaÃ§Ã£o: Teoria de categorias aplicada Ã  programaÃ§Ã£o</p>
</li>
<li>
<p><strong>async/await</strong> - ES2017</p>
</li>
<li>AÃ§Ãºcar sintÃ¡tico sobre Promises</li>
<li>Permite cÃ³digo assÃ­ncrono com sintaxe sÃ­ncrona</li>
<li>Facilita tratamento de erros</li>
</ol>
<h3>1.2 FundamentaÃ§Ã£o TeÃ³rica: Modelo de Eventos e Continuations</h3>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias MDN:</strong>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Event_loop">Concurrency model and Event Loop - MDN</a>
- <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous">Asynchronous JavaScript - MDN Guide</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises">Promises - MDN Guide</a></p>
</blockquote>
<p><strong>Teoria de Continuations:</strong>
Uma continuation representa o "resto do programa" apÃ³s uma operaÃ§Ã£o assÃ­ncrona. Em termos formais:</p>
<div class="codehilite"><pre><span></span><code>C = Î»k. (operacao_assincrona â†’ k(resultado))
</code></pre></div>

<p>Onde:
- <code>C</code> Ã© a continuation
- <code>k</code> Ã© a funÃ§Ã£o que serÃ¡ chamada com o resultado
- A operaÃ§Ã£o assÃ­ncrona eventualmente chama <code>k</code> com o resultado</p>
<p><strong>Modelo de Event Loop:</strong>
O JavaScript implementa um <strong>event loop single-threaded</strong> baseado no modelo de <strong>cooperative multitasking</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">         </span><span class="k">Call</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="p">(</span><span class="n">LIFO</span><span class="p">)</span><span class="w">              </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">funÃ§Ã£o3</span><span class="p">()</span><span class="w">                       </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">funÃ§Ã£o2</span><span class="p">()</span><span class="w">                       </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">funÃ§Ã£o1</span><span class="p">()</span><span class="w">                       </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">           </span><span class="err">â”‚</span>
<span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="n">quando</span><span class="w"> </span><span class="n">vazio</span>
<span class="w">           </span><span class="err">â–¼</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">Event</span><span class="w"> </span><span class="n">Queue</span><span class="w"> </span><span class="p">(</span><span class="n">FIFO</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="o">[</span><span class="n">callback1</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">callback2</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">callback3</span><span class="o">]</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<p><strong>AnÃ¡lise de Complexidade:</strong>
- <strong>Tempo:</strong> O(1) para enfileirar evento, O(n) para processar n eventos
- <strong>EspaÃ§o:</strong> O(n) onde n Ã© nÃºmero de eventos pendentes
- <strong>Vantagem:</strong> Evita overhead de criaÃ§Ã£o de threads</p>
<h3>1.3 ImplementaÃ§Ã£o no Projeto: AnÃ¡lise Detalhada</h3>
<p><strong>CÃ³digo Base:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">handlePagination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">direction</span><span class="p">,</span><span class="w"> </span><span class="nx">elements</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Previne requisiÃ§Ãµes simultÃ¢neas (mutex lÃ³gico)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isLoading</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="c1">// Early return - padrÃ£o guard clause</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// Lock adquirido</span>

<span class="w">    </span><span class="c1">// OperaÃ§Ã£o assÃ­ncrona nÃ£o-bloqueante</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/cities?</span><span class="si">${</span><span class="nx">queryString</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Processamento continua apÃ³s resposta</span>
<span class="w">    </span><span class="nx">renderCitiesList</span><span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">citiesList</span><span class="p">,</span><span class="w"> </span><span class="nx">cities</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Tratamento de erro centralizado</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Lock liberado</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>AnÃ¡lise AcadÃªmica:</strong></p>
<ol>
<li><strong>PadrÃ£o Mutex (Mutual Exclusion):</strong></li>
<li><code>isLoading</code> atua como semÃ¡foro binÃ¡rio</li>
<li>Garante exclusÃ£o mÃºtua: apenas uma requisiÃ§Ã£o por vez</li>
<li>
<p>Evita race conditions na UI</p>
</li>
<li>
<p><strong>DescompilaÃ§Ã£o do <code>async/await</code>:</strong>
   O cÃ³digo acima Ã© equivalente a:
   <code>javascript
   handlePagination = (direction, elements) =&gt; {
     return fetch(`/api/cities?${queryString}`)
       .then(response =&gt; response.json())
       .then(data =&gt; {
         renderCitiesList(...);
       })
       .catch(error =&gt; {
         // tratamento
       });
   };</code></p>
</li>
<li>
<p><strong>AnÃ¡lise de Performance:</strong></p>
</li>
<li><strong>Sem async:</strong> UI bloqueia por ~200-500ms por requisiÃ§Ã£o</li>
<li><strong>Com async:</strong> UI permanece responsiva, operaÃ§Ã£o ocorre em background</li>
<li><strong>Ganho:</strong> ExperiÃªncia do usuÃ¡rio melhorada sem overhead significativo</li>
</ol>
<h3>1.4 ComparaÃ§Ã£o com Abordagens Alternativas</h3>
<p><strong>1. Threads (Java, C#):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Abordagem com threads</span>
<span class="n">Thread</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<span class="w">    </span><span class="n">updateUI</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="p">});</span>
<span class="n">thread</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>

<p><strong>Vantagens:</strong>
- Verdadeiro paralelismo
- Melhor para CPU-bound tasks</p>
<p><strong>Desvantagens:</strong>
- Overhead de criaÃ§Ã£o de threads (~1MB por thread)
- Complexidade de sincronizaÃ§Ã£o
- Race conditions mais provÃ¡veis</p>
<p><strong>2. Corrotinas (Python, Kotlin):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Abordagem com corrotinas</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_data</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<p><strong>Similaridades com JavaScript:</strong>
- Single-threaded
- Cooperative multitasking
- Sintaxe similar</p>
<p><strong>DiferenÃ§as:</strong>
- Python permite verdadeiro paralelismo com <code>asyncio</code>
- JavaScript Ã© sempre single-threaded (exceto Workers)</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias Completas MDN e Node.js:</strong>
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise - MDN</a></strong> - Objeto Promise completo
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then">Promise.prototype.then() - MDN</a></strong> - Encadeamento de Promises
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch">Promise.prototype.catch() - MDN</a></strong> - Tratamento de erros
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all() - MDN</a></strong> - ExecuÃ§Ã£o paralela de Promises
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/race">Promise.race() - MDN</a></strong> - Primeira Promise a resolver
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">async function - MDN</a></strong> - DeclaraÃ§Ã£o de funÃ§Ã£o assÃ­ncrona
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await">await - MDN</a></strong> - Operador de espera
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Event_loop">Event Loop - MDN</a></strong> - Modelo de concorrÃªncia
- <strong><a href="https://nodejs.org/docs/latest/api/events.html">Node.js Event Loop</a></strong> - Event Loop no Node.js
- <strong><a href="https://nodejs.org/docs/latest/api/async_hooks.html">Node.js Async Hooks</a></strong> - Hooks para operaÃ§Ãµes assÃ­ncronas</p>
</blockquote>
<h3>1.5 ExercÃ­cios PrÃ¡ticos</h3>
<h4>ExercÃ­cio 1: Converter Callbacks para Promises</h4>
<p><strong>Objetivo:</strong> Praticar conversÃ£o de cÃ³digo callback-based para Promise-based.</p>
<p><strong>CÃ³digo Original (Callback):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">fetchCityData</span><span class="p">(</span><span class="nx">cityId</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cityId</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">cityId</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SÃ£o Paulo&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">callback</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;ID invÃ¡lido&#39;</span><span class="p">),</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">fetchCityData</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>

<p><strong>Tarefa:</strong> Converta para usar Promises e depois para async/await.</p>
<details>
<summary>ğŸ’¡ SoluÃ§Ã£o com Promises</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">fetchCityDataPromise</span><span class="p">(</span><span class="nx">cityId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cityId</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">resolve</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">cityId</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SÃ£o Paulo&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;ID invÃ¡lido&#39;</span><span class="p">));</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="nx">fetchCityDataPromise</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
</code></pre></div>



**ReferÃªncia:** [Promise Constructor - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/Promise)
</details>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o com async/await</summary>


<div class="codehilite"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchAndLogCity</span><span class="p">(</span><span class="nx">cityId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchCityDataPromise</span><span class="p">(</span><span class="nx">cityId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">fetchAndLogCity</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
</code></pre></div>



**ReferÃªncia:** [async/await - MDN](https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Async_await)
</details>

<h4>ExercÃ­cio 2: ExecuÃ§Ã£o Paralela com Promise.all()</h4>
<p><strong>Objetivo:</strong> Implementar requisiÃ§Ãµes paralelas usando Promise.all().</p>
<p><strong>Tarefa:</strong> Crie uma funÃ§Ã£o que busca dados de 3 cidades diferentes simultaneamente e retorna quando todas completarem.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// FunÃ§Ã£o base (jÃ¡ implementada)</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchCity</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/cities/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// TAREFA: Implemente fetchMultipleCities que busca 3 cidades em paralelo</span>
<span class="c1">// function fetchMultipleCities(ids) { ... }</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchMultipleCities</span><span class="p">(</span><span class="nx">ids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Cria array de Promises</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">promises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ids</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">fetchCity</span><span class="p">(</span><span class="nx">id</span><span class="p">));</span>

<span class="w">  </span><span class="c1">// Executa todas em paralelo</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchMultipleCities</span><span class="p">([</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">]);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Todas as cidades:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cities</span><span class="p">);</span>
</code></pre></div>



**ReferÃªncia:** [Promise.all() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all)

**AnÃ¡lise de Performance:**
- **Sequencial:** 3 requisiÃ§Ãµes Ã— 200ms = 600ms
- **Paralelo:** max(200ms) = 200ms
- **Speedup:** 3x mais rÃ¡pido
</details>

<h4>ExercÃ­cio 3: Tratamento de Erros com Promise.allSettled()</h4>
<p><strong>Objetivo:</strong> Implementar requisiÃ§Ãµes que continuam mesmo se algumas falharem.</p>
<p><strong>Tarefa:</strong> Busque 5 cidades, mas algumas podem nÃ£o existir. Retorne resultados e erros separadamente.</p>
<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchCitiesWithErrors</span><span class="p">(</span><span class="nx">ids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">promises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ids</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nx">fetchCity</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;fulfilled&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">}))</span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rejected&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">}))</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">successful</span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;fulfilled&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span>
<span class="w">    </span><span class="nx">failed</span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;rejected&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">reason</span><span class="p">)</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">successful</span><span class="p">,</span><span class="w"> </span><span class="nx">failed</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchCitiesWithErrors</span><span class="p">([</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">999</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">]);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Sucesso:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">successful</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Falhas:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">failed</span><span class="p">);</span>
</code></pre></div>



**ReferÃªncia:** [Promise.allSettled() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled)
</details>

<h4>ExercÃ­cio 4: Implementar Timeout para RequisiÃ§Ãµes</h4>
<p><strong>Objetivo:</strong> Adicionar timeout a requisiÃ§Ãµes assÃ­ncronas.</p>
<p><strong>Tarefa:</strong> Crie uma funÃ§Ã£o <code>fetchWithTimeout</code> que cancela a requisiÃ§Ã£o se demorar mais de 5 segundos.</p>
<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">fetchWithTimeout</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">timeoutMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fetchPromise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">timeoutPromise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Timeout&#39;</span><span class="p">)),</span><span class="w"> </span><span class="nx">timeoutMs</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span><span class="nx">fetchPromise</span><span class="p">,</span><span class="w"> </span><span class="nx">timeoutPromise</span><span class="p">]);</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchWithTimeout</span><span class="p">(</span><span class="s1">&#39;/api/cities&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Timeout&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;RequisiÃ§Ã£o demorou muito&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



**ReferÃªncia:** [Promise.race() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/race)
</details>

<hr />
<p><a id="capÃ­tulo-2-concorrÃªncia-vs-paralelismo---uma-distinÃ§Ã£o-fundamental"></a></p>
<h2>ğŸ“š CapÃ­tulo 2: ConcorrÃªncia vs Paralelismo - Uma DistinÃ§Ã£o Fundamental</h2>
<h3>2.0 FundamentaÃ§Ã£o TeÃ³rica: Modelos de ExecuÃ§Ã£o</h3>
<p><strong>DefiniÃ§Ã£o 2.1 (ConcorrÃªncia):</strong></p>
<p>Um sistema Ã© <strong>concorrente</strong> se mÃºltiplas tarefas podem estar em progresso simultaneamente, mesmo que apenas uma seja executada em um dado momento. Formalmente:</p>
<div class="codehilite"><pre><span></span><code>ConcorrÃªncia(S) = âˆƒtâ‚, tâ‚‚ âˆˆ T : (tâ‚ âˆˆ progresso âˆ§ tâ‚‚ âˆˆ progresso) âˆ§ 
                  (executando(tâ‚) âˆ¨ executando(tâ‚‚))
</code></pre></div>

<p>Onde <code>T</code> Ã© o conjunto de tarefas e <code>progresso</code> indica tarefas iniciadas mas nÃ£o completadas.</p>
<p><strong>DefiniÃ§Ã£o 2.2 (Paralelismo):</strong></p>
<p>Um sistema Ã© <strong>paralelo</strong> se mÃºltiplas tarefas sÃ£o executadas simultaneamente em diferentes unidades de processamento. Formalmente:</p>
<div class="codehilite"><pre><span></span><code>Paralelismo(S) = âˆƒtâ‚, tâ‚‚ âˆˆ T : executando(tâ‚) âˆ§ executando(tâ‚‚) âˆ§ 
                  processador(tâ‚) â‰  processador(tâ‚‚)
</code></pre></div>

<p><strong>Teorema 2.1: RelaÃ§Ã£o entre ConcorrÃªncia e Paralelismo</strong></p>
<p>Todo sistema paralelo Ã© concorrente, mas nem todo sistema concorrente Ã© paralelo.</p>
<p><strong>Prova:</strong></p>
<ol>
<li>
<p><strong>Paralelismo â†’ ConcorrÃªncia:</strong> Se <code>executando(tâ‚) âˆ§ executando(tâ‚‚)</code> em processadores diferentes, entÃ£o ambas estÃ£o em progresso simultaneamente, satisfazendo DefiniÃ§Ã£o 2.1.</p>
</li>
<li>
<p><strong>ConcorrÃªncia â†› Paralelismo:</strong> Um sistema single-threaded com event loop Ã© concorrente (mÃºltiplas tarefas em progresso), mas nÃ£o paralelo (apenas um processador).</p>
</li>
</ol>
<p><strong>CorolÃ¡rio 2.1.1:</strong></p>
<p>Em JavaScript, o event loop fornece concorrÃªncia sem paralelismo atÃ© que Web Workers sejam introduzidos.</p>
<p><strong>DefiniÃ§Ã£o 2.3 (Speedup):</strong></p>
<p>O speedup de um algoritmo paralelo Ã© definido como:</p>
<div class="codehilite"><pre><span></span><code>S(p) = Tâ‚ / Tâ‚š
</code></pre></div>

<p>Onde:
- <code>Tâ‚</code> = tempo de execuÃ§Ã£o sequencial
- <code>Tâ‚š</code> = tempo de execuÃ§Ã£o paralelo com p processadores</p>
<p><strong>Teorema 2.2: Limite Superior de Speedup (Lei de Amdahl)</strong></p>
<p>Para um algoritmo com fraÃ§Ã£o paralelizÃ¡vel <code>f</code> e fraÃ§Ã£o sequencial <code>s = 1 - f</code>, o speedup mÃ¡ximo Ã©:</p>
<div class="codehilite"><pre><span></span><code>S(p) â‰¤ 1 / (s + f/p)
</code></pre></div>

<p><strong>Prova:</strong></p>
<p>Tempo sequencial: <code>Tâ‚ = sÂ·Tâ‚ + fÂ·Tâ‚</code></p>
<p>Tempo paralelo: <code>Tâ‚š = sÂ·Tâ‚ + fÂ·Tâ‚/p</code></p>
<p>Speedup:</p>
<div class="codehilite"><pre><span></span><code>S(p) = Tâ‚ / Tâ‚š = Tâ‚ / (sÂ·Tâ‚ + fÂ·Tâ‚/p)
     = 1 / (s + f/p)
</code></pre></div>

<p>Como <code>s + f/p â‰¥ s + f/p</code> sempre, temos <code>S(p) â‰¤ 1/(s + f/p)</code>.</p>
<p><strong>CorolÃ¡rio 2.2.1: Speedup MÃ¡ximo</strong></p>
<p>Quando <code>p â†’ âˆ</code>:</p>
<div class="codehilite"><pre><span></span><code>lim_{pâ†’âˆ} S(p) = 1/s = 1/(1-f)
</code></pre></div>

<p>Isso significa que mesmo com infinitos processadores, o speedup Ã© limitado pela fraÃ§Ã£o sequencial.</p>
<p><strong>Exemplo 2.1: AplicaÃ§Ã£o no Projeto</strong></p>
<p>No projeto de coleta de dados:
- <code>f = 0.95</code> (95% paralelizÃ¡vel - requisiÃ§Ãµes HTTP)
- <code>s = 0.05</code> (5% sequencial - inicializaÃ§Ã£o, sincronizaÃ§Ã£o)</p>
<p>Com <code>p = 4</code> workers:</p>
<div class="codehilite"><pre><span></span><code>S(4) = 1 / (0.05 + 0.95/4) = 1 / (0.05 + 0.2375) = 1 / 0.2875 â‰ˆ 3.48x
</code></pre></div>

<p>Speedup mÃ¡ximo teÃ³rico: <code>1/0.05 = 20x</code> (com infinitos workers).</p>
<h3>ğŸ“– DefiniÃ§Ãµes de Conceitos</h3>
<p><strong>ConcorrÃªncia:</strong> A capacidade de um sistema de gerenciar mÃºltiplas tarefas simultaneamente, alternando entre elas rapidamente. Em JavaScript, a concorrÃªncia Ã© alcanÃ§ada atravÃ©s do event loop, que permite que mÃºltiplas operaÃ§Ãµes sejam iniciadas e processadas sem bloquear o thread principal.</p>
<p><strong>Paralelismo:</strong> A execuÃ§Ã£o simultÃ¢nea de mÃºltiplas tarefas em diferentes unidades de processamento (cores de CPU). Diferente da concorrÃªncia, o paralelismo requer hardware com mÃºltiplos processadores ou cores. Em JavaScript, o paralelismo Ã© alcanÃ§ado atravÃ©s de Web Workers ou Node.js Worker Threads.</p>
<p><strong>Thread:</strong> Uma unidade de execuÃ§Ã£o dentro de um processo. Um processo pode ter mÃºltiplos threads que compartilham memÃ³ria. Em JavaScript tradicional, hÃ¡ apenas um thread principal, mas Web Workers criam threads adicionais isolados.</p>
<p><strong>Processo:</strong> Uma instÃ¢ncia de um programa em execuÃ§Ã£o com seu prÃ³prio espaÃ§o de memÃ³ria isolado. Processos nÃ£o compartilham memÃ³ria diretamente e se comunicam atravÃ©s de mecanismos de IPC (Inter-Process Communication).</p>
<p><strong>Speedup:</strong> A razÃ£o entre o tempo de execuÃ§Ã£o sequencial e o tempo de execuÃ§Ã£o paralelo. Speedup = T_sequencial / T_paralelo. Um speedup de 4x significa que a versÃ£o paralela Ã© 4 vezes mais rÃ¡pida que a sequencial.</p>
<p><strong>EficiÃªncia:</strong> A razÃ£o entre o speedup real e o speedup teÃ³rico ideal. EficiÃªncia = Speedup_real / NÃºmero_de_processadores. Uma eficiÃªncia de 0.8 (80%) significa que estamos aproveitando 80% do potencial de paralelizaÃ§Ã£o.</p>
<p><strong>Amdahl's Law (Lei de Amdahl):</strong> Uma lei que limita o speedup teÃ³rico mÃ¡ximo baseado na fraÃ§Ã£o paralelizÃ¡vel do cÃ³digo. Speedup_max = 1 / (S + P/N), onde S Ã© a fraÃ§Ã£o sequencial e P Ã© a fraÃ§Ã£o paralela, com N processadores.</p>
<h3>2.1 DefiniÃ§Ãµes Formais</h3>
<p><strong>ConcorrÃªncia (Concurrency):</strong></p>
<blockquote>
<p>"A propriedade de um sistema onde mÃºltiplas tarefas podem estar em progresso ao mesmo tempo, mas nÃ£o necessariamente executando simultaneamente."</p>
</blockquote>
<p><strong>Paralelismo (Parallelism):</strong></p>
<blockquote>
<p>"A propriedade de um sistema onde mÃºltiplas tarefas executam simultaneamente, cada uma em seu prÃ³prio processador ou core."</p>
</blockquote>
<h3>2.2 Modelo TeÃ³rico: Processos e Threads</h3>
<p><strong>Processo:</strong>
- EspaÃ§o de endereÃ§amento isolado
- Recursos prÃ³prios (memÃ³ria, file descriptors)
- ComunicaÃ§Ã£o via IPC (Inter-Process Communication)</p>
<p><strong>Thread:</strong>
- Compartilha espaÃ§o de endereÃ§amento com outras threads do mesmo processo
- Stack prÃ³prio, heap compartilhado
- ComunicaÃ§Ã£o via memÃ³ria compartilhada</p>
<p><strong>No JavaScript (Browser):</strong>
- <strong>Main Thread:</strong> Executa JavaScript, renderiza UI
- <strong>Web Workers:</strong> Threads isoladas com memÃ³ria separada
- <strong>ComunicaÃ§Ã£o:</strong> Via <code>postMessage</code> (cÃ³pia de dados) ou <code>SharedArrayBuffer</code> (memÃ³ria compartilhada)</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias Completas:</strong>
- <strong><a href="https://nodejs.org/docs/latest/api/process.html">Process - Node.js</a></strong> - InformaÃ§Ãµes do processo Node.js
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">Threading - MDN</a></strong> - Threading no browser
- <strong><a href="https://nodejs.org/docs/latest/api/worker_threads.html">Worker Threads - Node.js</a></strong> - Threading no Node.js
- <strong><a href="https://nodejs.org/docs/latest/api/cluster.html">Cluster - Node.js</a></strong> - MÃºltiplos processos</p>
</blockquote>
<h3>2.3 AnÃ¡lise MatemÃ¡tica: Speedup e EficiÃªncia</h3>
<p><strong>Speedup (AceleraÃ§Ã£o):</strong></p>
<div class="codehilite"><pre><span></span><code>S(n) = T(1) / T(n)
</code></pre></div>

<p>Onde:
- <code>T(1)</code> = tempo com 1 processador
- <code>T(n)</code> = tempo com n processadores
- <code>S(n)</code> = speedup teÃ³rico</p>
<p><strong>Lei de Amdahl:</strong></p>
<div class="codehilite"><pre><span></span><code>S(n) = 1 / (f + (1-f)/n)
</code></pre></div>

<p>Onde:
- <code>f</code> = fraÃ§Ã£o sequencial do cÃ³digo
- <code>n</code> = nÃºmero de processadores</p>
<p><strong>Exemplo PrÃ¡tico:</strong>
Se 10% do cÃ³digo Ã© sequencial (<code>f = 0.1</code>):
- Com 4 processadores: <code>S(4) = 1 / (0.1 + 0.9/4) = 3.08x</code>
- Com 8 processadores: <code>S(8) = 1 / (0.1 + 0.9/8) = 4.71x</code>
- Limite teÃ³rico: <code>S(âˆ) = 10x</code> (nunca mais que 10x devido Ã  parte sequencial)</p>
<p><strong>No Projeto:</strong>
- Coleta de dados: ~95% paralelizÃ¡vel (<code>f = 0.05</code>)
- Speedup teÃ³rico com 4 workers: <code>S(4) â‰ˆ 3.48x</code>
- Na prÃ¡tica: ~2.5-3x devido a overhead de comunicaÃ§Ã£o</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias MDN e Node.js:</strong>
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Event_loop">Concurrency Model - MDN</a></strong> - Modelo de concorrÃªncia JavaScript
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">Web Workers - MDN</a></strong> - Paralelismo no browser
- <strong><a href="https://nodejs.org/docs/latest/api/worker_threads.html">Worker Threads - Node.js</a></strong> - Paralelismo no Node.js
- <strong><a href="https://nodejs.org/docs/latest/api/cluster.html">Cluster Module - Node.js</a></strong> - MÃºltiplos processos Node.js
- <strong><a href="https://nodejs.org/docs/latest/api/child_process.html">Child Process - Node.js</a></strong> - Processos filhos</p>
</blockquote>
<h3>2.4 Modelos de MemÃ³ria: Sequentially Consistent vs Relaxed</h3>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias:</strong>
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics#memory_ordering">Memory Model - MDN</a></strong> - Modelo de memÃ³ria JavaScript
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/wait">Atomics.wait() - MDN</a></strong> - SincronizaÃ§Ã£o de memÃ³ria</p>
</blockquote>
<p><strong>Sequential Consistency (SC):</strong></p>
<blockquote>
<p>"O resultado de qualquer execuÃ§Ã£o Ã© o mesmo que se as operaÃ§Ãµes de todas as threads fossem executadas em alguma ordem sequencial, e as operaÃ§Ãµes de cada thread aparecem nessa ordem."</p>
</blockquote>
<p><strong>Relaxed Memory Models:</strong>
- Permitem reordenaÃ§Ã£o de operaÃ§Ãµes para performance
- Requerem barreiras de memÃ³ria explÃ­citas
- Exemplo: x86-TSO, ARM</p>
<p><strong>JavaScript com SharedArrayBuffer:</strong>
- Implementa modelo <strong>sequentially consistent</strong> para operaÃ§Ãµes atÃ´micas
- <code>Atomics</code> API garante ordem de operaÃ§Ãµes
- Sem <code>Atomics</code>: comportamento indefinido (UB - Undefined Behavior)</p>
<h3>2.5 ExercÃ­cios PrÃ¡ticos</h3>
<h4>ExercÃ­cio 1: Calcular Speedup TeÃ³rico</h4>
<p><strong>Objetivo:</strong> Aplicar a Lei de Amdahl para calcular speedup.</p>
<p><strong>Tarefa:</strong> Se um algoritmo tem 20% de cÃ³digo sequencial (<code>f = 0.2</code>), calcule o speedup com 2, 4 e 8 processadores usando a fÃ³rmula de Amdahl.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente a funÃ§Ã£o calculateSpeedup</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">calculateSpeedup</span><span class="p">(</span><span class="nx">sequentialFraction</span><span class="p">,</span><span class="w"> </span><span class="nx">numProcessors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Lei de Amdahl: S(n) = 1 / (f + (1-f)/n)</span>
<span class="w">  </span><span class="c1">// Onde f = fraÃ§Ã£o sequencial, n = nÃºmero de processadores</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;2 processadores:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">calculateSpeedup</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;4 processadores:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">calculateSpeedup</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;8 processadores:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">calculateSpeedup</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">));</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">calculateSpeedup</span><span class="p">(</span><span class="nx">sequentialFraction</span><span class="p">,</span><span class="w"> </span><span class="nx">numProcessors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sequentialFraction</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">numProcessors</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">f</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;2 processadores:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">calculateSpeedup</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// 1.67x</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;4 processadores:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">calculateSpeedup</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// 2.50x</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;8 processadores:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">calculateSpeedup</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// 3.33x</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Limite teÃ³rico:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">calculateSpeedup</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="kc">Infinity</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// 5.00x</span>
</code></pre></div>



**FÃ³rmula:** `S(n) = 1 / (f + (1-f)/n)`

**ReferÃªncia:** [Lei de Amdahl - Wikipedia](https://en.wikipedia.org/wiki/Amdahl%27s_law)
</details>

<h4>ExercÃ­cio 2: Medir Speedup Real</h4>
<p><strong>Objetivo:</strong> Implementar cÃ³digo para medir speedup real entre execuÃ§Ã£o sequencial e paralela.</p>
<p><strong>Tarefa:</strong> Crie funÃ§Ãµes que processam um array de nÃºmeros (calcular quadrado) sequencialmente e em paralelo, medindo o tempo de execuÃ§Ã£o.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente processSequential e processParallel</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">);</span>

<span class="c1">// Sequencial</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">processSequential</span><span class="p">(</span><span class="nx">numbers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Implemente aqui</span>
<span class="p">}</span>

<span class="c1">// Paralelo (usando Promise.all para simular paralelismo)</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">processParallel</span><span class="p">(</span><span class="nx">numbers</span><span class="p">,</span><span class="w"> </span><span class="nx">chunkSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Implemente aqui</span>
<span class="p">}</span>

<span class="c1">// Teste e compare tempos</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="c1">// Processamento sequencial</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">processSequential</span><span class="p">(</span><span class="nx">numbers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">numbers</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">n</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Processamento paralelo (simulado com Promise.all)</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">processParallel</span><span class="p">(</span><span class="nx">numbers</span><span class="p">,</span><span class="w"> </span><span class="nx">chunkSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Divide em chunks</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numbers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">numbers</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Processa chunks em paralelo</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunkResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
<span class="w">    </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">chunk</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">n</span><span class="p">)))</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunkResults</span><span class="p">.</span><span class="nx">flat</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Teste</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">sequential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">processSequential</span><span class="p">(</span><span class="nx">numbers</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">parallel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">processParallel</span><span class="p">(</span><span class="nx">numbers</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">speedup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sequential</span><span class="p">.</span><span class="nx">time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">parallel</span><span class="p">.</span><span class="nx">time</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Tempo sequencial: </span><span class="si">${</span><span class="nx">sequential</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Tempo paralelo: </span><span class="si">${</span><span class="nx">parallel</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Speedup: </span><span class="si">${</span><span class="nx">speedup</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">x`</span><span class="p">);</span>
</code></pre></div>



**ReferÃªncia:** [performance.now() - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Performance/now)
</details>

<hr />
<p><a id="capÃ­tulo-3-programaÃ§Ã£o-funcional---fundamentaÃ§Ã£o-matemÃ¡tica"></a></p>
<h2>ğŸ“š CapÃ­tulo 3: ProgramaÃ§Ã£o Funcional - FundamentaÃ§Ã£o MatemÃ¡tica</h2>
<h3>ğŸ“– DefiniÃ§Ãµes de Conceitos</h3>
<p><strong>ProgramaÃ§Ã£o Funcional:</strong> Um paradigma de programaÃ§Ã£o que trata a computaÃ§Ã£o como avaliaÃ§Ã£o de funÃ§Ãµes matemÃ¡ticas, evitando mudanÃ§as de estado e dados mutÃ¡veis. Enfatiza funÃ§Ãµes puras, imutabilidade e composiÃ§Ã£o de funÃ§Ãµes.</p>
<p><strong>FunÃ§Ã£o Pura:</strong> Uma funÃ§Ã£o que sempre retorna o mesmo resultado para os mesmos argumentos e nÃ£o produz efeitos colaterais (side effects). FunÃ§Ãµes puras nÃ£o modificam variÃ¡veis globais, nÃ£o fazem I/O, nÃ£o modificam seus argumentos e nÃ£o dependem de estado externo mutÃ¡vel.</p>
<p><strong>Imutabilidade:</strong> A propriedade de um objeto ou estrutura de dados que nÃ£o pode ser modificada apÃ³s sua criaÃ§Ã£o. Em vez de modificar dados existentes, novas estruturas sÃ£o criadas com as mudanÃ§as desejadas. Isso previne bugs relacionados a estado compartilhado.</p>
<p><strong>Side Effect (Efeito Colateral):</strong> Qualquer mudanÃ§a no estado do sistema ou interaÃ§Ã£o com o mundo externo que ocorre durante a execuÃ§Ã£o de uma funÃ§Ã£o. Exemplos incluem modificar variÃ¡veis globais, fazer requisiÃ§Ãµes HTTP, escrever em arquivos ou modificar o DOM.</p>
<p><strong>Higher-Order Function (FunÃ§Ã£o de Ordem Superior):</strong> Uma funÃ§Ã£o que recebe outras funÃ§Ãµes como argumentos ou retorna uma funÃ§Ã£o como resultado. Exemplos incluem <code>map()</code>, <code>filter()</code>, <code>reduce()</code>, e <code>forEach()</code> em JavaScript.</p>
<p><strong>Closure:</strong> Uma funÃ§Ã£o que tem acesso a variÃ¡veis de seu escopo externo (lexical scope) mesmo apÃ³s a funÃ§Ã£o externa ter retornado. Closures permitem que funÃ§Ãµes "lembrem" do ambiente em que foram criadas.</p>
<p><strong>ComposiÃ§Ã£o de FunÃ§Ãµes:</strong> A combinaÃ§Ã£o de mÃºltiplas funÃ§Ãµes simples para criar funÃ§Ãµes mais complexas. Em JavaScript, a composiÃ§Ã£o pode ser feita manualmente ou usando bibliotecas como Ramda ou Lodash.</p>
<p><strong>Currying:</strong> A tÃ©cnica de transformar uma funÃ§Ã£o que recebe mÃºltiplos argumentos em uma sequÃªncia de funÃ§Ãµes que recebem um Ãºnico argumento cada. Exemplo: <code>f(a, b, c)</code> vira <code>f(a)(b)(c)</code>.</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias MDN:</strong>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array#instance_methods">Array Methods - MÃ©todos Funcionais</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map">Array.map() - TransformaÃ§Ã£o Funcional</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter">Array.filter() - Filtragem Funcional</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce">Array.reduce() - ReduÃ§Ã£o Funcional</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax">Spread Syntax - Operador Spread</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign() - CÃ³pia de Objetos</a></p>
</blockquote>
<h3>3.1 FundamentaÃ§Ã£o em Teoria de Categorias</h3>
<p>A programaÃ§Ã£o funcional tem suas raÃ­zes na <strong>Teoria de Categorias</strong> (Category Theory), desenvolvida por Saunders Mac Lane e Samuel Eilenberg na dÃ©cada de 1940.</p>
<p><strong>Conceitos Fundamentais:</strong></p>
<p><strong>1. FunÃ§Ã£o Pura (Pure Function):</strong>
Matematicamente, uma funÃ§Ã£o pura Ã© um mapeamento:</p>
<div class="codehilite"><pre><span></span><code><span class="n">f</span><span class="o">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">B</span>
</code></pre></div>

<p>Onde:
- Para cada <code>a âˆˆ A</code>, existe exatamente um <code>b âˆˆ B</code> tal que <code>f(a) = b</code>
- NÃ£o hÃ¡ dependÃªncia de estado externo
- NÃ£o hÃ¡ efeitos colaterais</p>
<p><strong>2. Imutabilidade e Ãlgebra:</strong>
Em Ã¡lgebra, operaÃ§Ãµes nÃ£o modificam valores, criam novos:</p>
<div class="codehilite"><pre><span></span><code>a + b = c  (nÃ£o modifica a nem b)
</code></pre></div>

<p>Em programaÃ§Ã£o funcional:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// âŒ MutaÃ§Ã£o (nÃ£o funcional)</span>
<span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span><span class="w"> </span><span class="c1">// modifica array</span>

<span class="c1">// âœ… Imutabilidade (funcional)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">newArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">array</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">];</span><span class="w"> </span><span class="c1">// cria novo array</span>
</code></pre></div>

<h3>3.2 Lambda Calculus e Computabilidade</h3>
<p><strong>Lambda Calculus (Î»-calculus):</strong>
Desenvolvido por Alonzo Church (1930s), Ã© equivalente em poder computacional Ã  MÃ¡quina de Turing.</p>
<p><strong>Sintaxe bÃ¡sica:</strong></p>
<div class="codehilite"><pre><span></span><code>Î»x. x + 1          // funÃ§Ã£o que adiciona 1
(Î»x. x + 1)(5)     // aplicaÃ§Ã£o: resultado = 6
</code></pre></div>

<p><strong>Em JavaScript:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Lambda calculus equivalente</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">addOne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="nx">addOne</span><span class="p">(</span><span class="mf">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// 6</span>
</code></pre></div>

<p><strong>Teorema de Church-Turing:</strong></p>
<blockquote>
<p>"Qualquer funÃ§Ã£o computÃ¡vel pode ser expressa em Î»-calculus ou em uma MÃ¡quina de Turing."</p>
<p><strong>ğŸ“š ReferÃªncias Adicionais MDN:</strong>
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">Arrow Functions - MDN</a></strong> - FunÃ§Ãµes lambda em JavaScript
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind">Function.prototype.bind() - MDN</a></strong> - Binding de contexto
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/flatMap">Array.flatMap() - MDN</a></strong> - Map + flat em uma operaÃ§Ã£o
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze">Object.freeze() - MDN</a></strong> - Congela objetos (imutabilidade)</p>
</blockquote>
<h3>3.3 AnÃ¡lise de Complexidade: Imutabilidade vs MutaÃ§Ã£o</h3>
<p><strong>OperaÃ§Ã£o: Adicionar elemento ao final de array</strong></p>
<p><strong>Abordagem MutÃ¡vel:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
</code></pre></div>

<ul>
<li>Complexidade: O(1) amortizado</li>
<li>EspaÃ§o: O(1) adicional</li>
<li>Problema: Efeitos colaterais, difÃ­cil rastrear mudanÃ§as</li>
</ul>
<p><strong>Abordagem ImutÃ¡vel:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">newArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">array</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">];</span>
</code></pre></div>

<ul>
<li>Complexidade: O(n) onde n = tamanho do array</li>
<li>EspaÃ§o: O(n) (cria novo array)</li>
<li>Vantagem: Rastreabilidade, thread-safety, debugging</li>
</ul>
<p><strong>Trade-off:</strong>
- Performance: MutaÃ§Ã£o Ã© mais rÃ¡pida
- SeguranÃ§a: Imutabilidade Ã© mais segura
- Escalabilidade: Imutabilidade escala melhor em sistemas distribuÃ­dos</p>
<p><strong>OtimizaÃ§Ã£o: Estruturas de Dados Persistentes</strong>
Para melhorar performance de operaÃ§Ãµes imutÃ¡veis, usamos estruturas como:
- <strong>Ãrvores B+</strong> para arrays imutÃ¡veis
- <strong>Tries</strong> para objetos imutÃ¡veis
- Exemplo: Immutable.js usa tries para O(log n) operaÃ§Ãµes</p>
<h3>3.4 ComposiÃ§Ã£o de FunÃ§Ãµes e Teoria de Categorias</h3>
<p><strong>ComposiÃ§Ã£o MatemÃ¡tica:</strong></p>
<div class="codehilite"><pre><span></span><code>(f âˆ˜ g)(x) = f(g(x))
</code></pre></div>

<p><strong>Em JavaScript:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">compose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">f</span><span class="p">(</span><span class="nx">g</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">addOne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">multiplyByTwo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">addOneThenDouble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">compose</span><span class="p">(</span><span class="nx">multiplyByTwo</span><span class="p">,</span><span class="w"> </span><span class="nx">addOne</span><span class="p">);</span>
<span class="nx">addOneThenDouble</span><span class="p">(</span><span class="mf">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// (5 + 1) * 2 = 12</span>
</code></pre></div>

<p><strong>No Projeto:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ComposiÃ§Ã£o de transformaÃ§Ãµes</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">processCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">compose</span><span class="p">(</span>
<span class="w">  </span><span class="nx">normalizePopulation</span><span class="p">,</span>
<span class="w">  </span><span class="nx">validateCoordinates</span><span class="p">,</span>
<span class="w">  </span><span class="nx">extractFields</span>
<span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">processedCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">processCity</span><span class="p">);</span>
</code></pre></div>

<p><strong>Teorema Fundamental:</strong></p>
<blockquote>
<p>"A composiÃ§Ã£o de funÃ§Ãµes puras Ã© sempre uma funÃ§Ã£o pura."</p>
</blockquote>
<h3>3.5 ExercÃ­cios PrÃ¡ticos</h3>
<h4>ExercÃ­cio 1: Converter CÃ³digo MutÃ¡vel para ImutÃ¡vel</h4>
<p><strong>Objetivo:</strong> Praticar transformaÃ§Ã£o de cÃ³digo mutÃ¡vel em cÃ³digo imutÃ¡vel.</p>
<p><strong>CÃ³digo Original (MutÃ¡vel):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">addCityToState</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="w">  </span><span class="nx">state</span><span class="p">.</span><span class="nx">totalCities</span><span class="o">++</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Tarefa:</strong> Converta para usar imutabilidade (nÃ£o modificar <code>state</code>, criar novo objeto).</p>
<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">addCityToState</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span>
<span class="w">    </span><span class="nx">selectedCities</span><span class="o">:</span><span class="w"> </span><span class="p">[...</span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">],</span>
<span class="w">    </span><span class="nx">totalCities</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">totalCities</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>



**ReferÃªncias:**
- [Spread Syntax - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax)
- [Object.assign() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign)
</details>

<h4>ExercÃ­cio 2: Implementar FunÃ§Ãµes Puras</h4>
<p><strong>Objetivo:</strong> Criar funÃ§Ãµes puras para manipulaÃ§Ã£o de arrays.</p>
<p><strong>Tarefa:</strong> Implemente as seguintes funÃ§Ãµes puras:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 1. Filtrar cidades por populaÃ§Ã£o mÃ­nima</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">filterByPopulation</span><span class="p">(</span><span class="nx">cities</span><span class="p">,</span><span class="w"> </span><span class="nx">minPopulation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Implemente aqui</span>
<span class="p">}</span>

<span class="c1">// 2. Mapear cidades para formato simplificado</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">mapToSimpleFormat</span><span class="p">(</span><span class="nx">cities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Retornar apenas: { id, name, population }</span>
<span class="p">}</span>

<span class="c1">// 3. Reduzir para calcular populaÃ§Ã£o total</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">calculateTotalPopulation</span><span class="p">(</span><span class="nx">cities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Implemente usando reduce</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="c1">// 1. Filtrar cidades por populaÃ§Ã£o mÃ­nima</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">filterByPopulation</span><span class="p">(</span><span class="nx">cities</span><span class="p">,</span><span class="w"> </span><span class="nx">minPopulation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">minPopulation</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 2. Mapear cidades para formato simplificado</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">mapToSimpleFormat</span><span class="p">(</span><span class="nx">cities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<span class="w">    </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span>
<span class="w">  </span><span class="p">}));</span>
<span class="p">}</span>

<span class="c1">// 3. Reduzir para calcular populaÃ§Ã£o total</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">calculateTotalPopulation</span><span class="p">(</span><span class="nx">cities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Uso combinado (composiÃ§Ã£o)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calculateTotalPopulation</span><span class="p">(</span>
<span class="w">  </span><span class="nx">mapToSimpleFormat</span><span class="p">(</span>
<span class="w">    </span><span class="nx">filterByPopulation</span><span class="p">(</span><span class="nx">cities</span><span class="p">,</span><span class="w"> </span><span class="mf">1000000</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>



**ReferÃªncias:**
- [Array.filter() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter)
- [Array.map() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map)
- [Array.reduce() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce)
</details>

<h4>ExercÃ­cio 3: ComposiÃ§Ã£o de FunÃ§Ãµes</h4>
<p><strong>Objetivo:</strong> Criar funÃ§Ã£o de composiÃ§Ã£o e aplicÃ¡-la.</p>
<p><strong>Tarefa:</strong> Implemente uma funÃ§Ã£o <code>compose</code> que combina mÃºltiplas funÃ§Ãµes e use para processar cidades.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente compose</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">compose</span><span class="p">(...</span><span class="nx">fns</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Implemente aqui</span>
<span class="p">}</span>

<span class="c1">// FunÃ§Ãµes auxiliares</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">normalize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">addMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">processed</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">validate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="c1">// Use compose para criar funÃ§Ã£o de processamento</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">processCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">compose</span><span class="p">(</span><span class="nx">validate</span><span class="p">,</span><span class="w"> </span><span class="nx">addMetadata</span><span class="p">,</span><span class="w"> </span><span class="nx">normalize</span><span class="p">);</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="c1">// ComposiÃ§Ã£o da direita para esquerda</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">compose</span><span class="p">(...</span><span class="nx">fns</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">fns</span><span class="p">.</span><span class="nx">reduceRight</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span><span class="w"> </span><span class="nx">fn</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">fn</span><span class="p">(</span><span class="nx">acc</span><span class="p">),</span><span class="w"> </span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// FunÃ§Ãµes auxiliares</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">normalize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">addMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">processed</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">validate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="c1">// ComposiÃ§Ã£o: validate(addMetadata(normalize(city)))</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">processCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">compose</span><span class="p">(</span><span class="nx">validate</span><span class="p">,</span><span class="w"> </span><span class="nx">addMetadata</span><span class="p">,</span><span class="w"> </span><span class="nx">normalize</span><span class="p">);</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SÃ£o Paulo&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">12000000</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Rio de Janeiro&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">6000000</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;BrasÃ­lia&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">}</span>
<span class="p">];</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">processed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">processCity</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">processed</span><span class="p">);</span>
<span class="c1">// [</span>
<span class="c1">//   { id: 1, name: &#39;SÃƒO PAULO&#39;, population: 12000000, processed: true },</span>
<span class="c1">//   { id: 2, name: &#39;RIO DE JANEIRO&#39;, population: 6000000, processed: true }</span>
<span class="c1">// ]</span>
</code></pre></div>



**ReferÃªncia:** [Function Composition - Wikipedia](https://en.wikipedia.org/wiki/Function_composition)
</details>

<hr />
<p><a id="capÃ­tulo-4-memÃ³ria-compartilhada-e-sincronizaÃ§Ã£o---teoria-de-sistemas-distribuÃ­dos"></a></p>
<h2>ğŸ“š CapÃ­tulo 4: MemÃ³ria Compartilhada e SincronizaÃ§Ã£o - Teoria de Sistemas DistribuÃ­dos</h2>
<h3>ğŸ“– DefiniÃ§Ãµes de Conceitos</h3>
<p><strong>SharedArrayBuffer:</strong> Um objeto JavaScript que representa um buffer de memÃ³ria compartilhada de tamanho fixo, que pode ser acessado simultaneamente por mÃºltiplos threads (Web Workers ou Worker Threads). Diferente de ArrayBuffer normal, SharedArrayBuffer permite acesso concorrente de mÃºltiplos workers.</p>
<p><strong>Atomics:</strong> Um objeto JavaScript que fornece operaÃ§Ãµes atÃ´micas como mÃ©todos estÃ¡ticos para trabalhar com SharedArrayBuffer. OperaÃ§Ãµes atÃ´micas garantem que leituras e escritas sejam completadas antes que outras operaÃ§Ãµes possam acessar a mesma localizaÃ§Ã£o de memÃ³ria, prevenindo race conditions.</p>
<p><strong>Race Condition:</strong> Uma condiÃ§Ã£o onde o comportamento de um sistema depende da ordem relativa de execuÃ§Ã£o de mÃºltiplos threads ou processos. Race conditions ocorrem quando mÃºltiplos threads acessam dados compartilhados sem sincronizaÃ§Ã£o adequada.</p>
<p><strong>CAS (Compare-And-Swap):</strong> Uma operaÃ§Ã£o atÃ´mica que compara o valor em uma localizaÃ§Ã£o de memÃ³ria com um valor esperado e, se forem iguais, atualiza a localizaÃ§Ã£o com um novo valor. CAS Ã© fundamental para implementar algoritmos lock-free.</p>
<p><strong>Lock-Free Algorithm:</strong> Um algoritmo que permite que mÃºltiplos threads acessem e modifiquem estruturas de dados compartilhadas sem usar locks (travas). Lock-free algorithms usam operaÃ§Ãµes atÃ´micas como CAS para garantir consistÃªncia sem bloquear threads.</p>
<p><strong>Memory Barrier (Barreira de MemÃ³ria):</strong> Uma instruÃ§Ã£o que forÃ§a operaÃ§Ãµes de memÃ³ria antes da barreira a serem completadas antes que operaÃ§Ãµes apÃ³s a barreira possam ser executadas. Garante ordem de execuÃ§Ã£o em arquiteturas com memÃ³ria relaxada.</p>
<p><strong>TypedArray:</strong> Uma visÃ£o (view) de um ArrayBuffer que permite acesso tipado aos dados binÃ¡rios. Exemplos incluem Int32Array, Uint8Array, Float64Array. TypedArrays sÃ£o necessÃ¡rios para trabalhar com SharedArrayBuffer.</p>
<p><strong>DataView:</strong> Uma interface JavaScript que fornece uma visÃ£o de baixo nÃ­vel de um ArrayBuffer, permitindo leitura e escrita de dados de diferentes tipos (inteiros, floats) em qualquer offset, com controle sobre endianness (little-endian ou big-endian).</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias MDN Completas:</strong>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer">SharedArrayBuffer - DocumentaÃ§Ã£o Completa</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics">Atomics - API Completa de OperaÃ§Ãµes AtÃ´micas</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer#security_requirements">SharedArrayBuffer - Requisitos de SeguranÃ§a</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">TypedArray - Arrays Tipados</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Int32Array">Int32Array - Array de 32 bits Inteiros</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array">Uint8Array - Array de 8 bits Unsigned</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView">DataView - View BinÃ¡ria de Dados</a></p>
</blockquote>
<h3>4.1 Contexto HistÃ³rico: MemÃ³ria Compartilhada vs Mensagens</h3>
<p><strong>Modelo de MemÃ³ria Compartilhada (Shared Memory):</strong>
Desenvolvido nos sistemas multiprocessadores dos anos 1980-1990.</p>
<p><strong>Vantagens:</strong>
- ComunicaÃ§Ã£o eficiente (sem serializaÃ§Ã£o)
- ProgramaÃ§Ã£o mais intuitiva (variÃ¡veis compartilhadas)
- Performance superior para dados grandes</p>
<p><strong>Desvantagens:</strong>
- Complexidade de sincronizaÃ§Ã£o
- Race conditions
- Deadlocks possÃ­veis</p>
<p><strong>Modelo de Passagem de Mensagens (Message Passing):</strong>
Desenvolvido em sistemas distribuÃ­dos (Erlang, 1986).</p>
<p><strong>Vantagens:</strong>
- Isolamento de processos
- Mais fÃ¡cil de raciocinar
- Escalabilidade horizontal</p>
<p><strong>Desvantagens:</strong>
- Overhead de serializaÃ§Ã£o
- LatÃªncia de comunicaÃ§Ã£o
- Complexidade de coordenaÃ§Ã£o</p>
<h3>4.2 SharedArrayBuffer: AnÃ¡lise TÃ©cnica Profunda</h3>
<p><strong>Arquitetura de MemÃ³ria:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Main</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="p">(</span><span class="n">JavaScript</span><span class="p">)</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">SharedArrayBuffer</span><span class="w"> </span><span class="p">(</span><span class="n">referÃªncia</span><span class="p">)</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">           </span><span class="err">â”‚</span>
<span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="n">compartilhado</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">referÃªncia</span>
<span class="w">           </span><span class="err">â–¼</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Worker</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">1</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Mesmo</span><span class="w"> </span><span class="n">SharedArrayBuffer</span><span class="w">          </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="p">(</span><span class="n">mesma</span><span class="w"> </span><span class="n">regiÃ£o</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">memÃ³ria</span><span class="w"> </span><span class="n">fÃ­sica</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">           </span><span class="err">â”‚</span>
<span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="n">mesma</span><span class="w"> </span><span class="n">memÃ³ria</span><span class="w"> </span><span class="n">fÃ­sica</span>
<span class="w">           </span><span class="err">â–¼</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">     </span><span class="n">Worker</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">2</span><span class="w">                     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Mesmo</span><span class="w"> </span><span class="n">SharedArrayBuffer</span><span class="w">          </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<p><strong>AnÃ¡lise de Performance:</strong></p>
<p><strong>Com postMessage (cÃ³pia):</strong></p>
<div class="codehilite"><pre><span></span><code>Tempo = T(serializaÃ§Ã£o) + T(cÃ³pia) + T(desserializaÃ§Ã£o)
      = O(n) onde n = tamanho dos dados
EspaÃ§o = 2n (original + cÃ³pia)
</code></pre></div>

<p><strong>Com SharedArrayBuffer:</strong></p>
<div class="codehilite"><pre><span></span><code>Tempo = T(escrita_atÃ´mica) = O(1) amortizado
EspaÃ§o = n (apenas uma cÃ³pia)
</code></pre></div>

<p><strong>Ganho:</strong> Para 10.000 cidades (~2MB):
- postMessage: ~5-10ms por transferÃªncia + 4MB de memÃ³ria
- SharedArrayBuffer: ~0.001ms por escrita + 2MB de memÃ³ria</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias Adicionais Node.js:</strong>
- <strong><a href="https://nodejs.org/docs/latest/api/buffer.html">Buffer - Node.js</a></strong> - ManipulaÃ§Ã£o de buffers binÃ¡rios
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer - MDN</a></strong> - Buffer de dados binÃ¡rios
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/from">TypedArray.from() - MDN</a></strong> - CriaÃ§Ã£o de TypedArrays
- <strong>Speedup:</strong> ~1000-10000x em operaÃ§Ãµes de escrita</p>
</blockquote>
<h3>4.3 Atomics API: FundamentaÃ§Ã£o em Hardware</h3>
<p><strong>OperaÃ§Ãµes AtÃ´micas no Hardware:</strong></p>
<p>Processadores modernos implementam operaÃ§Ãµes atÃ´micas via:
1. <strong>Lock prefix</strong> (x86): Garante exclusÃ£o durante instruÃ§Ã£o
2. <strong>LL/SC</strong> (Load-Link/Store-Conditional): ARM, RISC-V
3. <strong>Cache Coherence Protocol:</strong> MESI (Modified, Exclusive, Shared, Invalid)</p>
<p><strong>Compare-and-Swap (CAS) - ImplementaÃ§Ã£o Hardware:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">;</span><span class="w"> </span><span class="n">PseudocÃ³digo</span><span class="w"> </span><span class="n">assembly</span><span class="w"> </span><span class="n">x86</span>
<span class="nl">CAS</span><span class="p">:</span>
<span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">expected_value</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">Carrega</span><span class="w"> </span><span class="n">valor</span><span class="w"> </span><span class="n">esperado</span>
<span class="w">  </span><span class="n">lock</span><span class="w"> </span><span class="n">cmpxchg</span><span class="w"> </span><span class="o">[</span><span class="n">memory</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">new_value</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">Compara</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">troca</span><span class="w"> </span><span class="n">atÃ´mica</span>
<span class="w">  </span><span class="n">jz</span><span class="w"> </span><span class="n">success</span><span class="w">                 </span><span class="p">;</span><span class="w"> </span><span class="n">Se</span><span class="w"> </span><span class="n">igual</span><span class="p">,</span><span class="w"> </span><span class="n">sucesso</span>
<span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">memory</span><span class="o">]</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">SenÃ£o</span><span class="p">,</span><span class="w"> </span><span class="n">retorna</span><span class="w"> </span><span class="n">valor</span><span class="w"> </span><span class="n">atual</span>
<span class="w">  </span><span class="n">ret</span>
</code></pre></div>

<p><strong>Em JavaScript:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Equivalente ao cÃ³digo assembly acima</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">newValue</span><span class="p">);</span>
</code></pre></div>

<p><strong>AnÃ¡lise de Complexidade:</strong>
- <strong>Tempo:</strong> O(1) - operaÃ§Ã£o hardware Ãºnica
- <strong>EspaÃ§o:</strong> O(1) - nÃ£o aloca memÃ³ria adicional
- <strong>ContenÃ§Ã£o:</strong> Em alta contenÃ§Ã£o, pode haver retries (loop CAS)</p>
<h3>4.4 Algoritmo de Escrita Controlada: AnÃ¡lise Formal</h3>
<blockquote>
<p><strong>ğŸ“š DocumentaÃ§Ã£o Oficial - Atomics API:</strong>
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/compareExchange">Atomics.compareExchange() - MDN</a></strong> - OperaÃ§Ã£o Compare-and-Swap
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/load">Atomics.load() - MDN</a></strong> - Leitura atÃ´mica
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/store">Atomics.store() - MDN</a></strong> - Escrita atÃ´mica
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/add">Atomics.add() - MDN</a></strong> - AdiÃ§Ã£o atÃ´mica
- <strong><a href="https://nodejs.org/docs/latest/api/worker_threads.html#atomics">Atomics - Node.js</a></strong> - Atomics no Node.js Worker Threads</p>
</blockquote>
<p><strong>Problema:</strong> MÃºltiplos workers escrevendo no mesmo buffer compartilhado.</p>
<p><strong>SoluÃ§Ã£o: Lock-Free Algorithm usando CAS</strong></p>
<p><strong>PseudocÃ³digo Formal:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">funÃ§Ã£o</span><span class="w"> </span><span class="n">escrever_cidade</span><span class="p">(</span><span class="n">cidade</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="err">Ã­</span><span class="n">ndice_atÃ´mico</span><span class="p">):</span>
<span class="w">  </span><span class="n">tamanho</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calcular_tamanho</span><span class="p">(</span><span class="n">cidade</span><span class="p">)</span>

<span class="w">  </span><span class="n">enquanto</span><span class="w"> </span><span class="n">verdadeiro</span><span class="p">:</span>
<span class="w">    </span><span class="err">Ã­</span><span class="n">ndice_atual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carregar_atÃ´mico</span><span class="p">(</span><span class="err">Ã­</span><span class="n">ndice_atÃ´mico</span><span class="p">)</span>
<span class="w">    </span><span class="n">novo_Ã­ndice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">Ã­</span><span class="n">ndice_atual</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tamanho</span>

<span class="w">    </span><span class="n">se</span><span class="w"> </span><span class="n">novo_Ã­ndice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tamanho_buffer</span><span class="p">:</span>
<span class="w">      </span><span class="n">retornar</span><span class="w"> </span><span class="n">ERRO_BUFFER_CHEIO</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Tenta</span><span class="w"> </span><span class="n">reservar</span><span class="w"> </span><span class="n">espaÃ§o</span><span class="w"> </span><span class="n">atomicamente</span>
<span class="w">    </span><span class="err">Ã­</span><span class="n">ndice_reservado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CAS</span><span class="p">(</span><span class="err">Ã­</span><span class="n">ndice_atÃ´mico</span><span class="p">,</span><span class="w"> </span><span class="err">Ã­</span><span class="n">ndice_atual</span><span class="p">,</span><span class="w"> </span><span class="n">novo_Ã­ndice</span><span class="p">)</span>

<span class="w">    </span><span class="n">se</span><span class="w"> </span><span class="err">Ã­</span><span class="n">ndice_reservado</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">Ã­</span><span class="n">ndice_atual</span><span class="p">:</span>
<span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="n">Sucesso</span><span class="p">:</span><span class="w"> </span><span class="n">espaÃ§o</span><span class="w"> </span><span class="n">reservado</span>
<span class="w">      </span><span class="n">escrever_dados</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="err">Ã­</span><span class="n">ndice_atual</span><span class="p">,</span><span class="w"> </span><span class="n">cidade</span><span class="p">)</span>
<span class="w">      </span><span class="n">retornar</span><span class="w"> </span><span class="n">SUCESSO</span>
<span class="w">    </span><span class="n">senÃ£o</span><span class="p">:</span>
<span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="n">Falhou</span><span class="p">:</span><span class="w"> </span><span class="n">outro</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="n">escreveu</span><span class="w"> </span><span class="n">primeiro</span>
<span class="w">      </span><span class="n">continuar</span><span class="w"> </span><span class="n">loop</span>
</code></pre></div>

<p><strong>AnÃ¡lise de CorreÃ§Ã£o:</strong></p>
<p><strong>Invariante:</strong> <code>Ã­ndice_atÃ´mico</code> sempre aponta para prÃ³ximo espaÃ§o livre vÃ¡lido.</p>
<p><strong>Prova por InduÃ§Ã£o:</strong>
1. <strong>Base:</strong> Inicialmente, <code>Ã­ndice_atÃ´mico = headerSize</code> (vÃ¡lido)
2. <strong>InduÃ§Ã£o:</strong> Se <code>Ã­ndice_atÃ´mico</code> Ã© vÃ¡lido antes de CAS, apÃ³s CAS bem-sucedido, <code>novo_Ã­ndice</code> Ã© vÃ¡lido
3. <strong>ConclusÃ£o:</strong> Invariante mantido em todas as execuÃ§Ãµes</p>
<p><strong>AnÃ¡lise de Liveness:</strong></p>
<p><strong>PossÃ­vel Deadlock?</strong> NÃ£o - algoritmo Ã© lock-free (nÃ£o usa locks).</p>
<p><strong>PossÃ­vel Starvation?</strong> Teoricamente possÃ­vel se um worker sempre perde o CAS, mas na prÃ¡tica raro devido a:
- DistribuiÃ§Ã£o aleatÃ³ria de timing
- Backoff exponencial (nÃ£o implementado, mas possÃ­vel)</p>
<p><strong>AnÃ¡lise de Performance:</strong></p>
<p><strong>CenÃ¡rio Ideal (sem contenÃ§Ã£o):</strong>
- 1 CAS por escrita
- O(1) tempo</p>
<p><strong>CenÃ¡rio com ContenÃ§Ã£o:</strong>
- MÃºltiplos CAS retries
- O(k) onde k = nÃºmero de retries
- Na prÃ¡tica: k â‰ˆ 1-3 para baixa contenÃ§Ã£o</p>
<h3>4.5 ExercÃ­cios PrÃ¡ticos</h3>
<h4>ExercÃ­cio 1: Implementar Contador AtÃ´mico</h4>
<p><strong>Objetivo:</strong> Criar um contador thread-safe usando Atomics.</p>
<p><strong>Tarefa:</strong> Implemente uma classe <code>AtomicCounter</code> que permite incrementar/decrementar de forma thread-safe.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente AtomicCounter</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">AtomicCounter</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">initialValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Crie SharedArrayBuffer e Int32Array</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Incremente atomicamente</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">decrement</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Decremente atomicamente</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Retorne valor atual</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">AtomicCounter</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">initialValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Cria buffer compartilhado de 4 bytes (1 Int32)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="p">(</span><span class="mf">4</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">initialValue</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">decrement</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">compareAndSet</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">update</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">update</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AtomicCounter</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="nx">counter</span><span class="p">.</span><span class="nx">increment</span><span class="p">();</span><span class="w"> </span><span class="c1">// 1</span>
<span class="nx">counter</span><span class="p">.</span><span class="nx">increment</span><span class="p">();</span><span class="w"> </span><span class="c1">// 2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">counter</span><span class="p">.</span><span class="nx">getValue</span><span class="p">());</span><span class="w"> </span><span class="c1">// 2</span>
</code></pre></div>



**ReferÃªncias:**
- [Atomics.add() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/add)
- [Atomics.sub() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/sub)
- [Atomics.load() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/load)
</details>

<h4>ExercÃ­cio 2: Implementar Escrita Thread-Safe em Buffer</h4>
<p><strong>Objetivo:</strong> Implementar algoritmo de escrita controlada usando CAS.</p>
<p><strong>Tarefa:</strong> Crie funÃ§Ã£o <code>writeToBuffer</code> que escreve dados em buffer compartilhado de forma thread-safe.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente writeToBuffer</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">writeToBuffer</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">atomicIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 1. Serialize data para JSON</span>
<span class="w">  </span><span class="c1">// 2. Calcule tamanho necessÃ¡rio</span>
<span class="w">  </span><span class="c1">// 3. Use CAS loop para reservar espaÃ§o</span>
<span class="w">  </span><span class="c1">// 4. Escreva dados no espaÃ§o reservado</span>
<span class="w">  </span><span class="c1">// 5. Retorne true se sucesso, false se buffer cheio</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">writeToBuffer</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">atomicIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Serializa dados</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">encoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="c1">// 4 bytes (tamanho) + dados</span>

<span class="w">  </span><span class="c1">// View atÃ´mica do Ã­ndice</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">indexView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Loop CAS</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">attempts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxAttempts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// LÃª Ã­ndice atual</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">indexView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">dataSize</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Verifica espaÃ§o</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">maxSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Buffer cheio</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Tenta reservar espaÃ§o</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span>
<span class="w">      </span><span class="nx">indexView</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="nx">currentIndex</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="nx">newIndex</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">currentIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Sucesso: escreve dados</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dataView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">currentIndex</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="w">      </span><span class="nx">dataView</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// Little-endian</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">uint8View</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">currentIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">      </span><span class="nx">uint8View</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">bytes</span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// CAS falhou, tenta novamente</span>
<span class="w">    </span><span class="nx">attempts</span><span class="o">++</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Muitas tentativas</span>
<span class="p">}</span>
</code></pre></div>



**ReferÃªncias:**
- [Atomics.compareExchange() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/compareExchange)
- [DataView - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView)
- [TextEncoder - MDN](https://developer.mozilla.org/en-US/docs/Web/API/TextEncoder)
</details>

<hr />
<p><a id="capÃ­tulo-5-algoritmo-de-divisÃ£o-e-conquista---anÃ¡lise-de-algoritmos"></a></p>
<h2>ğŸ“š CapÃ­tulo 5: Algoritmo de DivisÃ£o e Conquista - AnÃ¡lise de Algoritmos</h2>
<h3>ğŸ“– DefiniÃ§Ãµes de Conceitos</h3>
<p><strong>Divide-and-Conquer (DivisÃ£o e Conquista):</strong> Um paradigma algorÃ­tmico que resolve problemas dividindo-os em subproblemas menores do mesmo tipo, resolvendo recursivamente os subproblemas e combinando as soluÃ§Ãµes para resolver o problema original. Exemplos clÃ¡ssicos incluem Merge Sort, Quick Sort e Binary Search.</p>
<p><strong>RecursÃ£o:</strong> Uma tÃ©cnica de programaÃ§Ã£o onde uma funÃ§Ã£o chama a si mesma para resolver um problema menor. RecursÃ£o Ã© fundamental para algoritmos divide-and-conquer, onde cada chamada recursiva resolve um subproblema.</p>
<p><strong>Base Case (Caso Base):</strong> A condiÃ§Ã£o que termina a recursÃ£o em um algoritmo recursivo. O caso base resolve o problema diretamente sem fazer chamadas recursivas adicionais. Sem um caso base bem definido, a recursÃ£o continuaria infinitamente.</p>
<p><strong>Master Theorem (Teorema Mestre):</strong> Um teorema que fornece uma soluÃ§Ã£o assintÃ³tica para recorrÃªncias da forma T(n) = aT(n/b) + f(n), onde a â‰¥ 1, b &gt; 1 sÃ£o constantes e f(n) Ã© uma funÃ§Ã£o assintoticamente positiva. Permite determinar a complexidade de algoritmos divide-and-conquer sem resolver a recorrÃªncia completamente.</p>
<p><strong>Work (Trabalho Total):</strong> A quantidade total de trabalho computacional realizado por um algoritmo paralelo, independentemente de quantos processadores sÃ£o usados. Work = soma de todas as operaÃ§Ãµes executadas por todos os processadores.</p>
<p><strong>Span (Caminho CrÃ­tico):</strong> O comprimento do caminho mais longo de dependÃªncias em um algoritmo paralelo, representando o tempo mÃ­nimo necessÃ¡rio mesmo com infinitos processadores. Span determina o limite superior do speedup possÃ­vel.</p>
<p><strong>Load Balancing (Balanceamento de Carga):</strong> A distribuiÃ§Ã£o uniforme de trabalho entre mÃºltiplos processadores ou workers para maximizar a utilizaÃ§Ã£o de recursos e minimizar o tempo total de execuÃ§Ã£o. Um bom balanceamento de carga Ã© essencial para eficiÃªncia paralela.</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias AcadÃªmicas:</strong>
- <a href="https://en.wikipedia.org/wiki/Divide-and-conquer_algorithm">Divide and Conquer Algorithms - Wikipedia</a>
- <a href="https://en.wikipedia.org/wiki/Master_theorem_(analysis_of_algorithms)">Master Theorem - Wikipedia</a>
- <a href="https://mitpress.mit.edu/9780262046305/introduction-to-algorithms/">Introduction to Algorithms (Cormen et al.)</a> - CapÃ­tulo 4</p>
</blockquote>
<h3>5.1 Paradigma Divide-and-Conquer: FundamentaÃ§Ã£o TeÃ³rica</h3>
<p>O paradigma <strong>Divide-and-Conquer</strong> foi formalizado por John von Neumann em 1945 e popularizado por algoritmos clÃ¡ssicos como Merge Sort (1945) e Quick Sort (1960).</p>
<p><strong>Estrutura Formal:</strong></p>
<div class="codehilite"><pre><span></span><code>funÃ§Ã£o divide_and_conquer(problema):
  se problema Ã© pequeno:
    resolver diretamente
  senÃ£o:
    dividir problema em subproblemas
    para cada subproblema:
      resultado = divide_and_conquer(subproblema)
    combinar resultados
    retornar resultado combinado
</code></pre></div>

<h3>5.2 AnÃ¡lise de Complexidade: Teorema Mestre</h3>
<p><strong>Teorema 5.1 (Master Theorem - Teorema Mestre):</strong></p>
<p>Seja <code>a â‰¥ 1</code> e <code>b &gt; 1</code> constantes, seja <code>f(n)</code> uma funÃ§Ã£o assintoticamente positiva, e seja <code>T(n)</code> definida pela recorrÃªncia:</p>
<div class="codehilite"><pre><span></span><code>T(n) = aT(n/b) + f(n)
</code></pre></div>

<p>Onde <code>n/b</code> Ã© interpretado como <code>âŒŠn/bâŒ‹</code> ou <code>âŒˆn/bâŒ‰</code>. EntÃ£o <code>T(n)</code> tem os seguintes limites assintÃ³ticos:</p>
<p><strong>Caso 1:</strong> Se <code>f(n) = O(n^(log_b a - Îµ))</code> para alguma constante <code>Îµ &gt; 0</code>, entÃ£o:</p>
<div class="codehilite"><pre><span></span><code>T(n) = Î˜(n^(log_b a))
</code></pre></div>

<p><strong>Caso 2:</strong> Se <code>f(n) = Î˜(n^(log_b a))</code>, entÃ£o:</p>
<div class="codehilite"><pre><span></span><code>T(n) = Î˜(n^(log_b a) Ã— lg n)
</code></pre></div>

<p><strong>Caso 3:</strong> Se <code>f(n) = Î©(n^(log_b a + Îµ))</code> para alguma constante <code>Îµ &gt; 0</code>, e se <code>af(n/b) â‰¤ cf(n)</code> para alguma constante <code>c &lt; 1</code> e todo <code>n</code> suficientemente grande, entÃ£o:</p>
<div class="codehilite"><pre><span></span><code>T(n) = Î˜(f(n))
</code></pre></div>

<p><strong>Prova (EsboÃ§o):</strong></p>
<p>A prova completa requer anÃ¡lise da Ã¡rvore de recursÃ£o. A ideia central Ã©:</p>
<ol>
<li><strong>Caso 1:</strong> O custo de dividir/combinar (<code>f(n)</code>) Ã© dominado pelo trabalho nas folhas (<code>n^(log_b a)</code>)</li>
<li><strong>Caso 2:</strong> O custo Ã© balanceado em todos os nÃ­veis</li>
<li><strong>Caso 3:</strong> O custo de dividir/combinar domina o trabalho nas folhas</li>
</ol>
<p><strong>Lema 5.1: Altura da Ãrvore de RecursÃ£o</strong></p>
<p>Para recorrÃªncia <code>T(n) = aT(n/b) + f(n)</code>, a altura da Ã¡rvore de recursÃ£o Ã©:</p>
<div class="codehilite"><pre><span></span><code>h = log_b n
</code></pre></div>

<p><strong>Prova:</strong></p>
<p>A cada nÃ­vel, o tamanho do problema Ã© reduzido por um fator <code>b</code>. ApÃ³s <code>h</code> nÃ­veis:</p>
<div class="codehilite"><pre><span></span><code>n / b^h = 1
</code></pre></div>

<p>Resolvendo: <code>h = log_b n</code>.</p>
<p><strong>Lema 5.2: NÃºmero de Folhas</strong></p>
<p>O nÃºmero de folhas na Ã¡rvore de recursÃ£o Ã©:</p>
<div class="codehilite"><pre><span></span><code>L = a^(log_b n) = n^(log_b a)
</code></pre></div>

<p><strong>Prova:</strong></p>
<p>A cada nÃ­vel, o nÃºmero de subproblemas Ã© multiplicado por <code>a</code>. Com altura <code>h = log_b n</code>:</p>
<div class="codehilite"><pre><span></span><code>L = a^h = a^(log_b n) = n^(log_b a)
</code></pre></div>

<p><strong>AplicaÃ§Ã£o no Projeto:</strong></p>
<p>Para coleta de dados paralela:</p>
<div class="codehilite"><pre><span></span><code>T(n) = pT(n/p) + O(1)
</code></pre></div>

<p>Onde:
- <code>a = p</code>
- <code>b = p</code>
- <code>f(n) = O(1)</code></p>
<p>Aplicando Master Theorem:</p>
<div class="codehilite"><pre><span></span><code>log_p p = 1
f(n) = O(1) = O(n^0) &lt; O(n^1)
</code></pre></div>

<p>Estamos no <strong>Caso 1</strong> com <code>Îµ = 1</code>:</p>
<div class="codehilite"><pre><span></span><code>T(n) = Î˜(n^(log_p p)) = Î˜(n)
</code></pre></div>

<p><strong>InterpretaÃ§Ã£o:</strong> Tempo linear, mas com constante menor devido ao paralelismo.</p>
<p><strong>Teorema 5.2: Speedup Real com Overhead</strong></p>
<p>Seja <code>T_seq(n) = n Ã— t</code> o tempo sequencial e <code>T_par(n, p) = (n/p) Ã— t + O(n)</code> o tempo paralelo com overhead <code>O(n)</code>, entÃ£o:</p>
<div class="codehilite"><pre><span></span><code>S(p) = T_seq(n) / T_par(n, p) = (n Ã— t) / ((n/p) Ã— t + c Ã— n)
</code></pre></div>

<p>Para <code>n &gt;&gt; c</code>:</p>
<div class="codehilite"><pre><span></span><code>S(p) â‰ˆ p / (1 + c Ã— p / t)
</code></pre></div>

<p><strong>Prova:</strong></p>
<div class="codehilite"><pre><span></span><code>S(p) = (n Ã— t) / ((n/p) Ã— t + c Ã— n)
     = (n Ã— t) / (n Ã— (t/p + c))
     = t / (t/p + c)
     = p Ã— t / (t + c Ã— p)
</code></pre></div>

<p>Para <code>t &gt;&gt; c Ã— p</code>, temos <code>S(p) â‰ˆ p</code>.</p>
<p><strong>Speedup Real:</strong></p>
<div class="codehilite"><pre><span></span><code>Speedup = T_sequencial / T_paralelo
        = (n Ã— t) / ((n/p) Ã— t + overhead)
        = p / (1 + overhead/(nÃ—t/p))
</code></pre></div>

<p>Para <code>n &gt;&gt; overhead</code>: <code>Speedup â‰ˆ p</code> (speedup linear ideal)</p>
<p><strong>No Projeto - Coleta de Dados:</strong></p>
<div class="codehilite"><pre><span></span><code>T(n) = pT(n/p) + O(1)
</code></pre></div>

<p>Onde:
- <code>n</code> = nÃºmero de pÃ¡ginas
- <code>p</code> = nÃºmero de workers (processadores)</p>
<p><strong>Aplicando Teorema Mestre:</strong>
- <code>a = p</code>, <code>b = p</code>, <code>f(n) = O(1)</code>
- <code>log_p(p) = 1</code>
- <code>f(n) = O(1) = O(n^0) &lt; O(n^1)</code>
- <strong>Caso 1:</strong> <code>T(n) = Î˜(n)</code></p>
<p><strong>InterpretaÃ§Ã£o:</strong> Tempo linear, mas com constante menor devido ao paralelismo.</p>
<p><strong>Speedup Real:</strong></p>
<div class="codehilite"><pre><span></span><code>Speedup = T_sequencial / T_paralelo
        = (n Ã— t) / ((n/p) Ã— t + overhead)
        = p / (1 + overhead/(nÃ—t/p))
</code></pre></div>

<p>Para <code>n &gt;&gt; overhead</code>: <code>Speedup â‰ˆ p</code> (speedup linear ideal)</p>
<h3>5.3 AnÃ¡lise de Work e Span</h3>
<p><strong>Work (Trabalho Total):</strong>
Quantidade total de trabalho realizado:</p>
<div class="codehilite"><pre><span></span><code>W(n) = nÃºmero total de operaÃ§Ãµes
</code></pre></div>

<p><strong>Span (Caminho CrÃ­tico):</strong>
Comprimento do caminho mais longo (tempo sequencial):</p>
<div class="codehilite"><pre><span></span><code><span class="nv">S</span><span class="ss">(</span><span class="nv">n</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tempo</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">caminho</span><span class="w"> </span><span class="nv">cr</span>Ã­<span class="nv">tico</span>
</code></pre></div>

<p><strong>No Projeto:</strong>
- <strong>Work:</strong> <code>W(n) = n Ã— t</code> onde t = tempo por pÃ¡gina
- <strong>Span:</strong> <code>S(n) = (n/p) Ã— t</code> (assumindo distribuiÃ§Ã£o uniforme)
- <strong>Paralelismo:</strong> <code>P = W(n) / S(n) = p</code></p>
<p><strong>Limite TeÃ³rico:</strong> Com <code>p</code> processadores, speedup mÃ¡ximo Ã© <code>p</code>.</p>
<h3>5.4 Load Balancing: DistribuiÃ§Ã£o de Trabalho</h3>
<p><strong>Problema:</strong> Distribuir <code>n</code> pÃ¡ginas entre <code>p</code> workers de forma equilibrada.</p>
<p><strong>SoluÃ§Ã£o IngÃªnua:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">p</span><span class="p">);</span>
<span class="c1">// Worker i: pÃ¡ginas [i Ã— pagesPerWorker, (i+1) Ã— pagesPerWorker)</span>
</code></pre></div>

<p><strong>AnÃ¡lise:</strong>
- <strong>Balanceamento:</strong> DiferenÃ§a mÃ¡xima de 1 pÃ¡gina entre workers
- <strong>Complexidade:</strong> O(1) para calcular distribuiÃ§Ã£o
- <strong>Ã“timo:</strong> Sim, para distribuiÃ§Ã£o estÃ¡tica</p>
<p><strong>Melhorias PossÃ­veis:</strong>
1. <strong>Work Stealing:</strong> Workers que terminam pegam trabalho de outros
2. <strong>Dynamic Load Balancing:</strong> Redistribui trabalho dinamicamente
3. <strong>Adaptive Partitioning:</strong> Ajusta tamanho de partiÃ§Ãµes baseado em performance</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias Node.js:</strong>
- <strong><a href="https://nodejs.org/docs/latest/api/cluster.html">Cluster Module - Node.js</a></strong> - Balanceamento de carga entre processos
- <strong><a href="https://nodejs.org/docs/latest/api/worker_threads.html">Worker Threads - Node.js</a></strong> - Threads para paralelismo
- <strong><a href="https://nodejs.org/docs/latest/api/os.html#oscpus">os.cpus() - Node.js</a></strong> - InformaÃ§Ãµes sobre CPUs</p>
</blockquote>
<h3>5.5 ExercÃ­cios PrÃ¡ticos</h3>
<h4>ExercÃ­cio 1: Implementar DivisÃ£o de Trabalho</h4>
<p><strong>Objetivo:</strong> Distribuir trabalho entre workers de forma equilibrada.</p>
<p><strong>Tarefa:</strong> Crie funÃ§Ã£o <code>distributeWork</code> que divide <code>n</code> itens entre <code>p</code> workers.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente distributeWork</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">distributeWork</span><span class="p">(</span><span class="nx">totalItems</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Retorna array de objetos: [{ start, end, workerId }, ...]</span>
<span class="w">  </span><span class="c1">// Cada worker processa itens de &#39;start&#39; atÃ© &#39;end&#39; (exclusivo)</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">distributeWork</span><span class="p">(</span><span class="nx">totalItems</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">itemsPerWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">totalItems</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">distribution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">itemsPerWorker</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">itemsPerWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">totalItems</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">totalItems</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">distribution</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">workerId</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span>
<span class="w">        </span><span class="nx">start</span><span class="p">,</span>
<span class="w">        </span><span class="nx">end</span><span class="p">,</span>
<span class="w">        </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">distribution</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">distributeWork</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="c1">// [</span>
<span class="c1">//   { workerId: 0, start: 0, end: 250, count: 250 },</span>
<span class="c1">//   { workerId: 1, start: 250, end: 500, count: 250 },</span>
<span class="c1">//   { workerId: 2, start: 500, end: 750, count: 250 },</span>
<span class="c1">//   { workerId: 3, start: 750, end: 1000, count: 250 }</span>
<span class="c1">// ]</span>
</code></pre></div>



**ReferÃªncia:** [Math.ceil() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/ceil)
</details>

<h4>ExercÃ­cio 2: Calcular Complexidade de Algoritmo Dividir e Conquistar</h4>
<p><strong>Objetivo:</strong> Aplicar Teorema Mestre para analisar complexidade.</p>
<p><strong>Tarefa:</strong> Para a recorrÃªncia <code>T(n) = 4T(n/2) + n</code>, determine a complexidade usando Teorema Mestre.</p>
<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code>T(n) = 4T(n/2) + n

a = 4, b = 2, f(n) = n
log_b(a) = log_2(4) = 2

f(n) = n = Î˜(n^1)
Como n^1 &lt; n^2, estamos no Caso 1:
T(n) = Î˜(n^log_b(a)) = Î˜(n^2)
</code></pre></div>



**ReferÃªncia:** [Master Theorem - Wikipedia](https://en.wikipedia.org/wiki/Master_theorem_(analysis_of_algorithms))
</details>

<hr />
<p><a id="capÃ­tulo-6-algoritmo-k-means---fundamentaÃ§Ã£o-em-machine-learning"></a></p>
<h2>ğŸ“š CapÃ­tulo 6: Algoritmo K-Means - FundamentaÃ§Ã£o em Machine Learning</h2>
<h3>ğŸ“– DefiniÃ§Ãµes de Conceitos</h3>
<p><strong>K-Means:</strong> Um algoritmo de clustering nÃ£o-supervisionado que particiona n observaÃ§Ãµes em k clusters, onde cada observaÃ§Ã£o pertence ao cluster com o centroide mais prÃ³ximo. O algoritmo minimiza a soma dos quadrados das distÃ¢ncias dentro de cada cluster (Within-Cluster Sum of Squares - WCSS).</p>
<p><strong>Clustering:</strong> Uma tÃ©cnica de aprendizado de mÃ¡quina nÃ£o-supervisionado que agrupa dados similares em clusters sem conhecimento prÃ©vio das classes. O objetivo Ã© encontrar padrÃµes e estruturas ocultas nos dados.</p>
<p><strong>Centroide:</strong> O ponto central de um cluster, calculado como a mÃ©dia de todos os pontos pertencentes ao cluster. Em K-Means, cada cluster tem um centroide que representa o "centro" do cluster.</p>
<p><strong>DistÃ¢ncia Euclidiana:</strong> A distÃ¢ncia em linha reta entre dois pontos em um espaÃ§o euclidiano. Para pontos p e q em n dimensÃµes, a distÃ¢ncia Ã© âˆš(Î£(páµ¢ - qáµ¢)Â²). Ã‰ a mÃ©trica padrÃ£o usada no K-Means.</p>
<p><strong>NormalizaÃ§Ã£o:</strong> O processo de escalar dados para um intervalo comum (geralmente [0, 1] ou [-1, 1]) para que diferentes dimensÃµes tenham pesos similares. NormalizaÃ§Ã£o Ã© essencial quando dimensÃµes tÃªm escalas muito diferentes (ex: latitude vs populaÃ§Ã£o).</p>
<p><strong>ConvergÃªncia:</strong> O estado onde o algoritmo K-Means para de fazer mudanÃ§as significativas nos centroides ou atribuiÃ§Ãµes. O algoritmo converge quando os centroides nÃ£o se movem mais ou quando as atribuiÃ§Ãµes permanecem estÃ¡veis entre iteraÃ§Ãµes.</p>
<p><strong>InicializaÃ§Ã£o:</strong> O processo de escolher os k centroides iniciais antes de iniciar o algoritmo K-Means. A inicializaÃ§Ã£o pode ser aleatÃ³ria ou usar mÃ©todos mais sofisticados como K-Means++ que escolhe centroides distantes entre si.</p>
<p><strong>WCSS (Within-Cluster Sum of Squares):</strong> A soma dos quadrados das distÃ¢ncias de cada ponto ao centroide de seu cluster. WCSS Ã© a funÃ§Ã£o objetivo que o K-Means tenta minimizar. Menor WCSS indica clusters mais compactos e bem definidos.</p>
<blockquote>
<p><strong>ğŸ“š DocumentaÃ§Ã£o Completa MDN e Node.js:</strong>
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/sqrt">Math.sqrt() - Raiz Quadrada - MDN</a></strong> - CÃ¡lculo de distÃ¢ncia euclidiana
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/min">Math.min() - MÃ­nimo - MDN</a></strong> - Encontrar mÃ­nimo
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/max">Math.max() - MÃ¡ximo - MDN</a></strong> - Encontrar mÃ¡ximo
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random">Math.random() - NÃºmeros AleatÃ³rios - MDN</a></strong> - InicializaÃ§Ã£o de centroides
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/pow">Math.pow() - PotÃªncia - MDN</a></strong> - CÃ¡lculo de distÃ¢ncia ao quadrado
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/from">Array.from() - CriaÃ§Ã£o de Arrays - MDN</a></strong> - Criar arrays de tamanho fixo
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/fill">Array.fill() - Preencher Array - MDN</a></strong> - Inicializar arrays
- <strong><a href="https://en.wikipedia.org/wiki/K-means_clustering">K-Means Clustering - Wikipedia</a></strong> - Algoritmo completo
- <strong><a href="https://en.wikipedia.org/wiki/Lloyd%27s_algorithm">Lloyd's Algorithm - Wikipedia</a></strong> - Algoritmo de Lloyd (K-Means)</p>
</blockquote>
<h3>6.1 Contexto HistÃ³rico e AplicaÃ§Ãµes</h3>
<p>O algoritmo K-Means foi proposto por <strong>Stuart Lloyd</strong> em 1957 (publicado em 1982) e <strong>James MacQueen</strong> em 1967. Ã‰ um dos algoritmos de clustering mais utilizados na prÃ¡tica.</p>
<p><strong>AplicaÃ§Ãµes Reais:</strong>
- SegmentaÃ§Ã£o de clientes
- CompressÃ£o de imagens
- AnÃ¡lise de dados genÃ´micos
- <strong>Neste projeto:</strong> Agrupamento geogrÃ¡fico de cidades</p>
<blockquote>
<p><strong>ğŸ“š DocumentaÃ§Ã£o Completa - Math API:</strong>
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math">Math Object - MDN</a></strong> - Objeto Math completo
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/sqrt">Math.sqrt() - MDN</a></strong> - Raiz quadrada para distÃ¢ncia euclidiana
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/pow">Math.pow() - MDN</a></strong> - PotÃªncia (alternativa a xÂ²)
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/abs">Math.abs() - MDN</a></strong> - Valor absoluto</p>
</blockquote>
<h3>6.2 FundamentaÃ§Ã£o MatemÃ¡tica</h3>
<p><strong>Problema Formal:</strong></p>
<p>Dado:
- Conjunto de pontos: <code>X = {xâ‚, xâ‚‚, ..., xâ‚™}</code> onde <code>xáµ¢ âˆˆ â„áµˆ</code>
- NÃºmero de clusters: <code>k</code></p>
<p>Encontrar:
- Centroides: <code>C = {câ‚, câ‚‚, ..., câ‚–}</code> onde <code>câ±¼ âˆˆ â„áµˆ</code>
- AtribuiÃ§Ãµes: <code>A = {aâ‚, aâ‚‚, ..., aâ‚™}</code> onde <code>aáµ¢ âˆˆ {1, 2, ..., k}</code></p>
<p>Que minimizam:</p>
<div class="codehilite"><pre><span></span><code>J(C, A) = Î£áµ¢â‚Œâ‚â¿ ||xáµ¢ - c_{aáµ¢}||Â²
</code></pre></div>

<p>Onde <code>||Â·||</code> Ã© a norma euclidiana.</p>
<p><strong>InterpretaÃ§Ã£o:</strong>
Minimizar a soma dos quadrados das distÃ¢ncias de cada ponto ao seu centroide atribuÃ­do (Within-Cluster Sum of Squares - WCSS).</p>
<h3>6.3 Algoritmo: AnÃ¡lise de ConvergÃªncia</h3>
<p><strong>Algoritmo K-Means:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">Inicializar</span><span class="w"> </span><span class="n">centroides</span><span class="w"> </span><span class="n">C</span><span class="err">â½</span><span class="n">â°</span><span class="err">â¾</span><span class="w"> </span><span class="n">aleatoriamente</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Para</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">...</span><span class="w"> </span><span class="n">atÃ©</span><span class="w"> </span><span class="n">convergÃªncia</span><span class="p">:</span>
<span class="w">   </span><span class="n">a</span><span class="mf">.</span><span class="w"> </span><span class="n">Atribuir</span><span class="p">:</span><span class="w"> </span><span class="n">aáµ¢</span><span class="err">â½</span><span class="n">áµ—</span><span class="err">â¾</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argminâ±¼</span><span class="w"> </span><span class="err">||</span><span class="n">xáµ¢</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">câ±¼</span><span class="err">â½</span><span class="n">áµ—</span><span class="err">â»</span><span class="n">Â¹</span><span class="err">â¾||</span><span class="n">Â²</span>
<span class="w">   </span><span class="n">b</span><span class="mf">.</span><span class="w"> </span><span class="n">Atualizar</span><span class="p">:</span><span class="w"> </span><span class="n">câ±¼</span><span class="err">â½</span><span class="n">áµ—</span><span class="err">â¾</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="o">/</span><span class="err">|</span><span class="n">Sâ±¼</span><span class="err">|</span><span class="p">)</span><span class="w"> </span><span class="n">Î£_</span><span class="err">{</span><span class="n">i</span><span class="err">âˆˆ</span><span class="n">Sâ±¼</span><span class="err">}</span><span class="w"> </span><span class="n">xáµ¢</span>
<span class="w">     </span><span class="kr">on</span><span class="n">de</span><span class="w"> </span><span class="n">Sâ±¼</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="n">i</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">aáµ¢</span><span class="err">â½</span><span class="n">áµ—</span><span class="err">â¾</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="err">}</span>
<span class="w">   </span><span class="n">c</span><span class="mf">.</span><span class="w"> </span><span class="n">Se</span><span class="w"> </span><span class="err">||</span><span class="n">C</span><span class="err">â½</span><span class="n">áµ—</span><span class="err">â¾</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">C</span><span class="err">â½</span><span class="n">áµ—</span><span class="err">â»</span><span class="n">Â¹</span><span class="err">â¾||</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Îµ</span><span class="p">:</span><span class="w"> </span><span class="n">convergiu</span>
</code></pre></div>

<p><strong>Teorema 6.1 (ConvergÃªncia do K-Means):</strong></p>
<p>O algoritmo K-Means sempre converge para um mÃ­nimo local em um nÃºmero finito de iteraÃ§Ãµes.</p>
<p><strong>Prova Formal:</strong></p>
<p><strong>Lema 6.1: Monotonicidade da FunÃ§Ã£o Objetivo</strong></p>
<p>A funÃ§Ã£o objetivo <code>J(C, A)</code> Ã© nÃ£o-crescente a cada iteraÃ§Ã£o:</p>
<div class="codehilite"><pre><span></span><code>J(C^(t+1), A^(t+1)) â‰¤ J(C^(t), A^(t))
</code></pre></div>

<p><strong>Prova do Lema 6.1:</strong></p>
<p>Na etapa de atribuiÃ§Ã£o (passo a):</p>
<div class="codehilite"><pre><span></span><code>a_i^(t+1) = argmin_j ||x_i - c_j^(t)||Â²
</code></pre></div>

<p>Por definiÃ§Ã£o de <code>argmin</code>:</p>
<div class="codehilite"><pre><span></span><code>||x_i - c_{a_i^(t+1)}^(t)||Â² â‰¤ ||x_i - c_{a_i^(t)}^(t)||Â²
</code></pre></div>

<p>Somando sobre todos os pontos:</p>
<div class="codehilite"><pre><span></span><code>Î£_i ||x_i - c_{a_i^(t+1)}^(t)||Â² â‰¤ Î£_i ||x_i - c_{a_i^(t)}^(t)||Â²
</code></pre></div>

<p>Na etapa de atualizaÃ§Ã£o (passo b):</p>
<div class="codehilite"><pre><span></span><code>c_j^(t+1) = (1/|S_j|) Î£_{iâˆˆS_j} x_i
</code></pre></div>

<p>Onde <code>S_j = {i : a_i^(t+1) = j}</code>.</p>
<p>Por propriedade da mÃ©dia, <code>c_j^(t+1)</code> minimiza <code>Î£_{iâˆˆS_j} ||x_i - c||Â²</code>:</p>
<div class="codehilite"><pre><span></span><code>Î£_{iâˆˆS_j} ||x_i - c_j^(t+1)||Â² â‰¤ Î£_{iâˆˆS_j} ||x_i - c_j^(t)||Â²
</code></pre></div>

<p>Combinando:</p>
<div class="codehilite"><pre><span></span><code>J(C^(t+1), A^(t+1)) = Î£_j Î£_{iâˆˆS_j} ||x_i - c_j^(t+1)||Â²
                    â‰¤ Î£_j Î£_{iâˆˆS_j} ||x_i - c_j^(t)||Â²
                    â‰¤ Î£_i ||x_i - c_{a_i^(t)}^(t)||Â²
                    = J(C^(t), A^(t))
</code></pre></div>

<p><strong>Lema 6.2: Finitude do EspaÃ§o de SoluÃ§Ãµes</strong></p>
<p>O nÃºmero de atribuiÃ§Ãµes possÃ­veis Ã© finito:</p>
<div class="codehilite"><pre><span></span><code>|A| = k^n
</code></pre></div>

<p>Onde <code>k</code> Ã© o nÃºmero de clusters e <code>n</code> Ã© o nÃºmero de pontos.</p>
<p><strong>Prova do Teorema 6.1:</strong></p>
<ol>
<li>Por Lema 6.1, <code>J</code> Ã© nÃ£o-crescente: <code>J^(t+1) â‰¤ J^(t)</code></li>
<li>Como <code>J â‰¥ 0</code> (soma de quadrados), a sequÃªncia <code>{J^(t)}</code> Ã© limitada inferiormente</li>
<li>Por Lema 6.2, hÃ¡ apenas <code>k^n</code> atribuiÃ§Ãµes possÃ­veis</li>
<li>Como <code>J</code> diminui ou permanece constante, e hÃ¡ apenas finitas atribuiÃ§Ãµes, o algoritmo deve convergir</li>
</ol>
<p><strong>CorolÃ¡rio 6.1.1: Limite Superior de IteraÃ§Ãµes</strong></p>
<p>No pior caso, o algoritmo converge em no mÃ¡ximo <code>k^n</code> iteraÃ§Ãµes.</p>
<p><strong>Teorema 6.2: ConvergÃªncia para MÃ­nimo Local</strong></p>
<p>O algoritmo K-Means converge para um mÃ­nimo local da funÃ§Ã£o objetivo <code>J</code>.</p>
<p><strong>Prova:</strong></p>
<p>Na convergÃªncia, temos:
- <code>a_i = argmin_j ||x_i - c_j||Â²</code> (atribuiÃ§Ã£o Ã³tima dado centroides)
- <code>c_j = (1/|S_j|) Î£_{iâˆˆS_j} x_i</code> (centroides Ã³timos dado atribuiÃ§Ãµes)</p>
<p>Qualquer mudanÃ§a em <code>a_i</code> ou <code>c_j</code> aumentaria <code>J</code>, portanto Ã© um mÃ­nimo local.</p>
<p><strong>Problema:</strong> ConvergÃªncia para mÃ­nimo local, nÃ£o global.</p>
<p><strong>Teorema 6.3: Complexidade de Encontrar MÃ­nimo Global</strong></p>
<p>Encontrar o mÃ­nimo global do K-Means Ã© NP-hard.</p>
<p><strong>Prova (EsboÃ§o):</strong></p>
<p>ReduÃ§Ã£o do problema de particionamento (Partition Problem) para K-Means com <code>k=2</code>. Como Partition Ã© NP-completo, K-Means Ã© NP-hard.</p>
<p><strong>SoluÃ§Ã£o PrÃ¡tica:</strong> MÃºltiplas inicializaÃ§Ãµes (K-Means++) ou inicializaÃ§Ã£o inteligente.</p>
<h3>6.4 Complexidade Computacional</h3>
<p><strong>AnÃ¡lise Sequencial:</strong></p>
<ul>
<li><strong>AtribuiÃ§Ã£o:</strong> O(n Ã— k Ã— d) onde:</li>
<li><code>n</code> = nÃºmero de pontos</li>
<li><code>k</code> = nÃºmero de clusters</li>
<li>
<p><code>d</code> = dimensÃµes (3 no projeto: lat, lon, pop)</p>
</li>
<li>
<p><strong>AtualizaÃ§Ã£o:</strong> O(n Ã— d)</p>
</li>
<li>
<p><strong>Total por iteraÃ§Ã£o:</strong> O(n Ã— k Ã— d)</p>
</li>
<li>
<p><strong>Total:</strong> O(I Ã— n Ã— k Ã— d) onde <code>I</code> = nÃºmero de iteraÃ§Ãµes</p>
</li>
</ul>
<p><strong>AnÃ¡lise Paralela:</strong></p>
<p>Com <code>p</code> processadores:</p>
<ul>
<li><strong>AtribuiÃ§Ã£o:</strong> O((n Ã— k Ã— d) / p) - paralelizÃ¡vel</li>
<li><strong>AtualizaÃ§Ã£o:</strong> O((n Ã— d) / p) - paralelizÃ¡vel</li>
<li><strong>SincronizaÃ§Ã£o:</strong> O(k Ã— d) - sequencial (comunicaÃ§Ã£o)</li>
</ul>
<p><strong>Speedup:</strong></p>
<div class="codehilite"><pre><span></span><code>S(p) = (I Ã— n Ã— k Ã— d) / (I Ã— (n Ã— k Ã— d)/p + I Ã— k Ã— d)
     = p / (1 + kÃ—d/(nÃ—kÃ—d/p))
     = p / (1 + p/(n))
</code></pre></div>

<p>Para <code>n &gt;&gt; p</code>: <code>S(p) â‰ˆ p</code> (speedup linear)</p>
<h3>6.5 NormalizaÃ§Ã£o de Dados: Por Que Ã‰ NecessÃ¡ria</h3>
<p><strong>Problema:</strong> DimensÃµes com escalas diferentes.</p>
<p><strong>Exemplo:</strong>
- Latitude: -90 a 90 (range = 180)
- Longitude: -180 a 180 (range = 360)
- PopulaÃ§Ã£o: 0 a 50.000.000 (range = 50.000.000)</p>
<p><strong>Sem normalizaÃ§Ã£o:</strong>
A distÃ¢ncia euclidiana seria dominada pela populaÃ§Ã£o:</p>
<div class="codehilite"><pre><span></span><code>dÂ² = (latâ‚ - latâ‚‚)Â² + (lonâ‚ - lonâ‚‚)Â² + (popâ‚ - popâ‚‚)Â²
   â‰ˆ 0 + 0 + (popâ‚ - popâ‚‚)Â²  (populaÃ§Ã£o domina!)
</code></pre></div>

<p><strong>Com normalizaÃ§Ã£o:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">normPop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">population</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">MAX_POPULATION</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0 a 1</span>
<span class="nx">d</span><span class="err">Â²</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">lat</span><span class="err">â‚</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">lat</span><span class="err">â‚‚</span><span class="p">)</span><span class="err">Â²</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">lon</span><span class="err">â‚</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">lon</span><span class="err">â‚‚</span><span class="p">)</span><span class="err">Â²</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">normPop</span><span class="err">â‚</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">normPop</span><span class="err">â‚‚</span><span class="p">)</span><span class="err">Â²</span>
</code></pre></div>

<p>Agora todas as dimensÃµes contribuem igualmente.</p>
<p><strong>MÃ©todos de NormalizaÃ§Ã£o:</strong></p>
<ol>
<li>
<p><strong>Min-Max Normalization:</strong>
   <code>x' = (x - min) / (max - min)</code>
   Range: [0, 1]</p>
</li>
<li>
<p><strong>Z-Score Normalization:</strong>
   <code>x' = (x - Î¼) / Ïƒ</code>
   MÃ©dia: 0, Desvio padrÃ£o: 1</p>
</li>
<li>
<p><strong>Unit Vector Normalization:</strong>
   <code>x' = x / ||x||</code>
   Norma: 1</p>
</li>
</ol>
<p><strong>No Projeto:</strong> Usamos Min-Max para populaÃ§Ã£o (simples e eficaz).</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias Adicionais:</strong>
- <strong><a href="https://en.wikipedia.org/wiki/Normalization_(statistics)">Normalization (Statistics) - Wikipedia</a></strong> - NormalizaÃ§Ã£o estatÃ­stica
- <strong><a href="https://en.wikipedia.org/wiki/Feature_scaling">Feature Scaling - Wikipedia</a></strong> - Escalonamento de features
- <strong><a href="https://en.wikipedia.org/wiki/Feature_scaling#Rescaling_(min-max_normalization)">Min-Max Normalization - Wikipedia</a></strong> - NormalizaÃ§Ã£o Min-Max</p>
</blockquote>
<h3>6.6 ExercÃ­cios PrÃ¡ticos</h3>
<h4>ExercÃ­cio 1: Implementar NormalizaÃ§Ã£o Min-Max</h4>
<p><strong>Objetivo:</strong> Criar funÃ§Ã£o de normalizaÃ§Ã£o para preparar dados para K-Means.</p>
<p><strong>Tarefa:</strong> Implemente <code>normalizeData</code> que normaliza um array de pontos usando Min-Max.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente normalizeData</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">normalizeData</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// points = [{ latitude, longitude, population }, ...]</span>
<span class="w">  </span><span class="c1">// Retorna: { normalizedPoints, ranges }</span>
<span class="w">  </span><span class="c1">// ranges = { lat: {min, max}, lon: {min, max}, pop: {min, max} }</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">normalizeData</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">normalizedPoints</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">ranges</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Encontra ranges</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">latitudes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">latitude</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">longitudes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">populations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">minLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">latitudes</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">latitudes</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">minLon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">longitudes</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxLon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">longitudes</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">minPop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">populations</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxPop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">populations</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Calcula ranges (evita divisÃ£o por zero)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rangeLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">maxLat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLat</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rangeLon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">maxLon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLon</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rangePop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">maxPop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minPop</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Normaliza cada ponto</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">point</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">    </span><span class="p">...</span><span class="nx">point</span><span class="p">,</span>
<span class="w">    </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLat</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">rangeLat</span><span class="p">,</span>
<span class="w">    </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLon</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">rangeLon</span><span class="p">,</span>
<span class="w">    </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="nx">point</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minPop</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">rangePop</span><span class="p">,</span>
<span class="w">  </span><span class="p">}));</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">normalizedPoints</span><span class="p">,</span>
<span class="w">    </span><span class="nx">ranges</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">lat</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">min</span><span class="o">:</span><span class="w"> </span><span class="nx">minLat</span><span class="p">,</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="nx">maxLat</span><span class="p">,</span><span class="w"> </span><span class="nx">range</span><span class="o">:</span><span class="w"> </span><span class="nx">rangeLat</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">lon</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">min</span><span class="o">:</span><span class="w"> </span><span class="nx">minLon</span><span class="p">,</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="nx">maxLon</span><span class="p">,</span><span class="w"> </span><span class="nx">range</span><span class="o">:</span><span class="w"> </span><span class="nx">rangeLon</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">pop</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">min</span><span class="o">:</span><span class="w"> </span><span class="nx">minPop</span><span class="p">,</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="nx">maxPop</span><span class="p">,</span><span class="w"> </span><span class="nx">range</span><span class="o">:</span><span class="w"> </span><span class="nx">rangePop</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">23.5505</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">46.6333</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">12000000</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">22.9068</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">43.1729</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">6000000</span><span class="w"> </span><span class="p">},</span>
<span class="p">];</span>

<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">normalizedPoints</span><span class="p">,</span><span class="w"> </span><span class="nx">ranges</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalizeData</span><span class="p">(</span><span class="nx">points</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">normalizedPoints</span><span class="p">);</span>
<span class="c1">// [</span>
<span class="c1">//   { latitude: 0.5, longitude: 0.5, population: 1.0 },</span>
<span class="c1">//   { latitude: 0.0, longitude: 0.0, population: 0.0 }</span>
<span class="c1">// ]</span>
</code></pre></div>



**ReferÃªncias:**
- [Math.min() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/min)
- [Math.max() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/max)
- [Spread Syntax - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax)
</details>

<h4>ExercÃ­cio 2: Calcular DistÃ¢ncia Euclidiana</h4>
<p><strong>Objetivo:</strong> Implementar cÃ¡lculo de distÃ¢ncia entre pontos normalizados.</p>
<p><strong>Tarefa:</strong> Crie funÃ§Ã£o <code>euclideanDistance</code> que calcula distÃ¢ncia entre dois pontos.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente euclideanDistance</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">euclideanDistance</span><span class="p">(</span><span class="nx">point1</span><span class="p">,</span><span class="w"> </span><span class="nx">point2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// point1 e point2 tÃªm: { latitude, longitude, population }</span>
<span class="w">  </span><span class="c1">// Retorna distÃ¢ncia euclidiana</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">euclideanDistance</span><span class="p">(</span><span class="nx">point1</span><span class="p">,</span><span class="w"> </span><span class="nx">point2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">latitude</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">popDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">population</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span>
<span class="w">    </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">    </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">    </span><span class="nx">popDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">popDiff</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// VersÃ£o otimizada (sem Math.sqrt para comparaÃ§Ãµes)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">euclideanDistanceSquared</span><span class="p">(</span><span class="nx">point1</span><span class="p">,</span><span class="w"> </span><span class="nx">point2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">latitude</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">popDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">population</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">popDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">popDiff</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.8</span><span class="w"> </span><span class="p">};</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.6</span><span class="w"> </span><span class="p">};</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">euclideanDistance</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span><span class="w"> </span><span class="nx">p2</span><span class="p">));</span><span class="w"> </span><span class="c1">// ~0.346</span>
</code></pre></div>



**ReferÃªncias:**
- [Math.sqrt() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/sqrt)
- [Euclidean Distance - Wikipedia](https://en.wikipedia.org/wiki/Euclidean_distance)
</details>

<h4>ExercÃ­cio 3: Encontrar Centroide Mais PrÃ³ximo</h4>
<p><strong>Objetivo:</strong> Implementar atribuiÃ§Ã£o de pontos a clusters.</p>
<p><strong>Tarefa:</strong> Crie funÃ§Ã£o <code>findClosestCentroid</code> que encontra o centroide mais prÃ³ximo de um ponto.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente findClosestCentroid</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">findClosestCentroid</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Retorna Ã­ndice do centroide mais prÃ³ximo</span>
<span class="w">  </span><span class="c1">// Use euclideanDistance implementada anteriormente</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">findClosestCentroid</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">minDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Infinity</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">closestIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">centroids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">euclideanDistance</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">distance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">minDistance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">minDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">distance</span><span class="p">;</span>
<span class="w">      </span><span class="nx">closestIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">closestIndex</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// VersÃ£o usando Array.reduce (mais funcional)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">findClosestCentroidFunctional</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">centroids</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">closest</span><span class="p">,</span><span class="w"> </span><span class="nx">centroid</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">euclideanDistance</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">centroid</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">distance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">closest</span><span class="p">.</span><span class="nx">distance</span><span class="w"> </span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nx">distance</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="nx">closest</span><span class="p">;</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">distance</span><span class="o">:</span><span class="w"> </span><span class="kc">Infinity</span><span class="w"> </span><span class="p">}).</span><span class="nx">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.7</span><span class="w"> </span><span class="p">};</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">centroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.6</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.7</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.8</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.9</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="p">},</span>
<span class="p">];</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findClosestCentroid</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Centroide mais prÃ³ximo: </span><span class="si">${</span><span class="nx">closest</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0, 1 ou 2</span>
</code></pre></div>



**ReferÃªncias:**
- [Array.reduce() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce)
- [Infinity - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Infinity)
</details>

<h4>ExercÃ­cio 4: Calcular Novos Centroides</h4>
<p><strong>Objetivo:</strong> Implementar atualizaÃ§Ã£o de centroides apÃ³s atribuiÃ§Ã£o.</p>
<p><strong>Tarefa:</strong> Crie funÃ§Ã£o <code>calculateCentroids</code> que calcula novos centroides baseado nos pontos atribuÃ­dos.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente calculateCentroids</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">calculateCentroids</span><span class="p">(</span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// clusters = [[pointIndex1, pointIndex2, ...], ...] (um array por cluster)</span>
<span class="w">  </span><span class="c1">// points = [{ latitude, longitude, population }, ...]</span>
<span class="w">  </span><span class="c1">// Retorna array de novos centroides</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">calculateCentroids</span><span class="p">(</span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">clusters</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">clusterPoints</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clusterPoints</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Cluster vazio - retorna null ou mantÃ©m centroide anterior</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Calcula mÃ©dia de cada dimensÃ£o</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">sumLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">sumLon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">sumPop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">pointIndex</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">clusterPoints</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">[</span><span class="nx">pointIndex</span><span class="p">];</span>
<span class="w">      </span><span class="nx">sumLat</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">point</span><span class="p">.</span><span class="nx">latitude</span><span class="p">;</span>
<span class="w">      </span><span class="nx">sumLon</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">point</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
<span class="w">      </span><span class="nx">sumPop</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">point</span><span class="p">.</span><span class="nx">population</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clusterPoints</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">sumLat</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span>
<span class="w">      </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">sumLon</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span>
<span class="w">      </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nx">sumPop</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// VersÃ£o funcional usando Array.reduce</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">calculateCentroidsFunctional</span><span class="p">(</span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">clusters</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">clusterPoints</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clusterPoints</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sums</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clusterPoints</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
<span class="w">      </span><span class="p">(</span><span class="nx">acc</span><span class="p">,</span><span class="w"> </span><span class="nx">idx</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">        </span><span class="nx">lat</span><span class="o">:</span><span class="w"> </span><span class="nx">acc</span><span class="p">.</span><span class="nx">lat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">points</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">latitude</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lon</span><span class="o">:</span><span class="w"> </span><span class="nx">acc</span><span class="p">.</span><span class="nx">lon</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">points</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">longitude</span><span class="p">,</span>
<span class="w">        </span><span class="nx">pop</span><span class="o">:</span><span class="w"> </span><span class="nx">acc</span><span class="p">.</span><span class="nx">pop</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">points</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">population</span><span class="p">,</span>
<span class="w">      </span><span class="p">}),</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">lat</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">lon</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">pop</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clusterPoints</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">sums</span><span class="p">.</span><span class="nx">lat</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span>
<span class="w">      </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">sums</span><span class="p">.</span><span class="nx">lon</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span>
<span class="w">      </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nx">sums</span><span class="p">.</span><span class="nx">pop</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">],</span><span class="w">  </span><span class="c1">// Cluster 0: pontos 0, 1, 2</span>
<span class="w">  </span><span class="p">[</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">],</span><span class="w">     </span><span class="c1">// Cluster 1: pontos 3, 4</span>
<span class="w">  </span><span class="p">[</span><span class="mf">5</span><span class="p">],</span><span class="w">        </span><span class="c1">// Cluster 2: ponto 5</span>
<span class="p">];</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.3</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.4</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.7</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.8</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.9</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.8</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.9</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="p">},</span>
<span class="p">];</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">centroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calculateCentroids</span><span class="p">(</span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">centroids</span><span class="p">);</span>
</code></pre></div>



**ReferÃªncias:**
- [Array.map() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map)
- [Array.reduce() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce)
</details>

<hr />
<p><a id="capÃ­tulo-7-web-workers---arquitetura-de-processamento-paralelo"></a></p>
<h2>ğŸ“š CapÃ­tulo 7: Web Workers - Arquitetura de Processamento Paralelo</h2>
<h3>ğŸ“– DefiniÃ§Ãµes de Conceitos</h3>
<p><strong>Web Worker:</strong> Um mecanismo JavaScript que permite executar cÃ³digo em threads separados em background, sem bloquear o thread principal da interface do usuÃ¡rio. Workers executam em um contexto global isolado, sem acesso ao DOM ou objetos do window.</p>
<p><strong>Dedicated Worker:</strong> Um tipo de Web Worker que Ã© criado e controlado por um Ãºnico script (main thread). Dedicated Workers se comunicam apenas com o script que os criou atravÃ©s de mensagens (postMessage).</p>
<p><strong>Shared Worker:</strong> Um tipo de Web Worker que pode ser compartilhado entre mÃºltiplos scripts ou janelas do mesmo domÃ­nio. Shared Workers permitem comunicaÃ§Ã£o entre diferentes contextos de execuÃ§Ã£o.</p>
<p><strong>postMessage():</strong> O mÃ©todo usado para enviar mensagens entre o main thread e workers, ou entre workers. Mensagens sÃ£o serializadas usando o algoritmo de clonagem estruturada (structured clone algorithm) e podem incluir objetos transferÃ­veis para melhor performance.</p>
<p><strong>Structured Clone Algorithm:</strong> O algoritmo usado pelo JavaScript para serializar objetos complexos ao enviar mensagens entre threads. Suporta objetos, arrays, Maps, Sets, TypedArrays, mas nÃ£o funÃ§Ãµes ou sÃ­mbolos.</p>
<p><strong>Transferable Objects:</strong> Objetos que podem ser transferidos entre threads sem cÃ³pia, transferindo a propriedade do objeto. ArrayBuffer e MessagePort sÃ£o exemplos. Transferir objetos Ã© mais eficiente que clonÃ¡-los para grandes volumes de dados.</p>
<p><strong>Worker Threads (Node.js):</strong> O equivalente de Web Workers no ambiente Node.js. Worker Threads permitem paralelismo verdadeiro em Node.js, executando cÃ³digo JavaScript em threads separados com acesso a APIs do Node.js.</p>
<p><strong>isMainThread:</strong> Uma propriedade booleana no Node.js Worker Threads que indica se o cÃ³digo estÃ¡ sendo executado no thread principal ou em um worker thread. Ãštil para cÃ³digo que precisa se comportar diferentemente dependendo do contexto.</p>
<p><strong>MessageChannel:</strong> Uma API que cria um canal de comunicaÃ§Ã£o bidirecional entre dois contextos. Permite comunicaÃ§Ã£o direta entre workers sem passar pelo main thread.</p>
<blockquote>
<p><strong>ğŸ“š DocumentaÃ§Ã£o Oficial Completa - Web Workers API:</strong>
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">Web Workers API - MDN Overview</a></strong> - VisÃ£o geral completa
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker">Worker - MDN Interface</a></strong> - Interface principal do Worker
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage">Worker.postMessage() - MDN</a></strong> - Envio de mensagens
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker/terminate">Worker.terminate() - MDN</a></strong> - Encerrar worker
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/WorkerGlobalScope">WorkerGlobalScope - MDN</a></strong> - Contexto global do worker
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/DedicatedWorkerGlobalScope">DedicatedWorkerGlobalScope - MDN</a></strong> - Worker dedicado
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Using Web Workers - MDN Guide</a></strong> - Guia prÃ¡tico completo
- <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers#transferable_objects">Transferable Objects - MDN</a></strong> - Objetos transferÃ­veis
- <strong><a href="https://nodejs.org/docs/latest/api/worker_threads.html">Worker Threads - Node.js</a></strong> - Workers no Node.js
- <strong><a href="https://nodejs.org/docs/latest/api/worker_threads.html#worker_threads_ismainthread">Worker Threads - isMainThread - Node.js</a></strong> - Verificar thread principal</p>
</blockquote>
<h3>7.1 Modelo de Threads em JavaScript</h3>
<p><strong>JavaScript Single-Threaded:</strong>
JavaScript foi projetado como single-threaded para simplicidade:
- Sem locks necessÃ¡rios
- Sem race conditions no cÃ³digo JavaScript
- Event loop simples</p>
<p><strong>LimitaÃ§Ã£o:</strong>
- NÃ£o pode aproveitar mÃºltiplos cores para CPU-bound tasks
- OperaÃ§Ãµes pesadas bloqueiam UI</p>
<p><strong>SoluÃ§Ã£o: Web Workers (HTML5, 2010)</strong></p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncia Oficial MDN:</strong><br />
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">Web Workers API - MDN Web Docs</a><br />
A documentaÃ§Ã£o completa do MDN cobre todos os aspectos dos Web Workers, incluindo tipos de workers, ciclo de vida, comunicaÃ§Ã£o e limitaÃ§Ãµes.</p>
</blockquote>
<h3>7.2 Arquitetura de Web Workers</h3>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias MDN:</strong>
- <a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker">Worker - Interface Principal</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/API/WorkerGlobalScope">WorkerGlobalScope - Contexto do Worker</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/API/DedicatedWorkerGlobalScope">DedicatedWorkerGlobalScope - Worker Dedicado</a></p>
</blockquote>
<p><strong>Isolamento de MemÃ³ria:</strong></p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Main Thread                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Heap prÃ³prio                 â”‚  â”‚
â”‚  â”‚  Stack prÃ³prio                â”‚  â”‚
â”‚  â”‚  Sem acesso a DOM             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ postMessage (cÃ³pia)
           â”‚ ou SharedArrayBuffer
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Worker Thread                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Heap isolado                 â”‚  â”‚
â”‚  â”‚  Stack isolado                â”‚  â”‚
â”‚  â”‚  Sem acesso a DOM             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Vantagens do Isolamento:</strong>
- <strong>SeguranÃ§a:</strong> Workers nÃ£o podem acessar DOM (prevenÃ§Ã£o de XSS)
- <strong>Estabilidade:</strong> Crash de worker nÃ£o afeta main thread
- <strong>Simplicidade:</strong> Sem necessidade de locks no cÃ³digo JavaScript</p>
<p><strong>Desvantagens:</strong>
- <strong>ComunicaÃ§Ã£o:</strong> Overhead de serializaÃ§Ã£o
- <strong>MemÃ³ria:</strong> Cada worker tem heap prÃ³prio (~10-50MB)</p>
<h3>7.3 Modelo de ComunicaÃ§Ã£o: Message Passing</h3>
<p><strong>PadrÃ£o Actor Model:</strong>
Web Workers implementam uma versÃ£o do <strong>Actor Model</strong> (Hewitt, 1973):</p>
<p><strong>Atores:</strong>
- Main thread = Actor principal
- Workers = Atores secundÃ¡rios</p>
<p><strong>Regras:</strong>
1. Atores comunicam apenas via mensagens
2. Cada ator processa uma mensagem por vez
3. NÃ£o hÃ¡ memÃ³ria compartilhada (sem SharedArrayBuffer)</p>
<p><strong>Com SharedArrayBuffer:</strong>
- Permite memÃ³ria compartilhada
- Requer sincronizaÃ§Ã£o explÃ­cita (Atomics)
- Modelo hÃ­brido: Actor + Shared Memory</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncia MDN:</strong><br />
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage">Worker.postMessage() - MÃ©todo de ComunicaÃ§Ã£o</a><br />
A documentaÃ§Ã£o MDN explica em detalhes como <code>postMessage()</code> funciona, incluindo transferÃªncia de objetos transferÃ­veis, clonagem estruturada e tratamento de erros.</p>
</blockquote>
<h3>7.4 AnÃ¡lise de Overhead</h3>
<p><strong>CriaÃ§Ã£o de Worker:</strong>
- Tempo: ~10-50ms
- MemÃ³ria: ~10-50MB por worker
- Custo: Alto para workers de curta duraÃ§Ã£o</p>
<p><strong>ComunicaÃ§Ã£o (postMessage):</strong>
- SerializaÃ§Ã£o: O(n) onde n = tamanho dos dados
- CÃ³pia: O(n) tempo, O(n) espaÃ§o
- LatÃªncia: ~1-5ms para dados pequenos</p>
<p><strong>ComunicaÃ§Ã£o (SharedArrayBuffer):</strong>
- Sem serializaÃ§Ã£o: O(1)
- Sem cÃ³pia: O(1)
- LatÃªncia: ~0.001ms (escrita direta na memÃ³ria)</p>
<blockquote>
<p><strong>ğŸ“š ReferÃªncias MDN:</strong>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer">SharedArrayBuffer - MemÃ³ria Compartilhada</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics">Atomics - OperaÃ§Ãµes AtÃ´micas</a>
- <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers#transferable_objects">Transferable Objects - Objetos TransferÃ­veis</a></p>
</blockquote>
<p><strong>RecomendaÃ§Ã£o:</strong>
- <strong>Dados pequenos (&lt; 1MB):</strong> postMessage Ã© suficiente
- <strong>Dados grandes (&gt; 1MB):</strong> SharedArrayBuffer Ã© essencial
- <strong>Alta frequÃªncia:</strong> SharedArrayBuffer reduz overhead significativamente</p>
<h3>7.5 Paralelismo Real vs ConcorrÃªncia: AnÃ¡lise Profunda</h3>
<p><strong>Conceito Fundamental:</strong>
Paralelismo verdadeiro requer que mÃºltiplas operaÃ§Ãµes executem <strong>simultaneamente</strong> em diferentes cores de CPU. ConcorrÃªncia permite que mÃºltiplas operaÃ§Ãµes <strong>compartilhem</strong> o mesmo recurso, alternando execuÃ§Ã£o.</p>
<p><strong>No Contexto de Web Workers:</strong></p>
<p><strong>1. Paralelismo Real:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 4 workers executando simultaneamente em 4 cores diferentes</span>
<span class="nx">Worker</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">(</span><span class="nx">Core</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="err">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span class="p">]</span><span class="w"> </span><span class="nx">Processando</span><span class="w"> </span><span class="nx">pÃ¡ginas</span><span class="w"> </span><span class="mf">1</span><span class="o">-</span><span class="mf">250</span>
<span class="nx">Worker</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">(</span><span class="nx">Core</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="err">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span class="p">]</span><span class="w"> </span><span class="nx">Processando</span><span class="w"> </span><span class="nx">pÃ¡ginas</span><span class="w"> </span><span class="mf">251</span><span class="o">-</span><span class="mf">500</span>
<span class="nx">Worker</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">(</span><span class="nx">Core</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="err">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span class="p">]</span><span class="w"> </span><span class="nx">Processando</span><span class="w"> </span><span class="nx">pÃ¡ginas</span><span class="w"> </span><span class="mf">501</span><span class="o">-</span><span class="mf">750</span>
<span class="nx">Worker</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">(</span><span class="nx">Core</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="err">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span class="p">]</span><span class="w"> </span><span class="nx">Processando</span><span class="w"> </span><span class="nx">pÃ¡ginas</span><span class="w"> </span><span class="mf">751</span><span class="o">-</span><span class="mf">1000</span>
</code></pre></div>

<p><strong>Speedup TeÃ³rico:</strong>
- Com 4 cores: atÃ© 4x mais rÃ¡pido (ideal)
- Na prÃ¡tica: ~2.5-3x devido a overhead</p>
<p><strong>2. ConcorrÃªncia (Sem Paralelismo):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 4 workers compartilhando 1 core (time-slicing)</span>
<span class="nx">Core</span><span class="w"> </span><span class="mf">0</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">Worker0</span><span class="p">][</span><span class="nx">Worker1</span><span class="p">][</span><span class="nx">Worker2</span><span class="p">][</span><span class="nx">Worker3</span><span class="p">][</span><span class="nx">Worker0</span><span class="p">]...</span>
<span class="w">       </span><span class="nx">Alternando</span><span class="w"> </span><span class="nx">execuÃ§Ã£o</span><span class="w"> </span><span class="nx">rapidamente</span>
</code></pre></div>

<p><strong>Speedup Real:</strong>
- Com 1 core: ~1x (sem ganho real)
- Overhead adicional de troca de contexto</p>
<p><strong>Como Verificar Paralelismo Real:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Mede tempo de execuÃ§Ã£o paralela vs sequencial</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">measureParallelism</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">hardwareConcurrency</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">4</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Sequencial</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">startSeq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">processChunk</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">timeSeq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startSeq</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Paralelo</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">startPar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
<span class="w">    </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">processChunk</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">timePar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startPar</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">speedup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">timeSeq</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">timePar</span><span class="p">;</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Speedup: </span><span class="si">${</span><span class="nx">speedup</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">x`</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Se speedup â‰ˆ numWorkers: paralelismo real</span>
<span class="w">  </span><span class="c1">// Se speedup â‰ˆ 1: apenas concorrÃªncia</span>
<span class="p">};</span>
</code></pre></div>

<h3>7.6 Modelo de MemÃ³ria Compartilhada: Detalhes TÃ©cnicos</h3>
<p><strong>Arquitetura de MemÃ³ria no Projeto:</strong></p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">              </span><span class="nv">Main</span><span class="w"> </span><span class="nv">Thread</span><span class="w"> </span><span class="ss">(</span><span class="nv">Heap</span><span class="w"> </span><span class="nv">Isolado</span><span class="ss">)</span><span class="w">                 </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">sharedBuffer</span>:<span class="w"> </span><span class="nv">SharedArrayBuffer</span><span class="w"> </span><span class="ss">(</span><span class="nv">refer</span>Ãª<span class="nv">ncia</span><span class="ss">)</span><span class="w">    </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">atomicView</span>:<span class="w"> </span><span class="nv">Int32Array</span><span class="w"> </span><span class="ss">(</span><span class="nv">view</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">buffer</span><span class="ss">)</span><span class="w">          </span>â”‚<span class="w">  </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">  </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">                        </span>â”‚
<span class="w">                        </span>â”‚<span class="w"> </span><span class="nv">Refer</span>Ãª<span class="nv">ncia</span><span class="w"> </span><span class="nv">compartilhada</span>
<span class="w">                        </span>â”‚<span class="w"> </span><span class="ss">(</span><span class="nv">mesmo</span><span class="w"> </span><span class="nv">buffer</span><span class="w"> </span><span class="nv">f</span>Ã­<span class="nv">sico</span><span class="ss">)</span>
<span class="w">                        </span>â”‚
<span class="w">        </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">        </span>â”‚<span class="w">               </span>â”‚<span class="w">               </span>â”‚
<span class="w">        </span>â–¼<span class="w">               </span>â–¼<span class="w">               </span>â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w"> </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w"> </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w"> </span><span class="nv">Worker</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">Worker</span><span class="w"> </span><span class="mi">1</span><span class="w">     </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">Worker</span><span class="w"> </span><span class="mi">2</span><span class="w">     </span>â”‚
â”‚<span class="w">              </span>â”‚<span class="w"> </span>â”‚<span class="w">              </span>â”‚<span class="w"> </span>â”‚<span class="w">              </span>â”‚
â”‚<span class="w"> </span><span class="nv">Heap</span><span class="w"> </span><span class="nv">Isolado</span><span class="w"> </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">Heap</span><span class="w"> </span><span class="nv">Isolado</span><span class="w"> </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">Heap</span><span class="w"> </span><span class="nv">Isolado</span><span class="w"> </span>â”‚
â”‚<span class="w">              </span>â”‚<span class="w"> </span>â”‚<span class="w">              </span>â”‚<span class="w"> </span>â”‚<span class="w">              </span>â”‚
â”‚<span class="w"> </span><span class="nv">atomicView</span>:<span class="w">  </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">atomicView</span>:<span class="w">  </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">atomicView</span>:<span class="w">  </span>â”‚
â”‚<span class="w"> </span><span class="nv">Int32Array</span><span class="w">   </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">Int32Array</span><span class="w">   </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="nv">Int32Array</span><span class="w">   </span>â”‚
â”‚<span class="w"> </span><span class="ss">(</span><span class="nv">mesma</span><span class="w">       </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="ss">(</span><span class="nv">mesma</span><span class="w">       </span>â”‚<span class="w"> </span>â”‚<span class="w"> </span><span class="ss">(</span><span class="nv">mesma</span><span class="w">       </span>â”‚
â”‚<span class="w">  </span><span class="nv">refer</span>Ãª<span class="nv">ncia</span><span class="ss">)</span><span class="w"> </span>â”‚<span class="w"> </span>â”‚<span class="w">  </span><span class="nv">refer</span>Ãª<span class="nv">ncia</span><span class="ss">)</span><span class="w"> </span>â”‚<span class="w"> </span>â”‚<span class="w">  </span><span class="nv">refer</span>Ãª<span class="nv">ncia</span><span class="ss">)</span><span class="w"> </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w"> </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w"> </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">        </span>â”‚<span class="w">               </span>â”‚<span class="w">               </span>â”‚
<span class="w">        </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">                        </span>â”‚
<span class="w">                        </span>â–¼
<span class="w">        </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">        </span>â”‚<span class="w">   </span><span class="nv">Mem</span>Ã³<span class="nv">ria</span><span class="w"> </span><span class="nv">F</span>Ã­<span class="nv">sica</span><span class="w"> </span><span class="nv">Compartilhada</span><span class="w"> </span>â”‚
<span class="w">        </span>â”‚<span class="w">   </span><span class="ss">(</span><span class="nv">SharedArrayBuffer</span><span class="ss">)</span><span class="w">          </span>â”‚
<span class="w">        </span>â”‚<span class="w">                                </span>â”‚
<span class="w">        </span>â”‚<span class="w">  </span>[<span class="mi">0</span><span class="o">-</span><span class="mi">3</span>]:<span class="w"> </span><span class="nv">writeIndex</span><span class="w"> </span><span class="ss">(</span><span class="nv">Uint32</span><span class="ss">)</span><span class="w">   </span>â”‚
<span class="w">        </span>â”‚<span class="w">  </span>[<span class="mi">4</span><span class="o">-</span><span class="mi">7</span>]:<span class="w"> </span><span class="nv">completedWorkers</span><span class="w">       </span>â”‚
<span class="w">        </span>â”‚<span class="w">  </span>[<span class="mi">8</span><span class="o">+</span>]:<span class="w">  </span><span class="nv">Dados</span><span class="w"> </span><span class="nv">das</span><span class="w"> </span><span class="nv">cidades</span><span class="w">      </span>â”‚
<span class="w">        </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>OperaÃ§Ãµes AtÃ´micas: Compare-and-Swap (CAS)</strong></p>
<p>CAS Ã© a operaÃ§Ã£o fundamental para sincronizaÃ§Ã£o lock-free:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// PseudocÃ³digo de CAS</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">compareAndSwap</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">newValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// OperaÃ§Ã£o atÃ´mica (hardware-level)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newValue</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">expected</span><span class="p">;</span><span class="w"> </span><span class="c1">// Sucesso</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span><span class="w"> </span><span class="c1">// Falhou, retorna valor atual</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Uso no projeto: reservar espaÃ§o no buffer</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">newIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">citySize</span><span class="p">;</span>

<span class="c1">// Tenta reservar espaÃ§o</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span>
<span class="w">  </span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">expectedIndex</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">newIndex</span>
<span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Sucesso: espaÃ§o reservado exclusivamente para este worker</span>
<span class="w">  </span><span class="c1">// Pode escrever com seguranÃ§a</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Outro worker escreveu primeiro, tenta novamente</span>
<span class="w">  </span><span class="c1">// Loop atÃ© conseguir reservar</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Por Que CAS Ã© Essencial?</strong></p>
<p>Sem CAS, terÃ­amos race conditions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// âŒ CÃ“DIGO INSEGURO (sem CAS)</span>
<span class="c1">// Worker 0 e Worker 1 executam simultaneamente:</span>

<span class="c1">// Worker 0:</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">atomicView</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span><span class="w">  </span><span class="c1">// LÃª: index = 100</span>
<span class="c1">// [Worker 1 executa aqui e escreve: atomicView[0] = 150]</span>
<span class="nx">atomicView</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">50</span><span class="p">;</span><span class="w">  </span><span class="c1">// Escreve: 150 (sobrescreve!)</span>

<span class="c1">// Resultado: dados corrompidos, cidades perdidas</span>
</code></pre></div>

<p>Com CAS:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// âœ… CÃ“DIGO SEGURO (com CAS)</span>
<span class="c1">// Worker 0:</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// LÃª: 100</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">newValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">50</span><span class="p">;</span>

<span class="c1">// CAS garante que ninguÃ©m escreveu entre a leitura e escrita</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">newValue</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actual</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Sucesso: espaÃ§o reservado exclusivamente</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Outro worker escreveu primeiro, tenta novamente com novo valor</span>
<span class="p">}</span>
</code></pre></div>

<h3>7.7 AnÃ¡lise de Performance: Workers vs Sequencial</h3>
<p><strong>CenÃ¡rio: Coletar 10.000 cidades (1.000 pÃ¡ginas, 10 cidades/pÃ¡gina)</strong></p>
<p><strong>Abordagem Sequencial:</strong></p>
<div class="codehilite"><pre><span></span><code>Tempo total = 1000 pÃ¡ginas Ã— 2.5s/pÃ¡gina = 2.500s â‰ˆ 41 minutos
</code></pre></div>

<p><strong>Abordagem Paralela (4 workers):</strong></p>
<div class="codehilite"><pre><span></span><code>Tempo por worker = 250 pÃ¡ginas Ã— 2.5s/pÃ¡gina = 625s
Tempo total = max(625s) + overhead â‰ˆ 650s â‰ˆ 11 minutos

Speedup = 2500s / 650s â‰ˆ 3.85x
</code></pre></div>

<p><strong>Breakdown de Overhead:</strong></p>
<ol>
<li><strong>CriaÃ§Ã£o de Workers:</strong> 4 Ã— 20ms = 80ms (desprezÃ­vel)</li>
<li><strong>ComunicaÃ§Ã£o:</strong> ~1ms por mensagem Ã— 1000 mensagens = 1s (desprezÃ­vel)</li>
<li><strong>SincronizaÃ§Ã£o CAS:</strong> ~0.001ms por operaÃ§Ã£o Ã— 10.000 operaÃ§Ãµes = 10ms (desprezÃ­vel)</li>
<li><strong>SerializaÃ§Ã£o:</strong> O(n) mas paralelizada, overhead mÃ­nimo</li>
</ol>
<p><strong>ConclusÃ£o:</strong> Overhead Ã© mÃ­nimo comparado ao tempo de I/O (requisiÃ§Ãµes HTTP).</p>
<h3>7.8 PadrÃµes de ParalelizaÃ§Ã£o no Projeto</h3>
<p><strong>1. Data Parallelism (Paralelismo de Dados):</strong></p>
<p>Cada worker processa um subconjunto diferente dos dados:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// DivisÃ£o de trabalho</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">totalPages</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">startPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">endPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">((</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">totalPages</span><span class="p">);</span>

<span class="w">  </span><span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">    </span><span class="nx">startPage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">endPage</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// Cada worker processa pÃ¡ginas diferentes</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Vantagens:</strong>
- Trabalho bem distribuÃ­do
- Sem dependÃªncias entre workers
- EscalÃ¡vel linearmente</p>
<p><strong>2. Task Parallelism (Paralelismo de Tarefas):</strong></p>
<p>No K-Means, diferentes workers calculam distÃ¢ncias para diferentes pontos:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Cada worker calcula distÃ¢ncias para um subconjunto de pontos</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">pointsPerWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pointsPerWorker</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">((</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pointsPerWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">  </span><span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;assign_points&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">points</span><span class="o">:</span><span class="w"> </span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="c1">// Todos os pontos (read-only)</span>
<span class="w">    </span><span class="nx">centroids</span><span class="o">:</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="c1">// Todos os centroides (read-only)</span>
<span class="w">    </span><span class="nx">startIndex</span><span class="p">,</span>
<span class="w">    </span><span class="nx">endIndex</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>CaracterÃ­sticas:</strong>
- Dados de entrada compartilhados (read-only)
- Resultados independentes
- CombinaÃ§Ã£o simples (concatenaÃ§Ã£o)</p>
<h3>7.9 LimitaÃ§Ãµes e ConsideraÃ§Ãµes PrÃ¡ticas</h3>
<p><strong>1. NÃºmero Ã“timo de Workers:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// FÃ³rmula empÃ­rica</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">optimalWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span>
<span class="w">  </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">hardwareConcurrency</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="c1">// NÃºmero de cores</span>
<span class="w">  </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">totalWork</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">workPerWorker</span><span class="p">),</span><span class="w"> </span><span class="c1">// Trabalho disponÃ­vel</span>
<span class="w">  </span><span class="mf">8</span><span class="w"> </span><span class="c1">// Limite prÃ¡tico (overhead cresce muito alÃ©m disso)</span>
<span class="p">);</span>
</code></pre></div>

<p><strong>Por que nÃ£o usar todos os cores disponÃ­veis?</strong></p>
<ul>
<li>Overhead de comunicaÃ§Ã£o cresce</li>
<li>ContenÃ§Ã£o no buffer compartilhado aumenta</li>
<li>Sistema operacional precisa de cores para outras tarefas</li>
</ul>
<p><strong>2. Balanceamento de Carga:</strong></p>
<p>Problema: Se trabalho nÃ£o Ã© uniformemente distribuÃ­do, alguns workers terminam antes.</p>
<p>SoluÃ§Ã£o no projeto: DivisÃ£o igual de pÃ¡ginas (assumindo tempo similar por pÃ¡gina).</p>
<p><strong>Melhoria possÃ­vel:</strong> Work-stealing (workers que terminam ajudam outros).</p>
<p><strong>3. Falhas e RecuperaÃ§Ã£o:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">worker</span><span class="p">.</span><span class="nx">onerror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">workerId</span><span class="si">}</span><span class="sb"> falhou:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// OpÃ§Ãµes:</span>
<span class="w">  </span><span class="c1">// 1. Retry com novo worker</span>
<span class="w">  </span><span class="c1">// 2. Redistribuir trabalho para outros workers</span>
<span class="w">  </span><span class="c1">// 3. Abortar toda a operaÃ§Ã£o</span>
<span class="p">};</span>
</code></pre></div>

<p>No projeto: Workers continuam mesmo se algumas pÃ¡ginas falharem (resiliÃªncia).</p>
<h3>7.10 ExercÃ­cios PrÃ¡ticos</h3>
<h4>ExercÃ­cio 1: Criar e Comunicar com Web Worker</h4>
<p><strong>Objetivo:</strong> Implementar comunicaÃ§Ã£o bÃ¡sica entre main thread e worker.</p>
<p><strong>Tarefa:</strong> Crie um worker que recebe um nÃºmero e retorna seu quadrado.</p>
<p><strong>Arquivo: <code>squareWorker.js</code> (Worker):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente o worker</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Recebe nÃºmero do main thread</span>
<span class="w">  </span><span class="c1">// Calcula quadrado</span>
<span class="w">  </span><span class="c1">// Envia resultado de volta</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>Arquivo: <code>main.js</code> (Main Thread):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Crie worker e comunique com ele</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">// Crie worker aqui</span>
<span class="c1">// Envie nÃºmero 5</span>
<span class="c1">// Receba resultado e console.log</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o - Worker</summary>


<div class="codehilite"><pre><span></span><code><span class="c1">// squareWorker.js</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">squared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">squared</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>



**ReferÃªncia:** [WorkerGlobalScope.onmessage - MDN](https://developer.mozilla.org/en-US/docs/Web/API/WorkerGlobalScope/onmessage)
</details>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o - Main Thread</summary>


<div class="codehilite"><pre><span></span><code><span class="c1">// main.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="s1">&#39;squareWorker.js&#39;</span><span class="p">);</span>

<span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Resultado:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="mf">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// Envia 5, recebe 25</span>
</code></pre></div>



**ReferÃªncias:**
- [Worker Constructor - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Worker/Worker)
- [Worker.postMessage() - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage)
- [Worker.terminate() - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Worker/terminate)
</details>

<h4>ExercÃ­cio 2: Processar Array em Paralelo com Workers</h4>
<p><strong>Objetivo:</strong> Dividir processamento de array grande entre mÃºltiplos workers.</p>
<p><strong>Tarefa:</strong> Crie funÃ§Ã£o que processa array de nÃºmeros (calcular quadrado) usando 4 workers.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente processArrayParallel</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">processArrayParallel</span><span class="p">(</span><span class="nx">numbers</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 1. Divide array em chunks</span>
<span class="w">  </span><span class="c1">// 2. Cria workers</span>
<span class="w">  </span><span class="c1">// 3. Processa chunks em paralelo</span>
<span class="w">  </span><span class="c1">// 4. Combina resultados</span>
<span class="w">  </span><span class="c1">// 5. Retorna array processado</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">processArrayParallel</span><span class="p">(</span><span class="nx">numbers</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunkSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">numbers</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="c1">// Divide em chunks</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numbers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">numbers</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Cria workers e processa chunks</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">promises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">chunk</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="s1">&#39;processChunkWorker.js&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="w"> </span><span class="nx">chunk</span><span class="p">,</span><span class="w"> </span><span class="nx">workerId</span><span class="o">:</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Aguarda todos e combina</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">flat</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Worker: processChunkWorker.js</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chunk</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">processed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunk</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">n</span><span class="p">);</span>
<span class="w">  </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">processed</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>



**ReferÃªncias:**
- [Promise.all() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all)
- [Array.flat() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/flat)
</details>

<h4>ExercÃ­cio 3: Usar SharedArrayBuffer com Workers</h4>
<p><strong>Objetivo:</strong> Implementar contador compartilhado usando SharedArrayBuffer e Atomics.</p>
<p><strong>Tarefa:</strong> Crie sistema onde mÃºltiplos workers incrementam contador compartilhado.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TAREFA: Implemente contador compartilhado</span>
<span class="c1">// Main thread: cria SharedArrayBuffer e workers</span>
<span class="c1">// Workers: incrementam contador atomicamente</span>
<span class="c1">// Main thread: lÃª valor final</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="c1">// main.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="p">(</span><span class="mf">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4 bytes para Int32</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">);</span>
<span class="nb">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Inicializa com 0</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">incrementsPerWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">promises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="s1">&#39;incrementWorker.js&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">promise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">resolve</span><span class="p">();</span>
<span class="w">      </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">    </span><span class="nx">sharedBuffer</span><span class="p">,</span>
<span class="w">    </span><span class="nx">increments</span><span class="o">:</span><span class="w"> </span><span class="nx">incrementsPerWorker</span><span class="p">,</span>
<span class="w">    </span><span class="nx">workerId</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">workers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">worker</span><span class="p">);</span>
<span class="w">  </span><span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">promise</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">finalValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Valor final: </span><span class="si">${</span><span class="nx">finalValue</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4000 (4 workers Ã— 1000)</span>

<span class="c1">// Worker: incrementWorker.js</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">increments</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">increments</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>



**ReferÃªncias:**
- [SharedArrayBuffer - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer)
- [Atomics.add() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/add)
- [Atomics.load() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/load)
</details>

<hr />
<h3>7.11 ExercÃ­cios AvanÃ§ados: Workers, MemÃ³ria Compartilhada e Derivadas Conceituais</h3>
<blockquote>
<p><strong>Objetivo do capÃ­tulo:</strong> Trazer exercÃ­cios que faÃ§am o aluno raciocinar sobre <em>derivadas conceituais</em> na construÃ§Ã£o de workers, explicando cada passo como um professor dissertaria sobre derivadas em cÃ¡lculo: â€œqual influÃªncia do passo, por que elegemos aquele operador, qual Ã© a taxa de variaÃ§Ã£oâ€.</p>
</blockquote>
<h4>ExercÃ­cio 4: Taxa de VariaÃ§Ã£o de Produtividade dos Workers</h4>
<p><strong>Contexto:</strong> Em cÃ¡lculo, derivada mede taxa de variaÃ§Ã£o instantÃ¢nea. Aqui aplicamos a mesma ideia a workers: quanto a produtividade (pÃ¡ginas por segundo) muda quando adicionamos um worker?</p>
<p><strong>Tarefa:</strong> Escreva funÃ§Ã£o <code>measureWorkerDelta(baseTime, numWorkers)</code> que retorna a â€œderivadaâ€ aproximada <code>(T(p) - T(p-1))</code>, explicando cada termo em linguagem conceitual. Use <code>numWorkers</code> atÃ© 4 e suponha <code>T(p) = baseTime / p + overhead</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">measureWorkerDelta</span><span class="p">(</span><span class="nx">baseTime</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Explique: baseTime representa tempo sequencial (p=1)</span>
<span class="w">  </span><span class="c1">// Overhead Ã© o custo fixo de sincronizaÃ§Ã£o</span>
<span class="w">  </span><span class="c1">// Derivada discreta: Î”T = T(p) - T(p - 1)</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">measureWorkerDelta</span><span class="p">(</span><span class="nx">baseTime</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">overhead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.05</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">baseTime</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5% de overhead fixo</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">p</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">Tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseTime</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">overhead</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">Tprev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">baseTime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">overhead</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">baseTime</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">overhead</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Tp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Tprev</span><span class="p">;</span>
<span class="w">    </span><span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">workers</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">,</span>
<span class="w">      </span><span class="nx">time</span><span class="o">:</span><span class="w"> </span><span class="nx">Tp</span><span class="p">,</span>
<span class="w">      </span><span class="nx">delta</span><span class="p">,</span>
<span class="w">      </span><span class="nx">explanation</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;Base: sem derivada anterior&quot;</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="sb">`Derivada discreta Î”T = T(</span><span class="si">${</span><span class="nx">p</span><span class="si">}</span><span class="sb">) - T(</span><span class="si">${</span><span class="nx">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">) = </span><span class="si">${</span><span class="nx">delta</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">3</span><span class="p">)</span><span class="si">}</span><span class="sb">s`</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">results</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">deltas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">measureWorkerDelta</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">deltas</span><span class="p">);</span>
</code></pre></div>



**ExplicaÃ§Ã£o analogia com derivada:** O aluno deve perceber que `delta` representa a variaÃ§Ã£o de tempo ao adicionar um worker, igual a `f(x + Î”x) - f(x)` em cÃ¡lculo. O â€œprofessorâ€ explica o porquÃª do overhead, o que significa `baseTime / p`, e como isso equivale a â€œinclinaÃ§Ã£oâ€ da curva de speedup.

**ReferÃªncias:**  
 - [MDN: SharedArrayBuffer - DocumentaÃ§Ã£o](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer)  
 - [MDN: Worker Threads - Node.js](https://nodejs.org/docs/latest/api/worker_threads.html)  
</details>

<h4>ExercÃ­cio 5: Derivada do Overhead em Casos de ContenÃ§Ã£o</h4>
<p><strong>Objetivo:</strong> Mostrar como o overhead aumenta com retries. Derivada aqui significa taxa de crescimento do overhead em funÃ§Ã£o do nÃºmero de CAS falhados.</p>
<p><strong>Tarefa:</strong> Implemente <code>overheadGrowth(numRetries)</code> que calcula <code>overhead = baseOverhead Ã— (1 + numRetries Ã— retryPenalty)</code> e retorna o incremento relativo <code>overhead - baseOverhead</code>. Explique como cada retry aumenta a â€œinclinaÃ§Ã£oâ€ da curva de overhead.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">overheadGrowth</span><span class="p">(</span><span class="nx">numRetries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// baseOverhead = 0.02 (2% do tempo total)</span>
<span class="w">  </span><span class="c1">// retryPenalty = 0.015 (1.5% por retry)</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">overheadGrowth</span><span class="p">(</span><span class="nx">numRetries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseOverhead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.02</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">retryPenalty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.015</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">overhead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseOverhead</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">numRetries</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">retryPenalty</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">growth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">overhead</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">baseOverhead</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">numRetries</span><span class="p">,</span>
<span class="w">    </span><span class="nx">overhead</span><span class="p">,</span>
<span class="w">    </span><span class="nx">growth</span><span class="p">,</span>
<span class="w">    </span><span class="nx">explanation</span><span class="o">:</span><span class="w"> </span><span class="sb">`Cada retry adiciona </span><span class="si">${</span><span class="nx">retryPenalty</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="si">}</span><span class="sb">% ao overhead base, totalizando </span><span class="si">${</span><span class="nx">growth</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">3</span><span class="p">)</span><span class="si">}</span><span class="sb">.`</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">overheadGrowth</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">table</span><span class="p">);</span>
</code></pre></div>



**ExplicaÃ§Ã£o didÃ¡tica:** O professor explica que o overhead Ã© uma funÃ§Ã£o `f(x) = baseOverhead Ã— (1 + x Ã— penalty)`. A derivada discreta `Î”f` Ã© o crescimento adicional a cada retry, ilustrando como a curva torna-se mais inclinada com contenÃ§Ã£o.

#### ExercÃ­cio 6: Derivada da AtualizaÃ§Ã£o de SharedArrayBuffer

**Objetivo:** Mostrar que cada atualizaÃ§Ã£o recolhe uma variaÃ§Ã£o incremental do Ã­ndice de escrita, como derivada de posiÃ§Ã£o.

**Tarefa:** Baseado no pseudocÃ³digo CAS do capÃ­tulo anterior, explique passo a passo como `Atomics.compareExchange` garante que o â€œÃ­ndice acumuladoâ€ evolui de forma controlada. Crie funÃ§Ã£o `describeCASProgress(iterations)` que simula vÃ¡rias execuÃ§Ãµes e imprime explicaÃ§Ãµes estilo professor para cada etapa.

<details>
<summary>ğŸ’¡ SoluÃ§Ã£o</summary>


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">describeCASProgress</span><span class="p">(</span><span class="nx">iterations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">descriptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">iterations</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">increment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">50</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">increment</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.3</span><span class="p">;</span><span class="w"> </span><span class="c1">// simula contenÃ§Ã£o</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">success</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">explanation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">success</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;CAS bem-sucedido: variaÃ§Ã£o incremental = +50 (derivada positiva controlada)&quot;</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;CAS falhou: outro worker jÃ¡ moveu o Ã­ndice, temos que recomputar (derivada ajustada)&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newValue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">actual</span><span class="p">;</span><span class="w"> </span><span class="c1">// o Ã­ndice foi atualizado por outro worker</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">descriptions</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">iteration</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="nx">expected</span><span class="p">,</span>
<span class="w">      </span><span class="nx">actual</span><span class="p">,</span>
<span class="w">      </span><span class="nx">explanation</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">descriptions</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">describeCASProgress</span><span class="p">(</span><span class="mf">5</span><span class="p">));</span>
</code></pre></div>



**ExplicaÃ§Ã£o:** Cada loop representa uma derivada discreta do Ã­ndice (`Î”index`). A â€œtaxa de variaÃ§Ã£oâ€ Ã© controlada pela condiÃ§Ã£o `success`, e o professor descreve como a comparaÃ§Ã£o garante monotonicidade e evita saltos bruscos.

**ReferÃªncia:**  
 - [Atomics.compareExchange() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/compareExchange)  
 - [Concurrency model and Event Loop - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Event_loop)


<a id="capÃ­tulo-8-serializaÃ§Ã£o-de-dados---teoria-de-codificaÃ§Ã£o"></a>
## ğŸ“š CapÃ­tulo 8: SerializaÃ§Ã£o de Dados - Teoria de CodificaÃ§Ã£o

### ğŸ“– DefiniÃ§Ãµes de Conceitos

**SerializaÃ§Ã£o:** O processo de converter uma estrutura de dados ou objeto em um formato que pode ser armazenado ou transmitido e depois reconstruÃ­do (deserializado). Em JavaScript, JSON Ã© o formato de serializaÃ§Ã£o mais comum.

**JSON (JavaScript Object Notation):** Um formato de dados leve e legÃ­vel por humanos baseado em texto, usado para representar objetos JavaScript. JSON suporta strings, nÃºmeros, booleanos, null, arrays e objetos aninhados, mas nÃ£o funÃ§Ãµes ou sÃ­mbolos.

**JSON.stringify():** Um mÃ©todo JavaScript que converte um objeto JavaScript em uma string JSON. Permite serializar objetos complexos, arrays e valores primitivos em formato JSON vÃ¡lido.

**JSON.parse():** Um mÃ©todo JavaScript que converte uma string JSON em um objeto JavaScript. Ã‰ o processo inverso de JSON.stringify(), reconstruindo objetos a partir de sua representaÃ§Ã£o JSON.

**TextEncoder:** Uma API web que converte strings JavaScript em sequÃªncias de bytes usando codificaÃ§Ã£o UTF-8. Ãštil para serializar texto em formatos binÃ¡rios como ArrayBuffer ou TypedArray.

**TextDecoder:** Uma API web que converte sequÃªncias de bytes (ArrayBuffer, TypedArray) em strings JavaScript usando uma codificaÃ§Ã£o especÃ­fica (geralmente UTF-8). Ã‰ o processo inverso de TextEncoder.

**Structured Clone Algorithm:** O algoritmo usado pelo JavaScript para clonar objetos complexos ao transferir dados entre threads (Web Workers) ou ao usar APIs como postMessage(). Suporta objetos, arrays, Maps, Sets, TypedArrays, mas nÃ£o funÃ§Ãµes ou sÃ­mbolos.

**DeserializaÃ§Ã£o:** O processo inverso da serializaÃ§Ã£o, onde dados serializados sÃ£o convertidos de volta para sua forma original (objetos, estruturas de dados). Em JavaScript, JSON.parse() Ã© usado para deserializar strings JSON.

**Length-Prefixed Format:** Um formato de serializaÃ§Ã£o onde cada registro Ã© precedido por seu tamanho em bytes. Permite leitura sequencial eficiente sem delimitadores especiais e permite pular registros sem ler seu conteÃºdo.

> **ğŸ“š ReferÃªncias MDN:**
> - [JSON - JavaScript Object Notation](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON)
> - [JSON.stringify()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify)
> - [JSON.parse()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse)
> - [TextEncoder - CodificaÃ§Ã£o de Texto](https://developer.mozilla.org/en-US/docs/Web/API/TextEncoder)
> - [TextDecoder - DecodificaÃ§Ã£o de Texto](https://developer.mozilla.org/en-US/docs/Web/API/TextDecoder)
> - [Structured Clone Algorithm - Clonagem Estruturada](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)

### 8.1 FundamentaÃ§Ã£o: RepresentaÃ§Ã£o de Dados

**Problema Fundamental:**
Como representar objetos JavaScript complexos em formato binÃ¡rio para armazenamento em ArrayBuffer?

**Abordagens:**

1. **JSON (JavaScript Object Notation):**
   - Texto legÃ­vel
   - FÃ¡cil de debugar
   - Overhead alto (~2-3x tamanho binÃ¡rio)

2. **Binary Formats:**
   - Protocol Buffers, MessagePack
   - Compacto
   - Requer schema

3. **Custom Binary Format:**
   - Otimizado para caso especÃ­fico
   - MÃ¡xima eficiÃªncia
   - Complexidade de implementaÃ§Ã£o

**No Projeto:** Usamos JSON por simplicidade, mas estrutura permite migraÃ§Ã£o futura.

### 8.2 Estrutura de Dados Auto-Descritiva

**Problema:** Como saber onde termina uma cidade e comeÃ§a a prÃ³xima?

**SoluÃ§Ã£o: Length-Prefixed Format**


<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4 bytes  â”‚    N bytes              â”‚
â”‚ (tamanho)â”‚    (dados JSON)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>



**Vantagens:**
- Permite leitura sequencial eficiente
- NÃ£o requer delimitadores especiais
- Permite pular registros sem ler conteÃºdo

**Desvantagens:**
- Overhead de 4 bytes por registro
- Requer leitura sequencial (nÃ£o acesso aleatÃ³rio eficiente)

### 8.3 AnÃ¡lise de EficiÃªncia

**Tamanho MÃ©dio de Cidade (JSON):**

<div class="codehilite"><pre><span></span><code>{
  &quot;id&quot;: 12345,                    // ~5 bytes
  &quot;name&quot;: &quot;SÃ£o Paulo&quot;,            // ~10 bytes
  &quot;country&quot;: &quot;Brazil&quot;,            // ~7 bytes
  &quot;latitude&quot;: -23.5505,           // ~10 bytes
  &quot;longitude&quot;: -46.6333,          // ~10 bytes
  &quot;population&quot;: 12300000          // ~11 bytes
  // + overhead JSON (~20 bytes)
}
Total: ~73 bytes por cidade
</code></pre></div>



**Com Length-Prefixed:**
- 4 bytes (tamanho) + 73 bytes (dados) = 77 bytes
- Overhead: 4/77 â‰ˆ 5.2%

**Para 10.000 cidades:**
- Tamanho total: ~770 KB
- Muito menor que limite de SharedArrayBuffer (vÃ¡rios MB)

---

<a id="capÃ­tulo-9-rate-limiting-e-backoff---teoria-de-controle"></a>
## ğŸ“š CapÃ­tulo 9: Rate Limiting e Backoff - Teoria de Controle

### ğŸ“– DefiniÃ§Ãµes de Conceitos

**Rate Limiting:** Uma tÃ©cnica de controle de trÃ¡fego que limita a taxa de requisiÃ§Ãµes que um cliente pode fazer a um servidor em um perÃ­odo de tempo especÃ­fico. Rate limiting previne abuso, protege recursos do servidor e garante uso justo de APIs.

**HTTP 429 (Too Many Requests):** Um cÃ³digo de status HTTP que indica que o cliente excedeu o limite de requisiÃ§Ãµes permitidas. Servidores retornam 429 quando rate limiting Ã© aplicado, geralmente incluindo headers como Retry-After indicando quando o cliente pode tentar novamente.

**Exponential Backoff:** Uma estratÃ©gia de retry onde o tempo de espera entre tentativas aumenta exponencialmente apÃ³s cada falha. A fÃ³rmula geral Ã©: wait_time = base_delay Ã— (2^attempt_number). Previne sobrecarga do servidor e permite recuperaÃ§Ã£o de problemas temporÃ¡rios.

**Retry-After Header:** Um header HTTP que indica ao cliente quanto tempo deve esperar antes de fazer uma nova requisiÃ§Ã£o apÃ³s receber um cÃ³digo 429 (Too Many Requests). Pode ser especificado em segundos ou como uma data/hora.

**Throttling:** O processo de limitar a taxa de execuÃ§Ã£o de operaÃ§Ãµes. Diferente de rate limiting (que Ã© aplicado pelo servidor), throttling pode ser aplicado pelo cliente para evitar exceder limites conhecidos.

**Circuit Breaker Pattern:** Um padrÃ£o de design que previne requisiÃ§Ãµes repetidas a um serviÃ§o que estÃ¡ falhando. ApÃ³s um nÃºmero de falhas, o circuit breaker "abre" e bloqueia requisiÃ§Ãµes subsequentes por um perÃ­odo, permitindo que o serviÃ§o se recupere.

**Jitter:** VariaÃ§Ã£o aleatÃ³ria adicionada ao tempo de backoff para evitar "thundering herd" (quando mÃºltiplos clientes tentam ao mesmo tempo). Jitter distribui tentativas ao longo do tempo, reduzindo picos de carga.

**Token Bucket:** Um algoritmo de rate limiting que mantÃ©m um "balde" de tokens que sÃ£o consumidos por requisiÃ§Ãµes. Tokens sÃ£o repostos a uma taxa fixa. RequisiÃ§Ãµes sÃ³ sÃ£o permitidas se houver tokens disponÃ­veis.

> **ğŸ“š ReferÃªncias:**
> - [HTTP Status Codes - MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
> - [HTTP 429 Too Many Requests](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429)
> - [setTimeout() - MDN](https://developer.mozilla.org/en-US/docs/Web/API/setTimeout)
> - [Promise - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)

### 9.1 Problema: Controle de Taxa de RequisiÃ§Ãµes

**Problema Formal:**
Dado um limite de `R` requisiÃ§Ãµes por segundo, como garantir que nÃ£o excedemos esse limite?

**SoluÃ§Ã£o: Token Bucket Algorithm**

**Algoritmo:**

<div class="codehilite"><pre><span></span><code>bucket = capacidade mÃ¡xima
tokens = bucket

funÃ§Ã£o fazer_requisiÃ§Ã£o():
  enquanto tokens &lt; 1:
    aguardar(1 segundo)
    tokens = min(bucket, tokens + taxa_por_segundo)

  tokens = tokens - 1
  fazer_requisiÃ§Ã£o_http()
</code></pre></div>



**No Projeto (Simplificado):**

<div class="codehilite"><pre><span></span><code><span class="c1">// Delay fixo entre requisiÃ§Ãµes</span>
<span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">2500</span><span class="p">));</span><span class="w"> </span><span class="c1">// 0.4 req/s</span>
</code></pre></div>



**AnÃ¡lise:**
- **Taxa:** 1 requisiÃ§Ã£o a cada 2.5s = 0.4 req/s
- **Margem de seguranÃ§a:** Bem abaixo do limite de 1 req/s
- **Trade-off:** Mais lento, mas garantido

### 9.2 Backoff Exponencial

**Problema:** Como lidar com rate limit quando atingido?

**SoluÃ§Ã£o: Exponential Backoff**

**Algoritmo:**

<div class="codehilite"><pre><span></span><code>wait_time = base_delay Ã— (2^retry_count)
</code></pre></div>



**No Projeto:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">waitTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">15000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span>
<span class="c1">// Retry 1: 15s</span>
<span class="c1">// Retry 2: 30s</span>
<span class="c1">// Retry 3: 45s</span>
<span class="c1">// MÃ¡ximo: 60s</span>
</code></pre></div>



**FundamentaÃ§Ã£o TeÃ³rica:**
Backoff exponencial Ã© usado em:
- **Ethernet CSMA/CD:** DetecÃ§Ã£o de colisÃ£o
- **TCP:** Controle de congestionamento
- **Distributed Systems:** Retry de operaÃ§Ãµes

**Por que Exponencial?**
- Reduz contenÃ§Ã£o exponencialmente
- Permite sistema se recuperar
- Evita "thundering herd" problem

---

<a id="capÃ­tulo-10-arquitetura-mvc---padrÃµes-de-design"></a>
## ğŸ“š CapÃ­tulo 10: Arquitetura MVC - PadrÃµes de Design

### ğŸ“– DefiniÃ§Ãµes de Conceitos

**MVC (Model-View-Controller):** Um padrÃ£o arquitetural que separa uma aplicaÃ§Ã£o em trÃªs componentes principais: Model (dados e lÃ³gica de negÃ³cio), View (interface do usuÃ¡rio) e Controller (coordenaÃ§Ã£o entre Model e View). MVC promove separaÃ§Ã£o de responsabilidades e facilita manutenÃ§Ã£o.

**Model (Modelo):** A camada que representa os dados e a lÃ³gica de negÃ³cio da aplicaÃ§Ã£o. O Model gerencia dados, validaÃ§Ãµes, regras de negÃ³cio e interage com fontes de dados (banco de dados, APIs). Ã‰ independente da interface do usuÃ¡rio.

**View (VisÃ£o):** A camada responsÃ¡vel pela apresentaÃ§Ã£o e interface do usuÃ¡rio. A View exibe dados do Model e captura interaÃ§Ãµes do usuÃ¡rio, mas nÃ£o contÃ©m lÃ³gica de negÃ³cio. Em aplicaÃ§Ãµes web, Views sÃ£o geralmente templates HTML.

**Controller (Controlador):** A camada que atua como intermediÃ¡rio entre Model e View. O Controller recebe entrada do usuÃ¡rio (via View), processa requisiÃ§Ãµes, interage com o Model e atualiza a View. Coordena o fluxo de dados e lÃ³gica da aplicaÃ§Ã£o.

**Separation of Concerns (SeparaÃ§Ã£o de Responsabilidades):** Um princÃ­pio de design que organiza cÃ³digo em mÃ³dulos distintos com responsabilidades bem definidas. Cada mÃ³dulo deve ter uma Ãºnica razÃ£o para mudar. Facilita manutenÃ§Ã£o, teste e evoluÃ§Ã£o do cÃ³digo.

**Template Engine:** Uma ferramenta que permite criar templates dinÃ¢micos combinando dados (do Model) com marcaÃ§Ã£o HTML. Exemplos incluem EJS, Handlebars, Pug. Template engines facilitam geraÃ§Ã£o de HTML dinÃ¢mico sem concatenaÃ§Ã£o manual de strings.

**Routing (Roteamento):** O processo de mapear requisiÃ§Ãµes HTTP (URLs e mÃ©todos) para handlers especÃ­ficos (controllers). Routers definem quais funÃ§Ãµes sÃ£o executadas para cada rota, organizando endpoints da aplicaÃ§Ã£o.

**Middleware:** FunÃ§Ãµes que sÃ£o executadas no ciclo de vida de uma requisiÃ§Ã£o HTTP, entre receber a requisiÃ§Ã£o e enviar a resposta. Middleware pode processar dados, validar, autenticar, fazer logging, etc. Em Express.js, middleware Ã© executado sequencialmente.

**Express.js:** Um framework web minimalista e flexÃ­vel para Node.js que facilita criaÃ§Ã£o de servidores HTTP e APIs REST. Express fornece roteamento, middleware, tratamento de requisiÃ§Ãµes/respostas e integraÃ§Ã£o com template engines.

### 10.1 FundamentaÃ§Ã£o: Separation of Concerns

**PrincÃ­pio Fundamental:**
> "Cada componente deve ter uma Ãºnica responsabilidade bem definida."

**Model-View-Controller (MVC):**
Desenvolvido por Trygve Reenskaug no Smalltalk-80 (1979).

**Componentes:**

1. **Model:** LÃ³gica de dados e estado
   - Representa dados da aplicaÃ§Ã£o
   - ContÃ©m lÃ³gica de negÃ³cio
   - Notifica views sobre mudanÃ§as

2. **View:** ApresentaÃ§Ã£o
   - Renderiza dados do modelo
   - Captura interaÃ§Ãµes do usuÃ¡rio
   - NÃ£o contÃ©m lÃ³gica de negÃ³cio

3. **Controller:** CoordenaÃ§Ã£o
   - Recebe input do usuÃ¡rio
   - Atualiza modelo
   - Seleciona view apropriada

**No Projeto:**

<div class="codehilite"><pre><span></span><code><span class="n">Model</span><span class="o">:</span><span class="w">  </span><span class="n">cityModel</span><span class="o">.</span><span class="na">js</span><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Estado</span><span class="w"> </span><span class="n">imutÃ¡vel</span>
<span class="n">View</span><span class="o">:</span><span class="w">   </span><span class="n">cityView</span><span class="o">.</span><span class="na">js</span><span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">RenderizaÃ§Ã£o</span><span class="w"> </span><span class="n">DOM</span>
<span class="n">Controller</span><span class="o">:</span><span class="w"> </span><span class="n">cityController</span><span class="o">.</span><span class="na">js</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OrquestraÃ§Ã£o</span>
</code></pre></div>



> **ğŸ“š ReferÃªncias:**
> - [Document Object Model (DOM) - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model)
> - [DOM Manipulation - MDN Guide](https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Client-side_web_APIs/Manipulating_documents)
> - [Event Handling - MDN](https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener)

### 10.2 Vantagens da Arquitetura MVC

**1. Manutenibilidade:**
- MudanÃ§as em uma camada nÃ£o afetam outras
- CÃ³digo organizado e previsÃ­vel

**2. Testabilidade:**
- Model pode ser testado isoladamente
- View pode ser testada com dados mock
- Controller pode ser testado sem UI

**3. ReutilizaÃ§Ã£o:**
- Mesmo model pode ter mÃºltiplas views
- Views podem ser reutilizadas com diferentes models

**4. Escalabilidade:**
- FÃ¡cil adicionar novas features
- FÃ¡cil modificar comportamento existente

---

## ğŸ“ ConclusÃ£o AcadÃªmica

Este projeto integra conceitos fundamentais de:
- **Sistemas DistribuÃ­dos:** MemÃ³ria compartilhada, sincronizaÃ§Ã£o
- **Algoritmos Paralelos:** DivisÃ£o e conquista, anÃ¡lise de complexidade
- **Machine Learning:** K-Means clustering
- **ProgramaÃ§Ã£o Funcional:** Imutabilidade, composiÃ§Ã£o
- **Arquitetura de Software:** MVC, separation of concerns

Cada decisÃ£o tÃ©cnica foi fundamentada em teoria estabelecida e testada em produÃ§Ã£o. O cÃ³digo nÃ£o Ã© apenas funcional, mas demonstra compreensÃ£o profunda dos princÃ­pios subjacentes.

---

## ğŸ”¬ AnÃ¡lise Profunda do Projeto: Arquitetura e Fluxo de ExecuÃ§Ã£o

> **ğŸ“š ReferÃªncias Fundamentais:**
> - **[Express.js - Guia Completo](https://expressjs.com/en/guide/routing.html)** - Framework web Node.js
> - **[Node.js - DocumentaÃ§Ã£o Oficial](https://nodejs.org/docs/latest/api/)** - APIs do Node.js
> - **[MDN Web Docs - JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript)** - ReferÃªncia completa JavaScript
> - **[Web Workers API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API)** - Processamento paralelo
> - **[SharedArrayBuffer - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer)** - MemÃ³ria compartilhada
> - **[EJS - Template Engine](https://ejs.co/)** - Templates server-side

### VisÃ£o Geral da Arquitetura

O projeto implementa uma arquitetura hÃ­brida que combina:

1. **Frontend Single-Page Application (SPA)** - Interface reativa
2. **Backend REST API** - Servidor Node.js/Express
3. **Processamento Paralelo** - Web Workers com memÃ³ria compartilhada
4. **Algoritmo de Machine Learning** - K-Means paralelizado

**Teorema Arquitetural:**

A arquitetura do projeto segue o padrÃ£o **Separation of Concerns** (SeparaÃ§Ã£o de Responsabilidades), onde cada camada tem responsabilidades bem definidas:


<div class="codehilite"><pre><span></span><code>Frontend (Browser) â†â†’ Backend (Node.js) â†â†’ External API (GeoDB)
     â†“                      â†“
Web Workers          Express Routes
     â†“                      â†“
SharedArrayBuffer    Controllers
     â†“                      â†“
K-Means Algorithm    Services
</code></pre></div>



**AnÃ¡lise de Camadas:**

1. **Camada de ApresentaÃ§Ã£o (View):** ResponsÃ¡vel pela interface do usuÃ¡rio
2. **Camada de Controle (Controller):** Orquestra interaÃ§Ãµes entre View e Model
3. **Camada de Modelo (Model):** Gerencia estado e lÃ³gica de dados
4. **Camada de ServiÃ§o (Service):** Implementa lÃ³gica de negÃ³cio
5. **Camada de Processamento (Workers):** Executa tarefas pesadas em paralelo

### Fluxo Completo de ExecuÃ§Ã£o: Do InÃ­cio ao Fim

#### Fase 1: InicializaÃ§Ã£o e ExploraÃ§Ã£o


<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">UsuÃ¡rio</span><span class="w"> </span><span class="n">acessa</span><span class="w"> </span><span class="n">aplicaÃ§Ã£o</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Frontend</span><span class="w"> </span><span class="n">carrega</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="mf">.</span><span class="n">ejs</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">HTML</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">JavaScript</span><span class="p">)</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">cityController</span><span class="mf">.</span><span class="n">js</span><span class="w"> </span><span class="n">inicializa</span><span class="w"> </span><span class="n">estado</span><span class="w"> </span><span class="p">(</span><span class="n">createState</span><span class="p">)</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">UsuÃ¡rio</span><span class="w"> </span><span class="n">navega</span><span class="w"> </span><span class="n">pÃ¡ginas</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">cidades</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">5.</span><span class="w"> </span><span class="n">handlePagination</span><span class="p">()</span><span class="w"> </span><span class="n">faz</span><span class="w"> </span><span class="n">requisiÃ§Ã£o</span><span class="w"> </span><span class="n">assÃ­ncrona</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">6.</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">retorna</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="n">cidades</span><span class="w"> </span><span class="n">por</span><span class="w"> </span><span class="n">pÃ¡gina</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">7.</span><span class="w"> </span><span class="n">cityView</span><span class="mf">.</span><span class="n">js</span><span class="w"> </span><span class="n">renderiza</span><span class="w"> </span><span class="kr">list</span><span class="n">a</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">DOM</span>
</code></pre></div>



**CaracterÃ­sticas desta fase:**
- **SÃ­ncrona:** Uma requisiÃ§Ã£o por vez
- **Reativa:** UI atualiza apÃ³s cada requisiÃ§Ã£o
- **Estado ImutÃ¡vel:** Cada navegaÃ§Ã£o cria novo estado

#### Fase 2: SeleÃ§Ã£o de Cidades


<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">UsuÃ¡rio</span><span class="w"> </span><span class="n">clica</span><span class="w"> </span><span class="n">em</span><span class="w"> </span><span class="s">&quot;Selecionar&quot;</span><span class="w"> </span><span class="n">em</span><span class="w"> </span><span class="n">uma</span><span class="w"> </span><span class="n">cidade</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">handleSelectCity</span><span class="p">()</span><span class="w"> </span><span class="n">Ã©</span><span class="w"> </span><span class="n">chamado</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">addSelectedCity</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">)</span><span class="w"> </span><span class="n">cria</span><span class="w"> </span><span class="n">novo</span><span class="w"> </span><span class="n">estado</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">renderSelectedCitiesList</span><span class="p">()</span><span class="w"> </span><span class="n">atualiza</span><span class="w"> </span><span class="n">UI</span>
<span class="w">   </span><span class="err">â†“</span>
<span class="mf">5.</span><span class="w"> </span><span class="n">updateSelectedCount</span><span class="p">()</span><span class="w"> </span><span class="n">mostra</span><span class="w"> </span><span class="kr">cont</span><span class="n">ador</span>
</code></pre></div>



**Conceitos aplicados:**
- **Imutabilidade:** `state` nunca Ã© modificado diretamente
- **FunÃ§Ã£o Pura:** `addSelectedCity()` sempre retorna novo objeto
- **IdempotÃªncia:** Selecionar mesma cidade mÃºltiplas vezes nÃ£o duplica

#### Fase 3: Coleta Paralela de Dados (A Parte Mais Complexa)

**Passo 1: PreparaÃ§Ã£o**


<div class="codehilite"><pre><span></span><code><span class="c1">// dataCollectionService.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">targetCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10000</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">totalPages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="p">);</span><span class="w"> </span><span class="c1">// 1000 pÃ¡ginas</span>

<span class="c1">// Verifica disponibilidade de SharedArrayBuffer</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">;</span>
</code></pre></div>



**Passo 2: CriaÃ§Ã£o do Buffer Compartilhado**


<div class="codehilite"><pre><span></span><code><span class="c1">// Estrutura do buffer:</span>
<span class="c1">// [0-3 bytes]: writeIndex (onde escrever prÃ³ximo)</span>
<span class="c1">// [4-7 bytes]: completedWorkers (quantos workers terminaram)</span>
<span class="c1">// [8+ bytes]: dados serializados das cidades</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">estimatedDataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">estimateBufferSize</span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">estimatedDataSize</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="p">(</span><span class="nx">totalBufferSize</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">atomicView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>

<span class="c1">// Inicializa Ã­ndices atÃ´micos</span>
<span class="nb">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">);</span><span class="w"> </span><span class="c1">// writeIndex</span>
<span class="nb">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// completedWorkers</span>
</code></pre></div>



**Passo 3: CriaÃ§Ã£o e DistribuiÃ§Ã£o de Workers**


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// Plano BASIC: apenas 1 worker</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">totalPages</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">startPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">endPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">((</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">totalPages</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="s2">&quot;/js/workers/dataCollectionWorker.js&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;module&quot;</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Passa referÃªncia do buffer compartilhado</span>
<span class="w">  </span><span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;start_collection&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">startPage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">endPage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">workerId</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sharedBuffer</span><span class="o">:</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="c1">// TransferÃ­vel, nÃ£o copiado!</span>
<span class="w">    </span><span class="nx">headerSize</span><span class="p">,</span>
<span class="w">    </span><span class="nx">totalBufferSize</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>



**Passo 4: Processamento em Cada Worker**


<div class="codehilite"><pre><span></span><code><span class="c1">// dataCollectionWorker.js</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">startPage</span><span class="p">,</span><span class="w"> </span><span class="nx">endPage</span><span class="p">,</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">workerId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Configura view atÃ´mica do buffer</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">atomicView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startPage</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">endPage</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. Faz requisiÃ§Ã£o HTTP</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchPage</span><span class="p">((</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 2. Filtra cidades vÃ¡lidas</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">validCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
<span class="w">      </span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 3. Escreve cada cidade no buffer compartilhado</span>
<span class="w">    </span><span class="nx">validCities</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">writeCityToSharedBuffer</span><span class="p">(</span>
<span class="w">        </span><span class="nx">city</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sharedBuffer</span><span class="p">,</span>
<span class="w">        </span><span class="nx">atomicView</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headerSize</span><span class="p">,</span>
<span class="w">        </span><span class="nx">totalBufferSize</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 4. Rate limiting: aguarda antes da prÃ³xima requisiÃ§Ã£o</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">REQUEST_DELAY_MS</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 5. Notifica conclusÃ£o</span>
<span class="w">  </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Incrementa contador atÃ´mico</span>
<span class="w">  </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;complete&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">workerId</span><span class="w"> </span><span class="p">});</span>
<span class="p">};</span>
</code></pre></div>



**Passo 5: Escrita Thread-Safe no Buffer**


<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">writeCityToSharedBuffer</span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">,</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 1. Serializa cidade para JSON</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="p">().</span><span class="nx">encode</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">citySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="c1">// 4 bytes (tamanho) + dados</span>

<span class="w">  </span><span class="c1">// 2. Loop CAS para reservar espaÃ§o thread-safe</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">attempts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// LÃª Ã­ndice atual atomicamente</span>
<span class="w">    </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Verifica espaÃ§o disponÃ­vel</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">citySize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Buffer cheio</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Tenta reservar espaÃ§o usando CAS</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">citySize</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span>
<span class="w">      </span><span class="nx">atomicView</span><span class="p">,</span>
<span class="w">      </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">expectedIndex</span><span class="p">,</span>
<span class="w">      </span><span class="nx">newIndex</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Sucesso: espaÃ§o reservado exclusivamente</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// CAS falhou: outro worker escreveu primeiro, tenta novamente</span>
<span class="w">    </span><span class="nx">attempts</span><span class="o">++</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 3. Escreve dados no espaÃ§o reservado</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">uint8Array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="w">  </span><span class="nx">view</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// Escreve tamanho</span>
<span class="w">  </span><span class="nx">uint8Array</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">jsonBytes</span><span class="p">,</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// Escreve dados JSON</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



**Passo 6: Aguardar ConclusÃ£o e Ler Dados**


<div class="codehilite"><pre><span></span><code><span class="c1">// dataCollectionService.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">checkComplete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">completedWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">completedWorkers</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">checkComplete</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// LÃª dados do buffer compartilhado</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">finalWriteIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dataBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">headerSize</span><span class="p">,</span><span class="w"> </span><span class="nx">finalWriteIndex</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">allCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">deserializeCities</span><span class="p">(</span><span class="nx">dataBuffer</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Remove duplicatas</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">removeDuplicates</span><span class="p">(</span><span class="nx">allCities</span><span class="p">);</span>

<span class="w">    </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">uniqueCities</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">},</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>
</code></pre></div>



#### Fase 4: Clustering K-Means Paralelizado

**Passo 1: NormalizaÃ§Ã£o dos Dados**


<div class="codehilite"><pre><span></span><code><span class="c1">// kmeansService.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">normalizeData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Encontra ranges</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">minLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">latitude</span><span class="p">));</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">latitude</span><span class="p">));</span>
<span class="w">  </span><span class="c1">// ... mesmo para longitude e populaÃ§Ã£o</span>

<span class="w">  </span><span class="c1">// Normaliza cada ponto: (x - min) / (max - min)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">point</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">    </span><span class="p">...</span><span class="nx">point</span><span class="p">,</span>
<span class="w">    </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLat</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="nx">maxLat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLat</span><span class="p">),</span>
<span class="w">    </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLon</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="nx">maxLon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLon</span><span class="p">),</span>
<span class="w">    </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minPop</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="nx">maxPop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minPop</span><span class="p">),</span>
<span class="w">  </span><span class="p">}));</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">normalizedPoints</span><span class="p">,</span><span class="w"> </span><span class="nx">ranges</span><span class="w"> </span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>



**Por que normalizar?**
- Latitude: -90 a +90
- Longitude: -180 a +180
- PopulaÃ§Ã£o: 0 a milhÃµes

Sem normalizaÃ§Ã£o, populaÃ§Ã£o dominaria o cÃ¡lculo de distÃ¢ncia. Com normalizaÃ§Ã£o (0-1), todas as dimensÃµes tÃªm peso igual.

**Passo 2: InicializaÃ§Ã£o de Centroides**


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">initializeCentroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">normalizedPoints</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">centroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">k</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">centroids</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span><span class="w"> </span><span class="c1">// 0-1 (jÃ¡ normalizado)</span>
<span class="w">      </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">centroids</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>



**Passo 3: Loop Principal de IteraÃ§Ã£o**


<div class="codehilite"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">iteration</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxIterations</span><span class="p">;</span><span class="w"> </span><span class="nx">iteration</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 1. Atribui pontos aos clusters (PARALELIZADO)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">assignPointsToClusters</span><span class="p">(</span>
<span class="w">    </span><span class="nx">normalizedPoints</span><span class="p">,</span>
<span class="w">    </span><span class="nx">centroids</span><span class="p">,</span>
<span class="w">    </span><span class="nx">numWorkers</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 2. Agrupa pontos por cluster</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">assignment</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">assignments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">clusters</span><span class="p">[</span><span class="nx">assignment</span><span class="p">.</span><span class="nx">centroidIndex</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">assignment</span><span class="p">.</span><span class="nx">pointIndex</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 3. Calcula novos centroides (PARALELIZADO)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">newCentroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">calculateNewCentroids</span><span class="p">(</span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">normalizedPoints</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 4. Verifica convergÃªncia</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasConverged</span><span class="p">(</span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="o">:</span><span class="w"> </span><span class="nx">denormalizeCentroids</span><span class="p">(</span><span class="nx">newCentroids</span><span class="p">,</span><span class="w"> </span><span class="nx">ranges</span><span class="p">),</span><span class="w"> </span><span class="nx">converged</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">centroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



**Passo 4: AtribuiÃ§Ã£o Paralela de Pontos**


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">assignPointsToClusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pointsPerWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">promises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pointsPerWorker</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">((</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pointsPerWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="s2">&quot;/js/workers/kmeansWorker.js&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;module&quot;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">promise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;assignments_complete&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
<span class="w">          </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">assignments</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;assign_points&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">endIndex</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">promise</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Aguarda todos os workers terminarem</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allAssignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">allAssignments</span><span class="p">.</span><span class="nx">flat</span><span class="p">();</span><span class="w"> </span><span class="c1">// Combina resultados</span>
<span class="p">};</span>
</code></pre></div>



**Passo 5: CÃ¡lculo de DistÃ¢ncias no Worker**


<div class="codehilite"><pre><span></span><code><span class="c1">// kmeansWorker.js</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">endIndex</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="c1">// Cada worker calcula distÃ¢ncias para seu subconjunto de pontos</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">endIndex</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">minDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Infinity</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">closestCentroid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Encontra centroide mais prÃ³ximo</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">centroids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">euclideanDistance</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">distance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">minDistance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">minDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">distance</span><span class="p">;</span>
<span class="w">        </span><span class="nx">closestCentroid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">j</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">assignments</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">pointIndex</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span>
<span class="w">      </span><span class="nx">centroidIndex</span><span class="o">:</span><span class="w"> </span><span class="nx">closestCentroid</span><span class="p">,</span>
<span class="w">      </span><span class="nx">distance</span><span class="o">:</span><span class="w"> </span><span class="nx">minDistance</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;assignments_complete&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">assignments</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">};</span>
</code></pre></div>



**FÃ³rmula de DistÃ¢ncia Euclidiana:**


<div class="codehilite"><pre><span></span><code>d(p1, p2) = âˆš[(lat1 - lat2)Â² + (lon1 - lon2)Â² + (pop1 - pop2)Â²]
</code></pre></div>



Como todos os valores estÃ£o normalizados (0-1), todas as dimensÃµes tÃªm peso igual.

### AnÃ¡lise de Complexidade do Fluxo Completo

**Tempo Total:**


<div class="codehilite"><pre><span></span><code>T_total = T_exploracao + T_selecao + T_coleta + T_clustering

Onde:
<span class="k">-</span> T_exploracao = O(1) por pÃ¡gina (requisiÃ§Ã£o HTTP)
<span class="k">-</span> T_selecao = O(1) por cidade selecionada
<span class="k">-</span> T_coleta = O(n/p) onde n = pÃ¡ginas, p = workers
<span class="k">-</span> T_clustering = O(I Ã— nÃ—k/p) onde I = iteraÃ§Ãµes, k = clusters
</code></pre></div>



**EspaÃ§o Total:**


<div class="codehilite"><pre><span></span><code>S_total = S_estado + S_buffer + S_clustering

Onde:
<span class="k">-</span> S_estado = O(m) onde m = cidades selecionadas (&lt; 100)
<span class="k">-</span> S_buffer = O(n Ã— avg_city_size) â‰ˆ 2MB para 10k cidades
<span class="k">-</span> S_clustering = O(n + k) â‰ˆ 10k pontos + k centroides
</code></pre></div>



### Pontos-Chave da Arquitetura

1. **Isolamento de Responsabilidades:**
   - Workers nÃ£o acessam DOM
   - Workers nÃ£o modificam estado global
   - ComunicaÃ§Ã£o apenas via mensagens

2. **Thread-Safety:**
   - OperaÃ§Ãµes atÃ´micas garantem consistÃªncia
   - CAS previne race conditions
   - Sem locks explÃ­citos (lock-free)

3. **Escalabilidade:**
   - NÃºmero de workers adaptÃ¡vel ao hardware
   - Buffer compartilhado evita cÃ³pias desnecessÃ¡rias
   - ParalelizaÃ§Ã£o eficiente de operaÃ§Ãµes CPU-bound

4. **ResiliÃªncia:**
   - Workers continuam mesmo se algumas pÃ¡ginas falharem
   - Retry automÃ¡tico em caso de rate limit
   - Fallback para navegadores sem SharedArrayBuffer

---

## ğŸ¯ Conceitos Fundamentais (Resumo PrÃ¡tico)

### 1. ProgramaÃ§Ã£o AssÃ­ncrona

**O que Ã©?**
ProgramaÃ§Ã£o assÃ­ncrona permite que operaÃ§Ãµes demoradas (como requisiÃ§Ãµes HTTP) nÃ£o bloqueiem a execuÃ§Ã£o do cÃ³digo.

**Por que usar?**
- Interface do usuÃ¡rio permanece responsiva
- MÃºltiplas operaÃ§Ãµes podem ocorrer simultaneamente
- Melhor experiÃªncia do usuÃ¡rio

**Como funciona no projeto:**

<div class="codehilite"><pre><span></span><code><span class="c1">// RequisiÃ§Ã£o assÃ­ncrona nÃ£o bloqueia a interface</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/cities?</span><span class="si">${</span><span class="nx">queryString</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="c1">// CÃ³digo continua executando enquanto aguarda resposta</span>
</code></pre></div>



### 2. ConcorrÃªncia vs Paralelismo

**ConcorrÃªncia:**
- MÃºltiplas tarefas compartilham recursos
- Alternam execuÃ§Ã£o no mesmo processador
- Exemplo: JavaScript single-threaded com event loop

**Paralelismo:**
- MÃºltiplas tarefas executam simultaneamente
- Cada uma em seu prÃ³prio processador/core
- Exemplo: Web Workers em threads separadas

**No projeto:**
- **ConcorrÃªncia:** Event loop JavaScript gerencia mÃºltiplas requisiÃ§Ãµes
- **Paralelismo:** Web Workers executam em threads separadas

### 3. ProgramaÃ§Ã£o Funcional

**PrincÃ­pios:**
- **Estado imutÃ¡vel:** Nunca modificar dados existentes, sempre criar novos
- **FunÃ§Ãµes puras:** FunÃ§Ãµes que sempre retornam o mesmo resultado para as mesmas entradas
- **Sem efeitos colaterais:** FunÃ§Ãµes nÃ£o modificam variÃ¡veis externas
- **ComposiÃ§Ã£o:** Construir funÃ§Ãµes complexas a partir de funÃ§Ãµes simples

**Exemplo no projeto:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âŒ RUIM: Modifica estado diretamente</span>
<span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>

<span class="c1">// âœ… BOM: Retorna novo estado (imutÃ¡vel)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span>
<span class="w">  </span><span class="nx">selectedCities</span><span class="o">:</span><span class="w"> </span><span class="p">[...</span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">]</span>
<span class="p">};</span>
</code></pre></div>



### 4. MemÃ³ria Compartilhada (SharedArrayBuffer)

**O que Ã©?**
Um buffer de memÃ³ria que pode ser compartilhado entre mÃºltiplas threads (Web Workers).

**Por que usar?**
- Permite comunicaÃ§Ã£o eficiente entre workers
- Evita cÃ³pia de dados (postMessage copia dados)
- Permite escrita controlada com Atomics

**Requisitos de seguranÃ§a:**
- Headers HTTP obrigatÃ³rios:
  - `Cross-Origin-Opener-Policy: same-origin`
  - `Cross-Origin-Embedder-Policy: require-corp`

**Estrutura no projeto:**

<div class="codehilite"><pre><span></span><code>SharedArrayBuffer:
â”œâ”€â”€ [0-3 bytes]   - writeIndex (Uint32) - Ã­ndice de escrita atual
â”œâ”€â”€ [4-7 bytes]   - completedWorkers (Uint32) - contador de workers completos
â””â”€â”€ [8+ bytes]    - Dados serializados das cidades
</code></pre></div>



### 5. SincronizaÃ§Ã£o com Atomics

**O que Ã©?**
Atomics API fornece operaÃ§Ãµes atÃ´micas para sincronizaÃ§Ã£o thread-safe.

**OperaÃ§Ãµes principais:**
- `Atomics.load()` - LÃª valor de forma atÃ´mica
- `Atomics.store()` - Escreve valor de forma atÃ´mica
- `Atomics.compareExchange()` - Compara e troca (CAS) - operaÃ§Ã£o atÃ´mica

**Por que usar?**
- Garante que apenas um worker escreva por vez
- Evita condiÃ§Ãµes de corrida (race conditions)
- Thread-safety garantido

**Exemplo no projeto:**

<div class="codehilite"><pre><span></span><code><span class="c1">// Reserva espaÃ§o no buffer de forma thread-safe</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">newIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">citySize</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">newIndex</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Sucesso: espaÃ§o reservado, pode escrever</span>
<span class="w">  </span><span class="c1">// Escreve dados...</span>
<span class="p">}</span>
</code></pre></div>



### 6. Algoritmo de DivisÃ£o e Conquista

**O que Ã©?**
Dividir um problema grande em subproblemas menores, resolver cada um independentemente, e combinar os resultados.

**No projeto:**
- Problema: Coletar 10.000 cidades
- DivisÃ£o: Distribuir pÃ¡ginas entre workers
  - Worker 0: pÃ¡ginas 1-250
  - Worker 1: pÃ¡ginas 251-500
  - Worker 2: pÃ¡ginas 501-750
  - Worker 3: pÃ¡ginas 751-1000
- Conquista: Cada worker coleta sua parcela
- CombinaÃ§Ã£o: Dados consolidados no buffer compartilhado

### 7. K-Means Clustering

**O que Ã©?**
Algoritmo de agrupamento que divide dados em k grupos baseado em similaridade.

**Como funciona:**
1. Inicializa k centroides aleatÃ³rios
2. Atribui cada ponto ao centroide mais prÃ³ximo
3. Recalcula centroides baseado nos pontos atribuÃ­dos
4. Repete atÃ© convergÃªncia (centroides nÃ£o mudam)

**MÃ©tricas no projeto:**
- Latitude
- Longitude  
- PopulaÃ§Ã£o (normalizada)

**ParalelizaÃ§Ã£o:**
- CÃ¡lculo de distÃ¢ncias distribuÃ­do entre workers
- AtualizaÃ§Ã£o de centroides paralelizada

---

<a id="capÃ­tulo-11-anÃ¡lise-de-complexidade-detalhada---todo-o-sistema"></a>
## ğŸ“š CapÃ­tulo 11: AnÃ¡lise de Complexidade Detalhada - Todo o Sistema

### 11.1 Complexidade Temporal por Componente

**1. PaginaÃ§Ã£o de Cidades:**


<div class="codehilite"><pre><span></span><code>T(n) = O(1)  // Constante - apenas uma requisiÃ§Ã£o
</code></pre></div>



**AnÃ¡lise:**
- RequisiÃ§Ã£o HTTP: ~100-500ms (depende da rede)
- Processamento: O(m) onde m = nÃºmero de cidades retornadas (geralmente 10)
- RenderizaÃ§Ã£o: O(m) - cria elementos DOM
- **Total:** O(1) em termos de complexidade assintÃ³tica, mas tempo real depende de latÃªncia de rede

**2. Coleta Paralela:**


<div class="codehilite"><pre><span></span><code>T(n, p) = O(n/p + overhead)
</code></pre></div>



Onde:
- `n` = nÃºmero de pÃ¡ginas
- `p` = nÃºmero de workers
- `overhead` = comunicaÃ§Ã£o e sincronizaÃ§Ã£o

**Breakdown:**
- RequisiÃ§Ãµes: O(n/p) - distribuÃ­das entre workers
- Escrita no buffer: O(n) - cada cidade escrita uma vez
- SincronizaÃ§Ã£o: O(n Ã— log p) - CAS pode ter retries
- **Total:** O(n/p + n) = O(n) para p constante

**3. K-Means:**


<div class="codehilite"><pre><span></span><code>T(n, k, p, I) = O(I Ã— (nÃ—kÃ—d/p + kÃ—d))
</code></pre></div>



Onde:
- `n` = nÃºmero de pontos
- `k` = nÃºmero de clusters
- `d` = dimensÃµes (3)
- `p` = nÃºmero de workers
- `I` = nÃºmero de iteraÃ§Ãµes

**Breakdown por iteraÃ§Ã£o:**
- AtribuiÃ§Ã£o: O(nÃ—kÃ—d/p) - paralelizado
- AtualizaÃ§Ã£o: O(nÃ—d/p) - paralelizado
- SincronizaÃ§Ã£o: O(kÃ—d) - sequencial
- **Total:** O(I Ã— nÃ—kÃ—d/p) para n >> k

### 11.2 Complexidade Espacial

**1. Estado da AplicaÃ§Ã£o:**


<div class="codehilite"><pre><span></span><code>S(m) = O(m)
</code></pre></div>



Onde `m` = nÃºmero de cidades selecionadas (geralmente pequeno, < 100)

**2. Buffer Compartilhado:**


<div class="codehilite"><pre><span></span><code>S(n) = O(n Ã— avg_city_size)
     â‰ˆ O(n Ã— 200 bytes)
     â‰ˆ O(200n) bytes
</code></pre></div>



Para 10.000 cidades: ~2MB

**3. K-Means:**


<div class="codehilite"><pre><span></span><code>S(n, k) = O(n + k)
</code></pre></div>



- Pontos: O(n) - mantidos em memÃ³ria
- Centroides: O(k) - apenas k pontos
- Clusters: O(n) - array de Ã­ndices

### 11.3 AnÃ¡lise de Escalabilidade

**Limites PrÃ¡ticos:**

1. **NÃºmero de Workers:**
   - Limite teÃ³rico: nÃºmero de cores disponÃ­veis
   - Limite prÃ¡tico: overhead de comunicaÃ§Ã£o
   - Sweet spot: 2-8 workers para maioria dos casos

2. **Tamanho do Buffer:**
   - Limite do SharedArrayBuffer: ~2GB (32-bit) ou ilimitado (64-bit)
   - Limite prÃ¡tico: memÃ³ria disponÃ­vel do navegador
   - RecomendaÃ§Ã£o: < 100MB para boa performance

3. **NÃºmero de Cidades:**
   - Limite teÃ³rico: ilimitado
   - Limite prÃ¡tico: memÃ³ria e tempo de processamento
   - RecomendaÃ§Ã£o: 1.000-50.000 para boa experiÃªncia

---

<a id="capÃ­tulo-12-seguranÃ§a-e-vulnerabilidades"></a>
## ğŸ“š CapÃ­tulo 12: SeguranÃ§a e Vulnerabilidades

### 12.1 Spectre e Meltdown: Por Que SharedArrayBuffer Foi Desabilitado

**Contexto HistÃ³rico (2018):**
Descoberta das vulnerabilidades Spectre e Meltdown levou navegadores a desabilitar SharedArrayBuffer por padrÃ£o.

**Vulnerabilidade:**
- Ataques de timing side-channel
- Leitura de memÃ³ria de outros processos
- SharedArrayBuffer facilitava esses ataques

**SoluÃ§Ã£o:**
- Headers HTTP obrigatÃ³rios:
  - `Cross-Origin-Opener-Policy: same-origin`
  - `Cross-Origin-Embedder-Policy: require-corp`
- Isolamento de processos por origem
- MitigaÃ§Ã£o de timing attacks

### 12.2 AnÃ¡lise de SeguranÃ§a do Projeto

**Vetores de Ataque Potenciais:**

1. **XSS (Cross-Site Scripting):**
   - MitigaÃ§Ã£o: Workers nÃ£o tÃªm acesso a DOM
   - ValidaÃ§Ã£o de entrada no servidor

2. **CSRF (Cross-Site Request Forgery):**
   - MitigaÃ§Ã£o: Headers CORS apropriados
   - ValidaÃ§Ã£o de origem

3. **Memory Corruption:**
   - MitigaÃ§Ã£o: JavaScript Ã© memory-safe
   - Bounds checking automÃ¡tico

4. **Race Conditions:**
   - MitigaÃ§Ã£o: OperaÃ§Ãµes atÃ´micas (Atomics)
   - ValidaÃ§Ã£o de invariantes

---

<a id="capÃ­tulo-13-otimizaÃ§Ãµes-e-tÃ©cnicas-avanÃ§adas"></a>
## ğŸ“š CapÃ­tulo 13: OtimizaÃ§Ãµes e TÃ©cnicas AvanÃ§adas

### 13.1 OtimizaÃ§Ãµes Implementadas

**1. Estimativa de Tamanho de Buffer:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">estimateBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">numCities</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">avgCitySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">200</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">numCities</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">avgCitySize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 20% margem</span>
<span class="p">};</span>
</code></pre></div>



**Por que 20% de margem?**
- Compensa variaÃ§Ã£o no tamanho real das cidades
- Evita realocaÃ§Ãµes (caras)
- Trade-off: memÃ³ria vs seguranÃ§a

**2. Filtragem Precoce:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">validCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">city</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">    </span><span class="nx">city</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">    </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">    </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span>
<span class="p">);</span>
</code></pre></div>



**Vantagem:** Remove dados invÃ¡lidos antes de serializar, economizando espaÃ§o no buffer.

**3. RemoÃ§Ã£o de Duplicatas:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span>
<span class="w">  </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">(</span><span class="nx">allCities</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[</span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">])).</span><span class="nx">values</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>



**Complexidade:** O(n) onde n = nÃºmero de cidades
**Estrutura:** Map usa hash table internamente (O(1) lookup)

### 13.2 OtimizaÃ§Ãµes PossÃ­veis (NÃ£o Implementadas)

**1. CompressÃ£o de Dados:**
- Usar gzip para serializaÃ§Ã£o
- Reduz tamanho em ~70%
- Trade-off: CPU vs memÃ³ria

**2. Estruturas de Dados Persistentes:**
- Usar tries para arrays imutÃ¡veis
- O(log n) operaÃ§Ãµes em vez de O(n)
- Biblioteca: Immutable.js

**3. Lazy Evaluation:**
- Processar cidades sob demanda
- Reduz memÃ³ria inicial
- Complexidade de implementaÃ§Ã£o maior

**4. WebAssembly:**
- SerializaÃ§Ã£o em WASM
- Potencial speedup de 2-10x
- Complexidade de build maior

---

<a id="capÃ­tulo-14-testes-e-validaÃ§Ã£o"></a>
## ğŸ“š CapÃ­tulo 14: Testes e ValidaÃ§Ã£o

### 14.1 EstratÃ©gias de Teste

**1. Testes UnitÃ¡rios:**
- FunÃ§Ãµes puras sÃ£o facilmente testÃ¡veis
- Exemplo: `euclideanDistance()`, `addSelectedCity()`

**2. Testes de IntegraÃ§Ã£o:**
- Testar comunicaÃ§Ã£o entre workers
- Validar serializaÃ§Ã£o/desserializaÃ§Ã£o

**3. Testes de Carga:**
- Performance com diferentes nÃºmeros de workers
- ValidaÃ§Ã£o de rate limiting

**4. Testes de RegressÃ£o:**
- Garantir que mudanÃ§as nÃ£o quebram funcionalidades existentes

### 14.2 MÃ©tricas de Qualidade

**1. Cobertura de CÃ³digo:**
- Meta: > 80% de cobertura
- Ferramentas: Jest, Istanbul

**2. Performance:**
- Tempo de resposta < 200ms para paginaÃ§Ã£o
- Throughput de coleta > 0.3 req/s
- Uso de memÃ³ria < 100MB para 10k cidades

**3. Manutenibilidade:**
- Complexidade ciclomÃ¡tica < 10 por funÃ§Ã£o
- CÃ³digo duplicado < 5%

---

<a id="capÃ­tulo-15-referÃªncias-acadÃªmicas-e-leitura-recomendada"></a>
## ğŸ“š CapÃ­tulo 15: ReferÃªncias AcadÃªmicas e Leitura Recomendada

### 15.1 Artigos Fundamentais

1. **K-Means:**
   - Lloyd, S. P. (1982). "Least squares quantization in PCM"
   - MacQueen, J. (1967). "Some methods for classification and analysis of multivariate observations"

2. **Divide-and-Conquer:**
   - Cormen, T. H., et al. (2009). "Introduction to Algorithms" - CapÃ­tulo 4

3. **ConcorrÃªncia:**
   - Hoare, C. A. R. (1978). "Communicating sequential processes"
   - Lamport, L. (1978). "Time, clocks, and the ordering of events"

4. **ProgramaÃ§Ã£o Funcional:**
   - Church, A. (1936). "An unsolvable problem of elementary number theory"
   - Backus, J. (1978). "Can programming be liberated from the von Neumann style?"

### 15.2 Livros Recomendados

1. **Algoritmos:**
   - "Introduction to Algorithms" (Cormen, Leiserson, Rivest, Stein)
   - "The Algorithm Design Manual" (Skiena)

2. **Sistemas DistribuÃ­dos:**
   - "Distributed Systems" (van Steen, Tanenbaum)
   - "Designing Data-Intensive Applications" (Kleppmann)

3. **ProgramaÃ§Ã£o Funcional:**
   - "Structure and Interpretation of Computer Programs" (Abelson, Sussman)
   - "Functional Programming in JavaScript" (Atencio)

### 15.3 Recursos Online

- MDN Web Docs: DocumentaÃ§Ã£o oficial
- JavaScript.info: Tutoriais profundos
- Wikipedia: Artigos acadÃªmicos sobre algoritmos

---

<a id="estrutura-completa-do-projeto"></a>
## ğŸ“ Estrutura Completa do Projeto


<div class="codehilite"><pre><span></span><code><span class="n">geodb</span><span class="o">-</span><span class="n">cities</span><span class="o">/</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">app</span><span class="o">/</span><span class="w">                          </span><span class="c1"># AplicaÃ§Ã£o Node.js</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">js</span><span class="w">                  </span><span class="c1"># Servidor Express principal</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">package</span><span class="o">.</span><span class="n">json</span><span class="w">              </span><span class="c1"># DependÃªncias Node.js</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">controllers</span><span class="o">/</span><span class="w">              </span><span class="c1"># Controladores MVC</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">cityApiController</span><span class="o">.</span><span class="n">js</span><span class="w">  </span><span class="c1"># Controller da API REST</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">cityController</span><span class="o">.</span><span class="n">js</span><span class="w">     </span><span class="c1"># Controller web (nÃ£o usado no frontend)</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">services</span><span class="o">/</span><span class="w">                 </span><span class="c1"># LÃ³gica de negÃ³cio</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">cityService</span><span class="o">.</span><span class="n">js</span><span class="w">        </span><span class="c1"># ServiÃ§o de comunicaÃ§Ã£o com API externa</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">routes</span><span class="o">/</span><span class="w">                   </span><span class="c1"># Rotas Express</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">api</span><span class="o">.</span><span class="n">js</span><span class="w">                </span><span class="c1"># Rotas da API REST (/api/*)</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">web</span><span class="o">.</span><span class="n">js</span><span class="w">                </span><span class="c1"># Rotas web (/)</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">middleware</span><span class="o">/</span><span class="w">               </span><span class="c1"># Middlewares Express</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">errorHandler</span><span class="o">.</span><span class="n">js</span><span class="w">       </span><span class="c1"># Tratamento de erros</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">validateQueryParams</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="c1"># ValidaÃ§Ã£o de parÃ¢metros</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">models</span><span class="o">/</span><span class="w">                   </span><span class="c1"># Modelos de dados (backend)</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">city</span><span class="o">.</span><span class="n">js</span><span class="w">               </span><span class="c1"># Modelo de cidade (nÃ£o usado)</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">util</span><span class="o">/</span><span class="w">                     </span><span class="c1"># UtilitÃ¡rios</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">envValidator</span><span class="o">.</span><span class="n">js</span><span class="w">       </span><span class="c1"># ValidaÃ§Ã£o de variÃ¡veis de ambiente</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">queryString</span><span class="o">.</span><span class="n">js</span><span class="w">        </span><span class="c1"># ConstruÃ§Ã£o de query strings</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">views</span><span class="o">/</span><span class="w">                    </span><span class="c1"># Templates EJS</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">ejs</span><span class="w">             </span><span class="c1"># PÃ¡gina principal HTML</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">public</span><span class="o">/</span><span class="w">                   </span><span class="c1"># Arquivos estÃ¡ticos</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">css</span><span class="o">/</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">public</span><span class="o">.</span><span class="n">css</span><span class="w">        </span><span class="c1"># Estilos customizados</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">js</span><span class="o">/</span><span class="w">                   </span><span class="c1"># JavaScript do frontend</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">js</span><span class="w">           </span><span class="c1"># Entry point (nÃ£o usado)</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">controllers</span><span class="o">/</span><span class="w">      </span><span class="c1"># Controladores frontend (MVC)</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">cityController</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="c1"># Controller principal</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">models</span><span class="o">/</span><span class="w">           </span><span class="c1"># Modelos de dados (frontend)</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">cityModel</span><span class="o">.</span><span class="n">js</span><span class="w">  </span><span class="c1"># Estado imutÃ¡vel da aplicaÃ§Ã£o</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">views</span><span class="o">/</span><span class="w">            </span><span class="c1"># Views (renderizaÃ§Ã£o)</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">cityView</span><span class="o">.</span><span class="n">js</span><span class="w">   </span><span class="c1"># RenderizaÃ§Ã£o de cidades</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">clusterView</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="c1"># RenderizaÃ§Ã£o de clusters</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">services</span><span class="o">/</span><span class="w">         </span><span class="c1"># ServiÃ§os de lÃ³gica</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">dataCollectionService</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="c1"># Coleta paralela</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">kmeansService</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="c1"># Algoritmo K-Means</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">workers</span><span class="o">/</span><span class="w">         </span><span class="c1"># Web Workers</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">dataCollectionWorker</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="c1"># Worker de coleta</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">kmeansWorker</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="c1"># Worker de K-Means</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">           </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">util</span><span class="o">/</span><span class="w">            </span><span class="c1"># UtilitÃ¡rios</span>
<span class="err">â”‚</span><span class="w">               </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">sharedMemorySerializer</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="c1"># SerializaÃ§Ã£o de dados</span>
<span class="err">â”‚</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">nginx</span><span class="o">/</span><span class="w">                       </span><span class="c1"># ConfiguraÃ§Ã£o Nginx</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Dockerfile</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="w">               </span><span class="c1"># ConfiguraÃ§Ã£o do proxy reverso</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="k">static</span><span class="o">-</span><span class="n">html</span><span class="o">-</span><span class="n">directory</span><span class="o">/</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
<span class="err">â”‚</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="n">yml</span><span class="w">           </span><span class="c1"># OrquestraÃ§Ã£o Docker</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Dockerfile</span><span class="w">                   </span><span class="c1"># Build da aplicaÃ§Ã£o Node.js</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">rebuild</span><span class="o">.</span><span class="n">bat</span><span class="w">          </span><span class="c1"># Script Windows (WSL)</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">rebuild</span><span class="o">.</span><span class="n">sh</span><span class="w">           </span><span class="c1"># Script Linux/Mac</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="o">.</span><span class="n">env</span><span class="w">                        </span><span class="c1"># VariÃ¡veis de ambiente (nÃ£o commitado)</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="o">.</span><span class="n">gitignore</span><span class="w">                  </span><span class="c1"># Arquivos ignorados pelo Git</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="o">.</span><span class="n">dockerignore</span><span class="w">              </span><span class="c1"># Arquivos ignorados no build Docker</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">README</span><span class="o">.</span><span class="n">md</span><span class="w">                   </span><span class="c1"># DocumentaÃ§Ã£o bÃ¡sica</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">guide</span><span class="o">.</span><span class="n">md</span><span class="w">                    </span><span class="c1"># Este arquivo</span>
</code></pre></div>



---

<a id="configuraÃ§Ã£o-inicial"></a>
## ğŸ”§ ConfiguraÃ§Ã£o Inicial

### 1. PrÃ©-requisitos

**Ferramentas necessÃ¡rias:**
- Node.js 18+ (com suporte nativo a `fetch`)
- Docker Desktop
- Git
- Editor de cÃ³digo (VS Code recomendado)
- WSL (Windows) ou terminal Linux/Mac

**Conta e credenciais:**
- Conta no [RapidAPI](https://rapidapi.com/)
- API Key da GeoDB Cities API

### 2. Obter API Key

1. Acesse: https://rapidapi.com/wirefreethought/api/geodb-cities
2. FaÃ§a login ou crie conta
3. Clique em "Subscribe to Test" (plano gratuito)
4. Copie sua API Key da seÃ§Ã£o "Code Snippets"
5. Guarde para usar no `.env`

### 3. Estrutura de Pastas

Crie a estrutura bÃ¡sica:


<div class="codehilite"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>geodb-cities/app/<span class="o">{</span>controllers,services,routes,middleware,models,util,views,public/<span class="o">{</span>css,js/<span class="o">{</span>controllers,models,views,services,workers,util<span class="o">}}}</span>
</code></pre></div>



### 4. VariÃ¡veis de Ambiente

Crie `.env` na raiz:


<div class="codehilite"><pre><span></span><code>PORT=3000
RAPIDAPI_KEY=sua-chave-api-aqui
</code></pre></div>



**âš ï¸ IMPORTANTE:** Nunca commite o arquivo `.env` no Git!

---

<a id="implementaÃ§Ã£o-passo-a-passo"></a>
## ğŸ“ ImplementaÃ§Ã£o Passo a Passo: Desenvolvimento Conceitual Completo

> **ğŸ“š ReferÃªncias Fundamentais de Desenvolvimento:**
> - **[Node.js - DocumentaÃ§Ã£o Completa](https://nodejs.org/docs/latest/api/)** - Todas as APIs do Node.js
> - **[Express.js - Guia Completo](https://expressjs.com/en/guide/routing.html)** - Framework web
> - **[MDN - JavaScript Guide](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide)** - Guia completo JavaScript
> - **[MDN - Web APIs](https://developer.mozilla.org/en-US/docs/Web/API)** - Todas as APIs web
> - **[ECMAScript Specification](https://tc39.es/ecma262/)** - EspecificaÃ§Ã£o oficial JavaScript
> - **[npm Documentation](https://docs.npmjs.com/)** - Gerenciador de pacotes

### FundamentaÃ§Ã£o TeÃ³rica: Arquitetura de AplicaÃ§Ãµes Web

**DefiniÃ§Ã£o Arquitetural:**

Uma aplicaÃ§Ã£o web moderna segue o padrÃ£o **Client-Server Architecture** onde:


<div class="codehilite"><pre><span></span><code>Client (Browser) â†HTTPâ†’ Server (Node.js) â†HTTPâ†’ External API
     â†“                      â†“                      â†“
  JavaScript            Express.js            GeoDB API
  Web Workers           Controllers           REST Endpoints
  SharedArrayBuffer     Services              JSON Response
</code></pre></div>



**Teorema de SeparaÃ§Ã£o de Responsabilidades:**

Seja `A` uma aplicaÃ§Ã£o web com `n` componentes. Se cada componente `C_i` tem responsabilidade Ãºnica `R_i` tal que `R_i âˆ© R_j = âˆ…` para `i â‰  j`, entÃ£o:

1. **Manutenibilidade:** MudanÃ§as em `C_i` afetam apenas `R_i`
2. **Testabilidade:** Cada `C_i` pode ser testado isoladamente
3. **Escalabilidade:** Novos componentes podem ser adicionados sem modificar existentes

**Prova (EsboÃ§o):**

Por definiÃ§Ã£o de responsabilidade Ãºnica, mudanÃ§as em `C_i` afetam apenas `R_i`. Como `R_i âˆ© R_j = âˆ…`, nÃ£o hÃ¡ dependÃªncias cruzadas. Portanto, modificaÃ§Ãµes sÃ£o localizadas e testÃ¡veis isoladamente.

**AplicaÃ§Ã£o no Projeto:**

- **Frontend (Browser):** ResponsÃ¡vel apenas por UI e interaÃ§Ã£o do usuÃ¡rio
- **Backend (Express):** ResponsÃ¡vel apenas por roteamento e orquestraÃ§Ã£o
- **Services:** ResponsÃ¡veis apenas por lÃ³gica de negÃ³cio
- **Workers:** ResponsÃ¡veis apenas por processamento paralelo

### NÃ­vel 1: Backend BÃ¡sico - FundamentaÃ§Ã£o TeÃ³rica

#### 1.1 package.json - Gerenciamento de DependÃªncias

> **ğŸ“š ReferÃªncias:**
> - **[package.json - npm Docs](https://docs.npmjs.com/cli/v9/configuring-npm/package-json)** - EspecificaÃ§Ã£o completa
> - **[Semantic Versioning](https://semver.org/)** - Versionamento semÃ¢ntico
> - **[Node.js Modules](https://nodejs.org/docs/latest/api/modules.html)** - Sistema de mÃ³dulos


<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;index.js&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;node index.js&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nodemon index.js&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;axios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^1.13.2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ejs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^3.1.10&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;express&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.2.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;nodemon&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^3.1.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;wft-geodb-js-client&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^2.0.3&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise Conceitual das DependÃªncias:**

> **ğŸ“š ReferÃªncias Completas:**
> - **[Express.js - DocumentaÃ§Ã£o Oficial](https://expressjs.com/en/5x/api.html)** - Framework web minimalista
> - **[EJS - Template Engine](https://ejs.co/)** - Embedded JavaScript templates
> - **[Axios - HTTP Client](https://axios-http.com/docs/intro)** - Cliente HTTP baseado em Promises
> - **[Node.js Modules](https://nodejs.org/docs/latest/api/modules.html)** - Sistema de mÃ³dulos CommonJS
> - **[npm - Package Manager](https://docs.npmjs.com/)** - Gerenciador de pacotes Node.js

**1. Express.js (`express`):**

**Conceito:** Framework web minimalista e flexÃ­vel para Node.js que fornece recursos robustos para aplicaÃ§Ãµes web e mÃ³veis.

**Por que usar:**
- **Routing:** Sistema de roteamento HTTP robusto
- **Middleware:** Arquitetura de middleware extensÃ­vel
- **Performance:** Alto desempenho e baixo overhead
- **PadrÃ£o:** PadrÃ£o de fato para aplicaÃ§Ãµes Node.js

**Teorema de Middleware:**

Em Express, middleware sÃ£o funÃ§Ãµes que tÃªm acesso ao objeto de requisiÃ§Ã£o (`req`), ao objeto de resposta (`res`) e Ã  prÃ³xima funÃ§Ã£o middleware (`next`). A execuÃ§Ã£o segue a ordem de registro:


<div class="codehilite"><pre><span></span><code>req â†’ middleware1 â†’ middleware2 â†’ ... â†’ route handler â†’ res
</code></pre></div>



**2. EJS (`ejs`):**

**Conceito:** Template engine que permite gerar HTML dinamicamente usando JavaScript.

**Por que usar:**
- **Sintaxe Familiar:** Usa JavaScript puro
- **Server-Side Rendering:** Renderiza HTML no servidor
- **Performance:** CompilaÃ§Ã£o rÃ¡pida e cache de templates

**3. Axios (`axios`):**

**Conceito:** Cliente HTTP baseado em Promises para fazer requisiÃ§Ãµes HTTP.

**Por que usar:**
- **Promises:** Suporte nativo a async/await
- **Interceptors:** Permite interceptar requisiÃ§Ãµes/respostas
- **Cancelamento:** Suporte a cancelamento de requisiÃ§Ãµes
- **TransformaÃ§Ã£o:** TransformaÃ§Ã£o automÃ¡tica de dados JSON

**ReferÃªncia:** [Axios - MDN Alternative](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API) - ComparaÃ§Ã£o com Fetch API

**4. Nodemon (`nodemon`):**

**Conceito:** UtilitÃ¡rio que monitora mudanÃ§as em arquivos e reinicia automaticamente o servidor Node.js.

**Por que usar:**
- **Desenvolvimento:** Acelera ciclo de desenvolvimento
- **Hot Reload:** Reinicia servidor automaticamente
- **Produtividade:** NÃ£o precisa reiniciar manualmente

**AnÃ¡lise de DependÃªncias:**

**Complexidade de DependÃªncias:**
- **Express:** ~50 dependÃªncias transitivas
- **Axios:** ~10 dependÃªncias transitivas
- **EJS:** ~5 dependÃªncias transitivas

**Gerenciamento de VersÃµes:**

O uso de `^` (caret) permite atualizaÃ§Ãµes de versÃ£o menores e patches:
- `^5.2.1` permite `5.2.1` atÃ© `5.x.x` (nÃ£o `6.0.0`)
- Garante compatibilidade enquanto permite correÃ§Ãµes de seguranÃ§a

#### 1.2 Validador de Ambiente - AnÃ¡lise Conceitual

> **ğŸ“š ReferÃªncias:**
> - **[process.env - Node.js](https://nodejs.org/docs/latest/api/process.html#processenv)** - VariÃ¡veis de ambiente
> - **[Error Handling - Node.js](https://nodejs.org/docs/latest/api/errors.html)** - Tratamento de erros
> - **[Fail-Fast Principle](https://en.wikipedia.org/wiki/Fail-fast)** - PrincÃ­pio de falha rÃ¡pida

**Conceito TeÃ³rico: Fail-Fast Principle**

O princÃ­pio **Fail-Fast** estabelece que erros devem ser detectados o mais cedo possÃ­vel no ciclo de vida da aplicaÃ§Ã£o. Em vez de permitir que a aplicaÃ§Ã£o continue com configuraÃ§Ã£o invÃ¡lida, devemos abortar imediatamente com mensagem de erro clara.

**Teorema de ValidaÃ§Ã£o Antecipada:**

Seja `V` o conjunto de validaÃ§Ãµes e `E` o conjunto de erros. Se validarmos todas as condiÃ§Ãµes `v âˆˆ V` antes de iniciar a aplicaÃ§Ã£o, entÃ£o:

1. **DetecÃ§Ã£o Precoce:** Erros sÃ£o detectados antes de qualquer processamento
2. **Mensagens Claras:** Erros podem incluir contexto completo
3. **Economia de Recursos:** NÃ£o desperdiÃ§amos recursos em configuraÃ§Ã£o invÃ¡lida

**Prova:**

Se uma validaÃ§Ã£o `v_i` falha apÃ³s `n` operaÃ§Ãµes, temos desperdÃ­cio de recursos `O(n)`. Se validamos antes, desperdÃ­cio Ã© `O(1)`. Portanto, validaÃ§Ã£o antecipada Ã© sempre mais eficiente.

**Arquivo:** `app/util/envValidator.js`


<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Validador de variÃ¡veis de ambiente</span>
<span class="cm"> * Verifica se todas as variÃ¡veis necessÃ¡rias estÃ£o configuradas</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">validateEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">requiredEnvVars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;RAPIDAPI_KEY&quot;</span><span class="p">];</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">missingVars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requiredEnvVars</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nx">varName</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">varName</span><span class="p">]</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">missingVars</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span>
<span class="w">      </span><span class="sb">`Missing required environment variables: </span><span class="si">${</span><span class="nx">missingVars</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="si">}</span><span class="sb">\n`</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="s2">&quot;Please check your .env file or environment configuration.&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ValidaÃ§Ã£o especÃ­fica do PORT</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">65535</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span>
<span class="w">      </span><span class="sb">`Invalid PORT value: </span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">. Must be a number between 1 and 65535.`</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ValidaÃ§Ã£o bÃ¡sica da API key</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RAPIDAPI_KEY</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;RAPIDAPI_KEY appears to be invalid (too short).&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Environment variables validated successfully&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">validateEnvironment</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>



**AnÃ¡lise Conceitual do CÃ³digo:**

**1. ValidaÃ§Ã£o Antecipada (Fail-Fast):**


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">missingVars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requiredEnvVars</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="nx">varName</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">varName</span><span class="p">]</span>
<span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">missingVars</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(...);</span>
<span class="p">}</span>
</code></pre></div>



**Conceito:** Usa `Array.filter()` para identificar variÃ¡veis faltantes antes de qualquer inicializaÃ§Ã£o.

> **ğŸ“š ReferÃªncia:** [Array.filter() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter) - MÃ©todo funcional de filtragem

**2. ValidaÃ§Ã£o de Tipos:**


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">65535</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(...);</span>
<span class="p">}</span>
</code></pre></div>



**Conceito:** Valida nÃ£o apenas existÃªncia, mas tambÃ©m tipo e range vÃ¡lido.

> **ğŸ“š ReferÃªncia:** [parseInt() - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseInt) - ConversÃ£o de string para inteiro

**3. ValidaÃ§Ã£o de Comprimento:**


<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RAPIDAPI_KEY</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;RAPIDAPI_KEY appears to be invalid (too short).&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



**Conceito:** ValidaÃ§Ã£o heurÃ­stica baseada em comprimento mÃ­nimo esperado.

**AnÃ¡lise de Complexidade:**

- **Tempo:** O(n) onde n Ã© nÃºmero de variÃ¡veis obrigatÃ³rias
- **EspaÃ§o:** O(n) para array de variÃ¡veis faltantes
- **Overhead:** MÃ­nimo, executado apenas uma vez na inicializaÃ§Ã£o

**PadrÃ£o de Design:** Strategy Pattern para validaÃ§Ãµes diferentes (tipo, range, comprimento)

#### 1.3 ServiÃ§o de Cidade - Arquitetura de ServiÃ§os

> **ğŸ“š ReferÃªncias Completas:**
> - **[Axios - DocumentaÃ§Ã£o Completa](https://axios-http.com/docs/intro)** - Cliente HTTP
> - **[HTTP Methods - MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods)** - MÃ©todos HTTP
> - **[REST API Design](https://restfulapi.net/)** - PrincÃ­pios REST
> - **[Error Handling Patterns](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises#error_handling)** - PadrÃµes de tratamento de erro

**Conceito TeÃ³rico: Service Layer Pattern**

O padrÃ£o **Service Layer** separa a lÃ³gica de negÃ³cio da lÃ³gica de apresentaÃ§Ã£o e acesso a dados. ServiÃ§os encapsulam operaÃ§Ãµes complexas e fornecem interface limpa para controllers.

**Teorema de Encapsulamento:**

Seja `S` um serviÃ§o que encapsula operaÃ§Ã£o `O`. Se `O` tem complexidade `C(O)`, entÃ£o usar `S` reduz complexidade percebida para `C(S) < C(O)` atravÃ©s de:

1. **AbstraÃ§Ã£o:** Detalhes de implementaÃ§Ã£o ocultos
2. **ReutilizaÃ§Ã£o:** `S` pode ser usado por mÃºltiplos controllers
3. **Testabilidade:** `S` pode ser testado isoladamente

**Arquivo:** `app/services/cityService.js`


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;axios&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">buildQueryString</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../util/queryString&quot;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Busca cidades da GeoDB API via RapidAPI</span>
<span class="cm"> * </span>
<span class="cm"> * @param {Object} options - OpÃ§Ãµes de filtro e paginaÃ§Ã£o</span>
<span class="cm"> * @param {number} options.limit - NÃºmero de resultados (padrÃ£o: 10)</span>
<span class="cm"> * @param {number} options.offset - Deslocamento para paginaÃ§Ã£o (padrÃ£o: 0)</span>
<span class="cm"> * @param {string} options.sort - Campo para ordenaÃ§Ã£o (padrÃ£o: &quot;name&quot;)</span>
<span class="cm"> * @returns {Promise&lt;Object&gt;} Dados das cidades retornados pela API</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">axiosRequestCityData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ... outros parÃ¢metros opcionais</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">queryString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">buildQueryString</span><span class="p">({</span>
<span class="w">    </span><span class="nx">offset</span><span class="p">,</span>
<span class="w">    </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sort</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ... outros parÃ¢metros</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://wft-geo-db.p.rapidapi.com/v1/geo/cities?</span><span class="si">${</span><span class="nx">queryString</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RAPIDAPI_KEY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;RAPIDAPI_KEY nÃ£o configurada.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500</span><span class="p">;</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;x-rapidapi-host&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;wft-geo-db.p.rapidapi.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;x-rapidapi-key&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RAPIDAPI_KEY</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Tratamento especial para diferentes tipos de erro</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">errorData</span><span class="o">?</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;ACCESS_DENIED&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span>
<span class="w">          </span><span class="sb">`Limite de consulta excedido: </span><span class="si">${</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="nx">limitError</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">403</span><span class="p">;</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">limitError</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span>
<span class="w">        </span><span class="sb">`API error: </span><span class="si">${</span><span class="nx">status</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}${</span><span class="nx">errorData</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">` - </span><span class="si">${</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="sb">`</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">      </span><span class="nx">apiError</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">status</span><span class="p">;</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">apiError</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Network error: NÃ£o foi possÃ­vel conectar Ã  API&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">axiosRequestCityData</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>



**Conceitos:**
- Tratamento robusto de erros
- DiferenciaÃ§Ã£o entre erros de rede, API e configuraÃ§Ã£o
- Headers de autenticaÃ§Ã£o

#### 1.4 Rotas da API

**Arquivo:** `app/routes/api.js`


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cityApiController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../controllers/cityApiController&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">validateQueryParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../middleware/validateQueryParams&quot;</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="cm">/**</span>
<span class="cm"> * GET /api/cities</span>
<span class="cm"> * Retorna lista de cidades com paginaÃ§Ã£o e filtros</span>
<span class="cm"> */</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/cities&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">validateQueryParams</span><span class="p">,</span><span class="w"> </span><span class="nx">cityApiController</span><span class="p">.</span><span class="nx">show</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * GET /api/health</span>
<span class="cm"> * Endpoint de health check</span>
<span class="cm"> */</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/health&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ok&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">uptime</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">uptime</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;development&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">router</span><span class="p">;</span>
</code></pre></div>



#### 1.5 Servidor Principal

**Arquivo:** `app/index.js`


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;node:path&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">webRouter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./routes/web&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">apiRouter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./routes/api&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">errorHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./middleware/errorHandler&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">validateEnvironment</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./util/envValidator&quot;</span><span class="p">);</span>

<span class="c1">// Valida variÃ¡veis de ambiente antes de iniciar</span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">validateEnvironment</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Environment validation failed:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">  </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>

<span class="c1">// ConfiguraÃ§Ã£o do template engine EJS</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;view engine&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ejs&quot;</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;views&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;views&quot;</span><span class="p">));</span>

<span class="c1">// Middleware para parsing de dados</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span><span class="w"> </span><span class="nx">extended</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}));</span>

<span class="c1">// Headers necessÃ¡rios para SharedArrayBuffer</span>
<span class="c1">// SharedArrayBuffer requer Cross-Origin-Opener-Policy e Cross-Origin-Embedder-Policy</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Cross-Origin-Opener-Policy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;same-origin&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Cross-Origin-Embedder-Policy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;require-corp&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="c1">// Middleware para servir arquivos estÃ¡ticos</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="k">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;public&quot;</span><span class="p">),</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">setHeaders</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">filePath</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">filePath</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.js&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;application/javascript; charset=utf-8&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Desabilita cache para arquivos JS durante desenvolvimento</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;no-cache, no-store, must-revalidate&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Pragma&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;no-cache&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Expires&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}));</span>

<span class="c1">// Registro das rotas</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">webRouter</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">apiRouter</span><span class="p">);</span>

<span class="c1">// Middleware de tratamento de erros (deve ser o Ãºltimo)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">errorHandler</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Server is running on port </span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Environment: </span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;development&quot;</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Access: http://localhost:</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>



**Conceitos importantes:**
- Headers HTTP para SharedArrayBuffer
- DesabilitaÃ§Ã£o de cache para desenvolvimento
- Ordem dos middlewares Ã© crucial

---

### NÃ­vel 2: Frontend - ProgramaÃ§Ã£o Funcional

#### 2.1 Modelo de Estado (ImutÃ¡vel)

**Arquivo:** `app/public/js/models/cityModel.js`


<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Cria estado inicial da aplicaÃ§Ã£o</span>
<span class="cm"> * @param {number} page - PÃ¡gina atual (padrÃ£o: 0)</span>
<span class="cm"> * @param {number} limit - Limite de resultados por pÃ¡gina (padrÃ£o: 10)</span>
<span class="cm"> * @param {string} sort - Campo para ordenaÃ§Ã£o (padrÃ£o: &quot;name&quot;)</span>
<span class="cm"> * @returns {Object} Estado inicial</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">createState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">sort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span>
<span class="w">  </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">  </span><span class="nx">sort</span><span class="o">:</span><span class="w"> </span><span class="nx">sort</span><span class="p">,</span>
<span class="w">  </span><span class="nx">selectedCities</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="c1">// Array de cidades selecionadas</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * Atualiza a pÃ¡gina no estado (imutÃ¡vel)</span>
<span class="cm"> * @param {Object} state - Estado atual</span>
<span class="cm"> * @param {number} page - Nova pÃ¡gina</span>
<span class="cm"> * @returns {Object} Novo estado com pÃ¡gina atualizada</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">setPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span>
<span class="w">  </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">),</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * Calcula o offset baseado na pÃ¡gina atual</span>
<span class="cm"> * @param {Object} state - Estado atual</span>
<span class="cm"> * @returns {number} Offset calculado</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">getOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">limit</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Adiciona uma cidade Ã  lista de selecionadas (se nÃ£o existir)</span>
<span class="cm"> * @param {Object} state - Estado atual</span>
<span class="cm"> * @param {Object} city - Cidade a ser adicionada</span>
<span class="cm"> * @returns {Object} Novo estado com cidade adicionada</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">addSelectedCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Verifica se a cidade jÃ¡ estÃ¡ selecionada</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isAlreadySelected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nx">selected</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">selected</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isAlreadySelected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">;</span><span class="w"> </span><span class="c1">// Retorna estado sem alteraÃ§Ãµes (idempotÃªncia)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Retorna NOVO objeto, nÃ£o modifica o existente</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span>
<span class="w">    </span><span class="nx">selectedCities</span><span class="o">:</span><span class="w"> </span><span class="p">[...</span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">],</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Remove uma cidade da lista de selecionadas</span>
<span class="cm"> * @param {Object} state - Estado atual</span>
<span class="cm"> * @param {number|string} cityId - ID da cidade a ser removida</span>
<span class="cm"> * @returns {Object} Novo estado com cidade removida</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">removeSelectedCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">cityId</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span>
<span class="w">  </span><span class="nx">selectedCities</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">cityId</span>
<span class="w">  </span><span class="p">),</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * Limpa todas as cidades selecionadas</span>
<span class="cm"> * @param {Object} state - Estado atual</span>
<span class="cm"> * @returns {Object} Novo estado sem cidades selecionadas</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">clearSelectedCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span>
<span class="w">  </span><span class="nx">selectedCities</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * Verifica se uma cidade estÃ¡ selecionada</span>
<span class="cm"> * @param {Object} state - Estado atual</span>
<span class="cm"> * @param {number|string} cityId - ID da cidade</span>
<span class="cm"> * @returns {boolean} True se a cidade estÃ¡ selecionada</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">isCitySelected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">cityId</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">cityId</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">createState</span><span class="p">,</span>
<span class="w">  </span><span class="nx">getOffset</span><span class="p">,</span>
<span class="w">  </span><span class="nx">setPage</span><span class="p">,</span>
<span class="w">  </span><span class="nx">addSelectedCity</span><span class="p">,</span>
<span class="w">  </span><span class="nx">removeSelectedCity</span><span class="p">,</span>
<span class="w">  </span><span class="nx">clearSelectedCities</span><span class="p">,</span>
<span class="w">  </span><span class="nx">isCitySelected</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>



**Conceitos de ProgramaÃ§Ã£o Funcional:**
- âœ… **Imutabilidade:** Nunca modifica `state`, sempre retorna novo objeto
- âœ… **FunÃ§Ãµes puras:** Mesma entrada = mesma saÃ­da, sem efeitos colaterais
- âœ… **ComposiÃ§Ã£o:** FunÃ§Ãµes pequenas que podem ser combinadas
- âœ… **IdempotÃªncia:** `addSelectedCity` pode ser chamada mÃºltiplas vezes sem efeito

**Por que imutabilidade?**
- Previsibilidade: estado nÃ£o muda inesperadamente
- Debugging: histÃ³rico de estados
- Performance: comparaÃ§Ã£o por referÃªncia Ã© rÃ¡pida
- Thread-safety: sem mutaÃ§Ã£o, sem race conditions

#### 2.2 View (RenderizaÃ§Ã£o)

**Arquivo:** `app/public/js/views/cityView.js`


<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Renderiza lista de cidades no DOM</span>
<span class="cm"> * @param {HTMLElement} element - Elemento container</span>
<span class="cm"> * @param {Array&lt;Object&gt;} cities - Array de objetos cidade</span>
<span class="cm"> * @param {Function} onSelectCity - Callback quando cidade Ã© selecionada</span>
<span class="cm"> * @param {Function} isSelected - FunÃ§Ã£o para verificar se cidade estÃ¡ selecionada</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">renderCitiesList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">element</span><span class="p">,</span><span class="w"> </span><span class="nx">cities</span><span class="p">,</span><span class="w"> </span><span class="nx">onSelectCity</span><span class="p">,</span><span class="w"> </span><span class="nx">isSelected</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Limpa conteÃºdo anterior</span>
<span class="w">  </span><span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">cities</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">      &lt;div class=&quot;alert alert-info mt-4&quot; role=&quot;alert&quot;&gt;</span>
<span class="sb">        &lt;i class=&quot;bi bi-info-circle&quot;&gt;&lt;/i&gt; No cities found.</span>
<span class="sb">      &lt;/div&gt;</span>
<span class="sb">    `</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Cria elementos para cada cidade</span>
<span class="w">  </span><span class="nx">cities</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cityItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">cityItem</span><span class="p">.</span><span class="nx">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;card mb-3 border&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Destaca se jÃ¡ estÃ¡ selecionada</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isSelected</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">isSelected</span><span class="p">(</span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cityItem</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">&quot;border-success&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;bg-light&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ... construÃ§Ã£o do HTML da cidade ...</span>

<span class="w">    </span><span class="c1">// Adiciona evento de clique</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">onSelectCity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">selectCityButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">onSelectCity</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">element</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">cityItem</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">renderCitiesList</span><span class="p">,</span>
<span class="w">  </span><span class="nx">renderSelectedCitiesList</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// ... outras funÃ§Ãµes de renderizaÃ§Ã£o</span>
<span class="p">};</span>
</code></pre></div>



**Conceitos:**
- SeparaÃ§Ã£o de responsabilidades (View apenas renderiza)
- FunÃ§Ãµes puras de renderizaÃ§Ã£o
- Callbacks para comunicaÃ§Ã£o com controller

---

### NÃ­vel 3: Consumo AssÃ­ncrono da API

#### 3.1 Controller de Cidades

**Arquivo:** `app/public/js/controllers/cityController.js`


<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">createState</span><span class="p">,</span>
<span class="w">  </span><span class="nx">getOffset</span><span class="p">,</span>
<span class="w">  </span><span class="nx">setPage</span><span class="p">,</span>
<span class="w">  </span><span class="nx">addSelectedCity</span><span class="p">,</span>
<span class="w">  </span><span class="nx">removeSelectedCity</span><span class="p">,</span>
<span class="w">  </span><span class="nx">clearSelectedCities</span><span class="p">,</span>
<span class="w">  </span><span class="nx">isCitySelected</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../models/cityModel.js&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">renderCitiesList</span><span class="p">,</span>
<span class="w">  </span><span class="nx">renderCurrentPage</span><span class="p">,</span>
<span class="w">  </span><span class="nx">showErrorCityList</span><span class="p">,</span>
<span class="w">  </span><span class="nx">showLoading</span><span class="p">,</span>
<span class="w">  </span><span class="nx">renderSelectedCitiesList</span><span class="p">,</span>
<span class="w">  </span><span class="nx">updateSelectedCount</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../views/cityView.js&quot;</span><span class="p">;</span>

<span class="c1">// Estado inicial da aplicaÃ§Ã£o</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createState</span><span class="p">();</span>

<span class="c1">// Flag para prevenir requisiÃ§Ãµes simultÃ¢neas</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Manipula a paginaÃ§Ã£o (prÃ³xima/anterior)</span>
<span class="cm"> * @param {string} direction - DireÃ§Ã£o da paginaÃ§Ã£o (&quot;next&quot; ou &quot;previous&quot;)</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">handlePagination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">direction</span><span class="p">,</span><span class="w"> </span><span class="nx">elements</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Previne requisiÃ§Ãµes simultÃ¢neas</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isLoading</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">setButtonsDisabled</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">clearErrorCityList</span><span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">errorBox</span><span class="p">);</span>
<span class="w">    </span><span class="nx">showLoading</span><span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">citiesList</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Calcula prÃ³xima pÃ¡gina</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextPage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="nx">direction</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;next&quot;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="nx">direction</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;previous&quot;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextPage</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">nextPage</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Atualiza estado (imutÃ¡vel)</span>
<span class="w">    </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setPage</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">newPage</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Prepara opÃ§Ãµes para requisiÃ§Ã£o</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">limit</span><span class="p">,</span>
<span class="w">      </span><span class="nx">offset</span><span class="o">:</span><span class="w"> </span><span class="nx">getOffset</span><span class="p">(</span><span class="nx">state</span><span class="p">),</span>
<span class="w">      </span><span class="nx">sort</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">sort</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// ConstrÃ³i query string</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">queryString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URLSearchParams</span><span class="p">(</span><span class="nx">options</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Faz requisiÃ§Ã£o assÃ­ncrona Ã  API</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/cities?</span><span class="si">${</span><span class="nx">queryString</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;Content-Type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Tratamento de erros...</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">errorMessage</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Processa resposta JSON</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="c1">// Atualiza UI</span>
<span class="w">    </span><span class="nx">renderCitiesList</span><span class="p">(</span>
<span class="w">      </span><span class="nx">elements</span><span class="p">.</span><span class="nx">citiesList</span><span class="p">,</span>
<span class="w">      </span><span class="nx">cities</span><span class="p">,</span>
<span class="w">      </span><span class="nx">handleSelectCity</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="nx">cityId</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">isCitySelected</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">cityId</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="nx">renderCurrentPage</span><span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">currentPage</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">page</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Tratamento de erros...</span>
<span class="w">    </span><span class="nx">showErrorCityList</span><span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">errorBox</span><span class="p">,</span><span class="w"> </span><span class="nx">errorMessage</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Sempre reabilita botÃµes</span>
<span class="w">    </span><span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="nx">setButtonsDisabled</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**Conceitos:**
- `async/await` para cÃ³digo assÃ­ncrono legÃ­vel
- Tratamento de erros com try/catch
- Flag de loading para prevenir requisiÃ§Ãµes simultÃ¢neas
- Estado imutÃ¡vel preservado

---

### NÃ­vel 4: MemÃ³ria Compartilhada e SerializaÃ§Ã£o

#### 4.1 Serializador de MemÃ³ria Compartilhada

**Arquivo:** `app/public/js/util/sharedMemorySerializer.js`


<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * UtilitÃ¡rio para serializaÃ§Ã£o/desserializaÃ§Ã£o de cidades em ArrayBuffer</span>
<span class="cm"> * Permite uso de memÃ³ria compartilhada (SharedArrayBuffer) entre workers</span>
<span class="cm"> * </span>
<span class="cm"> * Estrutura de cada cidade no buffer:</span>
<span class="cm"> * - 4 bytes: tamanho do objeto JSON serializado (Uint32)</span>
<span class="cm"> * - N bytes: dados JSON (UTF-8 encoded)</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Calcula tamanho necessÃ¡rio do buffer para armazenar cidades</span>
<span class="cm"> * @param {Array} cities - Array de cidades</span>
<span class="cm"> * @returns {number} Tamanho em bytes necessÃ¡rio</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">calculateBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">cities</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="nx">cities</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="p">().</span><span class="nx">encode</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="nx">totalSize</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="p">;</span><span class="w"> </span><span class="c1">// 4 bytes para tamanho + dados JSON</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">totalSize</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Serializa uma cidade para ArrayBuffer</span>
<span class="cm"> * @param {Object} city - Cidade a serializar</span>
<span class="cm"> * @param {number} offset - Offset no buffer</span>
<span class="cm"> * @param {Uint8Array} buffer - Buffer onde escrever</span>
<span class="cm"> * @returns {number} Novo offset apÃ³s escrita</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">serializeCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="p">().</span><span class="nx">encode</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Escreve tamanho (4 bytes, little-endian)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">byteOffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="w">  </span><span class="nx">view</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Escreve dados JSON</span>
<span class="w">  </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">jsonBytes</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Desserializa uma cidade do ArrayBuffer</span>
<span class="cm"> * @param {number} offset - Offset no buffer</span>
<span class="cm"> * @param {Uint8Array} buffer - Buffer de onde ler</span>
<span class="cm"> * @returns {Object|null} Cidade desserializada ou null se invÃ¡lida</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">deserializeCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// LÃª tamanho (4 bytes, little-endian)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">byteOffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">view</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">size</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="c1">// Tamanho invÃ¡lido</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// LÃª dados JSON</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">size</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextDecoder</span><span class="p">().</span><span class="nx">decode</span><span class="p">(</span><span class="nx">jsonBytes</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Erro ao desserializar cidade:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Serializa array de cidades para ArrayBuffer</span>
<span class="cm"> * @param {Array} cities - Array de cidades</span>
<span class="cm"> * @returns {ArrayBuffer} Buffer com cidades serializadas</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">serializeCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">cities</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calculateBufferSize</span><span class="p">(</span><span class="nx">cities</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">ArrayBuffer</span><span class="p">(</span><span class="nx">totalSize</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">uint8Array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="nx">cities</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">serializeCity</span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">uint8Array</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">buffer</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Desserializa array de cidades do ArrayBuffer</span>
<span class="cm"> * @param {ArrayBuffer|SharedArrayBuffer} buffer - Buffer com cidades serializadas</span>
<span class="cm"> * @param {number} maxCities - NÃºmero mÃ¡ximo de cidades a ler (opcional)</span>
<span class="cm"> * @returns {Array} Array de cidades desserializadas</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">deserializeCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span><span class="w"> </span><span class="nx">maxCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Infinity</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">uint8Array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">offset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">uint8Array</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxCities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">uint8Array</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">deserializeCity</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">uint8Array</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// Cidade invÃ¡lida, para leitura</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">cities</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="w">    </span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Calcula prÃ³ximo offset</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">view</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cities</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Calcula tamanho estimado necessÃ¡rio para armazenar N cidades</span>
<span class="cm"> * @param {number} numCities - NÃºmero de cidades</span>
<span class="cm"> * @returns {number} Tamanho estimado em bytes</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">estimateBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">numCities</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">avgCitySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">200</span><span class="p">;</span><span class="w"> </span><span class="c1">// bytes mÃ©dios por cidade</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">overhead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="p">;</span><span class="w"> </span><span class="c1">// 4 bytes para tamanho</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">numCities</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">avgCitySize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">overhead</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 20% de margem</span>
<span class="p">};</span>
</code></pre></div>



**Conceitos:**
- SerializaÃ§Ã£o binÃ¡ria eficiente
- Estrutura de dados auto-descritiva (tamanho + dados)
- Little-endian para compatibilidade
- Estimativa de tamanho para alocaÃ§Ã£o

---

### NÃ­vel 5: Web Workers e Coleta Paralela

#### 5.1 Worker de Coleta de Dados

**Arquivo:** `app/public/js/workers/dataCollectionWorker.js`


<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Web Worker para coleta paralela de dados da API</span>
<span class="cm"> * Cada worker busca um subconjunto de pÃ¡ginas usando algoritmo de divisÃ£o e conquista</span>
<span class="cm"> * Implementa escrita controlada em memÃ³ria compartilhada usando Atomics</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">serializeCity</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../util/sharedMemorySerializer.js&quot;</span><span class="p">;</span>

<span class="c1">// Rate limiting: delay entre requisiÃ§Ãµes</span>
<span class="c1">// Plano BASIC: 1 req/s, entÃ£o usamos 2.5s entre requisiÃ§Ãµes (~0.4 req/s)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">REQUEST_DELAY_MS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 2 segundos base</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">SAFETY_MARGIN_MS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0.5s de margem = total 2.5s</span>

<span class="cm">/**</span>
<span class="cm"> * Faz requisiÃ§Ã£o Ã  API com retry em caso de erro</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">fetchPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">retryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxRetries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">queryString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URLSearchParams</span><span class="p">({</span>
<span class="w">        </span><span class="nx">offset</span><span class="p">,</span>
<span class="w">        </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sort</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">}).</span><span class="nx">toString</span><span class="p">();</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/cities?</span><span class="si">${</span><span class="nx">queryString</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;Content-Type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">429</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Rate limit - backoff exponencial</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">waitTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">15000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`Rate limit atingido. Aguardando </span><span class="si">${</span><span class="nx">waitTime</span><span class="o">/</span><span class="mf">1000</span><span class="si">}</span><span class="sb">s...`</span><span class="p">);</span>

<span class="w">          </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">            </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;rate_limit&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">workerId</span><span class="o">:</span><span class="w"> </span><span class="nx">currentWorkerId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">waitTime</span><span class="o">:</span><span class="w"> </span><span class="nx">waitTime</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span>
<span class="w">            </span><span class="nx">page</span><span class="p">,</span>
<span class="w">          </span><span class="p">});</span>

<span class="w">          </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">waitTime</span><span class="p">));</span>
<span class="w">          </span><span class="nx">retryCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`HTTP error! status: </span><span class="si">${</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">retryCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">maxRetries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">retryCount</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Escreve cidade no buffer compartilhado usando Atomics para controle de escrita</span>
<span class="cm"> * Implementa algoritmo de divisÃ£o e conquista: cada worker escreve sua parcela</span>
<span class="cm"> * de forma thread-safe usando operaÃ§Ãµes atÃ´micas</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">writeCityToSharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">,</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Serializa cidade para calcular tamanho necessÃ¡rio</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="p">().</span><span class="nx">encode</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">citySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="c1">// 4 bytes para tamanho + dados</span>

<span class="w">    </span><span class="c1">// ObtÃ©m Ã­ndice de escrita atual de forma atÃ´mica</span>
<span class="w">    </span><span class="c1">// Usa compare-and-swap loop para garantir escrita thread-safe</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">attempts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxAttempts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// LÃª Ã­ndice atual</span>
<span class="w">      </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Verifica se hÃ¡ espaÃ§o suficiente</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">citySize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">currentWorkerId</span><span class="si">}</span><span class="sb">: Buffer cheio.`</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Tenta reservar espaÃ§o usando compare-and-swap</span>
<span class="w">      </span><span class="c1">// Se outro worker escreveu entre a leitura e agora, o CAS falha e tentamos novamente</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">citySize</span><span class="p">;</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">newIndex</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Sucesso: reservamos o espaÃ§o, agora podemos escrever</span>
<span class="w">        </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// CAS falhou: outro worker escreveu primeiro, tenta novamente</span>
<span class="w">      </span><span class="nx">attempts</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">attempts</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">maxAttempts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">currentWorkerId</span><span class="si">}</span><span class="sb">: Falhou ao reservar espaÃ§o apÃ³s </span><span class="si">${</span><span class="nx">maxAttempts</span><span class="si">}</span><span class="sb"> tentativas`</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Escreve dados no buffer (jÃ¡ temos o espaÃ§o reservado)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uint8Array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="w">    </span><span class="nx">view</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">jsonBytes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// Escreve tamanho</span>
<span class="w">    </span><span class="nx">uint8Array</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">jsonBytes</span><span class="p">,</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// Escreve dados JSON</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">currentWorkerId</span><span class="si">}</span><span class="sb">: Erro ao escrever cidade:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// VariÃ¡veis globais do worker</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">currentWorkerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">atomicView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Processa mensagens do thread principal</span>
<span class="cm"> */</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">startPage</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">endPage</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">limit</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">workerId</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">sharedBuffer</span><span class="o">:</span><span class="w"> </span><span class="nx">receivedBuffer</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">headerSize</span><span class="o">:</span><span class="w"> </span><span class="nx">receivedHeaderSize</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">totalBufferSize</span><span class="o">:</span><span class="w"> </span><span class="nx">receivedTotalBufferSize</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">useSharedMemory</span><span class="o">:</span><span class="w"> </span><span class="nx">receivedUseSharedMemory</span><span class="w"> </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

<span class="w">  </span><span class="nx">currentWorkerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">workerId</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Configura memÃ³ria compartilhada se disponÃ­vel</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">receivedBuffer</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">receivedUseSharedMemory</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">sharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">receivedBuffer</span><span class="p">;</span>
<span class="w">      </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">receivedHeaderSize</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="w">      </span><span class="nx">totalBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">receivedTotalBufferSize</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>
<span class="w">      </span><span class="nx">atomicView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">      </span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">workerId</span><span class="si">}</span><span class="sb">: Erro ao configurar memÃ³ria compartilhada, usando fallback`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"> </span><span class="c1">// Mantido para fallback</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">citiesCollected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Processa cada pÃ¡gina atribuÃ­da a este worker (divisÃ£o e conquista)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startPage</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">endPage</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">;</span>

<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchPage</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Extrai cidades do resultado</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Filtra cidades vÃ¡lidas</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">validCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
<span class="w">          </span><span class="p">(</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">            </span><span class="nx">city</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="nx">city</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Escreve cidades no buffer compartilhado ou acumula para fallback</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Escreve cada cidade no buffer compartilhado usando escrita controlada</span>
<span class="w">          </span><span class="nx">validCities</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">writeCityToSharedBuffer</span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">,</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">citiesCollected</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Fallback: acumula em array local</span>
<span class="w">          </span><span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">validCities</span><span class="p">);</span>
<span class="w">          </span><span class="nx">citiesCollected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">totalCities</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Envia progresso para o thread principal</span>
<span class="w">        </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;progress&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">workerId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">page</span><span class="p">,</span>
<span class="w">          </span><span class="nx">totalPages</span><span class="o">:</span><span class="w"> </span><span class="nx">endPage</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startPage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">          </span><span class="nx">citiesCollected</span><span class="o">:</span><span class="w"> </span><span class="nx">citiesCollected</span><span class="p">,</span>
<span class="w">          </span><span class="nx">totalCitiesInPage</span><span class="o">:</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Rate limiting: aguarda antes da prÃ³xima requisiÃ§Ã£o</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">page</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">endPage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">REQUEST_DELAY_MS</span><span class="p">));</span>
<span class="w">          </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">SAFETY_MARGIN_MS</span><span class="p">));</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">page</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">              </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;progress_log&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">workerId</span><span class="p">,</span>
<span class="w">              </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Processadas </span><span class="si">${</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startPage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb"> de </span><span class="si">${</span><span class="nx">endPage</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startPage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb"> pÃ¡ginas`</span><span class="p">,</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Envia erro mas continua processando outras pÃ¡ginas</span>
<span class="w">        </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">workerId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">page</span><span class="p">,</span>
<span class="w">          </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Envia resultados finais</span>
<span class="w">    </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;complete&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">workerId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">cities</span><span class="o">:</span><span class="w"> </span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="c1">// Vazio se usando memÃ³ria compartilhada</span>
<span class="w">      </span><span class="nx">totalCities</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Erro crÃ­tico</span>
<span class="w">    </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;critical_error&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">workerId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**Conceitos importantes:**
- **Compare-and-Swap (CAS):** OperaÃ§Ã£o atÃ´mica fundamental
- **Thread-safety:** Garantia de que apenas um worker escreve por vez
- **DivisÃ£o e conquista:** Cada worker processa sua parcela
- **Fallback:** Funciona mesmo sem SharedArrayBuffer

#### 5.2 ServiÃ§o de Coleta Paralela

**Arquivo:** `app/public/js/services/dataCollectionService.js`


<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * ServiÃ§o para coleta paralela de dados usando Web Workers</span>
<span class="cm"> * Usa SharedArrayBuffer para memÃ³ria compartilhada com sincronizaÃ§Ã£o Atomics</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">estimateBufferSize</span><span class="p">,</span><span class="w"> </span><span class="nx">deserializeCities</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../util/sharedMemorySerializer.js&quot;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Verifica se SharedArrayBuffer estÃ¡ disponÃ­vel</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">isSharedArrayBufferAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Coleta dados de forma paralela usando Web Workers e memÃ³ria compartilhada</span>
<span class="cm"> * Implementa algoritmo de divisÃ£o e conquista com escrita controlada via Atomics</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">collectCitiesParallel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">onProgress</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Verifica disponibilidade de SharedArrayBuffer</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isSharedArrayBufferAvailable</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">useSharedMemory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;SharedArrayBuffer nÃ£o disponÃ­vel. Usando fallback com postMessage.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">collectCitiesParallelFallback</span><span class="p">(</span><span class="nx">targetCities</span><span class="p">,</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="p">,</span><span class="w"> </span><span class="nx">onProgress</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Calcula nÃºmero de pÃ¡ginas necessÃ¡rias</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalPages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// NÃºmero de workers: ajustado para plano BASIC da RapidAPI</span>
<span class="w">  </span><span class="c1">// Plano BASIC tem limite muito restritivo (1 req/s)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// Apenas 1 worker para respeitar limite do plano BASIC</span>

<span class="w">  </span><span class="c1">// Distribui pÃ¡ginas entre workers (divisÃ£o e conquista)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">totalPages</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Cria SharedArrayBuffer para memÃ³ria compartilhada</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span><span class="w"> </span><span class="c1">// 2 Uint32 (writeIndex + completedWorkers)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">estimatedDataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">estimateBufferSize</span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">);</span><span class="w"> </span><span class="c1">// 50% de margem</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">estimatedDataSize</span><span class="p">;</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">;</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="p">(</span><span class="nx">totalBufferSize</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Erro ao criar SharedArrayBuffer:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">collectCitiesParallelFallback</span><span class="p">(</span><span class="nx">targetCities</span><span class="p">,</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="p">,</span><span class="w"> </span><span class="nx">onProgress</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Inicializa Ã­ndices atÃ´micos no buffer compartilhado</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">atomicView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">  </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">);</span><span class="w"> </span><span class="c1">// writeIndex comeÃ§a apÃ³s header</span>
<span class="w">  </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// completedWorkers comeÃ§a em 0</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalProcessed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Cria e inicializa workers</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">endPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">((</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pagesPerWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">totalPages</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">startPage</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">totalPages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="s2">&quot;/js/workers/dataCollectionWorker.js&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;module&quot;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Passa SharedArrayBuffer e informaÃ§Ãµes de sincronizaÃ§Ã£o</span>
<span class="w">    </span><span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;start_collection&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">startPage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">endPage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">workerId</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span>
<span class="w">      </span><span class="nx">sharedBuffer</span><span class="o">:</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="c1">// SharedArrayBuffer Ã© transferÃ­vel</span>
<span class="w">      </span><span class="nx">headerSize</span><span class="o">:</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">,</span>
<span class="w">      </span><span class="nx">totalBufferSize</span><span class="o">:</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Escuta mensagens do worker</span>
<span class="w">    </span><span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">workerId</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">citiesCollected</span><span class="p">,</span><span class="w"> </span><span class="nx">totalCitiesInPage</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">waitTime</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;progress&quot;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">totalProcessed</span><span class="o">++</span><span class="p">;</span>
<span class="w">          </span><span class="c1">// LÃª contador atual de cidades do buffer compartilhado</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">estimatedCollectedProgress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">atomicView</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nb">Atomics</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentWriteIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">              </span><span class="nx">estimatedCollectedProgress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">currentWriteIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">200</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Erro ao estimar cidades coletadas no progress:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">onProgress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="nx">totalProcessed</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">totalPages</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>
<span class="w">            </span><span class="nx">onProgress</span><span class="p">(</span><span class="nx">progress</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">workers</span><span class="o">:</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">,</span>
<span class="w">              </span><span class="nx">currentPage</span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span>
<span class="w">              </span><span class="nx">totalPages</span><span class="p">,</span>
<span class="w">              </span><span class="nx">citiesCollected</span><span class="o">:</span><span class="w"> </span><span class="nx">estimatedCollectedProgress</span><span class="p">,</span>
<span class="w">              </span><span class="nx">workerId</span><span class="p">,</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;complete&quot;</span><span class="o">:</span>
<span class="w">          </span><span class="c1">// Incrementa contador atÃ´mico de workers completos</span>
<span class="w">          </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">          </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;rate_limit&quot;</span><span class="o">:</span>
<span class="w">          </span><span class="c1">// Rate limit atingido - informa usuÃ¡rio</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">onProgress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="nx">totalProcessed</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">totalPages</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">estimatedCollected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">atomicView</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nb">Atomics</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentWriteIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">                </span><span class="nx">estimatedCollected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">currentWriteIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">200</span><span class="p">);</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Erro ao estimar cidades coletadas:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">onProgress</span><span class="p">(</span><span class="nx">progress</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">workers</span><span class="o">:</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">,</span>
<span class="w">              </span><span class="nx">currentPage</span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span>
<span class="w">              </span><span class="nx">totalPages</span><span class="p">,</span>
<span class="w">              </span><span class="nx">citiesCollected</span><span class="o">:</span><span class="w"> </span><span class="nx">estimatedCollected</span><span class="p">,</span>
<span class="w">              </span><span class="nx">workerId</span><span class="p">,</span>
<span class="w">              </span><span class="nx">rateLimit</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">              </span><span class="nx">waitTime</span><span class="p">,</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">workerId</span><span class="si">}</span><span class="sb"> rate limit na pÃ¡gina </span><span class="si">${</span><span class="nx">page</span><span class="si">}</span><span class="sb">. Aguardando </span><span class="si">${</span><span class="nx">waitTime</span><span class="si">}</span><span class="sb">s...`</span><span class="p">);</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// ... outros casos</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">worker</span><span class="p">.</span><span class="nx">onerror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb"> erro:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
<span class="w">      </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">workers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">worker</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Aguarda todos os workers terminarem e lÃª dados do buffer compartilhado</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">checkComplete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentCompleted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">currentCompleted</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">checkComplete</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// LÃª dados do buffer compartilhado</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">finalWriteIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">dataBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">headerSize</span><span class="p">,</span><span class="w"> </span><span class="nx">finalWriteIndex</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">allCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">deserializeCities</span><span class="p">(</span><span class="nx">dataBuffer</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Remove duplicatas baseado no ID da cidade</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span>
<span class="w">          </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">(</span><span class="nx">allCities</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[</span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">])).</span><span class="nx">values</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Atualiza progresso final</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">onProgress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">onProgress</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">workers</span><span class="o">:</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">,</span>
<span class="w">            </span><span class="nx">totalPages</span><span class="p">,</span>
<span class="w">            </span><span class="nx">citiesCollected</span><span class="o">:</span><span class="w"> </span><span class="nx">uniqueCities</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
<span class="w">            </span><span class="nx">completed</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">uniqueCities</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Timeout de seguranÃ§a (10 minutos)</span>
<span class="w">    </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">checkComplete</span><span class="p">);</span>
<span class="w">      </span><span class="nx">workers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">worker</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">());</span>
<span class="w">      </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Timeout na coleta de dados&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">600000</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Fallback: coleta sem SharedArrayBuffer (usa postMessage)</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">collectCitiesParallelFallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">onProgress</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ImplementaÃ§Ã£o usando postMessage (cÃ³digo similar mas sem SharedArrayBuffer)</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>



**Conceitos:**
- CriaÃ§Ã£o e gerenciamento de Web Workers
- Compartilhamento de SharedArrayBuffer entre workers
- SincronizaÃ§Ã£o com Atomics
- Polling para verificar conclusÃ£o
- Timeout de seguranÃ§a

---

### NÃ­vel 6: Algoritmo K-Means Paralelizado

#### 6.1 Worker de K-Means

**Arquivo:** `app/public/js/workers/kmeansWorker.js`


<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Web Worker para cÃ¡lculo de distÃ¢ncias no algoritmo K-Means</span>
<span class="cm"> * Paraleliza o cÃ¡lculo de distÃ¢ncias entre pontos e centroides</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Calcula distÃ¢ncia euclidiana entre dois pontos</span>
<span class="cm"> * Considera: latitude, longitude e populaÃ§Ã£o (normalizada)</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">euclideanDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">point1</span><span class="p">,</span><span class="w"> </span><span class="nx">point2</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Normaliza populaÃ§Ã£o para escala similar (0-1)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">MAX_POPULATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">50000000</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">normPop1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">MAX_POPULATION</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">normPop2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">MAX_POPULATION</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Calcula distÃ¢ncia considerando as trÃªs dimensÃµes</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">latitude</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">popDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normPop1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">normPop2</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">latDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">popDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">popDiff</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Processa mensagens do thread principal</span>
<span class="cm"> */</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;assign_points&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">endIndex</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">      </span><span class="c1">// Calcula distÃ¢ncias para cada ponto atribuÃ­do a este worker</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">endIndex</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">minDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Infinity</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">closestCentroid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Encontra o centroide mais prÃ³ximo</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">centroids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">euclideanDistance</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">distance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">minDistance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">minDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">distance</span><span class="p">;</span>
<span class="w">            </span><span class="nx">closestCentroid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">j</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">assignments</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">          </span><span class="nx">pointIndex</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span>
<span class="w">          </span><span class="nx">centroidIndex</span><span class="o">:</span><span class="w"> </span><span class="nx">closestCentroid</span><span class="p">,</span>
<span class="w">          </span><span class="nx">distance</span><span class="o">:</span><span class="w"> </span><span class="nx">minDistance</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Envia resultados de volta</span>
<span class="w">      </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;assignments_complete&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">assignments</span><span class="p">,</span>
<span class="w">        </span><span class="nx">startIndex</span><span class="p">,</span>
<span class="w">        </span><span class="nx">endIndex</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;calculate_new_centroids&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newCentroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">      </span><span class="c1">// Calcula novos centroides para cada cluster</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">clusterId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">clusterId</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">clusters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">clusterId</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">clusterPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clusters</span><span class="p">[</span><span class="nx">clusterId</span><span class="p">];</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clusterPoints</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">newCentroids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Calcula mÃ©dia das coordenadas e populaÃ§Ã£o</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">sumLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">sumLon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">sumPop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">pointIndex</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">clusterPoints</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">[</span><span class="nx">pointIndex</span><span class="p">];</span>
<span class="w">          </span><span class="nx">sumLat</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">point</span><span class="p">.</span><span class="nx">latitude</span><span class="p">;</span>
<span class="w">          </span><span class="nx">sumLon</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">point</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
<span class="w">          </span><span class="nx">sumPop</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">point</span><span class="p">.</span><span class="nx">population</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clusterPoints</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">        </span><span class="nx">newCentroids</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">          </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">sumLat</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span>
<span class="w">          </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">sumLon</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span>
<span class="w">          </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nx">sumPop</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;centroids_complete&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">centroids</span><span class="o">:</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">      </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="sb">`Unknown message type: </span><span class="si">${</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**Conceitos:**
- CÃ¡lculo paralelo de distÃ¢ncias
- NormalizaÃ§Ã£o de dados (populaÃ§Ã£o)
- DistÃ¢ncia euclidiana em 3D
- AtualizaÃ§Ã£o de centroides

#### 6.2 ServiÃ§o K-Means

**Arquivo:** `app/public/js/services/kmeansService.js`


<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * ServiÃ§o para execuÃ§Ã£o do algoritmo K-Means paralelizado</span>
<span class="cm"> * Usa Web Workers para calcular distÃ¢ncias e atualizar centroides</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Inicializa centroides aleatÃ³rios</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">initializeCentroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">centroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="c1">// Encontra ranges dos dados</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">latitudes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">latitude</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">longitudes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">populations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">population</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">minLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">latitudes</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">latitudes</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">minLon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">longitudes</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxLon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">longitudes</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">minPop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">populations</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxPop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">populations</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Gera k centroides aleatÃ³rios dentro dos ranges</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">k</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">centroids</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">minLat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">maxLat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLat</span><span class="p">),</span>
<span class="w">      </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">minLon</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">maxLon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLon</span><span class="p">),</span>
<span class="w">      </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nx">minPop</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">maxPop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minPop</span><span class="p">),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">centroids</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Atribui pontos aos clusters usando Web Workers</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">assignPointsToClusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pointsPerWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">promises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="c1">// Cria workers e distribui pontos</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pointsPerWorker</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">((</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">pointsPerWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">startIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="s2">&quot;/js/workers/kmeansWorker.js&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;module&quot;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">promise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;assignments_complete&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
<span class="w">          </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">assignments</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;error&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
<span class="w">          </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">error</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">worker</span><span class="p">.</span><span class="nx">onerror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
<span class="w">        </span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;assign_points&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">points</span><span class="p">,</span>
<span class="w">        </span><span class="nx">centroids</span><span class="p">,</span>
<span class="w">        </span><span class="nx">startIndex</span><span class="p">,</span>
<span class="w">        </span><span class="nx">endIndex</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">workers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">worker</span><span class="p">);</span>
<span class="w">    </span><span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">promise</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Aguarda todos os workers terminarem</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allAssignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">allAssignments</span><span class="p">.</span><span class="nx">flat</span><span class="p">();</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Verifica se centroides convergiram</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">hasConverged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">oldCentroids</span><span class="p">,</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">,</span><span class="w"> </span><span class="nx">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">oldCentroids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">oldCentroids</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">newCentroids</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">euclideanDistance</span><span class="p">(</span><span class="nx">oldCentroids</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">distance</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">threshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Executa algoritmo K-Means</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">kmeans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="nx">maxIterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">onIteration</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`NÃºmero de pontos (</span><span class="si">${</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">) deve ser maior ou igual a k (</span><span class="si">${</span><span class="nx">k</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Inicializa centroides</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">centroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">initializeCentroids</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">hardwareConcurrency</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">iteration</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxIterations</span><span class="p">;</span><span class="w"> </span><span class="nx">iteration</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Atribui pontos aos clusters (paralelizado)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">assignPointsToClusters</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Agrupa pontos por cluster</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">assignment</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">assignments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clusters</span><span class="p">[</span><span class="nx">assignment</span><span class="p">.</span><span class="nx">centroidIndex</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">assignment</span><span class="p">.</span><span class="nx">pointIndex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Calcula novos centroides (paralelizado)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newCentroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">calculateNewCentroids</span><span class="p">(</span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Trata centroides nulos (clusters vazios)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">newCentroids</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">centroids</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">newCentroids</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">centroids</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Gera centroide aleatÃ³rio</span>
<span class="w">          </span><span class="c1">// ...</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Verifica convergÃªncia</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasConverged</span><span class="p">(</span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">onIteration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">onIteration</span><span class="p">(</span><span class="nx">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">clusters</span><span class="p">,</span>
<span class="w">        </span><span class="nx">centroids</span><span class="o">:</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">,</span>
<span class="w">        </span><span class="nx">iterations</span><span class="o">:</span><span class="w"> </span><span class="nx">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">        </span><span class="nx">converged</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">centroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">onIteration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">onIteration</span><span class="p">(</span><span class="nx">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Ãšltima atribuiÃ§Ã£o</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">assignPointsToClusters</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">assignment</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">assignments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">clusters</span><span class="p">[</span><span class="nx">assignment</span><span class="p">.</span><span class="nx">centroidIndex</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">assignment</span><span class="p">.</span><span class="nx">pointIndex</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">clusters</span><span class="p">,</span>
<span class="w">    </span><span class="nx">centroids</span><span class="p">,</span>
<span class="w">    </span><span class="nx">iterations</span><span class="o">:</span><span class="w"> </span><span class="nx">maxIterations</span><span class="p">,</span>
<span class="w">    </span><span class="nx">converged</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>



**Conceitos:**
- Algoritmo K-Means completo e explÃ­cito
- ParalelizaÃ§Ã£o de cÃ¡lculos pesados
- ConvergÃªncia e critÃ©rio de parada
- Tratamento de clusters vazios

---

### NÃ­vel 7: Controller Principal e IntegraÃ§Ã£o

#### 7.1 Controller Completo

**Arquivo:** `app/public/js/controllers/cityController.js`


<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">collectCitiesParallel</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../services/dataCollectionService.js&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">kmeans</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../services/kmeansService.js&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">renderClusters</span><span class="p">,</span><span class="w"> </span><span class="nx">showClusteringProgress</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../views/clusterView.js&quot;</span><span class="p">;</span>

<span class="c1">// ... imports e seleÃ§Ã£o de elementos DOM ...</span>

<span class="cm">/**</span>
<span class="cm"> * Manipula inÃ­cio da coleta paralela de dados</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">handleStartCollection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isCollecting</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="w">    </span><span class="nx">isCollecting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">startCollectionButton</span><span class="p">.</span><span class="nx">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">startCollectionButton</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;i class=&quot;bi bi-hourglass-split&quot;&gt;&lt;/i&gt; Coletando...&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="nx">setButtonsDisabled</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">progressSection</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;d-none&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">clustersSection</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">&quot;d-none&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Verifica e mostra status de memÃ³ria compartilhada</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">useSharedMemory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">memoryInfo</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;d-none&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">memoryInfoText</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Usando memÃ³ria compartilhada (SharedArrayBuffer) com sincronizaÃ§Ã£o Atomics&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">citiesInput</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">5000</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Valida entrada</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">targetCities</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">targetCities</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Por favor, insira um nÃºmero vÃ¡lido de cidades (mÃ­nimo 100)&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Inicia coleta paralela</span>
<span class="w">    </span><span class="nx">collectedCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">collectCitiesParallel</span><span class="p">(</span><span class="nx">targetCities</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">progress</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">progressBar</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">progress</span><span class="si">}</span><span class="sb">%`</span><span class="p">;</span>
<span class="w">      </span><span class="nx">progressText</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">progress</span><span class="si">}</span><span class="sb">%`</span><span class="p">;</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">rateLimit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">progressDetails</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Rate limit atingido. Aguardando </span><span class="si">${</span><span class="nx">stats</span><span class="p">.</span><span class="nx">waitTime</span><span class="si">}</span><span class="sb">s antes de continuar...`</span><span class="p">;</span>
<span class="w">        </span><span class="nx">progressBar</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;bg-warning&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">progressBar</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">&quot;bg-danger&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">progressDetails</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Coletando dados... </span><span class="si">${</span><span class="nx">stats</span><span class="p">.</span><span class="nx">citiesCollected</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="si">}</span><span class="sb"> cidades`</span><span class="p">;</span>
<span class="w">        </span><span class="nx">progressBar</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;bg-danger&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">progressBar</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">&quot;bg-warning&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">memoryStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39; | MemÃ³ria Compartilhada: Ativa&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39; | Modo: Fallback&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="nx">progressStats</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Workers: </span><span class="si">${</span><span class="nx">stats</span><span class="p">.</span><span class="nx">workers</span><span class="si">}</span><span class="sb"> | PÃ¡gina atual: </span><span class="si">${</span><span class="nx">stats</span><span class="p">.</span><span class="nx">currentPage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">stats</span><span class="p">.</span><span class="nx">totalPages</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="si">}${</span><span class="nx">memoryStatus</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Calcula tempo decorrido</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">elapsedSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="nx">endTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">elapsedMinutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">elapsedSeconds</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">remainingSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">elapsedSeconds</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">timeString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">elapsedMinutes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">elapsedMinutes</span><span class="si">}</span><span class="sb">min </span><span class="si">${</span><span class="nx">remainingSeconds</span><span class="si">}</span><span class="sb">s`</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">elapsedSeconds</span><span class="si">}</span><span class="sb">s`</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Finaliza progresso</span>
<span class="w">    </span><span class="nx">progressBar</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;100%&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">progressText</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;100%&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">progressDetails</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Coleta concluÃ­da! Iniciando agrupamento K-Means...&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">progressStats</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Total coletado: </span><span class="si">${</span><span class="nx">collectedCities</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> cidades vÃ¡lidas | Tempo: </span><span class="si">${</span><span class="nx">timeString</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// REQUISITO: ApÃ³s finalizar o processo de preenchimento da memÃ³ria compartilhada,</span>
<span class="w">    </span><span class="c1">// inicia-se o processo de agrupamento automaticamente</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Coleta concluÃ­da! </span><span class="si">${</span><span class="nx">collectedCities</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> cidades coletadas em </span><span class="si">${</span><span class="nx">timeString</span><span class="si">}</span><span class="sb">. Iniciando K-Means automaticamente...`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Inicia K-Means automaticamente apÃ³s coleta</span>
<span class="w">    </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">handleStartClustering</span><span class="p">();</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Tratamento de erros...</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isCollecting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="nx">startCollectionButton</span><span class="p">.</span><span class="nx">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="nx">startCollectionButton</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;i class=&quot;bi bi-download&quot;&gt;&lt;/i&gt; Iniciar Coleta&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">setButtonsDisabled</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Manipula execuÃ§Ã£o do K-Means</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">handleStartClustering</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isClustering</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">collectedCities</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">kInput</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Por favor, insira um valor vÃ¡lido para k (entre 2 e 50)&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">collectedCities</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">alert</span><span class="p">(</span><span class="sb">`NÃºmero de cidades (</span><span class="si">${</span><span class="nx">collectedCities</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">) deve ser maior ou igual a k (</span><span class="si">${</span><span class="nx">k</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isClustering</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">startClusteringButton</span><span class="p">.</span><span class="nx">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">startClusteringButton</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;i class=&quot;bi bi-hourglass-split&quot;&gt;&lt;/i&gt; Processando...&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">clustersSection</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;d-none&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">showClusteringProgress</span><span class="p">(</span><span class="nx">clustersContainer</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Prepara pontos para o k-means (latitude, longitude, populaÃ§Ã£o)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">collectedCities</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">      </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span>
<span class="w">      </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">longitude</span><span class="p">,</span>
<span class="w">      </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">city</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">city</span><span class="p">,</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">cityName</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`Cidade </span><span class="si">${</span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">country</span><span class="o">:</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">country</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">countryCode</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">countryName</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">}));</span>

<span class="w">    </span><span class="c1">// Executa K-Means</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">kmeans</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">iteration</span><span class="p">,</span><span class="w"> </span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">converged</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">showClusteringProgress</span><span class="p">(</span><span class="nx">clustersContainer</span><span class="p">,</span><span class="w"> </span><span class="nx">iteration</span><span class="p">,</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Renderiza resultados</span>
<span class="w">    </span><span class="nx">renderClusters</span><span class="p">(</span><span class="nx">clustersContainer</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">centroids</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Mostra informaÃ§Ãµes finais</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">infoDiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">infoDiv</span><span class="p">.</span><span class="nx">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;alert alert-success mt-3&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">infoDiv</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">      &lt;strong&gt;&lt;i class=&quot;bi bi-check-circle&quot;&gt;&lt;/i&gt; Clustering concluÃ­do!&lt;/strong&gt;&lt;br&gt;</span>
<span class="sb">      IteraÃ§Ãµes: </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">iterations</span><span class="si">}</span><span class="sb"> | </span>
<span class="sb">      ConvergÃªncia: </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">converged</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;Sim&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;NÃ£o (mÃ¡ximo atingido)&quot;</span><span class="si">}</span><span class="sb"> |</span>
<span class="sb">      Total de pontos: </span><span class="si">${</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span>
<span class="sb">    `</span><span class="p">;</span>
<span class="w">    </span><span class="nx">clustersContainer</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">infoDiv</span><span class="p">,</span><span class="w"> </span><span class="nx">clustersContainer</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Erro no clustering:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="nx">clustersContainer</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">      &lt;div class=&quot;alert alert-danger&quot;&gt;</span>
<span class="sb">        &lt;strong&gt;Erro no clustering:&lt;/strong&gt; </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span>
<span class="sb">      &lt;/div&gt;</span>
<span class="sb">    `</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isClustering</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="nx">startClusteringButton</span><span class="p">.</span><span class="nx">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="nx">startClusteringButton</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;i class=&quot;bi bi-diagram-3&quot;&gt;&lt;/i&gt; Executar K-Means&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**Conceitos:**
- OrquestraÃ§Ã£o de processos assÃ­ncronos
- Callbacks de progresso
- InÃ­cio automÃ¡tico do K-Means apÃ³s coleta
- Tratamento de erros robusto

---

<a id="docker-e-containerizaÃ§Ã£o"></a>
## ğŸ³ Docker e ContainerizaÃ§Ã£o

### Dockerfile

**Arquivo:** `Dockerfile`


<div class="codehilite"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">node:25.2.1-alpine</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/home/node/app</span>

<span class="k">COPY</span><span class="w"> </span>./app/package.json<span class="w"> </span>./app/package-lock.json*<span class="w"> </span>./

<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>install

<span class="k">COPY</span><span class="w"> </span>./app<span class="w"> </span>.

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">3000</span>

<span class="c"># Usa nodemon para hot-reload automÃ¡tico</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;npx&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;nodemon&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;index.js&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--watch&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--ext&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;js,ejs&quot;</span><span class="p">]</span>
</code></pre></div>



### docker-compose.yml


<div class="codehilite"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nginx</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx/static-html-directory:/usr/share/nginx/html</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx/nginx.conf:/etc/nginx/nginx.conf</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8080:80&quot;</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-server</span>

<span class="w">  </span><span class="nt">node</span><span class="p">:</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app:/home/node/app</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">PORT</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${PORT}</span>
<span class="w">      </span><span class="nt">RAPIDAPI_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${RAPIDAPI_KEY}</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3000:3000&quot;</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-app</span>
</code></pre></div>



### Executando com Docker via WSL

**Windows (WSL):**

<div class="codehilite"><pre><span></span><code>.<span class="se">\d</span>ocker-rebuild.bat
</code></pre></div>



**Linux/Mac:**

<div class="codehilite"><pre><span></span><code>./docker-rebuild.sh
</code></pre></div>



**Ou manualmente:**

<div class="codehilite"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down
docker<span class="w"> </span>compose<span class="w"> </span>build<span class="w"> </span>--no-cache
docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>



---

<a id="fluxo-completo-da-aplicaÃ§Ã£o"></a>
## ğŸ“Š Fluxo Completo da AplicaÃ§Ã£o

### 1. ExploraÃ§Ã£o de Cidades


<div class="codehilite"><pre><span></span><code><span class="nv">Usu</span>Ã¡<span class="nv">rio</span><span class="w"> </span><span class="nv">clica</span><span class="w"> </span><span class="s2">&quot;Next&quot;</span><span class="w"> </span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">handlePagination</span><span class="ss">(</span><span class="s2">&quot;next&quot;</span><span class="ss">)</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Calcula</span><span class="w"> </span><span class="nv">offset</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Requisi</span>Ã§Ã£<span class="nv">o</span><span class="w"> </span><span class="nv">ass</span>Ã­<span class="nv">ncrona</span><span class="w"> </span>Ã <span class="w"> </span><span class="nv">API</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Atualiza</span><span class="w"> </span><span class="nv">estado</span><span class="w"> </span><span class="ss">(</span><span class="nv">imut</span>Ã¡<span class="nv">vel</span><span class="ss">)</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Renderiza</span><span class="w"> </span><span class="nv">lista</span><span class="w"> </span><span class="nv">de</span><span class="w"> </span><span class="nv">cidades</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Interface</span><span class="w"> </span><span class="nv">permanece</span><span class="w"> </span><span class="nv">responsiva</span>
</code></pre></div>



### 2. SeleÃ§Ã£o de Cidades


<div class="codehilite"><pre><span></span><code>UsuÃ¡rio clica &quot;Select City&quot;
  â†’ handleSelectCity(city)
  â†’ addSelectedCity(state, city) [retorna novo estado]
  â†’ Atualiza lista de selecionadas
  â†’ Atualiza contador
  â†’ Estado preservado durante navegaÃ§Ã£o
</code></pre></div>



### 3. Coleta Paralela


<div class="codehilite"><pre><span></span><code><span class="nv">Usu</span>Ã¡<span class="nv">rio</span><span class="w"> </span><span class="nv">clica</span><span class="w"> </span><span class="s2">&quot;Iniciar Coleta&quot;</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">handleStartCollection</span><span class="ss">()</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Cria</span><span class="w"> </span><span class="nv">SharedArrayBuffer</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Inicializa</span><span class="w"> </span>Ã­<span class="nv">ndices</span><span class="w"> </span><span class="nv">at</span>Ã´<span class="nv">micos</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Cria</span><span class="w"> </span><span class="nv">Web</span><span class="w"> </span><span class="nv">Workers</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Distribui</span><span class="w"> </span><span class="nv">p</span>Ã¡<span class="nv">ginas</span><span class="w"> </span><span class="ss">(</span><span class="nv">divis</span>Ã£<span class="nv">o</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="nv">conquista</span><span class="ss">)</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Cada</span><span class="w"> </span><span class="nv">worker</span>:
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nv">Busca</span><span class="w"> </span><span class="nv">suas</span><span class="w"> </span><span class="nv">p</span>Ã¡<span class="nv">ginas</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nv">Escreve</span><span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">buffer</span><span class="w"> </span><span class="nv">compartilhado</span><span class="w"> </span><span class="ss">(</span><span class="nv">Atomics</span><span class="ss">)</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nv">Envia</span><span class="w"> </span><span class="nv">progresso</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Aguarda</span><span class="w"> </span><span class="nv">conclus</span>Ã£<span class="nv">o</span><span class="w"> </span><span class="ss">(</span><span class="nv">polling</span><span class="ss">)</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">L</span>Ãª<span class="w"> </span><span class="nv">dados</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">buffer</span><span class="w"> </span><span class="nv">compartilhado</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Desserializa</span><span class="w"> </span><span class="nv">cidades</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Remove</span><span class="w"> </span><span class="nv">duplicatas</span>
<span class="w">  </span>â†’<span class="w"> </span><span class="nv">Inicia</span><span class="w"> </span><span class="nv">K</span><span class="o">-</span><span class="nv">Means</span><span class="w"> </span><span class="nv">automaticamente</span>
</code></pre></div>



### 4. K-Means Paralelizado


<div class="codehilite"><pre><span></span><code><span class="n">handleStartClustering</span><span class="p">()</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Prepara</span><span class="w"> </span><span class="n">pontos</span><span class="w"> </span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">populaÃ§Ã£o</span><span class="p">)</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">kmeans</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Inicializa</span><span class="w"> </span><span class="n">centroides</span><span class="w"> </span><span class="n">aleatÃ³rios</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="nl">iteraÃ§Ãµes</span><span class="p">:</span>
<span class="w">      </span><span class="err">â†’</span><span class="w"> </span><span class="n">assignPointsToClusters</span><span class="p">()</span><span class="w"> </span><span class="o">[</span><span class="n">paralelizado</span><span class="o">]</span>
<span class="w">        </span><span class="err">â†’</span><span class="w"> </span><span class="n">Distribui</span><span class="w"> </span><span class="n">pontos</span><span class="w"> </span><span class="n">entre</span><span class="w"> </span><span class="n">workers</span>
<span class="w">        </span><span class="err">â†’</span><span class="w"> </span><span class="n">Cada</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="n">calcula</span><span class="w"> </span><span class="n">distÃ¢ncias</span>
<span class="w">        </span><span class="err">â†’</span><span class="w"> </span><span class="n">Retorna</span><span class="w"> </span><span class="n">assignments</span>
<span class="w">      </span><span class="err">â†’</span><span class="w"> </span><span class="n">Agrupa</span><span class="w"> </span><span class="n">pontos</span><span class="w"> </span><span class="n">por</span><span class="w"> </span><span class="n">cluster</span>
<span class="w">      </span><span class="err">â†’</span><span class="w"> </span><span class="n">calculateNewCentroids</span><span class="p">()</span><span class="w"> </span><span class="o">[</span><span class="n">paralelizado</span><span class="o">]</span>
<span class="w">        </span><span class="err">â†’</span><span class="w"> </span><span class="n">Calcula</span><span class="w"> </span><span class="n">novos</span><span class="w"> </span><span class="n">centroides</span>
<span class="w">      </span><span class="err">â†’</span><span class="w"> </span><span class="n">Verifica</span><span class="w"> </span><span class="n">convergÃªncia</span>
<span class="w">  </span><span class="err">â†’</span><span class="w"> </span><span class="n">Renderiza</span><span class="w"> </span><span class="n">clusters</span>
</code></pre></div>



---

## ğŸ“ Conceitos TeÃ³ricos Detalhados

### 1. Compare-and-Swap (CAS)

**O que Ã©?**
OperaÃ§Ã£o atÃ´mica que compara um valor na memÃ³ria com um valor esperado e, se forem iguais, atualiza para um novo valor.

**PseudocÃ³digo:**

<div class="codehilite"><pre><span></span><code><span class="nv">CAS</span><span class="ss">(</span><span class="nv">memory</span>,<span class="w"> </span><span class="nv">expected</span>,<span class="w"> </span><span class="nv">newValue</span><span class="ss">)</span>:
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">expected</span>:
<span class="w">    </span><span class="nv">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">newValue</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">expected</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="nv">Sucesso</span>
<span class="w">  </span><span class="k">else</span>:
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">memory</span><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">Falhou</span>,<span class="w"> </span><span class="nv">retorna</span><span class="w"> </span><span class="nv">valor</span><span class="w"> </span><span class="nv">atual</span>
</code></pre></div>



**Por que usar?**
- Garante que apenas uma thread modifica a memÃ³ria por vez
- Evita condiÃ§Ãµes de corrida
- Base para outras operaÃ§Ãµes atÃ´micas

**No projeto:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">newIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">citySize</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">newIndex</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Sucesso: espaÃ§o reservado</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Falhou: outro worker escreveu primeiro, tenta novamente</span>
<span class="p">}</span>
</code></pre></div>



### 2. Thread-Safety

**O que Ã©?**
Propriedade de cÃ³digo que funciona corretamente quando executado por mÃºltiplas threads simultaneamente.

**Problemas sem thread-safety:**
- **Race condition:** MÃºltiplas threads modificam mesmo dado
- **Data corruption:** Dados inconsistentes
- **Lost updates:** AtualizaÃ§Ãµes perdidas

**SoluÃ§Ãµes:**
- OperaÃ§Ãµes atÃ´micas (Atomics)
- Locks (nÃ£o disponÃ­vel em JavaScript)
- MemÃ³ria compartilhada com sincronizaÃ§Ã£o

### 3. NormalizaÃ§Ã£o de Dados

**Por que normalizar populaÃ§Ã£o?**
- Latitude: -90 a 90 (range ~180)
- Longitude: -180 a 180 (range ~360)
- PopulaÃ§Ã£o: 0 a 50.000.000 (range muito maior!)

**SoluÃ§Ã£o:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">MAX_POPULATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">50000000</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">normPop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">population</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">MAX_POPULATION</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0 a 1</span>
</code></pre></div>



Agora todas as dimensÃµes tÃªm escala similar, entÃ£o a distÃ¢ncia euclidiana faz sentido.

### 4. Algoritmo K-Means - Detalhado

**Passo 1: InicializaÃ§Ã£o**
- Escolhe k pontos aleatÃ³rios como centroides iniciais
- Pode usar pontos aleatÃ³rios dos dados ou valores aleatÃ³rios dentro do range

**Passo 2: AtribuiÃ§Ã£o**
- Para cada ponto, calcula distÃ¢ncia a todos os centroides
- Atribui ao centroide mais prÃ³ximo
- Complexidade: O(n Ã— k) onde n = pontos, k = clusters

**Passo 3: AtualizaÃ§Ã£o**
- Para cada cluster, calcula mÃ©dia de todos os pontos atribuÃ­dos
- Novo centroide = mÃ©dia das coordenadas
- Complexidade: O(n)

**Passo 4: ConvergÃªncia**
- Compara centroides antigos com novos
- Se diferenÃ§a < threshold, convergiu
- SenÃ£o, volta ao passo 2

**ParalelizaÃ§Ã£o:**
- AtribuiÃ§Ã£o: Distribui pontos entre workers
- AtualizaÃ§Ã£o: Pode paralelizar cÃ¡lculo de mÃ©dias

---

## ğŸ” Debugging e Troubleshooting

### Problemas Comuns

**1. SharedArrayBuffer nÃ£o disponÃ­vel**
- **Causa:** Headers HTTP nÃ£o configurados
- **SoluÃ§Ã£o:** Verificar `Cross-Origin-Opener-Policy` e `Cross-Origin-Embedder-Policy`

**2. Rate limit excedido**
- **Causa:** Muitas requisiÃ§Ãµes simultÃ¢neas
- **SoluÃ§Ã£o:** Reduzir nÃºmero de workers, aumentar delay

**3. Erro de serializaÃ§Ã£o**
- **Causa:** Buffer muito pequeno ou dados corrompidos
- **SoluÃ§Ã£o:** Aumentar margem de buffer, verificar integridade dos dados

**4. Workers nÃ£o terminam**
- **Causa:** Erro nÃ£o tratado ou loop infinito
- **SoluÃ§Ã£o:** Verificar logs, adicionar timeout

---

## ğŸ“š Recursos de Aprendizado - DocumentaÃ§Ã£o Oficial Completa

### ğŸŒ MDN Web Docs - ReferÃªncia Completa de Web APIs

#### Web Workers e Paralelismo

- **[Web Workers API - VisÃ£o Geral](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API)**
  - IntroduÃ§Ã£o completa aos Web Workers
  - Tipos de workers (Dedicated, Shared, Service)
  - Casos de uso e exemplos prÃ¡ticos

- **[Worker - Interface Principal](https://developer.mozilla.org/en-US/docs/Web/API/Worker)**
  - Construtor: `new Worker(url, options)`
  - MÃ©todos: `postMessage()`, `terminate()`
  - Propriedades: `onmessage`, `onerror`
  - Eventos: `message`, `error`, `messageerror`

- **[WorkerGlobalScope - Contexto Global do Worker](https://developer.mozilla.org/en-US/docs/Web/API/WorkerGlobalScope)**
  - APIs disponÃ­veis dentro do worker
  - `self` como referÃªncia ao escopo global
  - MÃ©todos: `importScripts()`, `close()`

- **[DedicatedWorkerGlobalScope - Worker Dedicado](https://developer.mozilla.org/en-US/docs/Web/API/DedicatedWorkerGlobalScope)**
  - EspecÃ­fico para workers dedicados
  - Propriedades e mÃ©todos exclusivos

- **[Using Web Workers - Guia PrÃ¡tico](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers)**
  - Tutorial passo a passo
  - Exemplos de cÃ³digo
  - Transferable Objects
  - Tratamento de erros

#### MemÃ³ria Compartilhada e SincronizaÃ§Ã£o

- **[SharedArrayBuffer - MemÃ³ria Compartilhada](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer)**
  - VisÃ£o geral e uso bÃ¡sico
  - Requisitos de seguranÃ§a (COOP/COEP headers)
  - Compatibilidade de navegadores
  - Exemplos prÃ¡ticos

- **[Atomics - OperaÃ§Ãµes AtÃ´micas](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics)**
  - **[Atomics.load()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/load)** - Leitura atÃ´mica
  - **[Atomics.store()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/store)** - Escrita atÃ´mica
  - **[Atomics.compareExchange()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/compareExchange)** - Compare-and-Swap (CAS)
  - **[Atomics.add()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/add)** - AdiÃ§Ã£o atÃ´mica
  - **[Atomics.sub()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/sub)** - SubtraÃ§Ã£o atÃ´mica
  - **[Atomics.and()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/and)** - OperaÃ§Ã£o AND atÃ´mica
  - **[Atomics.or()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/or)** - OperaÃ§Ã£o OR atÃ´mica
  - **[Atomics.xor()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/xor)** - OperaÃ§Ã£o XOR atÃ´mica
  - **[Atomics.wait()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/wait)** - Aguarda mudanÃ§a de valor
  - **[Atomics.notify()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/notify)** - Notifica workers aguardando

#### JavaScript AssÃ­ncrono

- **[Promise - Promessas](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)**
  - **[Promise.then()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then)**
  - **[Promise.catch()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)**
  - **[Promise.all()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all)**
  - **[Promise.race()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/race)**

- **[async function - FunÃ§Ãµes AssÃ­ncronas](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function)**
  - Sintaxe `async/await`
  - Tratamento de erros
  - Exemplos prÃ¡ticos

- **[await - Operador de Espera](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await)**
  - Como funciona internamente
  - Comportamento com diferentes tipos

#### Fetch API e RequisiÃ§Ãµes HTTP

- **[Fetch API - RequisiÃ§Ãµes HTTP](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)**
  - **[fetch() - FunÃ§Ã£o Principal](https://developer.mozilla.org/en-US/docs/Web/API/fetch)**
  - **[Request - Objeto de RequisiÃ§Ã£o](https://developer.mozilla.org/en-US/docs/Web/API/Request)**
  - **[Response - Objeto de Resposta](https://developer.mozilla.org/en-US/docs/Web/API/Response)**
  - **[Headers - CabeÃ§alhos HTTP](https://developer.mozilla.org/en-US/docs/Web/API/Headers)**

- **[Using Fetch - Guia PrÃ¡tico](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch)**
  - Exemplos de requisiÃ§Ãµes GET, POST, PUT, DELETE
  - Envio de dados JSON
  - Upload de arquivos
  - Tratamento de erros

#### Estruturas de Dados JavaScript

- **[Array - Arrays](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)**
  - **[Array.map()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map)**
  - **[Array.filter()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter)**
  - **[Array.reduce()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce)**
  - **[Array.forEach()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach)**

- **[Map - Mapas](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map)**
  - Estrutura de dados chave-valor
  - MÃ©todos: `set()`, `get()`, `has()`, `delete()`
  - IteraÃ§Ã£o e performance

- **[Set - Conjuntos](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set)**
  - Valores Ãºnicos
  - OperaÃ§Ãµes de conjunto

- **[TypedArray - Arrays Tipados](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray)**
  - **[Int32Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Int32Array)**
  - **[Uint8Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array)**
  - **[DataView](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView)**

#### SeguranÃ§a e Headers HTTP

- **[Cross-Origin-Opener-Policy (COOP)](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Opener-Policy)**
  - ConfiguraÃ§Ã£o necessÃ¡ria para SharedArrayBuffer
  - Valores: `same-origin`, `same-origin-allow-popups`, `unsafe-none`

- **[Cross-Origin-Embedder-Policy (COEP)](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Embedder-Policy)**
  - Isolamento de contexto
  - Valor: `require-corp`

- **[Content-Security-Policy (CSP)](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy)**
  - PrevenÃ§Ã£o de XSS
  - ConfiguraÃ§Ã£o de polÃ­ticas de seguranÃ§a

### ğŸŸ¢ Node.js - DocumentaÃ§Ã£o Oficial Completa

#### Fundamentos Node.js

- **[Node.js - DocumentaÃ§Ã£o Principal](https://nodejs.org/docs/latest/api/)**
  - Guia completo de todas as APIs do Node.js
  - VersÃµes LTS e Current
  - Changelog e breaking changes

- **[Getting Started - Iniciando com Node.js](https://nodejs.org/en/docs/guides/getting-started-guide/)**
  - InstalaÃ§Ã£o e configuraÃ§Ã£o
  - Primeiro servidor HTTP
  - Conceitos fundamentais

#### MÃ³dulos e Sistema de Arquivos

- **[fs - Sistema de Arquivos](https://nodejs.org/docs/latest/api/fs.html)**
  - **[fs.readFileSync()](https://nodejs.org/docs/latest/api/fs.html#fsreadfilesyncpath-options)** - Leitura sÃ­ncrona
  - **[fs.readFile()](https://nodejs.org/docs/latest/api/fs.html#fsreadfilepath-options-callback)** - Leitura assÃ­ncrona
  - **[fs.writeFileSync()](https://nodejs.org/docs/latest/api/fs.html#fswritefilesyncpath-data-options)** - Escrita sÃ­ncrona
  - **[fs.writeFile()](https://nodejs.org/docs/latest/api/fs.html#fswritefilepath-data-options-callback)** - Escrita assÃ­ncrona
  - **[fs.existsSync()](https://nodejs.org/docs/latest/api/fs.html#fsexistssyncpath)** - VerificaÃ§Ã£o de existÃªncia

- **[path - ManipulaÃ§Ã£o de Caminhos](https://nodejs.org/docs/latest/api/path.html)**
  - **[path.join()](https://nodejs.org/docs/latest/api/path.html#pathjoinpaths)** - Junta caminhos
  - **[path.resolve()](https://nodejs.org/docs/latest/api/path.html#pathresolvepaths)** - Resolve caminho absoluto
  - **[path.dirname()](https://nodejs.org/docs/latest/api/path.html#pathdirnamepath)** - DiretÃ³rio do arquivo
  - **[path.basename()](https://nodejs.org/docs/latest/api/path.html#pathbasenamepath-ext)** - Nome do arquivo

- **[__dirname e __filename](https://nodejs.org/docs/latest/api/modules.html#__dirname)**
  - VariÃ¡veis globais do Node.js
  - DiferenÃ§as entre CommonJS e ES Modules

#### HTTP e Servidores Web

- **[http - Servidor HTTP](https://nodejs.org/docs/latest/api/http.html)**
  - **[http.createServer()](https://nodejs.org/docs/latest/api/http.html#httpcreateserveroptions-requestlistener)** - Cria servidor HTTP
  - **[http.request()](https://nodejs.org/docs/latest/api/http.html#httprequestoptions-callback)** - Faz requisiÃ§Ãµes HTTP
  - **[http.get()](https://nodejs.org/docs/latest/api/http.html#httpgetoptions-callback)** - RequisiÃ§Ã£o GET simplificada

- **[https - Servidor HTTPS](https://nodejs.org/docs/latest/api/https.html)**
  - ConfiguraÃ§Ã£o SSL/TLS
  - Certificados e seguranÃ§a

#### Express.js (Framework Web)

- **[Express.js - DocumentaÃ§Ã£o Oficial](https://expressjs.com/)**
  - **[Guia de Roteamento](https://expressjs.com/en/guide/routing.html)**
  - **[Guia de Middleware](https://expressjs.com/en/guide/using-middleware.html)**
  - **[API Reference](https://expressjs.com/en/4x/api.html)**
  - **[Express Router](https://expressjs.com/en/4x/api.html#router)**

- **[Express - MÃ©todos de Rota](https://expressjs.com/en/4x/api.html#app.METHOD)**
  - `app.get()`, `app.post()`, `app.put()`, `app.delete()`
  - ParÃ¢metros de rota e query strings
  - Middleware de rota

- **[Express - Middleware](https://expressjs.com/en/guide/using-middleware.html)**
  - Conceito de middleware
  - Middleware built-in: `express.json()`, `express.static()`
  - Middleware customizado
  - Ordem de execuÃ§Ã£o

#### VariÃ¡veis de Ambiente e ConfiguraÃ§Ã£o

- **[process - Processo Node.js](https://nodejs.org/docs/latest/api/process.html)**
  - **[process.env](https://nodejs.org/docs/latest/api/process.html#processenv)** - VariÃ¡veis de ambiente
  - **[process.argv](https://nodejs.org/docs/latest/api/process.html#processargv)** - Argumentos da linha de comando
  - **[process.exit()](https://nodejs.org/docs/latest/api/process.html#processexitcode)** - Encerra processo

- **[dotenv - Gerenciamento de .env](https://github.com/motdotla/dotenv)**
  - Carregamento de variÃ¡veis de ambiente
  - Boas prÃ¡ticas de seguranÃ§a

#### MÃ³dulos ES6 e CommonJS

- **[ES Modules - MÃ³dulos ES6](https://nodejs.org/docs/latest/api/esm.html)**
  - `import` e `export`
  - DiferenÃ§as com CommonJS
  - ConfiguraÃ§Ã£o `package.json` com `"type": "module"`

- **[CommonJS - MÃ³dulos ClÃ¡ssicos](https://nodejs.org/docs/latest/api/modules.html)**
  - `require()` e `module.exports`
  - Sistema de mÃ³dulos do Node.js

#### UtilitÃ¡rios e Helpers

- **[util - UtilitÃ¡rios](https://nodejs.org/docs/latest/api/util.html)**
  - **[util.promisify()](https://nodejs.org/docs/latest/api/util.html#utilpromisifyoriginal)** - Converte callbacks para Promises
  - **[util.inherits()](https://nodejs.org/docs/latest/api/util.html#utilinheritsconstructor-superconstructor)** - HeranÃ§a de classes

- **[url - ManipulaÃ§Ã£o de URLs](https://nodejs.org/docs/latest/api/url.html)**
  - **[url.parse()](https://nodejs.org/docs/latest/api/url.html#urlparseurlstring-parsequerystring-slashesdenotehost)** - Parse de URL
  - **[URLSearchParams](https://nodejs.org/docs/latest/api/url.html#class-urlsearchparams)** - Query strings

### ğŸ“– Outros Recursos Importantes

- **[Express.js Guide](https://expressjs.com/en/guide/routing.html)** - Framework web minimalista
- **[K-Means Algorithm - Wikipedia](https://en.wikipedia.org/wiki/K-means_clustering)** - Algoritmo de clustering
- **[JavaScript.info](https://javascript.info/)** - Tutoriais profundos de JavaScript
- **[Can I Use](https://caniuse.com/)** - Compatibilidade de APIs web

### Conceitos AvanÃ§ados

- **Lock-free programming:** ProgramaÃ§Ã£o sem locks usando CAS
- **Memory models:** Como threads veem memÃ³ria compartilhada
- **Parallel algorithms:** Algoritmos projetados para paralelismo
- **Functional programming:** Paradigma sem mutaÃ§Ã£o

---

## âœ… Checklist de ImplementaÃ§Ã£o

### Backend
- [ ] Servidor Express configurado
- [ ] Rotas da API implementadas
- [ ] IntegraÃ§Ã£o com GeoDB API
- [ ] Tratamento de erros robusto
- [ ] ValidaÃ§Ã£o de variÃ¡veis de ambiente
- [ ] Headers HTTP para SharedArrayBuffer

### Frontend - BÃ¡sico
- [ ] Modelo de estado imutÃ¡vel
- [ ] Views de renderizaÃ§Ã£o
- [ ] Controller de paginaÃ§Ã£o
- [ ] SeleÃ§Ã£o de cidades funcional
- [ ] Estado preservado durante navegaÃ§Ã£o

### Frontend - AvanÃ§ado
- [ ] Serializador de memÃ³ria compartilhada
- [ ] Worker de coleta de dados
- [ ] ServiÃ§o de coleta paralela
- [ ] Escrita controlada com Atomics
- [ ] Worker de K-Means
- [ ] ServiÃ§o K-Means paralelizado
- [ ] RenderizaÃ§Ã£o de clusters
- [ ] InÃ­cio automÃ¡tico do K-Means

### Docker
- [ ] Dockerfile configurado
- [ ] docker-compose.yml
- [ ] Scripts de rebuild
- [ ] Nginx como proxy reverso

---

## ğŸ¯ PrÃ³ximos Passos para Aprendizado

1. **Experimente aumentar nÃºmero de workers** (quando tiver plano superior da API)
2. **Implemente diferentes estratÃ©gias de inicializaÃ§Ã£o** de centroides (K-Means++)
3. **Adicione visualizaÃ§Ã£o grÃ¡fica** dos clusters em um mapa
4. **Otimize serializaÃ§Ã£o** usando formatos binÃ¡rios mais eficientes
5. **Implemente cache** de requisiÃ§Ãµes para reduzir chamadas Ã  API

---

## ğŸ“ Notas Finais

Este projeto demonstra:
- âœ… ProgramaÃ§Ã£o funcional em JavaScript
- âœ… Assincronismo e paralelismo
- âœ… MemÃ³ria compartilhada e sincronizaÃ§Ã£o
- âœ… Algoritmos paralelos (divisÃ£o e conquista)
- âœ… ImplementaÃ§Ã£o explÃ­cita de K-Means
- âœ… Arquitetura escalÃ¡vel e mantÃ­vel

**Lembre-se:** O cÃ³digo Ã© apenas a expressÃ£o do raciocÃ­nio. Entenda o "porquÃª" antes do "como".

---

<a id="capÃ­tulo-16-anÃ¡lise-comparativa-de-abordagens"></a>
## ğŸ“š CapÃ­tulo 16: AnÃ¡lise Comparativa de Abordagens

### 16.1 MemÃ³ria Compartilhada vs Message Passing

**Tabela Comparativa:**

| Aspecto | SharedArrayBuffer | postMessage |
|---------|------------------|-------------|
| **SerializaÃ§Ã£o** | NÃ£o necessÃ¡ria | ObrigatÃ³ria (JSON) |
| **CÃ³pia de Dados** | NÃ£o (referÃªncia) | Sim (deep copy) |
| **Performance** | O(1) escrita | O(n) serializaÃ§Ã£o + cÃ³pia |
| **SincronizaÃ§Ã£o** | ExplÃ­cita (Atomics) | ImplÃ­cita (automÃ¡tica) |
| **Complexidade** | Alta | Baixa |
| **SeguranÃ§a** | Requer headers HTTP | Mais segura por padrÃ£o |
| **Uso Ideal** | Dados grandes, alta frequÃªncia | Dados pequenos, baixa frequÃªncia |

**DecisÃ£o no Projeto:**
Usamos SharedArrayBuffer porque:
- Dados grandes (10k+ cidades)
- Alta frequÃªncia de escrita
- Performance crÃ­tica
- Headers HTTP podem ser configurados

### 16.2 InicializaÃ§Ã£o de Centroides: AleatÃ³ria vs K-Means++

**K-Means ClÃ¡ssico (AleatÃ³rio):**

<div class="codehilite"><pre><span></span><code><span class="c1">// Gera centroides aleatÃ³rios dentro do range</span>
<span class="nx">centroids</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">  </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">minLat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">maxLat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLat</span><span class="p">),</span>
<span class="w">  </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">minLon</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">maxLon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLon</span><span class="p">),</span>
<span class="w">  </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nx">minPop</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">maxPop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minPop</span><span class="p">),</span>
<span class="p">});</span>
</code></pre></div>



**Problema:** Pode convergir para mÃ­nimo local ruim.

**K-Means++ (Proposto por Arthur & Vassilvitskii, 2007):**
1. Escolhe primeiro centroide aleatoriamente
2. Para cada centroide subsequente:
   - Calcula distÃ¢ncia de cada ponto ao centroide mais prÃ³ximo
   - Escolhe ponto com probabilidade proporcional ao quadrado da distÃ¢ncia

**Vantagens:**
- ConvergÃªncia mais rÃ¡pida (menos iteraÃ§Ãµes)
- Melhor qualidade de clusters
- Garantia teÃ³rica: O(log k) aproximaÃ§Ã£o do Ã³timo

**Complexidade:**
- K-Means clÃ¡ssico: O(k) para inicializaÃ§Ã£o
- K-Means++: O(nÃ—k) para inicializaÃ§Ã£o

**Trade-off:** K-Means++ Ã© mais lento na inicializaÃ§Ã£o, mas compensa com menos iteraÃ§Ãµes.

**No Projeto:** Usamos inicializaÃ§Ã£o aleatÃ³ria por simplicidade, mas estrutura permite migraÃ§Ã£o para K-Means++.

---

<a id="capÃ­tulo-17-padrÃµes-de-design-aplicados"></a>
## ğŸ“š CapÃ­tulo 17: PadrÃµes de Design Aplicados

### 17.1 PadrÃ£o Observer (Implicitamente)

**Conceito:**
Objetos observam mudanÃ§as em outros objetos e reagem automaticamente.

**No Projeto:**

<div class="codehilite"><pre><span></span><code><span class="c1">// Model muda</span>
<span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">addSelectedCity</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">);</span>

<span class="c1">// View reage automaticamente</span>
<span class="nx">renderSelectedCitiesList</span><span class="p">(</span><span class="nx">selectedCitiesList</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
</code></pre></div>



**ImplementaÃ§Ã£o:** Manual (nÃ£o usa biblioteca), mas segue o padrÃ£o.

### 17.2 PadrÃ£o Strategy

**Conceito:**
Permite selecionar algoritmo em tempo de execuÃ§Ã£o.

**No Projeto:**

<div class="codehilite"><pre><span></span><code><span class="c1">// EstratÃ©gia selecionada baseada em disponibilidade</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">useSharedMemory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// EstratÃ©gia: SharedArrayBuffer</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">collectCitiesParallel</span><span class="p">(...);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// EstratÃ©gia: postMessage (fallback)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">collectCitiesParallelFallback</span><span class="p">(...);</span>
<span class="p">}</span>
</code></pre></div>



### 17.3 PadrÃ£o Factory

**Conceito:**
Cria objetos sem especificar classe exata.

**No Projeto:**

<div class="codehilite"><pre><span></span><code><span class="c1">// Factory de workers</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="s2">&quot;/js/workers/dataCollectionWorker.js&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;module&quot;</span><span class="w"> </span><span class="p">});</span>
</code></pre></div>



### 17.4 PadrÃ£o Command

**Conceito:**
Encapsula requisiÃ§Ã£o como objeto.

**No Projeto:**

<div class="codehilite"><pre><span></span><code><span class="c1">// Comandos encapsulados em funÃ§Ãµes</span>
<span class="nx">handlePagination</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">elements</span><span class="p">);</span>
<span class="nx">handleSelectCity</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="nx">handleStartCollection</span><span class="p">();</span>
</code></pre></div>



---

<a id="capÃ­tulo-18-anÃ¡lise-de-erros-e-robustez"></a>
## ğŸ“š CapÃ­tulo 18: AnÃ¡lise de Erros e Robustez

### 18.1 Tratamento de Erros em Sistemas AssÃ­ncronos

**Problema:** Erros em cÃ³digo assÃ­ncrono podem ser perdidos se nÃ£o tratados.

**SoluÃ§Ã£o: Try-Catch com Async/Await**


<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchPage</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Processa dados...</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Erro capturado e tratado</span>
<span class="w">  </span><span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise:**
- Erros sÃ­ncronos: capturados imediatamente
- Erros assÃ­ncronos: capturados quando Promise rejeita
- Erros em workers: propagados via postMessage

### 18.2 Retry Logic e Exponential Backoff

**FundamentaÃ§Ã£o TeÃ³rica:**

Backoff exponencial Ã© usado em:
- **Ethernet:** CSMA/CD protocol
- **TCP:** Congestion control
- **Distributed Systems:** Consensus algorithms

**Algoritmo:**

<div class="codehilite"><pre><span></span><code>wait_time = base Ã— multiplier^attempt
</code></pre></div>



**No Projeto:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">waitTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">15000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span>
<span class="c1">// Linear em vez de exponencial (mais conservador)</span>
</code></pre></div>



**Por que Linear?**
- Rate limits geralmente resetam em tempo fixo
- Exponencial pode esperar tempo desnecessÃ¡rio
- Linear Ã© mais previsÃ­vel

### 18.3 ValidaÃ§Ã£o e SanitizaÃ§Ã£o

**Camadas de ValidaÃ§Ã£o:**

1. **Cliente (Frontend):**
   - ValidaÃ§Ã£o de entrada do usuÃ¡rio
   - Feedback imediato
   - NÃ£o confiÃ¡vel (pode ser contornada)

2. **Servidor (Backend):**
   - ValidaÃ§Ã£o definitiva
   - SanitizaÃ§Ã£o de dados
   - ConfiÃ¡vel

**No Projeto:**

<div class="codehilite"><pre><span></span><code><span class="c1">// ValidaÃ§Ã£o no cliente</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">targetCities</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">targetCities</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Por favor, insira um nÃºmero vÃ¡lido...&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ValidaÃ§Ã£o no servidor (deveria existir)</span>
<span class="c1">// Middleware validateQueryParams valida parÃ¢metros da API</span>
</code></pre></div>



---

<a id="capÃ­tulo-19-performance-e-otimizaÃ§Ã£o"></a>
## ğŸ“š CapÃ­tulo 19: Performance e OtimizaÃ§Ã£o

### 19.1 Profiling e AnÃ¡lise de Performance

**Ferramentas:**
- Chrome DevTools Performance tab
- Memory profiler
- Network tab para anÃ¡lise de requisiÃ§Ãµes

**MÃ©tricas Importantes:**
1. **First Contentful Paint (FCP):** < 1.8s
2. **Time to Interactive (TTI):** < 3.8s
3. **Total Blocking Time (TBT):** < 200ms
4. **Cumulative Layout Shift (CLS):** < 0.1

### 19.2 OtimizaÃ§Ãµes de MemÃ³ria

**Problema:** Vazamentos de memÃ³ria em aplicaÃ§Ãµes longas.

**SoluÃ§Ãµes:**
1. **Limpar referÃªncias:**
   ```javascript
   worker.terminate(); // Libera recursos do worker
   ```

2. **Remover event listeners:**
   ```javascript
   element.removeEventListener('click', handler);
   ```

3. **Limpar arrays grandes:**
   ```javascript
   array.length = 0; // Mais eficiente que array = []
   ```

### 19.3 Lazy Loading e Code Splitting

**Conceito:**
Carregar cÃ³digo apenas quando necessÃ¡rio.

**PossÃ­vel ImplementaÃ§Ã£o:**

<div class="codehilite"><pre><span></span><code><span class="c1">// Carrega worker apenas quando necessÃ¡rio</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">loadWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;/js/workers/dataCollectionWorker.js&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="k">default</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>



**BenefÃ­cios:**
- Reduz bundle inicial
- Melhora tempo de carregamento inicial
- Trade-off: LatÃªncia na primeira execuÃ§Ã£o

---

<a id="capÃ­tulo-20-escalabilidade-e-arquitetura"></a>
## ğŸ“š CapÃ­tulo 20: Escalabilidade e Arquitetura

### 20.1 Escalabilidade Horizontal vs Vertical

**Escalabilidade Vertical (Scale Up):**
- Adicionar mais recursos a uma mÃ¡quina
- Limite: Hardware fÃ­sico
- Custo: Alto (hardware especializado)

**Escalabilidade Horizontal (Scale Out):**
- Adicionar mais mÃ¡quinas
- Limite: TeÃ³rico (ilimitado)
- Custo: Linear com nÃºmero de mÃ¡quinas

**No Projeto:**
- **Frontend:** Escalabilidade horizontal (mais workers = mais processamento)
- **Backend:** Pode escalar horizontalmente (load balancer + mÃºltiplos servidores)

### 20.2 Arquitetura de MicroserviÃ§os (Futuro)

**PossÃ­vel EvoluÃ§Ã£o:**

<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Gateway â”‚â”€â”€â”€â”€â–¶â”‚ City Serviceâ”‚â”€â”€â”€â”€â–¶â”‚ GeoDB API   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ K-Means     â”‚
â”‚ Service     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>



**Vantagens:**
- Escalabilidade independente
- Deploy independente
- Tecnologias diferentes por serviÃ§o

**Desvantagens:**
- Complexidade de operaÃ§Ã£o
- LatÃªncia de rede entre serviÃ§os
- Overhead de comunicaÃ§Ã£o

---

<a id="capÃ­tulo-21-Ã©tica-e-responsabilidade-em-sistemas-computacionais"></a>
## ğŸ“š CapÃ­tulo 21: Ã‰tica e Responsabilidade em Sistemas Computacionais

### 21.1 Privacidade de Dados

**ConsideraÃ§Ãµes:**
- Dados de cidades sÃ£o pÃºblicos, mas agregados podem revelar padrÃµes
- Respeitar termos de uso da API
- NÃ£o armazenar dados desnecessariamente

### 21.2 Uso ResponsÃ¡vel de Recursos

**ConsideraÃ§Ãµes:**
- Rate limiting respeita limites da API
- NÃ£o sobrecarregar servidores externos
- Implementar backoff para evitar abuso

### 21.3 Acessibilidade

**ConsideraÃ§Ãµes:**
- Interface deve ser acessÃ­vel (ARIA labels)
- Suporte a leitores de tela
- NavegaÃ§Ã£o por teclado

---

## ğŸ“ ConclusÃ£o AcadÃªmica Final

Este projeto demonstra integraÃ§Ã£o de mÃºltiplas Ã¡reas da CiÃªncia da ComputaÃ§Ã£o:

1. **Sistemas Operacionais:** Threads, memÃ³ria compartilhada, sincronizaÃ§Ã£o
2. **Algoritmos e Estruturas de Dados:** DivisÃ£o e conquista, anÃ¡lise de complexidade
3. **Machine Learning:** K-Means clustering, normalizaÃ§Ã£o de dados
4. **ProgramaÃ§Ã£o de Sistemas:** ProgramaÃ§Ã£o assÃ­ncrona, concorrÃªncia
5. **Arquitetura de Software:** MVC, separation of concerns, design patterns
6. **Teoria da ComputaÃ§Ã£o:** Lambda calculus, funÃ§Ãµes puras

Cada decisÃ£o tÃ©cnica foi fundamentada em teoria estabelecida e validada em produÃ§Ã£o. O cÃ³digo nÃ£o apenas funciona, mas demonstra compreensÃ£o profunda dos princÃ­pios fundamentais da computaÃ§Ã£o.

**PrÃ³ximos Passos AcadÃªmicos:**
1. Implementar K-Means++ para melhor inicializaÃ§Ã£o
2. Adicionar visualizaÃ§Ã£o grÃ¡fica dos clusters
3. Implementar testes automatizados abrangentes
4. Otimizar serializaÃ§Ã£o com formatos binÃ¡rios
5. Adicionar mÃ©tricas de qualidade de clustering (Silhouette Score, etc.)

---

## ğŸ“š CapÃ­tulo 22: ExercÃ­cios PrÃ¡ticos e AplicaÃ§Ã£o do Conhecimento

### 22.1 ExercÃ­cios de CompreensÃ£o

**ExercÃ­cio 1: AnÃ¡lise de Complexidade**
Analise a complexidade temporal e espacial da funÃ§Ã£o `collectCitiesParallel`:
- Quantas operaÃ§Ãµes sÃ£o realizadas?
- Qual Ã© o fator limitante?
- Como a complexidade muda com nÃºmero de workers?

**ExercÃ­cio 2: ImplementaÃ§Ã£o de CAS**
Implemente uma versÃ£o simplificada de `compareExchange` usando apenas `load` e `store`:

<div class="codehilite"><pre><span></span><code><span class="c1">// Desafio: Implementar CAS usando apenas load/store</span>
<span class="c1">// (NÃ£o Ã© possÃ­vel em JavaScript, mas exercÃ­cio teÃ³rico)</span>
</code></pre></div>



**ExercÃ­cio 3: OtimizaÃ§Ã£o de SerializaÃ§Ã£o**
Projete um formato binÃ¡rio mais eficiente que JSON para cidades:
- Quais campos sÃ£o essenciais?
- Como reduzir overhead?
- Qual ganho de espaÃ§o esperado?

### 22.2 Projetos de ExtensÃ£o

**Projeto 1: K-Means++**
Implemente inicializaÃ§Ã£o K-Means++:
- Escolha primeiro centroide aleatoriamente
- Para cada centroide subsequente, escolha com probabilidade proporcional a DÂ²
- Compare qualidade de clusters vs inicializaÃ§Ã£o aleatÃ³ria

**Projeto 2: VisualizaÃ§Ã£o em Mapa**
Integre biblioteca de mapas (Leaflet, Mapbox):
- Plote cidades em mapa interativo
- Colorir por cluster
- Mostrar centroides

**Projeto 3: MÃ©tricas de Qualidade**
Implemente mÃ©tricas de avaliaÃ§Ã£o:
- Silhouette Score
- Within-Cluster Sum of Squares (WCSS)
- Between-Cluster Sum of Squares (BCSS)

### 22.3 AnÃ¡lise CrÃ­tica

**QuestÃµes para ReflexÃ£o:**

1. **Trade-offs:**
   - Quando usar SharedArrayBuffer vs postMessage?
   - Quando paralelizar vs sequencial?
   - Quando otimizar vs manter simplicidade?

2. **Escalabilidade:**
   - Qual Ã© o limite prÃ¡tico de workers?
   - Como o sistema se comporta com 100k cidades?
   - Onde estÃ£o os gargalos?

3. **Robustez:**
   - O que acontece se um worker falha?
   - Como garantir consistÃªncia dos dados?
   - Como lidar com dados corrompidos?

---

## ğŸ“š CapÃ­tulo 23: GlossÃ¡rio de Termos TÃ©cnicos

### A

**Atomics API:** Conjunto de operaÃ§Ãµes atÃ´micas para sincronizaÃ§Ã£o thread-safe em JavaScript.

**Async/Await:** AÃ§Ãºcar sintÃ¡tico sobre Promises que permite cÃ³digo assÃ­ncrono com sintaxe sÃ­ncrona.

### B

**Backoff Exponencial:** EstratÃ©gia de retry onde tempo de espera aumenta exponencialmente a cada tentativa.

**Buffer:** RegiÃ£o contÃ­gua de memÃ³ria para armazenamento de dados binÃ¡rios.

### C

**CAS (Compare-and-Swap):** OperaÃ§Ã£o atÃ´mica que compara valor na memÃ³ria com valor esperado e troca se iguais.

**Clustering:** TÃ©cnica de machine learning para agrupar dados similares.

**ConcorrÃªncia:** Propriedade de sistema onde mÃºltiplas tarefas podem estar em progresso simultaneamente.

### D

**DivisÃ£o e Conquista:** Paradigma algorÃ­tmico que divide problema em subproblemas menores.

**Deadlock:** SituaÃ§Ã£o onde processos ficam bloqueados esperando uns pelos outros.

### E

**Event Loop:** Mecanismo que gerencia execuÃ§Ã£o de cÃ³digo assÃ­ncrono em JavaScript.

**Euclidiana (DistÃ¢ncia):** Medida de distÃ¢ncia entre dois pontos no espaÃ§o euclidiano.

### F

**FunÃ§Ã£o Pura:** FunÃ§Ã£o que sempre retorna mesmo resultado para mesmas entradas, sem efeitos colaterais.

### I

**Imutabilidade:** Propriedade de dados que nÃ£o podem ser modificados apÃ³s criaÃ§Ã£o.

**IdempotÃªncia:** Propriedade de operaÃ§Ã£o que pode ser aplicada mÃºltiplas vezes sem mudar resultado.

### K

**K-Means:** Algoritmo de clustering que divide dados em k grupos baseado em similaridade.

### M

**Mutex:** Mecanismo de sincronizaÃ§Ã£o que garante exclusÃ£o mÃºtua (mutual exclusion).

**MemÃ³ria Compartilhada:** RegiÃ£o de memÃ³ria acessÃ­vel por mÃºltiplas threads simultaneamente.

### P

**Paralelismo:** Propriedade de sistema onde mÃºltiplas tarefas executam simultaneamente em processadores diferentes.

**Promise:** Objeto que representa resultado futuro de operaÃ§Ã£o assÃ­ncrona.

### R

**Race Condition:** SituaÃ§Ã£o onde resultado depende de timing de execuÃ§Ã£o de threads.

**Rate Limiting:** Controle de taxa de requisiÃ§Ãµes para evitar sobrecarga.

### S

**SerializaÃ§Ã£o:** Processo de converter objeto em formato que pode ser armazenado ou transmitido.

**SharedArrayBuffer:** Buffer de memÃ³ria compartilhado entre mÃºltiplas threads em JavaScript.

**Speedup:** Medida de aceleraÃ§Ã£o: `S(n) = T(1) / T(n)`.

### T

**Thread-Safety:** Propriedade de cÃ³digo que funciona corretamente quando executado por mÃºltiplas threads.

**Token Bucket:** Algoritmo para controle de taxa de requisiÃ§Ãµes.

### W

**Web Worker:** Thread isolada em JavaScript para processamento paralelo.

**WCSS (Within-Cluster Sum of Squares):** Soma dos quadrados das distÃ¢ncias de pontos aos seus centroides.

---

## ğŸ“š CapÃ­tulo 24: Resumo Executivo para Estudo

### 24.1 Conceitos-Chave por TÃ³pico

**ProgramaÃ§Ã£o AssÃ­ncrona:**
- Event loop single-threaded
- Promises e async/await
- NÃ£o-bloqueante I/O

**ConcorrÃªncia vs Paralelismo:**
- ConcorrÃªncia: compartilhamento de recursos
- Paralelismo: execuÃ§Ã£o simultÃ¢nea
- JavaScript: concorrente por padrÃ£o, paralelo com Workers

**ProgramaÃ§Ã£o Funcional:**
- Imutabilidade
- FunÃ§Ãµes puras
- ComposiÃ§Ã£o
- Sem efeitos colaterais

**MemÃ³ria Compartilhada:**
- SharedArrayBuffer
- Atomics API
- Compare-and-Swap
- Thread-safety

**K-Means:**
- Algoritmo iterativo
- Minimiza WCSS
- ParalelizÃ¡vel
- Converge para mÃ­nimo local

### 24.2 FÃ³rmulas Importantes

**Speedup:**

<div class="codehilite"><pre><span></span><code>S(n) = T(1) / T(n)
</code></pre></div>



**Lei de Amdahl:**

<div class="codehilite"><pre><span></span><code>S(n) = 1 / (f + (1-f)/n)
</code></pre></div>



**DistÃ¢ncia Euclidiana:**

<div class="codehilite"><pre><span></span><code>d = âˆš(Î£(xáµ¢ - yáµ¢)Â²)
</code></pre></div>



**WCSS (K-Means):**

<div class="codehilite"><pre><span></span><code>J = Î£áµ¢ ||xáµ¢ - c_{aáµ¢}||Â²
</code></pre></div>



### 24.3 Complexidades Principais

| OperaÃ§Ã£o | Complexidade |
|----------|--------------|
| PaginaÃ§Ã£o | O(1) |
| Coleta paralela | O(n/p) |
| K-Means (por iteraÃ§Ã£o) | O(nÃ—kÃ—d/p) |
| SerializaÃ§Ã£o | O(n) |
| Escrita atÃ´mica | O(1) amortizado |

---

## ğŸ“ ConclusÃ£o Final: SÃ­ntese AcadÃªmica

Este projeto representa uma integraÃ§Ã£o completa de mÃºltiplas Ã¡reas da CiÃªncia da ComputaÃ§Ã£o:

### Ãreas Cobertas:

1. **Teoria da ComputaÃ§Ã£o:**
   - Lambda calculus
   - Computabilidade
   - Complexidade algorÃ­tmica

2. **Sistemas DistribuÃ­dos:**
   - MemÃ³ria compartilhada
   - SincronizaÃ§Ã£o
   - ComunicaÃ§Ã£o entre processos

3. **Algoritmos e Estruturas de Dados:**
   - DivisÃ£o e conquista
   - AnÃ¡lise de complexidade
   - OtimizaÃ§Ã£o

4. **Machine Learning:**
   - Clustering nÃ£o-supervisionado
   - K-Means
   - NormalizaÃ§Ã£o de dados

5. **Arquitetura de Software:**
   - PadrÃµes de design
   - Separation of concerns
   - Escalabilidade

6. **ProgramaÃ§Ã£o de Sistemas:**
   - ConcorrÃªncia
   - Paralelismo
   - SincronizaÃ§Ã£o

### CompetÃªncias Desenvolvidas:

âœ… **AnÃ¡lise:** Capacidade de analisar complexidade e performance  
âœ… **Design:** Capacidade de projetar sistemas escalÃ¡veis  
âœ… **ImplementaÃ§Ã£o:** Capacidade de implementar soluÃ§Ãµes robustas  
âœ… **OtimizaÃ§Ã£o:** Capacidade de identificar e resolver gargalos  
âœ… **FundamentaÃ§Ã£o:** CompreensÃ£o teÃ³rica profunda dos conceitos

### PrÃ³ximos NÃ­veis de Aprendizado:

1. **AvanÃ§ado:** Implementar algoritmos mais sofisticados (DBSCAN, Hierarchical Clustering)
2. **DistribuÃ­do:** Estender para mÃºltiplos servidores
3. **OtimizaÃ§Ã£o:** Implementar estruturas de dados persistentes
4. **VisualizaÃ§Ã£o:** Adicionar visualizaÃ§Ãµes interativas avanÃ§adas
5. **ProduÃ§Ã£o:** Implementar monitoramento, logging, mÃ©tricas

---

## ğŸ“š CapÃ­tulo 25: AnÃ¡lise Completa do CÃ³digo - Arquitetura e ImplementaÃ§Ã£o Detalhada

> **Nota do Professor:** Esta seÃ§Ã£o apresenta uma anÃ¡lise linha por linha do cÃ³digo implementado, explicando cada decisÃ£o de design, padrÃ£o utilizado e fundamentaÃ§Ã£o teÃ³rica. Este nÃ­vel de detalhamento Ã© caracterÃ­stico de dissertaÃ§Ãµes de doutorado em Engenharia de Software.

---

## ğŸ“ Parte A: Backend - Servidor Express.js

> **ğŸ“š ReferÃªncias Node.js e Express:**
> - [Express.js - DocumentaÃ§Ã£o Oficial](https://expressjs.com/)
> - [Express Application - API Reference](https://expressjs.com/en/4x/api.html#app)
> - [Express Router - API Reference](https://expressjs.com/en/4x/api.html#router)
> - [Node.js Modules - Sistema de MÃ³dulos](https://nodejs.org/docs/latest/api/modules.html)
> - [Node.js path - ManipulaÃ§Ã£o de Caminhos](https://nodejs.org/docs/latest/api/path.html)
> - [Node.js process - Processo e VariÃ¡veis de Ambiente](https://nodejs.org/docs/latest/api/process.html)
> - [Node.js http - Servidor HTTP](https://nodejs.org/docs/latest/api/http.html)

### A.1 Arquivo: `app/index.js` - Ponto de Entrada do Servidor

**AnÃ¡lise Arquitetural:**

Este arquivo implementa o padrÃ£o **Application Entry Point** e configura o servidor Express.js seguindo princÃ­pios de **Separation of Concerns**.

> **ğŸ“š ReferÃªncias Express:**
> - [Express Application Setup](https://expressjs.com/en/4x/api.html#app)
> - [Express Middleware](https://expressjs.com/en/guide/using-middleware.html)
> - [Express Static Files](https://expressjs.com/en/starter/static-files.html)
> - [Express Error Handling](https://expressjs.com/en/guide/error-handling.html)

#### Linha 1-6: Imports e DependÃªncias


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;node:path&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">webRouter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./routes/web&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">apiRouter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./routes/api&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">errorHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./middleware/errorHandler&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">validateEnvironment</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./util/envValidator&quot;</span><span class="p">);</span>
</code></pre></div>



**AnÃ¡lise:**
- **`express`**: Framework web minimalista para Node.js, baseado em **middleware pattern**
  - [Express.js - DocumentaÃ§Ã£o](https://expressjs.com/)
  - [Express Installation](https://expressjs.com/en/starter/installing.html)
- **`path`**: MÃ³dulo nativo para manipulaÃ§Ã£o de caminhos de arquivos (cross-platform)
  - [Node.js path Module](https://nodejs.org/docs/latest/api/path.html)
  - [path.join() - Junta Caminhos](https://nodejs.org/docs/latest/api/path.html#pathjoinpaths)
- **Rotas modulares**: SeparaÃ§Ã£o clara entre rotas web (renderizaÃ§Ã£o) e API (JSON)
  - [Express Router](https://expressjs.com/en/4x/api.html#router)
- **Error Handler**: Middleware centralizado para tratamento de erros (padrÃ£o Express)
  - [Express Error Handling](https://expressjs.com/en/guide/error-handling.html)

**FundamentaÃ§Ã£o TeÃ³rica:**
- **Dependency Injection**: DependÃªncias injetadas via `require()` facilitam testes
- **Single Responsibility Principle**: Cada mÃ³dulo tem responsabilidade Ãºnica

#### Linha 8-14: ValidaÃ§Ã£o de Ambiente


<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">validateEnvironment</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Environment validation failed:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">  </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise:**
- **Fail-Fast Principle**: ValidaÃ§Ã£o ocorre antes de iniciar servidor
- **Graceful Degradation**: `process.exit(1)` indica falha ao sistema operacional
  - [Node.js process.exit()](https://nodejs.org/docs/latest/api/process.html#processexitcode)
- **Error Propagation**: Erro propagado imediatamente, nÃ£o mascarado
  - [Node.js process - Error Handling](https://nodejs.org/docs/latest/api/process.html#process_event_uncaughtexception)

**Por que validar antes?**
- Evita servidor iniciar em estado invÃ¡lido
- Facilita debugging (erro claro no inÃ­cio)
- SeguranÃ§a: nÃ£o expÃµe servidor sem configuraÃ§Ã£o adequada

#### Linha 16-21: ConfiguraÃ§Ã£o do Template Engine


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;view engine&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ejs&quot;</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;views&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;views&quot;</span><span class="p">));</span>
</code></pre></div>



**AnÃ¡lise:**
- **EJS (Embedded JavaScript)**: Template engine server-side
  - [EJS - Embedded JavaScript Templates](https://ejs.co/)
  - [Express View Engines](https://expressjs.com/en/guide/using-template-engines.html)
- **`path.join()`**: Garante caminho correto em diferentes sistemas operacionais
  - [Node.js path.join()](https://nodejs.org/docs/latest/api/path.html#pathjoinpaths)
- **`__dirname`**: VariÃ¡vel global Node.js com diretÃ³rio do mÃ³dulo atual
  - [Node.js __dirname](https://nodejs.org/docs/latest/api/modules.html#__dirname)

**DecisÃ£o de Design:**
- EJS escolhido por simplicidade e integraÃ§Ã£o com Express
- Alternativas: Handlebars, Pug, Mustache
- Trade-off: EJS permite JavaScript inline (mais flexÃ­vel, menos seguro)

#### Linha 23-25: Middleware de Parsing


<div class="codehilite"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span><span class="w"> </span><span class="nx">extended</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}));</span>
</code></pre></div>



**AnÃ¡lise:**
- **`urlencoded`**: Middleware para parsing de dados de formulÃ¡rios HTML
  - [Express express.urlencoded()](https://expressjs.com/en/4x/api.html#express.urlencoded)
  - [Body Parsing Middleware](https://expressjs.com/en/resources/middleware/body-parser.html)
- **`extended: true`**: Permite objetos aninhados (usa `qs` library)
  - [qs - Query String Parser](https://github.com/ljharb/qs)
- **`app.use()`**: Aplica middleware a todas as rotas
  - [Express app.use()](https://expressjs.com/en/4x/api.html#app.use)

**Complexidade:**
- Tempo: O(n) onde n = tamanho do body
- EspaÃ§o: O(n) para armazenar objeto parseado

#### Linha 27-34: Headers para SharedArrayBuffer


<div class="codehilite"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Cross-Origin-Opener-Policy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;same-origin&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Cross-Origin-Embedder-Policy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;require-corp&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>



**AnÃ¡lise Detalhada:**

**Cross-Origin-Opener-Policy (COOP):**
- **Valor `same-origin`**: Apenas documentos da mesma origem podem abrir janelas
- **PropÃ³sito**: Isolamento de contexto de navegaÃ§Ã£o
- **Impacto**: Previne ataques de timing side-channel (Spectre)

**Cross-Origin-Embedder-Policy (COEP):**
- **Valor `require-corp`**: Recursos devem declarar `Cross-Origin-Resource-Policy`
- **PropÃ³sito**: Permite uso de APIs sensÃ­veis (SharedArrayBuffer, Performance API)
- **Requisito**: Todos os recursos (CSS, JS, imagens) devem ter header CORP

**FundamentaÃ§Ã£o de SeguranÃ§a:**

<div class="codehilite"><pre><span></span><code>Sem COOP/COEP:
  SharedArrayBuffer â†’ DESABILITADO (vulnerabilidade Spectre)

Com COOP/COEP:
  SharedArrayBuffer â†’ HABILITADO (isolamento garante seguranÃ§a)
</code></pre></div>



**Trade-offs:**
- âœ… Permite SharedArrayBuffer
- âŒ Requer configuraÃ§Ã£o de todos os recursos
- âŒ Pode quebrar recursos de terceiros sem CORP

#### Linha 36-50: Middleware de Arquivos EstÃ¡ticos


<div class="codehilite"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="k">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;public&quot;</span><span class="p">),</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">setHeaders</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">filePath</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">filePath</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.js&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;application/javascript; charset=utf-8&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;no-cache, no-store, must-revalidate&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Pragma&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;no-cache&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Expires&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}));</span>
</code></pre></div>



**AnÃ¡lise:**

**`express.static()`:**
- Serve arquivos estÃ¡ticos do diretÃ³rio `public`
- Middleware de alto desempenho (usa `send` library)
- Suporta cache HTTP e compressÃ£o

**Headers Configurados:**

1. **Content-Type:**
   - `application/javascript`: MIME type correto para mÃ³dulos ES6
   - `charset=utf-8`: Garante encoding correto

2. **Cache-Control:**
   - `no-cache`: Deve validar com servidor antes de usar cache
   - `no-store`: NÃ£o armazena em cache
   - `must-revalidate`: Valida cache expirado antes de usar

3. **Pragma/Expires:**
   - Headers legados para compatibilidade HTTP/1.0
   - Garantem que navegadores antigos nÃ£o faÃ§am cache

**Por que desabilitar cache em desenvolvimento?**
- Facilita debugging (mudanÃ§as aparecem imediatamente)
- Evita problemas com hot-reload
- Trade-off: Performance reduzida (mas aceitÃ¡vel em dev)

**Em ProduÃ§Ã£o:**

<div class="codehilite"><pre><span></span><code><span class="c1">// Deveria usar:</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;public, max-age=31536000&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 1 ano</span>
</code></pre></div>



#### Linha 52-58: Registro de Rotas e Error Handler


<div class="codehilite"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">webRouter</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">apiRouter</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">errorHandler</span><span class="p">);</span>
</code></pre></div>



**AnÃ¡lise:**

**Ordem Importante:**
1. Rotas especÃ­ficas primeiro (`webRouter`, `apiRouter`)
2. Error handler por Ãºltimo (captura erros de todas as rotas)

**Por que essa ordem?**
- Express processa middlewares na ordem de registro
- Error handler deve ser Ãºltimo para capturar todos os erros
- Se colocado antes, nÃ£o captura erros de rotas

**PadrÃ£o de Roteamento:**

<div class="codehilite"><pre><span></span><code>Request â†’ Middleware 1 â†’ Middleware 2 â†’ ... â†’ Route Handler â†’ Response
                                                      â†“ (erro)
                                              Error Handler
</code></pre></div>



#### Linha 60-67: InicializaÃ§Ã£o do Servidor


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Server is running on port </span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Environment: </span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;development&quot;</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Access: http://localhost:</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>



**AnÃ¡lise:**

**`process.env.PORT`:**
- VariÃ¡vel de ambiente (12-factor app)
- Permite configuraÃ§Ã£o sem alterar cÃ³digo
- PadrÃ£o: 3000 em desenvolvimento

**`app.listen()`:**
- Inicia servidor HTTP na porta especificada
  - [Express app.listen()](https://expressjs.com/en/4x/api.html#app.listen)
- Retorna objeto `http.Server`
  - [Node.js http.Server](https://nodejs.org/docs/latest/api/http.html#class-httpserver)
- Callback executado quando servidor estÃ¡ pronto

**Logging:**
- InformaÃ§Ãµes essenciais para debugging
- Em produÃ§Ã£o, usar logger estruturado (Winston, Pino)

---

### A.2 Arquivo: `app/routes/api.js` - Rotas da API REST

#### Linha 1-5: Setup do Router


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cityApiController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../controllers/cityApiController&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">validateQueryParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../middleware/validateQueryParams&quot;</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
</code></pre></div>



**AnÃ¡lise:**

**`express.Router()`:**
- Cria mini-aplicaÃ§Ã£o Express isolada
  - [Express Router](https://expressjs.com/en/4x/api.html#router)
- Permite modularizaÃ§Ã£o de rotas
  - [Express Router Guide](https://expressjs.com/en/guide/routing.html#express-router)
- Pode ter seus prÃ³prios middlewares
  - [Router Middleware](https://expressjs.com/en/4x/api.html#router.use)

**PadrÃ£o MVC:**
- **Routes**: Definem endpoints (este arquivo)
- **Controllers**: LÃ³gica de negÃ³cio (`cityApiController`)
- **Middleware**: ValidaÃ§Ã£o (`validateQueryParams`)

#### Linha 7-18: Rota GET /api/cities


<div class="codehilite"><pre><span></span><code><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/cities&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">validateQueryParams</span><span class="p">,</span><span class="w"> </span><span class="nx">cityApiController</span><span class="p">.</span><span class="nx">show</span><span class="p">);</span>
</code></pre></div>



**AnÃ¡lise:**

**Sintaxe:**

<div class="codehilite"><pre><span></span><code>router.METHOD(path, [middleware...], handler)
</code></pre></div>



**Fluxo de ExecuÃ§Ã£o:**

<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="kr">GET</span><span class="w"> </span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">cities</span><span class="err">?</span><span class="n">limit</span><span class="o">=</span><span class="mf">10</span><span class="err">&amp;</span><span class="n">offset</span><span class="o">=</span><span class="mf">0</span>
<span class="mf">2.</span><span class="w"> </span><span class="nb">val</span><span class="n">idateQueryParams</span><span class="w"> </span><span class="p">(</span><span class="n">middleware</span><span class="p">)</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="nb">Val</span><span class="n">ida</span><span class="w"> </span><span class="n">parÃ¢metros</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Se</span><span class="w"> </span><span class="n">invÃ¡lido</span><span class="p">:</span><span class="w"> </span><span class="n">retorna</span><span class="w"> </span><span class="mf">400</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Se</span><span class="w"> </span><span class="n">vÃ¡lido</span><span class="p">:</span><span class="w"> </span><span class="n">chama</span><span class="w"> </span><span class="kr">next</span><span class="p">()</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">cityApiController</span><span class="mf">.</span><span class="n">show</span><span class="w"> </span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Processa</span><span class="w"> </span><span class="n">requisiÃ§Ã£o</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Retorna</span><span class="w"> </span><span class="n">JSON</span>
</code></pre></div>



**RESTful Design:**
- **GET**: OperaÃ§Ã£o idempotente (nÃ£o modifica estado)
- **Path**: `/api/cities` (plural, recurso)
- **Query params**: Filtros e paginaÃ§Ã£o

#### Linha 20-31: Health Check Endpoint


<div class="codehilite"><pre><span></span><code><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/health&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ok&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">uptime</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">uptime</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;development&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>



**AnÃ¡lise:**

**PropÃ³sito:**
- Monitoramento de saÃºde do servidor
- IntegraÃ§Ã£o com load balancers
- Debugging rÃ¡pido

**InformaÃ§Ãµes Retornadas:**
- **status**: Estado do servidor
- **timestamp**: Momento da verificaÃ§Ã£o (ISO 8601)
- **uptime**: Tempo de execuÃ§Ã£o em segundos
- **environment**: Ambiente atual

**Uso em ProduÃ§Ã£o:**

<div class="codehilite"><pre><span></span><code><span class="c1"># Kubernetes liveness probe</span>
curl<span class="w"> </span>http://app/api/health

<span class="c1"># Load balancer health check</span>
GET<span class="w"> </span>/api/health<span class="w"> </span>â†’<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span>â†’<span class="w"> </span>Servidor<span class="w"> </span>saudÃ¡vel
</code></pre></div>



---

### A.3 Arquivo: `app/middleware/validateQueryParams.js` - ValidaÃ§Ã£o de ParÃ¢metros

#### Linha 7-23: ValidaÃ§Ã£o de `limit`


<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">limit</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">limit</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">limitNum</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">limitNum</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">limitNum</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Parameter &#39;limit&#39; must be a number between 1 and 10 (plan limit)&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">400</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">request</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitNum</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise Detalhada:**

**`parseInt(limit, 10)`:**
- Converte string para nÃºmero inteiro
- Base 10 (decimal)
- Retorna `NaN` se invÃ¡lido

**ValidaÃ§Ã£o:**
- **`isNaN()`**: Verifica se nÃ£o Ã© nÃºmero
- **Range**: 1-10 (limite do plano BASIC da RapidAPI)
- **Early return**: Retorna erro imediatamente se invÃ¡lido

**SanitizaÃ§Ã£o:**
- `request.query.limit = limitNum`: Substitui string por nÃºmero
- PrÃ³ximos middlewares recebem valor tipado

**Por que validar?**
- **SeguranÃ§a**: Previne injection attacks
- **Robustez**: Garante tipos corretos
- **UX**: Mensagens de erro claras

#### Linha 25-37: ValidaÃ§Ã£o de `offset`


<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">offset</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">offsetNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">offsetNum</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">offsetNum</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Parameter &#39;offset&#39; must be a non-negative number&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">400</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">request</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">offsetNum</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise:**

**DiferenÃ§a do `limit`:**
- NÃ£o tem limite mÃ¡ximo (apenas >= 0)
- Permite paginaÃ§Ã£o de grandes datasets
- ValidaÃ§Ã£o mais simples

**Uso em PaginaÃ§Ã£o:**

<div class="codehilite"><pre><span></span><code>PÃ¡gina 1: offset=0, limit=10   â†’ itens 0-9
PÃ¡gina 2: offset=10, limit=10 â†’ itens 10-19
PÃ¡gina 3: offset=20, limit=10 â†’ itens 20-29
</code></pre></div>



#### Linha 39-53: ValidaÃ§Ã£o de `sort`


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">allowedSortFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;population&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;elevationMeters&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;timezone&quot;</span><span class="p">,</span>
<span class="p">];</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sort</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">allowedSortFields</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">sort</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Parameter &#39;sort&#39; must be one of: </span><span class="si">${</span><span class="nx">allowedSortFields</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">400</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise:**

**Whitelist Approach:**
- Lista explÃ­cita de campos permitidos
- Mais seguro que blacklist
- Previne SQL injection (se houvesse SQL)

**`Array.includes()`:**
- Verifica se valor estÃ¡ na lista
- O(1) em arrays pequenos
- Mais legÃ­vel que `indexOf() !== -1`

**Mensagem de Erro:**
- Inclui lista de valores vÃ¡lidos
- Facilita debugging
- Melhora UX

---

### A.4 Arquivo: `app/services/cityService.js` - ServiÃ§o de IntegraÃ§Ã£o com API Externa

#### Linha 18-39: Destructuring com Valores PadrÃ£o


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">axiosRequestCityData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">location</span><span class="p">,</span>
<span class="w">    </span><span class="nx">radius</span><span class="p">,</span>
<span class="w">    </span><span class="nx">distanceUnit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;MI&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ... mais parÃ¢metros</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">;</span>
</code></pre></div>



**AnÃ¡lise:**

**Default Parameters:**
- Valores padrÃ£o para parÃ¢metros opcionais
- Garante comportamento previsÃ­vel
- Reduz necessidade de validaÃ§Ã£o

**Destructuring:**
- Extrai propriedades do objeto `options`
- Sintaxe ES6 mais limpa
- Permite renomeaÃ§Ã£o se necessÃ¡rio

**Complexidade:**
- Tempo: O(1) - apenas atribuiÃ§Ã£o
- EspaÃ§o: O(n) onde n = nÃºmero de propriedades

#### Linha 41-60: ConstruÃ§Ã£o de Query String


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">queryString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">buildQueryString</span><span class="p">({</span>
<span class="w">  </span><span class="nx">offset</span><span class="p">,</span>
<span class="w">  </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">  </span><span class="nx">sort</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://wft-geo-db.p.rapidapi.com/v1/geo/cities?</span><span class="si">${</span><span class="nx">queryString</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</code></pre></div>



**AnÃ¡lise:**

**`buildQueryString()`:**
- Remove valores `null`/`undefined`
- Converte objeto para URLSearchParams
- Garante encoding correto

**Template Literal:**
- InterpolaÃ§Ã£o de variÃ¡veis
- Mais legÃ­vel que concatenaÃ§Ã£o
- Suporta multi-line

#### Linha 64-69: ValidaÃ§Ã£o de API Key


<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RAPIDAPI_KEY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;RAPIDAPI_KEY nÃ£o configurada...&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500</span><span class="p">;</span>
<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise:**

**Fail-Fast:**
- Erro imediato se API key ausente
- Evita requisiÃ§Ã£o desnecessÃ¡ria
- Mensagem clara para debugging

**Error Object Customizado:**
- Adiciona propriedade `status`
- Facilita tratamento no controller
- PadrÃ£o comum em Node.js

#### Linha 71-76: Headers de AutenticaÃ§Ã£o


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;x-rapidapi-host&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;wft-geo-db.p.rapidapi.com&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;x-rapidapi-key&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RAPIDAPI_KEY</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise:**

**RapidAPI Headers:**
- **x-rapidapi-host**: Identifica API especÃ­fica
- **x-rapidapi-key**: Token de autenticaÃ§Ã£o
- Headers customizados (nÃ£o padrÃ£o HTTP)

**SeguranÃ§a:**
- API key nunca exposta ao cliente
- Armazenada em variÃ¡vel de ambiente
- NÃ£o commitada no Git (`.env` no `.gitignore`)

#### Linha 78-133: Tratamento de Erros Detalhado


<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Servidor respondeu com erro</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// RequisiÃ§Ã£o feita mas sem resposta</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Erro na configuraÃ§Ã£o</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise Detalhada:**

**TrÃªs Tipos de Erros Axios:**

1. **`error.response`**: Servidor respondeu
   - Status code de erro (4xx, 5xx)
   - Dados de erro disponÃ­veis
   - Tratamento especÃ­fico por cÃ³digo

2. **`error.request`**: Sem resposta
   - Timeout
   - Rede indisponÃ­vel
   - DNS nÃ£o resolve

3. **Outros**: Erro de configuraÃ§Ã£o
   - URL invÃ¡lida
   - Headers malformados
   - Erro de cÃ³digo

**Tratamento Especial para Rate Limit:**


<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">errorData</span><span class="o">?</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;ACCESS_DENIED&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(...);</span>
<span class="w">  </span><span class="nx">limitError</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">403</span><span class="p">;</span>
<span class="w">  </span><span class="nx">limitError</span><span class="p">.</span><span class="nx">isLimitError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="nx">limitError</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise:**
- **Optional Chaining (`?.`)**: Seguro se `errorData` for `null`
- **Error Customizado**: Adiciona flag `isLimitError`
- **Status 403**: Forbidden (limite excedido)

**Por que tratamento detalhado?**
- Diferentes erros requerem diferentes aÃ§Ãµes
- Rate limit: retry com backoff
- Network error: retry imediato
- Auth error: nÃ£o retry

---

## ğŸ“ Parte B: Frontend - Arquitetura MVC

### B.1 Arquivo: `app/public/js/models/cityModel.js` - Modelo de Estado ImutÃ¡vel

#### Linha 8-13: CriaÃ§Ã£o de Estado Inicial


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">createState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">sort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span>
<span class="w">  </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">  </span><span class="nx">sort</span><span class="o">:</span><span class="w"> </span><span class="nx">sort</span><span class="p">,</span>
<span class="w">  </span><span class="nx">selectedCities</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="p">});</span>
</code></pre></div>



**AnÃ¡lise TeÃ³rica:**

**ProgramaÃ§Ã£o Funcional:**
- FunÃ§Ã£o pura (mesma entrada â†’ mesma saÃ­da)
- Sem efeitos colaterais
- Retorna novo objeto (nÃ£o modifica existente)

**Object Literal Shorthand:**

<div class="codehilite"><pre><span></span><code><span class="c1">// Equivalente a:</span>
<span class="p">{</span>
<span class="w">  </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span>
<span class="w">  </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// Pode ser simplificado para:</span>
<span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span><span class="w"> </span><span class="nx">sort</span><span class="p">,</span><span class="w"> </span><span class="nx">selectedCities</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>



**Default Parameters:**
- Valores padrÃ£o ES6
- Reduz necessidade de validaÃ§Ã£o
- DocumentaÃ§Ã£o implÃ­cita

#### Linha 21-24: AtualizaÃ§Ã£o ImutÃ¡vel de PÃ¡gina


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">setPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span>
<span class="w">  </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">),</span>
<span class="p">});</span>
</code></pre></div>



**AnÃ¡lise:**

**Spread Operator (`...`):**
- Copia todas as propriedades de `state`
- Cria novo objeto (nÃ£o referencia)
- MantÃ©m imutabilidade

**`Math.max(0, page)`:**
- Garante pÃ¡gina nÃ£o negativa
- ValidaÃ§Ã£o inline
- Mais eficiente que `if`

**Complexidade:**
- Tempo: O(1) - operaÃ§Ã£o constante
- EspaÃ§o: O(n) onde n = tamanho do estado

#### Linha 39-53: AdiÃ§Ã£o de Cidade Selecionada


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">addSelectedCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isAlreadySelected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nx">selected</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">selected</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isAlreadySelected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">;</span><span class="w"> </span><span class="c1">// Retorna estado sem alteraÃ§Ãµes</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span>
<span class="w">    </span><span class="nx">selectedCities</span><span class="o">:</span><span class="w"> </span><span class="p">[...</span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">],</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise Detalhada:**

**`Array.some()`:**
- Retorna `true` se algum elemento satisfaz condiÃ§Ã£o
- Para na primeira correspondÃªncia (otimizaÃ§Ã£o)
- Complexidade: O(n) no pior caso

**IdempotÃªncia:**
- Se cidade jÃ¡ existe, retorna estado original
- NÃ£o duplica entradas
- Comportamento previsÃ­vel

**Spread em Arrays:**

<div class="codehilite"><pre><span></span><code><span class="p">[...</span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">]</span>
<span class="c1">// Equivale a:</span>
<span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">city</span><span class="p">])</span>
<span class="c1">// Mas mais legÃ­vel e performÃ¡tico</span>
</code></pre></div>



**Complexidade:**
- Tempo: O(n) onde n = nÃºmero de cidades selecionadas
- EspaÃ§o: O(n) - novo array criado

**Alternativa Otimizada (Set):**

<div class="codehilite"><pre><span></span><code><span class="c1">// Se performance crÃ­tica:</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">selectedIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">selectedCities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">selectedIds</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">;</span>
</code></pre></div>



---

### B.2 Arquivo: `app/public/js/views/cityView.js` - RenderizaÃ§Ã£o DOM

#### Linha 47-126: RenderizaÃ§Ã£o de Lista de Cidades


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">renderCitiesList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">element</span><span class="p">,</span><span class="w"> </span><span class="nx">cities</span><span class="p">,</span><span class="w"> </span><span class="nx">onSelectCity</span><span class="p">,</span><span class="w"> </span><span class="nx">isSelected</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">cities</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">cities</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`&lt;div class=&quot;alert alert-info&quot;&gt;No cities found.&lt;/div&gt;`</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">cities</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cityItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ... construÃ§Ã£o do DOM</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise:**

**`innerHTML = ""`:**
- Limpa conteÃºdo anterior
- Mais rÃ¡pido que `removeChild()` em loop
- **AtenÃ§Ã£o**: Remove event listeners (necessÃ¡rio reanexar)

**Early Return:**
- Retorna imediatamente se sem dados
- Evita processamento desnecessÃ¡rio
- Melhora legibilidade

**`forEach()` vs `map()`:**
- `forEach`: Efeitos colaterais (cria elementos DOM)
- `map`: TransformaÃ§Ã£o funcional (nÃ£o aplicÃ¡vel aqui)
- Escolha correta: `forEach`

**Complexidade:**
- Tempo: O(n) onde n = nÃºmero de cidades
- EspaÃ§o: O(n) - elementos DOM criados

#### Linha 62-125: ConstruÃ§Ã£o de Elementos DOM


<div class="codehilite"><pre><span></span><code><span class="nx">cities</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cityItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">cityItem</span><span class="p">.</span><span class="nx">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;card mb-3 border&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">cityItem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;data-city-id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isSelected</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">isSelected</span><span class="p">(</span><span class="nx">city</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cityItem</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">&quot;border-success&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;bg-light&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">});</span>
</code></pre></div>



**AnÃ¡lise:**

**`document.createElement()`:**
- Cria elemento sem inserir no DOM
- Mais seguro que `innerHTML` (previne XSS)
- Permite configuraÃ§Ã£o antes de inserir

**`setAttribute()`:**
- Adiciona atributo customizado
- `data-*` attributes: padrÃ£o HTML5 para dados
- AcessÃ­vel via `dataset.cityId`

**Conditional Styling:**
- Adiciona classes condicionalmente
- Feedback visual para usuÃ¡rio
- Usa Bootstrap classes

**Event Listeners:**

<div class="codehilite"><pre><span></span><code><span class="nx">selectCityButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">onSelectCity</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>



**AnÃ¡lise:**
- Callback recebe cidade completa
- Closure captura `city` do loop
- **AtenÃ§Ã£o**: Cada listener mantÃ©m referÃªncia

**Memory Leak Prevention:**
- Listeners removidos quando `innerHTML = ""`
- Em SPAs complexas, usar `removeEventListener()`

---

### B.3 Arquivo: `app/public/js/services/kmeansService.js` - Algoritmo K-Means

#### Linha 18-56: NormalizaÃ§Ã£o Min-Max


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">normalizeData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">normalizedPoints</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">ranges</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">latitudes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">latitude</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">longitudes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">populations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">minLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">latitudes</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">latitudes</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// ...</span>
</code></pre></div>



**AnÃ¡lise MatemÃ¡tica:**

**Min-Max Normalization:**

<div class="codehilite"><pre><span></span><code>x_norm = (x - min) / (max - min)
</code></pre></div>



**Propriedades:**
- Range resultante: [0, 1]
- Preserva ordem relativa
- Linear transformation

**`Math.min(...array)`:**
- Spread operator expande array
- Encontra mÃ­nimo em O(n)
- Mais legÃ­vel que loop manual

**Complexidade:**
- Tempo: O(n Ã— d) onde d = dimensÃµes (3)
- EspaÃ§o: O(n) - novo array criado

**Tratamento de Zero Range:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">rangeLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">maxLat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">minLat</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
</code></pre></div>



**AnÃ¡lise:**
- Se `maxLat === minLat`, range = 0
- DivisÃ£o por zero evitada
- Retorna 1 (valor seguro)

#### Linha 48-58: DesnormalizaÃ§Ã£o de Centroides


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">denormalizeCentroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">normalizedCentroids</span><span class="p">,</span><span class="w"> </span><span class="nx">ranges</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ranges</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">normalizedCentroids</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">normalizedCentroids</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">centroid</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">    </span><span class="p">...</span><span class="nx">centroid</span><span class="p">,</span>
<span class="w">    </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">centroid</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">ranges</span><span class="p">.</span><span class="nx">lat</span><span class="p">.</span><span class="nx">range</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ranges</span><span class="p">.</span><span class="nx">lat</span><span class="p">.</span><span class="nx">min</span><span class="p">,</span>
<span class="w">    </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">centroid</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">ranges</span><span class="p">.</span><span class="nx">lon</span><span class="p">.</span><span class="nx">range</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ranges</span><span class="p">.</span><span class="nx">lon</span><span class="p">.</span><span class="nx">min</span><span class="p">,</span>
<span class="w">    </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nx">centroid</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">ranges</span><span class="p">.</span><span class="nx">pop</span><span class="p">.</span><span class="nx">range</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ranges</span><span class="p">.</span><span class="nx">pop</span><span class="p">.</span><span class="nx">min</span><span class="p">,</span>
<span class="w">  </span><span class="p">}));</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise:**

**TransformaÃ§Ã£o Inversa:**

<div class="codehilite"><pre><span></span><code>x_original = x_norm Ã— range + min
</code></pre></div>



**Prova:**

<div class="codehilite"><pre><span></span><code>x_norm = (x_original - min) / range
x_norm Ã— range = x_original - min
x_original = x_norm Ã— range + min âœ“
</code></pre></div>



**`Array.map()`:**
- TransformaÃ§Ã£o funcional
- Retorna novo array
- MantÃ©m imutabilidade

#### Linha 96-108: CÃ¡lculo de DistÃ¢ncia Euclidiana


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">euclideanDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">point1</span><span class="p">,</span><span class="w"> </span><span class="nx">point2</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">latitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">latitude</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">longitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">popDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">point1</span><span class="p">.</span><span class="nx">population</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">point2</span><span class="p">.</span><span class="nx">population</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">latDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">latDiff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">lonDiff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">popDiff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">popDiff</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise MatemÃ¡tica:**

**FÃ³rmula Euclidiana:**

<div class="codehilite"><pre><span></span><code>d = âˆš(Î£(xáµ¢ - yáµ¢)Â²)
</code></pre></div>



**Para 3 dimensÃµes:**

<div class="codehilite"><pre><span></span><code>d = âˆš((latâ‚ - latâ‚‚)Â² + (lonâ‚ - lonâ‚‚)Â² + (popâ‚ - popâ‚‚)Â²)
</code></pre></div>



**Complexidade:**
- Tempo: O(1) - operaÃ§Ã£o constante
- EspaÃ§o: O(1) - apenas variÃ¡veis temporÃ¡rias

**OtimizaÃ§Ã£o:**
- NÃ£o calcula raiz quadrada para comparaÃ§Ã£o
- `dÂ²` suficiente para encontrar mÃ­nimo
- Mas raiz necessÃ¡ria para threshold de convergÃªncia

#### Linha 178-260: Loop Principal do K-Means


<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">kmeans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="nx">maxIterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">onIteration</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// NormalizaÃ§Ã£o</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">normalizedPoints</span><span class="p">,</span><span class="w"> </span><span class="nx">ranges</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalizeData</span><span class="p">(</span><span class="nx">points</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// InicializaÃ§Ã£o</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">centroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">initializeCentroids</span><span class="p">(</span><span class="nx">normalizedPoints</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">iteration</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxIterations</span><span class="p">;</span><span class="w"> </span><span class="nx">iteration</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// AtribuiÃ§Ã£o</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">assignPointsToClusters</span><span class="p">(</span><span class="nx">normalizedPoints</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Agrupamento</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">assignment</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">assignments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clusters</span><span class="p">[</span><span class="nx">assignment</span><span class="p">.</span><span class="nx">centroidIndex</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">assignment</span><span class="p">.</span><span class="nx">pointIndex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// AtualizaÃ§Ã£o</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newCentroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">calculateNewCentroids</span><span class="p">(</span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">normalizedPoints</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ConvergÃªncia</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasConverged</span><span class="p">(</span><span class="nx">centroids</span><span class="p">,</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">clusters</span><span class="p">,</span><span class="w"> </span><span class="nx">centroids</span><span class="o">:</span><span class="w"> </span><span class="nx">denormalizeCentroids</span><span class="p">(</span><span class="nx">newCentroids</span><span class="p">,</span><span class="w"> </span><span class="nx">ranges</span><span class="p">),</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">centroids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newCentroids</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise AlgorÃ­tmica:**

**Estrutura do Loop:**
1. **AtribuiÃ§Ã£o**: O(n Ã— k) - cada ponto verifica k centroides
2. **Agrupamento**: O(n) - organiza Ã­ndices
3. **AtualizaÃ§Ã£o**: O(n) - calcula mÃ©dias
4. **ConvergÃªncia**: O(k) - verifica distÃ¢ncias

**Complexidade por IteraÃ§Ã£o:**
- Tempo: O(n Ã— k Ã— d) onde d = dimensÃµes
- Paralelizado: O((n Ã— k Ã— d) / p) onde p = workers

**ConvergÃªncia:**
- CritÃ©rio: distÃ¢ncia entre centroides < threshold
- MÃ¡ximo: `maxIterations` (evita loop infinito)
- TÃ­pico: 10-50 iteraÃ§Ãµes

---

## ğŸ“ Parte C: Web Workers e MemÃ³ria Compartilhada

### C.1 Arquivo: `app/public/js/util/sharedMemorySerializer.js` - SerializaÃ§Ã£o BinÃ¡ria

#### Linha 18-56: SerializaÃ§Ã£o de Cidade Individual


<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">serializeCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">encoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">encoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">encoded</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Escreve tamanho (4 bytes)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">  </span><span class="nx">view</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// little-endian</span>

<span class="w">  </span><span class="c1">// Escreve dados (N bytes)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">uint8Array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">  </span><span class="nx">uint8Array</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">encoded</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise Detalhada:**

**Length-Prefixed Format:**

<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span><span class="o">:</span><span class="w"> </span><span class="n">tamanho</span><span class="p">][</span><span class="n">N</span><span class="w"> </span><span class="n">bytes</span><span class="o">:</span><span class="w"> </span><span class="n">dados</span><span class="w"> </span><span class="n">JSON</span><span class="p">]</span>
</code></pre></div>



**Vantagens:**
- Permite leitura sequencial eficiente
- NÃ£o requer delimitadores especiais
- Permite pular registros sem ler conteÃºdo

**`JSON.stringify()`:**
- Serializa objeto JavaScript para string
- Formato padrÃ£o, legÃ­vel
- Overhead: ~2-3x tamanho binÃ¡rio

**`TextEncoder`/`TextDecoder`:**
- API moderna para encoding UTF-8
- Mais eficiente que `Buffer` em browsers
- Suporta caracteres Unicode

**`DataView.setUint32()`:**
- Escreve inteiro de 32 bits
- `little-endian`: byte menos significativo primeiro
- PadrÃ£o x86/x64

**Complexidade:**
- Tempo: O(m) onde m = tamanho do JSON
- EspaÃ§o: O(m) - dados escritos no buffer

#### Linha 73-98: DesserializaÃ§Ã£o


<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">deserializeCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">view</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Buffer overflow&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">uint8Array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">encoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uint8Array</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">size</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">decoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextDecoder</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">jsonString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">decoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">encoded</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise:**

**Bounds Checking:**
- Verifica se offset + size nÃ£o excede buffer
- Previne buffer overflow
- SeguranÃ§a crÃ­tica

**`slice()`:**
- Cria novo array com subconjunto
- NÃ£o modifica buffer original
- Eficiente (copia referÃªncia, nÃ£o dados)

**Error Handling:**
- `throw Error`: Propaga erro para caller
- Mensagem clara para debugging
- Em produÃ§Ã£o, logar e continuar

---

### C.2 Arquivo: `app/public/js/workers/dataCollectionWorker.js` - Worker de Coleta

#### Linha 134-180: Escrita AtÃ´mica no Buffer Compartilhado


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">writeCityToSharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">,</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">serialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">serializeCity</span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">ArrayBuffer</span><span class="p">(</span><span class="mf">10000</span><span class="p">));</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">citySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">serialized</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Tamanho calculado</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">citySize</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Buffer cheio</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span>
<span class="w">      </span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="nx">expectedIndex</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="nx">newIndex</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Sucesso: espaÃ§o reservado</span>
<span class="w">      </span><span class="nx">serializeCity</span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Falhou: outro worker escreveu primeiro, tenta novamente</span>
<span class="w">    </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">actualIndex</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise Detalhada:**

**Compare-and-Swap (CAS):**

<div class="codehilite"><pre><span></span><code><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">newValue</span><span class="p">)</span>
<span class="c1">// Retorna valor anterior</span>
<span class="c1">// Se valor anterior == expected: troca para newValue</span>
<span class="c1">// SenÃ£o: nÃ£o troca, retorna valor atual</span>
</code></pre></div>



**Algoritmo Lock-Free:**
- NÃ£o usa locks (mutex, semÃ¡foro)
- Loop atÃ© sucesso (retry)
- Evita deadlocks

**Complexidade:**
- Tempo: O(1) amortizado (geralmente 1 tentativa)
- Pior caso: O(k) onde k = nÃºmero de workers competindo
- EspaÃ§o: O(1) - apenas variÃ¡veis locais

**Por que Lock-Free?**
- Locks podem causar contenÃ§Ã£o
- Deadlocks possÃ­veis
- Lock-free: melhor escalabilidade

**Trade-offs:**
- âœ… Sem deadlocks
- âœ… Melhor performance em baixa contenÃ§Ã£o
- âŒ PossÃ­vel starvation (teÃ³rico)
- âŒ Mais complexo de entender

---

## ğŸ“š CapÃ­tulo 26: AnÃ¡lise de Design Patterns e DecisÃµes Arquiteturais

### 26.1 PadrÃµes Identificados no CÃ³digo

**1. MVC (Model-View-Controller)**
- **Model**: `cityModel.js` - Estado imutÃ¡vel
- **View**: `cityView.js`, `clusterView.js` - RenderizaÃ§Ã£o DOM
- **Controller**: `cityController.js` - OrquestraÃ§Ã£o

**2. Factory Pattern**
- `createState()` - Cria objetos de estado
- `new Worker()` - Cria workers

**3. Strategy Pattern**
- NormalizaÃ§Ã£o: Min-Max (poderia ser Z-score)
- Coleta: SharedArrayBuffer vs postMessage

**4. Observer Pattern (Implicit)**
- Model muda â†’ View atualiza
- Callbacks em eventos

**5. Singleton Pattern**
- `app` (Express) - Ãºnica instÃ¢ncia
- `state` - estado global da aplicaÃ§Ã£o

### 26.2 DecisÃµes Arquiteturais CrÃ­ticas

**1. Por que Imutabilidade?**
- Facilita debugging (histÃ³rico de estados)
- Thread-safety (sem locks necessÃ¡rios)
- Previsibilidade (mesma entrada â†’ mesma saÃ­da)

**2. Por que Web Workers?**
- NÃ£o bloqueia UI thread
- Aproveita mÃºltiplos cores
- Isolamento de erros

**3. Por que SharedArrayBuffer?**
- Performance: sem serializaÃ§Ã£o
- EficiÃªncia: sem cÃ³pia de dados
- Escalabilidade: suporta grandes datasets

**4. Por que NormalizaÃ§Ã£o Min-Max?**
- Simples de implementar
- Range conhecido [0, 1]
- Preserva ordem relativa

---

**Este guia foi desenvolvido com rigor acadÃªmico para servir como material de referÃªncia completo e fundamentado teoricamente.**

---

## ğŸ“š CapÃ­tulo 27: AnÃ¡lise Detalhada dos Arquivos CrÃ­ticos Restantes

### 27.1 Arquivo: `app/public/js/controllers/cityController.js` - OrquestraÃ§Ã£o Completa

Este arquivo implementa o **Controller** do padrÃ£o MVC, coordenando todas as interaÃ§Ãµes entre Model, View e Services.

#### Linha 1-21: Imports e DependÃªncias


<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">createState</span><span class="p">,</span><span class="w"> </span><span class="nx">getOffset</span><span class="p">,</span><span class="w"> </span><span class="nx">setPage</span><span class="p">,</span><span class="w"> </span><span class="nx">addSelectedCity</span><span class="p">,</span>
<span class="w">  </span><span class="nx">removeSelectedCity</span><span class="p">,</span><span class="w"> </span><span class="nx">clearSelectedCities</span><span class="p">,</span><span class="w"> </span><span class="nx">isCitySelected</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../models/cityModel.js&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">clearErrorCityList</span><span class="p">,</span><span class="w"> </span><span class="nx">renderCitiesList</span><span class="p">,</span><span class="w"> </span><span class="nx">renderCurrentPage</span><span class="p">,</span>
<span class="w">  </span><span class="nx">showErrorCityList</span><span class="p">,</span><span class="w"> </span><span class="nx">showLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">renderSelectedCitiesList</span><span class="p">,</span>
<span class="w">  </span><span class="nx">updateSelectedCount</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../views/cityView.js&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">collectCitiesParallel</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../services/dataCollectionService.js&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">kmeans</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../services/kmeansService.js&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">renderClusters</span><span class="p">,</span><span class="w"> </span><span class="nx">showClusteringProgress</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;../views/clusterView.js&quot;</span><span class="p">;</span>
</code></pre></div>



**AnÃ¡lise Arquitetural:**

**Separation of Concerns:**
- **Model**: LÃ³gica de estado (importado de `cityModel.js`)
- **View**: RenderizaÃ§Ã£o DOM (importado de `cityView.js`)
- **Services**: LÃ³gica de negÃ³cio (importado de `services/`)

**ES6 Modules:**
- `import/export` em vez de `require/module.exports`
- Suportado nativamente em navegadores modernos
- Type-safe (melhor para IDEs)

**Dependency Graph:**

<div class="codehilite"><pre><span></span><code>cityController.js
â”œâ”€â”€ cityModel.js (estado)
â”œâ”€â”€ cityView.js (renderizaÃ§Ã£o)
â”œâ”€â”€ dataCollectionService.js (coleta)
â”œâ”€â”€ kmeansService.js (clustering)
â””â”€â”€ clusterView.js (visualizaÃ§Ã£o clusters)
</code></pre></div>



#### Linha 23-69: SeleÃ§Ã£o de Elementos DOM


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">citiesList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;cities-list&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">selectedCitiesList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;selected-cities-list&quot;</span><span class="p">);</span>
<span class="c1">// ... mais elementos</span>
</code></pre></div>



**AnÃ¡lise:**

**`document.getElementById()`:**
- Retorna `HTMLElement` ou `null`
- O(1) lookup por ID (hash table interno)
- Mais rÃ¡pido que `querySelector()`

**VerificaÃ§Ã£o de SeguranÃ§a (Linha 35-38):**

<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">citiesList</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">selectedCitiesList</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">selectedCitiesList</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Elementos DOM crÃ­ticos nÃ£o encontrados...&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise:**
- **Fail-Fast**: Erro imediato se elementos ausentes
- Previne `null reference` errors
- Facilita debugging

**Por que verificar?**
- HTML pode nÃ£o ter carregado completamente
- Erros de digitaÃ§Ã£o em IDs
- Melhor UX: erro claro vs crash silencioso

#### Linha 40-52: Estado da AplicaÃ§Ã£o


<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createState</span><span class="p">();</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">lastRenderedCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">collectedCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">isCollecting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">isClustering</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</code></pre></div>



**AnÃ¡lise:**

**Estado Global:**
- `state`: Estado imutÃ¡vel da aplicaÃ§Ã£o (paginaÃ§Ã£o, seleÃ§Ãµes)
- `isLoading`: Mutex lÃ³gico (previne requisiÃ§Ãµes simultÃ¢neas)
- `lastRenderedCities`: Cache para atualizaÃ§Ã£o apÃ³s seleÃ§Ã£o
- `collectedCities`: Dados coletados para clustering
- Flags booleanas: Controle de fluxo assÃ­ncrono

**Por que variÃ¡veis separadas?**
- `state`: ImutÃ¡vel (programaÃ§Ã£o funcional)
- Flags: MutÃ¡veis (necessÃ¡rio para controle de fluxo)
- Trade-off: Alguma mutabilidade necessÃ¡ria para coordenaÃ§Ã£o

#### Linha 75-100: CÃ¡lculo de Estimativa de Tempo


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">updateTimeEstimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">citiesInput</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">5000</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">delayPerPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.5</span><span class="p">;</span><span class="w"> </span><span class="c1">// segundos</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalPages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">totalPages</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">delayPerPage</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalMinutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">totalSeconds</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise MatemÃ¡tica:**

**CÃ¡lculo:**

<div class="codehilite"><pre><span></span><code>totalPages = âŒˆtargetCities / limitPerPageâŒ‰
totalSeconds = totalPages Ã— delayPerPage
totalMinutes = âŒˆtotalSeconds / 60âŒ‰
</code></pre></div>



**`Math.ceil()`:**
- Arredonda para cima
- Garante tempo suficiente (conservador)
- Melhor UX: subestimar Ã© pior que superestimar

**FormataÃ§Ã£o de Tempo:**

<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">totalMinutes</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">60</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">timeString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`~</span><span class="si">${</span><span class="nx">totalMinutes</span><span class="si">}</span><span class="sb"> min`</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">totalMinutes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">totalMinutes</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>
<span class="w">  </span><span class="nx">timeString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">minutes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`~</span><span class="si">${</span><span class="nx">hours</span><span class="si">}</span><span class="sb">h </span><span class="si">${</span><span class="nx">minutes</span><span class="si">}</span><span class="sb">min`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`~</span><span class="si">${</span><span class="nx">hours</span><span class="si">}</span><span class="sb">h`</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



**AnÃ¡lise:**
- FormataÃ§Ã£o human-readable
- Usa `Math.floor()` e `%` para extrair horas/minutos
- Condicional para evitar "0 min" desnecessÃ¡rio

#### Linha 102-180: ManipulaÃ§Ã£o de PaginaÃ§Ã£o


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">handlePagination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">direction</span><span class="p">,</span><span class="w"> </span><span class="nx">elements</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isLoading</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="c1">// Mutex</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">direction</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;next&quot;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setPage</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">newPage</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getOffset</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/cities?offset=</span><span class="si">${</span><span class="nx">offset</span><span class="si">}</span><span class="sb">&amp;limit=</span><span class="si">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">limit</span><span class="si">}</span><span class="sb">&amp;sort=</span><span class="si">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">sort</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Renderiza resultados</span>
<span class="w">    </span><span class="nx">renderCitiesList</span><span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">citiesList</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">handleSelectCity</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">isCitySelected</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">showErrorCityList</span><span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">errorBox</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise Detalhada:**

**Mutex Pattern:**

<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isLoading</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="c1">// Early return</span>
<span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// OperaÃ§Ã£o assÃ­ncrona</span>
<span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Sempre libera lock</span>
<span class="p">}</span>
</code></pre></div>



**Por que Mutex?**
- Previne requisiÃ§Ãµes simultÃ¢neas
- Evita race conditions
- Garante ordem de execuÃ§Ã£o

**Fluxo AssÃ­ncrono:**
1. Verifica lock
2. Adquire lock
3. Atualiza estado (imutÃ¡vel)
4. Faz requisiÃ§Ã£o HTTP
5. Renderiza resultados
6. Libera lock (finally)

**Error Handling:**
- `try/catch`: Captura erros de rede/parsing
- `finally`: Garante lock sempre liberado
- UX: Mostra erro ao usuÃ¡rio

#### Linha 391-510: Coleta Paralela de Dados


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">handleStartCollection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isCollecting</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">collectedCities</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">citiesInput</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">5000</span><span class="p">;</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isCollecting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">startCollectionButton</span><span class="p">.</span><span class="nx">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">collectCitiesParallel</span><span class="p">(</span>
<span class="w">      </span><span class="nx">targetCities</span><span class="p">,</span>
<span class="w">      </span><span class="mf">10</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="nx">progress</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Atualiza UI com progresso</span>
<span class="w">        </span><span class="nx">progressBar</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">progress</span><span class="si">}</span><span class="sb">%`</span><span class="p">;</span>
<span class="w">        </span><span class="nx">progressText</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">progress</span><span class="si">}</span><span class="sb">%`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">collectedCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cities</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Inicia K-Means automaticamente</span>
<span class="w">    </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">handleStartClustering</span><span class="p">();</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Tratamento de erro</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isCollecting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise:**

**Callback de Progresso:**
- Atualiza UI durante coleta
- Feedback visual para usuÃ¡rio
- NÃ£o bloqueia operaÃ§Ã£o principal

**InÃ­cio AutomÃ¡tico do K-Means:**

<div class="codehilite"><pre><span></span><code><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">handleStartClustering</span><span class="p">();</span>
<span class="p">},</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
</code></pre></div>



**Por que setTimeout?**
- Permite UI atualizar antes de iniciar clustering
- Evita bloqueio visual
- Delay mÃ­nimo (500ms) suficiente

**Complexidade:**
- Tempo: O(n/p) onde n = pÃ¡ginas, p = workers
- EspaÃ§o: O(n) - array de cidades coletadas

---

### 27.2 Arquivo: `app/public/js/services/dataCollectionService.js` - Coleta Paralela

#### Linha 32-71: Setup de MemÃ³ria Compartilhada


<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">collectCitiesParallel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">onProgress</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">useSharedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isSharedArrayBufferAvailable</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">useSharedMemory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">collectCitiesParallelFallback</span><span class="p">(...);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalPages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">limitPerPage</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// Ajustado para plano BASIC</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span><span class="w"> </span><span class="c1">// 2 Uint32</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">estimatedDataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">estimateBufferSize</span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">estimatedDataSize</span><span class="p">;</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">;</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="p">(</span><span class="nx">totalBufferSize</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">collectCitiesParallelFallback</span><span class="p">(...);</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>



**AnÃ¡lise Detalhada:**

**Feature Detection:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">isSharedArrayBufferAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>



**Por que Feature Detection?**
- Nem todos navegadores suportam
- Fallback automÃ¡tico se nÃ£o disponÃ­vel
- Graceful degradation

**CÃ¡lculo de Tamanho do Buffer:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">estimatedDataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">estimateBufferSize</span><span class="p">(</span><span class="nx">targetCities</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">);</span>
</code></pre></div>



**Por que 1.5x?**
- Margem de seguranÃ§a (50%)
- Compensa variaÃ§Ã£o no tamanho das cidades
- Evita realocaÃ§Ãµes (caras)

**Error Handling:**
- `try/catch` ao criar buffer
- Fallback automÃ¡tico se falhar
- NÃ£o expÃµe erro ao usuÃ¡rio

#### Linha 73-76: InicializaÃ§Ã£o de Atomics


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">atomicView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="nb">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">);</span><span class="w"> </span><span class="c1">// writeIndex</span>
<span class="nb">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// completedWorkers</span>
</code></pre></div>



**AnÃ¡lise:**

**`Int32Array`:**
- View tipada do buffer
- 32 bits por elemento
- 2 elementos: writeIndex + completedWorkers

**`Atomics.store()`:**
- OperaÃ§Ã£o atÃ´mica de escrita
- Garante visibilidade imediata
- Thread-safe

**InicializaÃ§Ã£o:**
- `writeIndex = headerSize`: ComeÃ§a apÃ³s header
- `completedWorkers = 0`: Nenhum worker completo ainda

#### Linha 119-200: Gerenciamento de Workers


<div class="codehilite"><pre><span></span><code><span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;progress&quot;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// Atualiza progresso</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">estimatedCollected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">onProgress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">onProgress</span><span class="p">(</span><span class="nx">progressPercent</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">citiesCollected</span><span class="o">:</span><span class="w"> </span><span class="nx">estimatedCollected</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;complete&quot;</span><span class="o">:</span>
<span class="w">      </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Incrementa completedWorkers</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise:**

**Message Types:**
- `progress`: AtualizaÃ§Ã£o de progresso
- `complete`: Worker terminou
- `error`: Erro no worker

**`Atomics.load()`:**
- LÃª valor atomicamente
- Garante leitura consistente
- Thread-safe

**`Atomics.add()`:**
- Incrementa atomicamente
- Equivalente a `value += 1` mas thread-safe
- Retorna valor anterior

**Progress Calculation:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">progressPercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">currentPage</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">totalPages</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>
</code></pre></div>



**AnÃ¡lise:**
- Normaliza para 0-100%
- `Math.min()` garante nÃ£o exceder 100%
- AtualizaÃ§Ã£o em tempo real

---

### 27.3 Arquivo: `app/public/js/workers/dataCollectionWorker.js` - Worker de Coleta

#### Linha 27-100: FunÃ§Ã£o de Fetch com Retry


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">fetchPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">retryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxRetries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/cities?</span><span class="si">${</span><span class="nx">queryString</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">429</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Rate limit - backoff exponencial</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">waitTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">15000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span>
<span class="w">          </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">waitTime</span><span class="p">));</span>
<span class="w">          </span><span class="nx">retryCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">retryCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">maxRetries</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise Detalhada:**

**Retry Logic:**
- MÃ¡ximo 3 tentativas
- Backoff exponencial para rate limit
- Retry imediato para outros erros

**Rate Limit Handling:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">waitTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">15000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span>
<span class="c1">// Retry 1: 15s</span>
<span class="c1">// Retry 2: 30s</span>
<span class="c1">// Retry 3: 45s</span>
<span class="c1">// MÃ¡ximo: 60s</span>
</code></pre></div>



**Por que Backoff Exponencial?**
- Reduz carga no servidor
- Permite sistema se recuperar
- Evita "thundering herd"

**`Math.min()`:**
- Limita tempo mÃ¡ximo de espera
- Previne esperas muito longas
- Melhora UX

#### Linha 134-180: Escrita AtÃ´mica no Buffer


<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">writeCityToSharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="p">,</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">citySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calculateCitySize</span><span class="p">(</span><span class="nx">city</span><span class="p">);</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">citySize</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Buffer cheio</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">compareExchange</span><span class="p">(</span>
<span class="w">      </span><span class="nx">atomicView</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">newIndex</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actualIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Sucesso: espaÃ§o reservado</span>
<span class="w">      </span><span class="nx">serializeCity</span><span class="p">(</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">writeIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Falhou: tenta novamente</span>
<span class="w">    </span><span class="nx">writeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">actualIndex</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



**AnÃ¡lise AlgorÃ­tmica:**

**Lock-Free Algorithm:**
- Loop atÃ© sucesso
- CAS garante atomicidade
- Sem deadlocks possÃ­veis

**Bounds Checking:**

<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Buffer cheio</span>
<span class="p">}</span>
</code></pre></div>



**Por que verificar?**
- Previne buffer overflow
- SeguranÃ§a crÃ­tica
- Retorna `false` para indicar falha

**CAS Loop:**

<div class="codehilite"><pre><span></span><code><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">CAS</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">actual</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expected</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// Sucesso</span>
<span class="w">  </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">actual</span><span class="p">;</span><span class="w"> </span><span class="c1">// Atualiza e tenta novamente</span>
<span class="p">}</span>
</code></pre></div>



**Complexidade:**
- Melhor caso: O(1) - primeira tentativa
- Pior caso: O(k) onde k = workers competindo
- Amortizado: O(1) para baixa contenÃ§Ã£o

---

### 27.4 Arquivo: `app/views/index.ejs` - Template HTML

#### Linha 1-26: Estrutura HTML Base


<div class="codehilite"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;pt-BR&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;h-100&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="p">/&gt;</span>
  <span class="cm">&lt;!-- Bootstrap CSS --&gt;</span>
  <span class="cm">&lt;!-- Bootstrap Icons --&gt;</span>
  <span class="cm">&lt;!-- Custom CSS --&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;d-flex flex-column align-items-center py-4 bg-light h-100&quot;</span><span class="p">&gt;</span>
</code></pre></div>



**AnÃ¡lise:**

**HTML5 Semantic:**
- `<!DOCTYPE html>`: Modo padrÃ£o HTML5
- `lang="pt-BR"`: Acessibilidade (leitores de tela)
- Meta tags: Viewport para responsividade

**Bootstrap Classes:**
- `d-flex`: Flexbox layout
- `flex-column`: Coluna vertical
- `h-100`: Altura 100%
- Utility-first CSS

#### Linha 37-40: Status de MemÃ³ria Compartilhada


<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;shared-memory-status&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;alert alert-secondary&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;bi bi-memory&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span> 
  <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;memory-status-text&quot;</span><span class="p">&gt;</span>Verificando...<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>



**AnÃ¡lise:**

**Dynamic Status:**
- Atualizado via JavaScript
- Feedback visual para usuÃ¡rio
- Indica capacidade do navegador

**Bootstrap Icons:**
- `bi-memory`: Ãcone de memÃ³ria
- Biblioteca de Ã­cones SVG
- Leve e escalÃ¡vel

---

## ğŸ“š CapÃ­tulo 28: AnÃ¡lise de Performance e OtimizaÃ§Ãµes Aplicadas

### 28.1 OtimizaÃ§Ãµes de RenderizaÃ§Ã£o

**1. Virtual Scrolling (NÃ£o Implementado, Mas PossÃ­vel):**

<div class="codehilite"><pre><span></span><code><span class="c1">// Renderiza apenas elementos visÃ­veis</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">visibleItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">startIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">endIndex</span><span class="p">);</span>
</code></pre></div>



**2. Debouncing de Eventos:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">debounce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">func</span><span class="p">,</span><span class="w"> </span><span class="nx">wait</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">timeout</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>
<span class="w">    </span><span class="nx">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">func</span><span class="p">(...</span><span class="nx">args</span><span class="p">),</span><span class="w"> </span><span class="nx">wait</span><span class="p">);</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>



**3. MemoizaÃ§Ã£o de CÃ¡lculos:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">memoize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fn</span><span class="p">(...</span><span class="nx">args</span><span class="p">);</span>
<span class="w">    </span><span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>



### 28.2 OtimizaÃ§Ãµes de MemÃ³ria

**1. Limpeza de Workers:**

<div class="codehilite"><pre><span></span><code><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span><span class="w"> </span><span class="c1">// Libera recursos</span>
</code></pre></div>



**2. Limpeza de Event Listeners:**

<div class="codehilite"><pre><span></span><code><span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">handler</span><span class="p">);</span>
</code></pre></div>



**3. WeakMap para Cache:**

<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">WeakMap</span><span class="p">();</span><span class="w"> </span><span class="c1">// GC automÃ¡tico</span>
</code></pre></div>



---

## ğŸ“š CapÃ­tulo 29: AnÃ¡lise de SeguranÃ§a Aplicada

### 29.1 PrevenÃ§Ã£o de XSS

**SanitizaÃ§Ã£o de Input:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âŒ Perigoso</span>
<span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userInput</span><span class="p">;</span>

<span class="c1">// âœ… Seguro</span>
<span class="nx">element</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userInput</span><span class="p">;</span>
</code></pre></div>



**Content Security Policy (CSP):**

<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Security-Policy&quot;</span> 
      <span class="na">content</span><span class="o">=</span><span class="s">&quot;default-src &#39;self&#39;; script-src &#39;self&#39; &#39;unsafe-inline&#39;;&quot;</span><span class="p">&gt;</span>
</code></pre></div>



### 29.2 ValidaÃ§Ã£o de Dados

**ValidaÃ§Ã£o no Cliente:**
- Feedback imediato
- NÃ£o confiÃ¡vel (pode ser contornada)

**ValidaÃ§Ã£o no Servidor:**
- Ãšnica fonte de verdade
- Sempre executada
- CrÃ­tica para seguranÃ§a

---

---

## ğŸ—ï¸ CapÃ­tulo 30: Arquitetura Moderna JavaScript/Node.js - Guia do Arquiteto de Software

> **ğŸ“š Diretriz de Conhecimento:**  
> Esta seÃ§Ã£o segue estritamente a documentaÃ§Ã£o oficial:
> - **[MDN Web Docs](https://developer.mozilla.org/)** para padrÃµes ECMAScript
> - **[Node.js LTS Documentation](https://nodejs.org/docs/latest/api/)** para APIs de sistema
> - Prioriza recursos modernos e performance conforme especificaÃ§Ãµes oficiais

### 30.1 Recursos Modernos ECMAScript: Substituindo PadrÃµes Obsoletos

#### Optional Chaining (`?.`) - Acesso Seguro a Propriedades

**Problema com CÃ³digo Antigo:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âŒ PadrÃ£o obsoleto - verificaÃ§Ã£o manual</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cityName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">errorMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Erro desconhecido&#39;</span><span class="p">;</span>
</code></pre></div>



**SoluÃ§Ã£o Moderna com Optional Chaining:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âœ… PadrÃ£o moderno ES2020 - Optional Chaining</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cityName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">city</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">errorMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;Erro desconhecido&#39;</span><span class="p">;</span>
</code></pre></div>



> **ğŸ“š ReferÃªncia MDN:**  
> [Optional Chaining (`?.`) - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Optional_chaining)  
> **Compatibilidade:** Node.js 14.0.0+, Chrome 80+, Firefox 74+, Safari 13.1+

**AplicaÃ§Ã£o no Projeto:**

**Antes (cÃ³digo atual):**

<div class="codehilite"><pre><span></span><code><span class="c1">// app/public/js/workers/dataCollectionWorker.js linha 72</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">errorData</span><span class="p">.</span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">errorData</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Limite excedido&#39;</span><span class="p">;</span>
</code></pre></div>



**Depois (otimizado):**

<div class="codehilite"><pre><span></span><code><span class="c1">// Usando Nullish Coalescing para valores padrÃ£o mais precisos</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">errorData</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">errorData</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;Limite excedido&#39;</span><span class="p">;</span>
</code></pre></div>



**Vantagens:**
- âœ… CÃ³digo mais limpo e legÃ­vel
- âœ… Evita erros de `Cannot read property of undefined`
- âœ… CompatÃ­vel com Node.js 14+ (LTS)

#### Nullish Coalescing (`??`) - Valores PadrÃ£o Inteligentes

**Problema com Operador `||`:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âŒ Problema: 0, &#39;&#39;, false sÃ£o valores vÃ¡lidos mas sÃ£o substituÃ­dos</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userLimit</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span><span class="w"> </span><span class="c1">// Se userLimit = 0, usa 10 (ERRADO!)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Guest&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Se userName = &#39;&#39;, usa &#39;Guest&#39; (ERRADO!)</span>
</code></pre></div>



**SoluÃ§Ã£o com Nullish Coalescing:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âœ… SÃ³ substitui se null ou undefined</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userLimit</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span><span class="w"> </span><span class="c1">// Se userLimit = 0, mantÃ©m 0 (CORRETO!)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;Guest&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Se userName = &#39;&#39;, mantÃ©m &#39;&#39; (CORRETO!)</span>
</code></pre></div>



> **ğŸ“š ReferÃªncia MDN:**  
> [Nullish Coalescing (`??`) - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Nullish_coalescing)  
> **Compatibilidade:** Node.js 14.0.0+, Chrome 80+, Firefox 72+, Safari 13.1+

**AplicaÃ§Ã£o no Projeto:**

**Antes:**

<div class="codehilite"><pre><span></span><code><span class="c1">// app/public/js/services/dataCollectionService.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">receivedHeaderSize</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">receivedTotalBufferSize</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>
</code></pre></div>



**Depois:**

<div class="codehilite"><pre><span></span><code><span class="c1">// Usa ?? para preservar 0 como valor vÃ¡lido</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">headerSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">receivedHeaderSize</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">totalBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">receivedTotalBufferSize</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>
</code></pre></div>



#### Campos Privados (`#`) - Encapsulamento Real

**Problema com ConvenÃ§Ãµes:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âŒ ConvenÃ§Ã£o (nÃ£o Ã© realmente privado)</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">CityService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_KEY</span><span class="p">;</span><span class="w"> </span><span class="c1">// ConvenÃ§Ã£o: _ significa privado (mas nÃ£o Ã©!)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Qualquer cÃ³digo externo pode acessar this._apiKey</span>
<span class="p">}</span>
</code></pre></div>



**SoluÃ§Ã£o com Campos Privados:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âœ… Campos privados reais (ES2022)</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">CityService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">#apiKey</span><span class="p">;</span><span class="w"> </span><span class="c1">// Realmente privado - nÃ£o acessÃ­vel externamente</span>
<span class="w">  </span><span class="n">#cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span><span class="w"> </span><span class="c1">// Cache privado</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="n">#apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_KEY</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">fetchCity</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Acesso interno Ã© permitido</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cached</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">#cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cached</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">cached</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/cities/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="n">#apiKey</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Tentativa de acesso externo falha:</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CityService</span><span class="p">();</span>
<span class="nx">service</span><span class="p">.</span><span class="n">#apiKey</span><span class="p">;</span><span class="w"> </span><span class="c1">// âŒ SyntaxError: Private field &#39;#apiKey&#39; must be declared in an enclosing class</span>
</code></pre></div>



> **ğŸ“š ReferÃªncia MDN:**  
> [Private Class Fields - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes/Private_class_fields)  
> **Compatibilidade:** Node.js 12.0.0+, Chrome 74+, Firefox 90+, Safari 14.1+

**AplicaÃ§Ã£o no Projeto - RefatoraÃ§Ã£o Sugerida:**


<div class="codehilite"><pre><span></span><code><span class="c1">// app/services/cityService.js - VersÃ£o Moderna</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">CityService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">#rapidApiKey</span><span class="p">;</span>
<span class="w">  </span><span class="n">#baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;https://wft-geo-db.p.rapidapi.com&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="n">#cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="w">  </span><span class="n">#requestQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="n">#rapidApiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RAPIDAPI_KEY</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="n">#rapidApiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;RAPIDAPI_KEY nÃ£o configurada&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="n">#makeRequest</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// MÃ©todo privado - nÃ£o acessÃ­vel externamente</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="n">#baseUrl</span><span class="si">}${</span><span class="nx">endpoint</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cacheKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">?</span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nx">URLSearchParams</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">params</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="si">}</span><span class="sb">)}`</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">#cache</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">#cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">options</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;X-RapidAPI-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">#rapidApiKey</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;X-RapidAPI-Host&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;wft-geo-db.p.rapidapi.com&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">...</span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`HTTP </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="n">#cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getCities</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">#makeRequest</span><span class="p">(</span><span class="s1">&#39;/v1/geo/cities&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CityService</span><span class="p">();</span>
</code></pre></div>



### 30.2 Performance: Worker Threads do Node.js vs Web Workers

#### DiferenÃ§a Fundamental

**Web Workers (Browser):**
- Executam em contexto isolado do DOM
- ComunicaÃ§Ã£o via `postMessage()` ou `SharedArrayBuffer`
- Limitados ao ambiente do navegador

**Worker Threads (Node.js):**
- Executam em threads separadas do processo Node.js
- Acesso completo Ã s APIs do Node.js (fs, http, etc.)
- Melhor para tarefas CPU-intensive no servidor

> **ğŸ“š ReferÃªncia Node.js:**  
> [Worker Threads - Node.js Documentation](https://nodejs.org/docs/latest/api/worker_threads.html)  
> **Compatibilidade:** Node.js 12.17.0+ (LTS), 10.5.0+ (experimental)

#### ImplementaÃ§Ã£o Moderna: Worker Threads para Processamento no Servidor

**CenÃ¡rio:** Processar grandes volumes de dados no backend antes de enviar ao cliente.


<div class="codehilite"><pre><span></span><code><span class="c1">// app/services/dataProcessor.js - Usando Worker Threads do Node.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Worker</span><span class="p">,</span><span class="w"> </span><span class="nx">isMainThread</span><span class="p">,</span><span class="w"> </span><span class="nx">parentPort</span><span class="p">,</span><span class="w"> </span><span class="nx">workerData</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;worker_threads&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fileURLToPath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;url&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">join</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">__filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fileURLToPath</span><span class="p">(</span><span class="k">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">__dirname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dirname</span><span class="p">(</span><span class="nx">__filename</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Processa dados em paralelo usando Worker Threads do Node.js</span>
<span class="cm"> * @param {Array} data - Array de dados para processar</span>
<span class="cm"> * @param {number} numWorkers - NÃºmero de workers (padrÃ£o: CPU cores)</span>
<span class="cm"> * @returns {Promise&lt;Array&gt;} Dados processados</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">processDataParallel</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isMainThread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Thread principal - coordena workers</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">os</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workerCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">cpus</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunkSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">workerCount</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">promises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">workerCount</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">chunkSize</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="p">);</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="nx">__filename</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">workerData</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chunk</span><span class="p">,</span><span class="w"> </span><span class="nx">workerId</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">promise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">worker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">resolve</span><span class="p">);</span>
<span class="w">        </span><span class="nx">worker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">);</span>
<span class="w">        </span><span class="nx">worker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb"> parou com cÃ³digo </span><span class="si">${</span><span class="nx">code</span><span class="si">}</span><span class="sb">`</span><span class="p">));</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">workers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">worker</span><span class="p">);</span>
<span class="w">      </span><span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">promise</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Limpeza</span>
<span class="w">    </span><span class="nx">workers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">worker</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// Combina resultados</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">flat</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Worker thread - processa chunk</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chunk</span><span class="p">,</span><span class="w"> </span><span class="nx">workerId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">workerData</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Processamento CPU-intensive aqui</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">processed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunk</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Exemplo: normalizaÃ§Ã£o, validaÃ§Ã£o, transformaÃ§Ã£o</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">item</span><span class="p">,</span>
<span class="w">        </span><span class="nx">normalized</span><span class="o">:</span><span class="w"> </span><span class="nx">normalizeData</span><span class="p">(</span><span class="nx">item</span><span class="p">),</span>
<span class="w">        </span><span class="nx">validated</span><span class="o">:</span><span class="w"> </span><span class="nx">validateData</span><span class="p">(</span><span class="nx">item</span><span class="p">),</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">parentPort</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">processed</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">normalizeData</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// LÃ³gica de normalizaÃ§Ã£o</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">item</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">validateData</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// LÃ³gica de validaÃ§Ã£o</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



**Uso no Controller:**


<div class="codehilite"><pre><span></span><code><span class="c1">// app/controllers/cityApiController.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">processDataParallel</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../services/dataProcessor.js&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">getCities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rawData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">cityService</span><span class="p">.</span><span class="nx">getCities</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Processa em paralelo usando Worker Threads</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">processedData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">processDataParallel</span><span class="p">(</span><span class="nx">rawData</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>

<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">processedData</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="nx">processedData</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processed</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>



> **ğŸ“š ReferÃªncias Node.js:**
> - [Worker Threads - Overview](https://nodejs.org/docs/latest/api/worker_threads.html)
> - [Worker.postMessage()](https://nodejs.org/docs/latest/api/worker_threads.html#workerpostmessagevalue-transferlist)
> - [SharedArrayBuffer com Worker Threads](https://nodejs.org/docs/latest/api/worker_threads.html#sharedarraybuffer-and-transferable-objects)

### 30.3 SincronizaÃ§Ã£o com Atomics no Node.js

**Worker Threads + SharedArrayBuffer + Atomics:**


<div class="codehilite"><pre><span></span><code><span class="c1">// app/services/parallelProcessor.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Worker</span><span class="p">,</span><span class="w"> </span><span class="nx">isMainThread</span><span class="p">,</span><span class="w"> </span><span class="nx">parentPort</span><span class="p">,</span><span class="w"> </span><span class="nx">workerData</span><span class="p">,</span><span class="w"> </span><span class="nx">SHARE_ENVS</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;worker_threads&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;globalThis&#39;</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isMainThread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Thread principal</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">bufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1MB</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SharedArrayBuffer</span><span class="p">(</span><span class="nx">bufferSize</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Inicializa contador atÃ´mico</span>
<span class="w">  </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Worker</span><span class="p">(</span><span class="nx">__filename</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">workerData</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">workerId</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="nx">SHARE_ENVS</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">worker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb"> processou </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">count</span><span class="si">}</span><span class="sb"> itens`</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">workers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">worker</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Aguarda todos terminarem</span>
<span class="w">  </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">workers</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">resolve</span><span class="p">))))</span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">finalCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Total processado: </span><span class="si">${</span><span class="nx">finalCount</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">workers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">terminate</span><span class="p">());</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Worker thread</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sharedBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">workerId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">workerData</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int32Array</span><span class="p">(</span><span class="nx">sharedBuffer</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Processa itens e incrementa contador atomicamente</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">itemsToProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">itemsToProcess</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Processa item...</span>
<span class="w">    </span><span class="nx">processItem</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Incrementa contador atomicamente</span>
<span class="w">    </span><span class="nb">Atomics</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">parentPort</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="w"> </span>
<span class="w">    </span><span class="nx">workerId</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="nx">itemsToProcess</span><span class="w"> </span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">processItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// SimulaÃ§Ã£o de processamento</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



> **ğŸ“š ReferÃªncia Node.js:**  
> [Atomics com Worker Threads](https://nodejs.org/docs/latest/api/worker_threads.html#sharedarraybuffer-and-transferable-objects)  
> **Nota:** Node.js usa a mesma API Atomics do browser, garantindo consistÃªncia.

### 30.4 Substituindo MÃ©todos Obsoletos

#### Array Methods Modernos

**Antes (padrÃµes antigos):**

<div class="codehilite"><pre><span></span><code><span class="c1">// âŒ for loops manuais</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">doubled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">doubled</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// âŒ forEach sem retorno</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="nx">array</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="nx">filtered</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>



**Depois (mÃ©todos modernos):**

<div class="codehilite"><pre><span></span><code><span class="c1">// âœ… Array.map() - transformaÃ§Ã£o funcional</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">doubled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">array</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>

<span class="c1">// âœ… Array.filter() - filtragem funcional</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">array</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>

<span class="c1">// âœ… Array.flatMap() - map + flat em uma operaÃ§Ã£o (ES2019)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nested</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">]];</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">flattened</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nested</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">arr</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">arr</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// [2, 4, 6, 8]</span>
</code></pre></div>



> **ğŸ“š ReferÃªncias MDN:**
> - [Array.map()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map)
> - [Array.filter()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter)
> - [Array.flatMap()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/flatMap) - ES2019

#### Object Methods Modernos

**Antes:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âŒ Object.keys() + map para valores</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>

<span class="c1">// âŒ VerificaÃ§Ã£o manual de propriedade</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>



**Depois:**

<div class="codehilite"><pre><span></span><code><span class="c1">// âœ… Object.values() - direto</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>

<span class="c1">// âœ… Object.hasOwn() - mÃ©todo estÃ¡tico moderno (ES2022)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// âœ… Object.entries() - iteraÃ§Ã£o moderna</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



> **ğŸ“š ReferÃªncias MDN:**
> - [Object.values()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/values)
> - [Object.hasOwn()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/hasOwn) - ES2022
> - [Object.entries()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/entries)

### 30.5 PadrÃµes de Auditoria: Campos `criado_em` e `alterado_em`

**ImplementaÃ§Ã£o com Sequelize (ORM):**


<div class="codehilite"><pre><span></span><code><span class="c1">// app/models/City.js - Modelo com auditoria</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">DataTypes</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;sequelize&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">sequelize</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../config/database.js&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">City</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;City&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="nx">primaryKey</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">autoIncrement</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
<span class="w">    </span><span class="nx">allowNull</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">DataTypes</span><span class="p">.</span><span class="nx">DECIMAL</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">),</span>
<span class="w">    </span><span class="nx">allowNull</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">DataTypes</span><span class="p">.</span><span class="nx">DECIMAL</span><span class="p">(</span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">),</span>
<span class="w">    </span><span class="nx">allowNull</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="nx">allowNull</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="c1">// Campos de auditoria</span>
<span class="w">  </span><span class="nx">criado_em</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">DataTypes</span><span class="p">.</span><span class="nx">DATE</span><span class="p">,</span>
<span class="w">    </span><span class="nx">allowNull</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nx">defaultValue</span><span class="o">:</span><span class="w"> </span><span class="nx">DataTypes</span><span class="p">.</span><span class="nx">NOW</span><span class="p">,</span>
<span class="w">    </span><span class="nx">field</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;criado_em&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Nome da coluna no banco</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">alterado_em</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">DataTypes</span><span class="p">.</span><span class="nx">DATE</span><span class="p">,</span>
<span class="w">    </span><span class="nx">allowNull</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nx">defaultValue</span><span class="o">:</span><span class="w"> </span><span class="nx">DataTypes</span><span class="p">.</span><span class="nx">NOW</span><span class="p">,</span>
<span class="w">    </span><span class="nx">field</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;alterado_em&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">tableName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;cidades&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">timestamps</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="c1">// Habilita timestamps automÃ¡ticos</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;criado_em&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;alterado_em&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">underscored</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="c1">// snake_case para campos</span>
<span class="p">});</span>

<span class="c1">// Hook para atualizar alterado_em manualmente se necessÃ¡rio</span>
<span class="nx">City</span><span class="p">.</span><span class="nx">addHook</span><span class="p">(</span><span class="s1">&#39;beforeUpdate&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">city</span><span class="p">.</span><span class="nx">alterado_em</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">City</span><span class="p">;</span>
</code></pre></div>



**Uso no Service:**


<div class="codehilite"><pre><span></span><code><span class="c1">// app/services/cityService.js</span>
<span class="k">import</span><span class="w"> </span><span class="nx">City</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/City.js&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">CityService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">createCity</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Sequelize automaticamente preenche criado_em e alterado_em</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">City</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span>
<span class="w">      </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">longitude</span><span class="p">,</span>
<span class="w">      </span><span class="nx">population</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">population</span><span class="p">,</span>
<span class="w">      </span><span class="c1">// criado_em e alterado_em sÃ£o preenchidos automaticamente</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">city</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">updateCity</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">City</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">city</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Cidade nÃ£o encontrada&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Sequelize automaticamente atualiza alterado_em</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">city</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">city</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getCitiesWithAudit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">City</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span>
<span class="w">      </span><span class="nx">attributes</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;population&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;criado_em&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;alterado_em&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nx">order</span><span class="o">:</span><span class="w"> </span><span class="p">[[</span><span class="s1">&#39;alterado_em&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;DESC&#39;</span><span class="p">]],</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



> **ğŸ“š ReferÃªncias:**
> - [Sequelize Timestamps](https://sequelize.org/docs/v6/core-concepts/model-basics/#timestamps)
> - [Sequelize Hooks](https://sequelize.org/docs/v6/other-topics/hooks/)

### 30.6 Checklist de ModernizaÃ§Ã£o

**âœ… Recursos Modernos Implementados:**
- [ ] Optional Chaining (`?.`) substituindo verificaÃ§Ãµes manuais
- [ ] Nullish Coalescing (`??`) substituindo `||` para valores padrÃ£o
- [ ] Campos Privados (`#`) para encapsulamento real
- [ ] Array methods modernos (map, filter, flatMap)
- [ ] Object methods modernos (values, entries, hasOwn)

**âœ… Performance:**
- [ ] Worker Threads do Node.js para processamento server-side
- [ ] SharedArrayBuffer + Atomics para sincronizaÃ§Ã£o eficiente
- [ ] Cache inteligente com WeakMap para GC automÃ¡tico

**âœ… PadrÃµes de CÃ³digo:**
- [ ] ES Modules (`import/export`) em vez de CommonJS
- [ ] Async/await em vez de callbacks
- [ ] Destructuring para cÃ³digo mais limpo
- [ ] Template literals para strings

**âœ… Compatibilidade:**
- [ ] Node.js 18+ LTS (suporta todos os recursos modernos)
- [ ] VerificaÃ§Ã£o de recursos antes de usar (feature detection)
- [ ] Fallbacks para navegadores antigos quando necessÃ¡rio

---

**Ãšltima atualizaÃ§Ã£o:** 30/01/2026  
**VersÃ£o:** 6.0.0 - Guia Completo com Arquitetura Moderna JavaScript/Node.js  
**NÃ­vel:** Doutorado em CiÃªncia da ComputaÃ§Ã£o  
**PadrÃ£o:** USP - Universidade de SÃ£o Paulo  
**Total de PÃ¡ginas:** ~450+ pÃ¡ginas de conteÃºdo acadÃªmico detalhado
</body>
</html>
